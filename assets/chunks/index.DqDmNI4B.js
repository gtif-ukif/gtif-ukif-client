const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunks/raw.DxtaBMev.js","assets/chunks/basedecoder.B2c5_Eok.js","assets/chunks/lzw.BikwkTY2.js","assets/chunks/jpeg.CbvpOiPg.js","assets/chunks/deflate.B4_27dB1.js","assets/chunks/pako.esm.BkaqWuDM.js","assets/chunks/packbits.D6Qr5eNi.js","assets/chunks/lerc.Dhuk8PcV.js","assets/chunks/commonjsHelpers.BosuxZz1.js","assets/chunks/GeoJSON.Br7Jz3X5.js","assets/chunks/extent.CajDHjk1.js","assets/chunks/WMTS.D-lC2MIp.js","assets/chunks/Group.DfJ6KxFj.js","assets/chunks/WKT.CRW3-4HE.js","assets/chunks/framework.DGPOY9aA.js","assets/chunks/item.koN_VtZd.js","assets/chunks/webimage.CU41Mh7j.js"])))=>i.map(i=>d[i]);
var Kp=Object.defineProperty;var Jp=(n,e,t)=>e in n?Kp(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var pe=(n,e,t)=>Jp(n,typeof e!="symbol"?e+"":e,t);import{a5 as Qp,a as Ft,u as ue,t as ut,ao as eg,ap as tg,aq as xa,M as ro,b as Mi,c as sl,P as Cn,L as yr,d as zt,ar as ol,as as rg,i as ng,W as ig,F as sg,G as gi,S as Zu,am as og,ag as _s,ah as mi,at as qu,al as li,T as nt,O as al,aj as ag,ai as Hu,au as lg,ak as ll,l as Jh,U as _r,R as Qh,ae as ug,_ as ef,Q as yi,$ as cg,av as _i,af as hg,m as fg,k as dg,aw as Yu,a9 as Ku,B as ul,w as Ea,e as bs,h as pg,z as wa,x as va,y as gg,ax as Ju,J as mg,N as yg}from"./GeoJSON.Br7Jz3X5.js";import{P as _g,_ as xs,K as Es,Q as tf,c as Mt,a as cl,R as hl,z as bg,ai as xg,ar as Eg,f as rr,a1 as bi,L as no,v as nr,I as Ln,h as it,d as Ue,k as Fn,ab as vn,g as me,a9 as rf,e as wg,a4 as vg,E as ft,al as Tg,ag as Sg,Z as Rg,n as Oi,l as dr,Y as fl,u as ws,a2 as nf,q as jt,b as sf,M as Pg,V as vs,$ as Qu,aj as Ag,a8 as xi,S as Ig,U as Cg,an as ec,m as Lg,a3 as Fg,C as Mg}from"./extent.CajDHjk1.js";import{ae as io,af as q,ag as W,ah as B,ai as Ts,aj as Og,ak as Nr,al as ee,am as T,an as ae,ao as Pe,ap as St,aq as zn,ar as Cr,as as Ei,at as of,au as Ss,av as Rs,aw as k,ax as w,ay as D,az as so,aA as je,aB as lt,aC as dl,aD as af,aE as Ps,aF as Xr,aG as Ng,aH as we,aI as bt,aJ as Qt,T as Dg,K as Ug,aK as Bg,aL as Gg,V as Ni,Q as Lr,S as er,aM as Ta,a9 as Fr,aN as Hr,a as Dr,aO as zg,aP as Q,aQ as pl,aR as Vt,aS as kg,aT as gl,aU as Sa,aV as Ra,aW as Br,aX as $g,aY as Xo,aZ as jg,a_ as Pa,a$ as lf,b0 as yn,b1 as Di,b2 as Vg,b3 as Xg,b4 as ye,b5 as oo,b6 as wi,b7 as gt,b8 as sn,b9 as ln,ba as Wg,bb as te,bc as uf,bd as cf,be as Zg,bf as qg,h as Mr,bg as Gr,bh as ao,bi as hf,bj as Yr,bk as Hg,bl as Yg,bm as Kg,bn as Jg,bo as lo,bp as Qg,bq as em,br as tm,bs as rm,bt as nm,bu as im,J as ml,Y as kr,bv as un,bw as sm,bx as om,by as Wo,bz as Ui,A as kn,u as cn,v as yl,bA as Er,bB as ff,bC as df,bD as am,j as lm,G as Bi,L as pf,F as _l,X as As,W as um,bE as gf,H as cm,B as Sn,E as Is,bF as hm,bG as fm,a5 as bl,bH as tc,bI as dm,bJ as uo,a7 as pm,bK as mf,bL as gm,r as mm,i as ym,bM as xl,bN as Aa,bO as yf,bP as rc,bQ as Cs,bR as _f,bS as _m,bT as bf,bU as bm,bV as xm,bW as Em,bX as wm,bY as vm,bZ as Tm,b_ as Sm}from"./WMTS.D-lC2MIp.js";import{T as xf,W as Rm}from"./WKT.CRW3-4HE.js";import{C as Pm,b as Ia,L as Ef}from"./Group.DfJ6KxFj.js";import{g as wf}from"./commonjsHelpers.BosuxZz1.js";import{a5 as $r}from"./framework.DGPOY9aA.js";import{S as Am,a as Im,u as El,b as vf,C as Tf,I as wl,M as Cm,A as es,c as ei,d as Lm,f as Fm,g as nc,i as ic}from"./item.koN_VtZd.js";class vl extends Am{constructor(e,t=null,r={},i=[]){super(e,t,r,i)}getAll(){return[]}}class Mm extends Im{constructor(e,t=null){super(e,t)}}class Om extends vl{constructor(e,t=null){const r={collections:i=>i.map(s=>new Tf(s))};super(e,t,r)}getObjectType(){return"CollectionCollection"}getAll(){return this.collections}isCollectionCollection(){return!0}toGeoJSON(){return{type:"FeatureCollection",features:this.collections.map(t=>t.toGeoJSON()).filter(t=>t!==null)}}getBoundingBox(){return El(this.getBoundingBoxes())}getBoundingBoxes(){return this.collections.map(e=>e.getBoundingBox())}getTemporalExtent(){return vf(this.getTemporalExtents())}getTemporalExtents(){return this.collections.map(e=>e.getTemporalExtent())}}class Sf extends vl{constructor(e,t=null){const r={features:i=>i.map(s=>new wl(s))};super(e,t,r)}getObjectType(){return"ItemCollection"}getAll(){return this.features}toGeoJSON(){return this.toJSON()}getBoundingBox(){return El(this.getBoundingBoxes())}getBoundingBoxes(){return this.features.map(e=>e.getBoundingBox())}getTemporalExtent(){return vf(this.getTemporalExtents())}getTemporalExtents(){return this.features.map(e=>e.getTemporalExtent())}}function ts(n,e=!0,t=!1){return e&&(n=Cm.stac(n,t)),n.type==="Feature"?new wl(n):n.type==="FeatureCollection"?new Sf(n):n.type==="Collection"||!n.type&&typeof n.extent<"u"&&typeof n.license<"u"?new Tf(n):!n.type&&Array.isArray(n.collections)?new Om(n):new Mm(n)}const Nm={Point:Gm,LineString:zm,Polygon:Vm,MultiPoint:$m,MultiLineString:km,MultiPolygon:jm},Dm={Point:Xm,LineString:Wm,Polygon:Zm,MultiPoint:Hm,MultiLineString:qm,MultiPolygon:Ym};class Um extends Qp{constructor(e){e=e||{},super(),this.geometryName_=e.geometryName}readFeatureFromObject(e,t,r){const i=e,s=sc(i.geometry,t),o=new Ft;if(this.geometryName_&&o.setGeometryName(this.geometryName_),o.setGeometry(s),i.attributes){o.setProperties(i.attributes,!0);const a=i.attributes[r];a!==void 0&&o.setId(a)}return o}readFeaturesFromObject(e,t){if(t=t||{},e.features){const r=e,i=[],s=r.features;for(let o=0,a=s.length;o<a;++o)i.push(this.readFeatureFromObject(s[o],t,e.objectIdFieldName));return i}return[this.readFeatureFromObject(e,t)]}readGeometryFromObject(e,t){return sc(e,t)}readProjectionFromObject(e){if(e.spatialReference&&e.spatialReference.wkid!==void 0){const r=e.spatialReference.wkid;return ue("EPSG:"+r)}return null}writeGeometryObject(e,t){return oc(e,this.adaptOptions(t))}writeFeatureObject(e,t){t=this.adaptOptions(t);const r={};if(!e.hasProperties())return r.attributes={},r;const i=e.getProperties(),s=e.getGeometry();if(s){r.geometry=oc(s,t);const o=t&&(t.dataProjection||t.featureProjection);o&&(r.geometry.spatialReference={wkid:Number(ue(o).getCode().split(":").pop())}),delete i[e.getGeometryName()]}return _g(i)?r.attributes={}:r.attributes=i,r}writeFeaturesObject(e,t){t=this.adaptOptions(t);const r=[];for(let i=0,s=e.length;i<s;++i)r.push(this.writeFeatureObject(e[i],t));return{features:r}}}function sc(n,e){if(!n)return null;let t;if(typeof n.x=="number"&&typeof n.y=="number")t="Point";else if(n.points)t="MultiPoint";else if(n.paths)n.paths.length===1?t="LineString":t="MultiLineString";else if(n.rings){const i=n,s=$n(i),o=Bm(i.rings,s);o.length===1?(t="Polygon",n=Object.assign({},n,{rings:o[0]})):(t="MultiPolygon",n=Object.assign({},n,{rings:o}))}const r=Nm[t];return ut(r(n),!1,e)}function Bm(n,e){const t=[],r=[],i=[];let s,o;for(s=0,o=n.length;s<o;++s)t.length=0,eg(t,0,n[s],e.length),tg(t,0,t.length,e.length)?r.push([n[s]]):i.push(n[s]);for(;i.length;){const a=i.shift();let l=!1;for(s=r.length-1;s>=0;s--){const u=r[s][0];if(xs(new xa(u).getExtent(),new xa(a).getExtent())){r[s].push(a),l=!0;break}}l||r.push([a.reverse()])}return r}function Gm(n){let e;return n.m!==void 0&&n.z!==void 0?e=new zt([n.x,n.y,n.z,n.m],"XYZM"):n.z!==void 0?e=new zt([n.x,n.y,n.z],"XYZ"):n.m!==void 0?e=new zt([n.x,n.y,n.m],"XYM"):e=new zt([n.x,n.y]),e}function zm(n){const e=$n(n);return new yr(n.paths[0],e)}function km(n){const e=$n(n);return new Mi(n.paths,e)}function $n(n){let e="XY";return n.hasZ===!0&&n.hasM===!0?e="XYZM":n.hasZ===!0?e="XYZ":n.hasM===!0&&(e="XYM"),e}function $m(n){const e=$n(n);return new sl(n.points,e)}function jm(n){const e=$n(n);return new ro(n.rings,e)}function Vm(n){const e=$n(n);return new Cn(n.rings,e)}function Xm(n,e){const t=n.getCoordinates();let r;const i=n.getLayout();if(i==="XYZ")r={x:t[0],y:t[1],z:t[2]};else if(i==="XYM")r={x:t[0],y:t[1],m:t[2]};else if(i==="XYZM")r={x:t[0],y:t[1],z:t[2],m:t[3]};else if(i==="XY")r={x:t[0],y:t[1]};else throw new Error("Invalid geometry layout");return r}function Gi(n){const e=n.getLayout();return{hasZ:e==="XYZ"||e==="XYZM",hasM:e==="XYM"||e==="XYZM"}}function Wm(n,e){const t=Gi(n);return{hasZ:t.hasZ,hasM:t.hasM,paths:[n.getCoordinates()]}}function Zm(n,e){const t=Gi(n);return{hasZ:t.hasZ,hasM:t.hasM,rings:n.getCoordinates(!1)}}function qm(n,e){const t=Gi(n);return{hasZ:t.hasZ,hasM:t.hasM,paths:n.getCoordinates()}}function Hm(n,e){const t=Gi(n);return{hasZ:t.hasZ,hasM:t.hasM,points:n.getCoordinates()}}function Ym(n,e){const t=Gi(n),r=n.getCoordinates(!1),i=[];for(let s=0;s<r.length;s++)for(let o=r[s].length-1;o>=0;o--)i.push(r[s][o]);return{hasZ:t.hasZ,hasM:t.hasM,rings:i}}function oc(n,e){const t=Dm[n.getType()];return t(ut(n,!0,e),e)}const gr="http://www.opengis.net/gml",Km=/^\s*$/;class j extends io{constructor(e){super(),e=e||{},this.featureType=e.featureType,this.featureNS=e.featureNS,this.srsName=e.srsName,this.schemaLocation="",this.FEATURE_COLLECTION_PARSERS={},this.FEATURE_COLLECTION_PARSERS[this.namespace]={featureMember:W(this.readFeaturesInternal),featureMembers:q(this.readFeaturesInternal)},this.supportedMediaTypes=["application/gml+xml"]}readFeaturesInternal(e,t){const r=e.localName;let i=null;if(r=="FeatureCollection")i=B([],this.FEATURE_COLLECTION_PARSERS,e,t,this);else if(r=="featureMembers"||r=="featureMember"||r=="member"){const s=t[0];let o=s.featureType,a=s.featureNS;const l="p",u="p0";if(!o&&e.childNodes){o=[],a={};for(let f=0,p=e.childNodes.length;f<p;++f){const d=e.childNodes[f];if(d.nodeType===1){const g=d.nodeName.split(":").pop();if(!o.includes(g)){let m="",_=0;const y=d.namespaceURI;for(const b in a){if(a[b]===y){m=b;break}++_}m||(m=l+_,a[m]=y),o.push(m+":"+g)}}}r!="featureMember"&&(s.featureType=o,s.featureNS=a)}if(typeof a=="string"){const f=a;a={},a[u]=f}const h={},c=Array.isArray(o)?o:[o];for(const f in a){const p={};for(let d=0,g=c.length;d<g;++d)(c[d].includes(":")?c[d].split(":")[0]:u)===f&&(p[c[d].split(":").pop()]=r=="featureMembers"?W(this.readFeatureElement,this):q(this.readFeatureElement,this));h[a[f]]=p}r=="featureMember"||r=="member"?i=B(void 0,h,e,t):i=B([],h,e,t)}return i===null&&(i=[]),i}readGeometryOrExtent(e,t){const r=t[0];return r.srsName=e.firstElementChild.getAttribute("srsName"),r.srsDimension=e.firstElementChild.getAttribute("srsDimension"),B(null,this.GEOMETRY_PARSERS,e,t,this)}readExtentElement(e,t){const r=t[0],i=this.readGeometryOrExtent(e,t);return i?ol(i,r):void 0}readGeometryElement(e,t){const r=t[0],i=this.readGeometryOrExtent(e,t);return i?ut(i,!1,r):void 0}readFeatureElementInternal(e,t,r){let i;const s={};for(let l=e.firstElementChild;l;l=l.nextElementSibling){let u;const h=l.localName;l.childNodes.length===0||l.childNodes.length===1&&(l.firstChild.nodeType===3||l.firstChild.nodeType===4)?(u=Ts(l,!1),Km.test(u)&&(u=void 0)):(r&&(u=h==="boundedBy"?this.readExtentElement(l,t):this.readGeometryElement(l,t)),u?h!=="boundedBy"&&(i=h):u=this.readFeatureElementInternal(l,t,!1));const c=l.attributes.length;if(c>0&&!(u instanceof rg)){u={_content_:u};for(let f=0;f<c;f++){const p=l.attributes[f].name;u[p]=l.attributes[f].value}}s[h]?(s[h]instanceof Array||(s[h]=[s[h]]),s[h].push(u)):s[h]=u}if(!r)return s;const o=new Ft(s);i&&o.setGeometryName(i);const a=e.getAttribute("fid")||Og(e,this.namespace,"id");return a&&o.setId(a),o}readFeatureElement(e,t){return this.readFeatureElementInternal(e,t,!0)}readPoint(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new zt(r,"XYZ")}readMultiPoint(e,t){const r=B([],this.MULTIPOINT_PARSERS,e,t,this);if(r)return new sl(r)}readMultiLineString(e,t){const r=B([],this.MULTILINESTRING_PARSERS,e,t,this);if(r)return new Mi(r)}readMultiPolygon(e,t){const r=B([],this.MULTIPOLYGON_PARSERS,e,t,this);if(r)return new ro(r)}pointMemberParser(e,t){Nr(this.POINTMEMBER_PARSERS,e,t,this)}lineStringMemberParser(e,t){Nr(this.LINESTRINGMEMBER_PARSERS,e,t,this)}polygonMemberParser(e,t){Nr(this.POLYGONMEMBER_PARSERS,e,t,this)}readLineString(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new yr(r,"XYZ")}readFlatLinearRing(e,t){const r=B(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this);if(r)return r}readLinearRing(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new xa(r,"XYZ")}readPolygon(e,t){const r=B([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this);if(r&&r[0]){const i=r[0],s=[i.length];let o,a;for(o=1,a=r.length;o<a;++o)Es(i,r[o]),s.push(i.length);return new Cn(i,"XYZ",s)}}readFlatCoordinatesFromNode(e,t){return B(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)}readGeometryFromNode(e,t){const r=this.readGeometryElement(e,[this.getReadOptions(e,t||{})]);return r||null}readFeaturesFromNode(e,t){const r={featureType:this.featureType,featureNS:this.featureNS};return r&&Object.assign(r,this.getReadOptions(e,t)),this.readFeaturesInternal(e,[r])||[]}readProjectionFromNode(e){return ue(this.srsName?this.srsName:e.firstElementChild.getAttribute("srsName"))}}j.prototype.namespace=gr;j.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{}};j.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{}};j.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{}};j.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml":{pointMember:W(j.prototype.pointMemberParser),pointMembers:W(j.prototype.pointMemberParser)}};j.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml":{lineStringMember:W(j.prototype.lineStringMemberParser),lineStringMembers:W(j.prototype.lineStringMemberParser)}};j.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml":{polygonMember:W(j.prototype.polygonMemberParser),polygonMembers:W(j.prototype.polygonMemberParser)}};j.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml":{Point:W(j.prototype.readFlatCoordinatesFromNode)}};j.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:W(j.prototype.readLineString)}};j.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:W(j.prototype.readPolygon)}};j.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:q(j.prototype.readFlatLinearRing)}};const Jm=gr+" http://schemas.opengis.net/gml/2.1.2/feature.xsd",Qm={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class oe extends j{constructor(e){e=e||{},super(e),this.FEATURE_COLLECTION_PARSERS[gr].featureMember=W(this.readFeaturesInternal),this.schemaLocation=e.schemaLocation?e.schemaLocation:Jm}readFlatCoordinates(e,t){const r=Ts(e,!1).replace(/^\s*|\s*$/g,""),s=t[0].srsName;let o="enu";if(s){const u=ue(s);u&&(o=u.getAxisOrientation())}const a=r.trim().split(/\s+/),l=[];for(let u=0,h=a.length;u<h;u++){const c=a[u].split(/,+/),f=parseFloat(c[0]),p=parseFloat(c[1]),d=c.length===3?parseFloat(c[2]):0;o.startsWith("en")?l.push(f,p,d):l.push(p,f,d)}return l}readBox(e,t){const r=B([null],this.BOX_PARSERS_,e,t,this);return tf(r[1][0],r[1][1],r[1][3],r[1][4])}innerBoundaryIsParser(e,t){const r=B(void 0,this.RING_PARSERS,e,t,this);r&&t[t.length-1].push(r)}outerBoundaryIsParser(e,t){const r=B(void 0,this.RING_PARSERS,e,t,this);if(r){const i=t[t.length-1];i[0]=r}}GEOMETRY_NODE_FACTORY_(e,t,r){const i=t[t.length-1],s=i.multiSurface,o=i.surface,a=i.multiCurve;return Array.isArray(e)?r="Envelope":(r=e.getType(),r==="MultiPolygon"&&s===!0?r="MultiSurface":r==="Polygon"&&o===!0?r="Surface":r==="MultiLineString"&&a===!0&&(r="MultiCurve")),ee("http://www.opengis.net/gml",r)}writeFeatureElement(e,t,r){const i=t.getId();i&&e.setAttribute("fid",i);const s=r[r.length-1],o=s.featureNS,a=t.getGeometryName();s.serializers||(s.serializers={},s.serializers[o]={});const l=[],u=[];if(t.hasProperties()){const c=t.getProperties();for(const f in c){const p=c[f];p!=null&&(l.push(f),u.push(p),f==a||typeof p.getSimplifiedGeometry=="function"?f in s.serializers[o]||(s.serializers[o][f]=T(this.writeGeometryElement,this)):f in s.serializers[o]||(s.serializers[o][f]=T(ae)))}}const h=Object.assign({},s);h.node=e,Pe(h,s.serializers,St(void 0,o),u,r,l)}writeCurveOrLineString(e,t,r){const s=r[r.length-1].srsName;if(e.nodeName!=="LineStringSegment"&&s&&e.setAttribute("srsName",s),e.nodeName==="LineString"||e.nodeName==="LineStringSegment"){const o=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(o),this.writeCoordinates_(o,t,r)}else if(e.nodeName==="Curve"){const o=ee(e.namespaceURI,"segments");e.appendChild(o),this.writeCurveSegments_(o,t,r)}}writeLineStringOrCurveMember(e,t,r){const i=this.GEOMETRY_NODE_FACTORY_(t,r);i&&(e.appendChild(i),this.writeCurveOrLineString(i,t,r))}writeMultiCurveOrLineString(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName,a=i.curve;o&&e.setAttribute("srsName",o);const l=t.getLineStrings();Pe({node:e,hasZ:s,srsName:o,curve:a},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeGeometryElement(e,t,r){const i=r[r.length-1],s=Object.assign({},i);s.node=e;let o;Array.isArray(t)?o=ol(t,i):o=ut(t,!0,i),Pe(s,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[o],r,void 0,this)}createCoordinatesNode_(e){const t=ee(e,"coordinates");return t.setAttribute("decimal","."),t.setAttribute("cs",","),t.setAttribute("ts"," "),t}writeCoordinates_(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName,a=t.getCoordinates(),l=a.length,u=new Array(l);for(let h=0;h<l;++h){const c=a[h];u[h]=this.getCoords_(c,o,s)}ae(e,u.join(" "))}writeCurveSegments_(e,t,r){const i=ee(e.namespaceURI,"LineStringSegment");e.appendChild(i),this.writeCurveOrLineString(i,t,r)}writeSurfaceOrPolygon(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName;if(e.nodeName!=="PolygonPatch"&&o&&e.setAttribute("srsName",o),e.nodeName==="Polygon"||e.nodeName==="PolygonPatch"){const a=t.getLinearRings();Pe({node:e,hasZ:s,srsName:o},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,a,r,void 0,this)}else if(e.nodeName==="Surface"){const a=ee(e.namespaceURI,"patches");e.appendChild(a),this.writeSurfacePatches_(a,t,r)}}RING_NODE_FACTORY_(e,t,r){const i=t[t.length-1],s=i.node,o=i.exteriorWritten;return o===void 0&&(i.exteriorWritten=!0),ee(s.namespaceURI,o!==void 0?"innerBoundaryIs":"outerBoundaryIs")}writeSurfacePatches_(e,t,r){const i=ee(e.namespaceURI,"PolygonPatch");e.appendChild(i),this.writeSurfaceOrPolygon(i,t,r)}writeRing(e,t,r){const i=ee(e.namespaceURI,"LinearRing");e.appendChild(i),this.writeLinearRing(i,t,r)}getCoords_(e,t,r){let s=(t?ue(t).getAxisOrientation():"enu").startsWith("en")?e[0]+","+e[1]:e[1]+","+e[0];if(r){const o=e[2]||0;s+=","+o}return s}writePoint(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName;o&&e.setAttribute("srsName",o);const a=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(a);const l=t.getCoordinates(),u=this.getCoords_(l,o,s);ae(a,u)}writeMultiPoint(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName;o&&e.setAttribute("srsName",o);const a=t.getPoints();Pe({node:e,hasZ:s,srsName:o},this.POINTMEMBER_SERIALIZERS,St("pointMember"),a,r,void 0,this)}writePointMember(e,t,r){const i=ee(e.namespaceURI,"Point");e.appendChild(i),this.writePoint(i,t,r)}writeLinearRing(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(o),this.writeCoordinates_(o,t,r)}writeMultiSurfaceOrPolygon(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName,a=i.surface;o&&e.setAttribute("srsName",o);const l=t.getPolygons();Pe({node:e,hasZ:s,srsName:o,surface:a},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeSurfaceOrPolygonMember(e,t,r){const i=this.GEOMETRY_NODE_FACTORY_(t,r);i&&(e.appendChild(i),this.writeSurfaceOrPolygon(i,t,r))}writeEnvelope(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=["lowerCorner","upperCorner"],a=[t[0]+" "+t[1],t[2]+" "+t[3]];Pe({node:e},this.ENVELOPE_SERIALIZERS,zn,a,r,o,this)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(e,t,r){const i=t[t.length-1].node;return ee("http://www.opengis.net/gml",Qm[i.nodeName])}}oe.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{coordinates:q(oe.prototype.readFlatCoordinates)}};oe.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{innerBoundaryIs:oe.prototype.innerBoundaryIsParser,outerBoundaryIs:oe.prototype.outerBoundaryIsParser}};oe.prototype.BOX_PARSERS_={"http://www.opengis.net/gml":{coordinates:W(oe.prototype.readFlatCoordinates)}};oe.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:q(j.prototype.readPoint),MultiPoint:q(j.prototype.readMultiPoint),LineString:q(j.prototype.readLineString),MultiLineString:q(j.prototype.readMultiLineString),LinearRing:q(j.prototype.readLinearRing),Polygon:q(j.prototype.readPolygon),MultiPolygon:q(j.prototype.readMultiPolygon),Box:q(oe.prototype.readBox)}};oe.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:T(oe.prototype.writeCurveOrLineString),MultiCurve:T(oe.prototype.writeMultiCurveOrLineString),Point:T(oe.prototype.writePoint),MultiPoint:T(oe.prototype.writeMultiPoint),LineString:T(oe.prototype.writeCurveOrLineString),MultiLineString:T(oe.prototype.writeMultiCurveOrLineString),LinearRing:T(oe.prototype.writeLinearRing),Polygon:T(oe.prototype.writeSurfaceOrPolygon),MultiPolygon:T(oe.prototype.writeMultiSurfaceOrPolygon),Surface:T(oe.prototype.writeSurfaceOrPolygon),MultiSurface:T(oe.prototype.writeMultiSurfaceOrPolygon),Envelope:T(oe.prototype.writeEnvelope)}};oe.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:T(oe.prototype.writeLineStringOrCurveMember),curveMember:T(oe.prototype.writeLineStringOrCurveMember)}};oe.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{outerBoundaryIs:T(oe.prototype.writeRing),innerBoundaryIs:T(oe.prototype.writeRing)}};oe.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:T(oe.prototype.writePointMember)}};oe.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:T(oe.prototype.writeSurfaceOrPolygonMember),polygonMember:T(oe.prototype.writeSurfaceOrPolygonMember)}};oe.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:T(ae),upperCorner:T(ae)}};const ey=gr+" http://schemas.opengis.net/gml/3.1.1/profiles/gmlsfProfile/1.0.0/gmlsf.xsd",ty={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class O extends j{constructor(e){e=e||{},super(e),this.surface_=e.surface!==void 0?e.surface:!1,this.curve_=e.curve!==void 0?e.curve:!1,this.multiCurve_=e.multiCurve!==void 0?e.multiCurve:!0,this.multiSurface_=e.multiSurface!==void 0?e.multiSurface:!0,this.schemaLocation=e.schemaLocation?e.schemaLocation:ey,this.hasZ=e.hasZ!==void 0?e.hasZ:!1}readMultiCurve(e,t){const r=B([],this.MULTICURVE_PARSERS,e,t,this);if(r)return new Mi(r)}readFlatCurveRing(e,t){const r=B([],this.MULTICURVE_PARSERS,e,t,this),i=[];for(let s=0,o=r.length;s<o;++s)Es(i,r[s].getFlatCoordinates());return i}readMultiSurface(e,t){const r=B([],this.MULTISURFACE_PARSERS,e,t,this);if(r)return new ro(r)}curveMemberParser(e,t){Nr(this.CURVEMEMBER_PARSERS,e,t,this)}surfaceMemberParser(e,t){Nr(this.SURFACEMEMBER_PARSERS,e,t,this)}readPatch(e,t){return B([null],this.PATCHES_PARSERS,e,t,this)}readSegment(e,t){return B([],this.SEGMENTS_PARSERS,e,t,this)}readPolygonPatch(e,t){return B([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this)}readLineStringSegment(e,t){return B([null],this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)}interiorParser(e,t){const r=B(void 0,this.RING_PARSERS,e,t,this);r&&t[t.length-1].push(r)}exteriorParser(e,t){const r=B(void 0,this.RING_PARSERS,e,t,this);if(r){const i=t[t.length-1];i[0]=r}}readSurface(e,t){const r=B([null],this.SURFACE_PARSERS,e,t,this);if(r&&r[0]){const i=r[0],s=[i.length];let o,a;for(o=1,a=r.length;o<a;++o)Es(i,r[o]),s.push(i.length);return new Cn(i,"XYZ",s)}}readCurve(e,t){const r=B([null],this.CURVE_PARSERS,e,t,this);if(r)return new yr(r,"XYZ")}readEnvelope(e,t){const r=B([null],this.ENVELOPE_PARSERS,e,t,this);return tf(r[1][0],r[1][1],r[2][0],r[2][1])}readFlatPos(e,t){let r=Ts(e,!1);const i=/^\s*([+\-]?\d*\.?\d+(?:[eE][+\-]?\d+)?)\s*/,s=[];let o;for(;o=i.exec(r);)s.push(parseFloat(o[1])),r=r.substr(o[0].length);if(r!=="")return;const l=t[0].srsName;if((l?ue(l).getAxisOrientation():"enu")==="neu")for(let c=0,f=s.length;c<f;c+=3){const p=s[c],d=s[c+1];s[c]=d,s[c+1]=p}const h=s.length;if(h==2&&s.push(0),h!==0)return s}readFlatPosList(e,t){const r=Ts(e,!1).replace(/^\s*|\s*$/g,""),i=t[0],s=i.srsName,o=i.srsDimension,a=s?ue(s).getAxisOrientation():"enu",l=r.split(/\s+/);let u=2;e.getAttribute("srsDimension")?u=Cr(e.getAttribute("srsDimension")):e.getAttribute("dimension")?u=Cr(e.getAttribute("dimension")):e.parentNode.getAttribute("srsDimension")?u=Cr(e.parentNode.getAttribute("srsDimension")):o&&(u=Cr(o));const h=a.startsWith("en");let c,f,p;const d=[];for(let g=0,m=l.length;g<m;g+=u)c=parseFloat(l[g]),f=parseFloat(l[g+1]),p=u===3?parseFloat(l[g+2]):0,h?d.push(c,f,p):d.push(f,c,p);return d}writePos_(e,t,r){const i=r[r.length-1],s=i.hasZ,o=s?"3":"2";e.setAttribute("srsDimension",o);const a=i.srsName,l=a?ue(a).getAxisOrientation():"enu",u=t.getCoordinates();let h=l.startsWith("en")?u[0]+" "+u[1]:u[1]+" "+u[0];if(s){const c=u[2]||0;h+=" "+c}ae(e,h)}getCoords_(e,t,r){let s=(t?ue(t).getAxisOrientation():"enu").startsWith("en")?e[0]+" "+e[1]:e[1]+" "+e[0];if(r){const o=e[2]||0;s+=" "+o}return s}writePosList_(e,t,r){const i=r[r.length-1],s=i.hasZ,o=s?"3":"2";e.setAttribute("srsDimension",o);const a=i.srsName,l=t.getCoordinates(),u=l.length,h=new Array(u);let c;for(let f=0;f<u;++f)c=l[f],h[f]=this.getCoords_(c,a,s);ae(e,h.join(" "))}writePoint(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=ee(e.namespaceURI,"pos");e.appendChild(o),this.writePos_(o,t,r)}writeEnvelope(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=["lowerCorner","upperCorner"],a=[t[0]+" "+t[1],t[2]+" "+t[3]];Pe({node:e},this.ENVELOPE_SERIALIZERS,zn,a,r,o,this)}writeLinearRing(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=ee(e.namespaceURI,"posList");e.appendChild(o),this.writePosList_(o,t,r)}RING_NODE_FACTORY_(e,t,r){const i=t[t.length-1],s=i.node,o=i.exteriorWritten;return o===void 0&&(i.exteriorWritten=!0),ee(s.namespaceURI,o!==void 0?"interior":"exterior")}writeSurfaceOrPolygon(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName;if(e.nodeName!=="PolygonPatch"&&o&&e.setAttribute("srsName",o),e.nodeName==="Polygon"||e.nodeName==="PolygonPatch"){const a=t.getLinearRings();Pe({node:e,hasZ:s,srsName:o},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,a,r,void 0,this)}else if(e.nodeName==="Surface"){const a=ee(e.namespaceURI,"patches");e.appendChild(a),this.writeSurfacePatches_(a,t,r)}}writeCurveOrLineString(e,t,r){const s=r[r.length-1].srsName;if(e.nodeName!=="LineStringSegment"&&s&&e.setAttribute("srsName",s),e.nodeName==="LineString"||e.nodeName==="LineStringSegment"){const o=ee(e.namespaceURI,"posList");e.appendChild(o),this.writePosList_(o,t,r)}else if(e.nodeName==="Curve"){const o=ee(e.namespaceURI,"segments");e.appendChild(o),this.writeCurveSegments_(o,t,r)}}writeMultiSurfaceOrPolygon(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName,a=i.surface;o&&e.setAttribute("srsName",o);const l=t.getPolygons();Pe({node:e,hasZ:s,srsName:o,surface:a},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeMultiPoint(e,t,r){const i=r[r.length-1],s=i.srsName,o=i.hasZ;s&&e.setAttribute("srsName",s);const a=t.getPoints();Pe({node:e,hasZ:o,srsName:s},this.POINTMEMBER_SERIALIZERS,St("pointMember"),a,r,void 0,this)}writeMultiCurveOrLineString(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName,a=i.curve;o&&e.setAttribute("srsName",o);const l=t.getLineStrings();Pe({node:e,hasZ:s,srsName:o,curve:a},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeRing(e,t,r){const i=ee(e.namespaceURI,"LinearRing");e.appendChild(i),this.writeLinearRing(i,t,r)}writeSurfaceOrPolygonMember(e,t,r){const i=this.GEOMETRY_NODE_FACTORY_(t,r);i&&(e.appendChild(i),this.writeSurfaceOrPolygon(i,t,r))}writePointMember(e,t,r){const i=ee(e.namespaceURI,"Point");e.appendChild(i),this.writePoint(i,t,r)}writeLineStringOrCurveMember(e,t,r){const i=this.GEOMETRY_NODE_FACTORY_(t,r);i&&(e.appendChild(i),this.writeCurveOrLineString(i,t,r))}writeSurfacePatches_(e,t,r){const i=ee(e.namespaceURI,"PolygonPatch");e.appendChild(i),this.writeSurfaceOrPolygon(i,t,r)}writeCurveSegments_(e,t,r){const i=ee(e.namespaceURI,"LineStringSegment");e.appendChild(i),this.writeCurveOrLineString(i,t,r)}writeGeometryElement(e,t,r){const i=r[r.length-1],s=Object.assign({},i);s.node=e;let o;Array.isArray(t)?o=ol(t,i):o=ut(t,!0,i),Pe(s,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[o],r,void 0,this)}writeFeatureElement(e,t,r){const i=t.getId();i&&e.setAttribute("fid",i);const s=r[r.length-1],o=s.featureNS,a=t.getGeometryName();s.serializers||(s.serializers={},s.serializers[o]={});const l=[],u=[];if(t.hasProperties()){const c=t.getProperties();for(const f in c){const p=c[f];p!=null&&(l.push(f),u.push(p),f==a||typeof p.getSimplifiedGeometry=="function"?f in s.serializers[o]||(s.serializers[o][f]=T(this.writeGeometryElement,this)):f in s.serializers[o]||(s.serializers[o][f]=T(ae)))}}const h=Object.assign({},s);h.node=e,Pe(h,s.serializers,St(void 0,o),u,r,l)}writeFeatureMembers_(e,t,r){const i=r[r.length-1],s=i.featureType,o=i.featureNS,a={};a[o]={},a[o][s]=T(this.writeFeatureElement,this);const l=Object.assign({},i);l.node=e,Pe(l,a,St(s,o),t,r)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(e,t,r){const i=t[t.length-1].node;return ee(this.namespace,ty[i.nodeName])}GEOMETRY_NODE_FACTORY_(e,t,r){const i=t[t.length-1],s=i.multiSurface,o=i.surface,a=i.curve,l=i.multiCurve;return Array.isArray(e)?r="Envelope":(r=e.getType(),r==="MultiPolygon"&&s===!0?r="MultiSurface":r==="Polygon"&&o===!0?r="Surface":r==="LineString"&&a===!0?r="Curve":r==="MultiLineString"&&l===!0&&(r="MultiCurve")),ee(this.namespace,r)}writeGeometryNode(e,t){t=this.adaptOptions(t);const r=ee(this.namespace,"geom"),i={node:r,hasZ:this.hasZ,srsName:this.srsName,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_};return t&&Object.assign(i,t),this.writeGeometryElement(r,e,[i]),r}writeFeaturesNode(e,t){t=this.adaptOptions(t);const r=ee(this.namespace,"featureMembers");r.setAttributeNS(Ei,"xsi:schemaLocation",this.schemaLocation);const i={srsName:this.srsName,hasZ:this.hasZ,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_,featureNS:this.featureNS,featureType:this.featureType};return t&&Object.assign(i,t),this.writeFeatureMembers_(r,e,[i]),r}}O.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{pos:q(O.prototype.readFlatPos),posList:q(O.prototype.readFlatPosList),coordinates:q(oe.prototype.readFlatCoordinates)}};O.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{interior:O.prototype.interiorParser,exterior:O.prototype.exteriorParser}};O.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:q(j.prototype.readPoint),MultiPoint:q(j.prototype.readMultiPoint),LineString:q(j.prototype.readLineString),MultiLineString:q(j.prototype.readMultiLineString),LinearRing:q(j.prototype.readLinearRing),Polygon:q(j.prototype.readPolygon),MultiPolygon:q(j.prototype.readMultiPolygon),Surface:q(O.prototype.readSurface),MultiSurface:q(O.prototype.readMultiSurface),Curve:q(O.prototype.readCurve),MultiCurve:q(O.prototype.readMultiCurve),Envelope:q(O.prototype.readEnvelope)}};O.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml":{curveMember:W(O.prototype.curveMemberParser),curveMembers:W(O.prototype.curveMemberParser)}};O.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml":{surfaceMember:W(O.prototype.surfaceMemberParser),surfaceMembers:W(O.prototype.surfaceMemberParser)}};O.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:W(j.prototype.readLineString),Curve:W(O.prototype.readCurve)}};O.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:W(j.prototype.readPolygon),Surface:W(O.prototype.readSurface)}};O.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml":{patches:q(O.prototype.readPatch)}};O.prototype.CURVE_PARSERS={"http://www.opengis.net/gml":{segments:q(O.prototype.readSegment)}};O.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml":{lowerCorner:W(O.prototype.readFlatPosList),upperCorner:W(O.prototype.readFlatPosList)}};O.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml":{PolygonPatch:q(O.prototype.readPolygonPatch)}};O.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml":{LineStringSegment:of(O.prototype.readLineStringSegment)}};j.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:q(j.prototype.readFlatLinearRing),Ring:q(O.prototype.readFlatCurveRing)}};O.prototype.writeFeatures;O.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{exterior:T(O.prototype.writeRing),interior:T(O.prototype.writeRing)}};O.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:T(ae),upperCorner:T(ae)}};O.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:T(O.prototype.writeSurfaceOrPolygonMember),polygonMember:T(O.prototype.writeSurfaceOrPolygonMember)}};O.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:T(O.prototype.writePointMember)}};O.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:T(O.prototype.writeLineStringOrCurveMember),curveMember:T(O.prototype.writeLineStringOrCurveMember)}};O.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:T(O.prototype.writeCurveOrLineString),MultiCurve:T(O.prototype.writeMultiCurveOrLineString),Point:T(O.prototype.writePoint),MultiPoint:T(O.prototype.writeMultiPoint),LineString:T(O.prototype.writeCurveOrLineString),MultiLineString:T(O.prototype.writeMultiCurveOrLineString),LinearRing:T(O.prototype.writeLinearRing),Polygon:T(O.prototype.writeSurfaceOrPolygon),MultiPolygon:T(O.prototype.writeMultiSurfaceOrPolygon),Surface:T(O.prototype.writeSurfaceOrPolygon),MultiSurface:T(O.prototype.writeMultiSurfaceOrPolygon),Envelope:T(O.prototype.writeEnvelope)}};const Tl=O;Tl.prototype.writeFeatures;Tl.prototype.writeFeaturesNode;const Oe=[null,"http://www.topografix.com/GPX/1/0","http://www.topografix.com/GPX/1/1"],ry="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd",ny={rte:Rf,trk:Pf,wpt:Af},iy=k(Oe,{rte:W(Rf),trk:W(Pf),wpt:W(Af)}),sy=k(Oe,{text:w(D,"linkText"),type:w(D,"linkType")}),oy=k(Oe,{name:w(D),email:My,link:zi}),ay=k(Oe,{name:w(D),desc:w(D),author:w(Cy),copyright:w(Ly),link:zi,time:w(so),keywords:w(D),bounds:Fy,extensions:co}),ly=k(Oe,{year:w(je),license:w(D)}),uy=k(Oe,{rte:T(Uy),trk:T(By),wpt:T(zy)});class cy extends io{constructor(e){super(),e=e||{},this.dataProjection=ue("EPSG:4326"),this.readExtensions_=e.readExtensions}handleReadExtensions_(e){e||(e=[]);for(let t=0,r=e.length;t<r;++t){const i=e[t];if(this.readExtensions_){const s=i.get("extensionsNode_")||null;this.readExtensions_(i,s)}i.set("extensionsNode_",void 0)}}readMetadata(e){return e?typeof e=="string"?this.readMetadataFromDocument(Ss(e)):Rs(e)?this.readMetadataFromDocument(e):this.readMetadataFromNode(e):null}readMetadataFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType===Node.ELEMENT_NODE){const r=this.readMetadataFromNode(t);if(r)return r}return null}readMetadataFromNode(e){if(!Oe.includes(e.namespaceURI))return null;for(let t=e.firstElementChild;t;t=t.nextElementSibling)if(Oe.includes(t.namespaceURI)&&t.localName==="metadata")return B({},ay,t,[]);return null}readFeatureFromNode(e,t){if(!Oe.includes(e.namespaceURI))return null;const r=ny[e.localName];if(!r)return null;const i=r(e,[this.getReadOptions(e,t)]);return i?(this.handleReadExtensions_([i]),i):null}readFeaturesFromNode(e,t){if(!Oe.includes(e.namespaceURI))return[];if(e.localName=="gpx"){const r=B([],iy,e,[this.getReadOptions(e,t)]);return r?(this.handleReadExtensions_(r),r):[]}return[]}writeFeaturesNode(e,t){t=this.adaptOptions(t);const r=ee("http://www.topografix.com/GPX/1/1","gpx");return r.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xsi",Ei),r.setAttributeNS(Ei,"xsi:schemaLocation",ry),r.setAttribute("version","1.1"),r.setAttribute("creator","OpenLayers"),Pe({node:r},uy,Iy,e,[t]),r}}const hy=k(Oe,{name:w(D),cmt:w(D),desc:w(D),src:w(D),link:zi,number:w(je),extensions:co,type:w(D),rtept:Oy}),fy=k(Oe,{ele:w(lt),time:w(so)}),dy=k(Oe,{name:w(D),cmt:w(D),desc:w(D),src:w(D),link:zi,number:w(je),type:w(D),extensions:co,trkseg:Dy}),py=k(Oe,{trkpt:Ny}),gy=k(Oe,{ele:w(lt),time:w(so)}),my=k(Oe,{ele:w(lt),time:w(so),magvar:w(lt),geoidheight:w(lt),name:w(D),cmt:w(D),desc:w(D),src:w(D),link:zi,sym:w(D),type:w(D),fix:w(D),sat:w(je),hdop:w(lt),vdop:w(lt),pdop:w(lt),ageofdgpsdata:w(lt),dgpsid:w(je),extensions:co}),yy=["text","type"],_y=k(Oe,{text:T(ae),type:T(ae)}),by=k(Oe,["name","cmt","desc","src","link","number","type","rtept"]),xy=k(Oe,{name:T(ae),cmt:T(ae),desc:T(ae),src:T(ae),link:T(Pl),number:T(Ps),type:T(ae),rtept:af(T(Al))}),Ey=k(Oe,["ele","time"]),wy=k(Oe,["name","cmt","desc","src","link","number","type","trkseg"]),vy=k(Oe,{name:T(ae),cmt:T(ae),desc:T(ae),src:T(ae),link:T(Pl),number:T(Ps),type:T(ae),trkseg:af(T(Gy))}),Ty=St("trkpt"),Sy=k(Oe,{trkpt:T(Al)}),Ry=k(Oe,["ele","time","magvar","geoidheight","name","cmt","desc","src","link","sym","type","fix","sat","hdop","vdop","pdop","ageofdgpsdata","dgpsid"]),Py=k(Oe,{ele:T(Xr),time:T(Ng),magvar:T(Xr),geoidheight:T(Xr),name:T(ae),cmt:T(ae),desc:T(ae),src:T(ae),link:T(Pl),sym:T(ae),type:T(ae),fix:T(ae),sat:T(Ps),hdop:T(Xr),vdop:T(Xr),pdop:T(Xr),ageofdgpsdata:T(Xr),dgpsid:T(Ps)}),Ay={Point:"wpt",LineString:"rte",MultiLineString:"trk"};function Iy(n,e,t){const r=n.getGeometry();if(r){const i=Ay[r.getType()];if(i){const s=e[e.length-1].node;return ee(s.namespaceURI,i)}}}function Sl(n,e,t,r){return n.push(parseFloat(t.getAttribute("lon")),parseFloat(t.getAttribute("lat"))),"ele"in r?(n.push(r.ele),delete r.ele,e.hasZ=!0):n.push(0),"time"in r?(n.push(r.time),delete r.time,e.hasM=!0):n.push(0),n}function Rl(n,e,t){let r="XY",i=2;if(n.hasZ&&n.hasM?(r="XYZM",i=4):n.hasZ?(r="XYZ",i=3):n.hasM&&(r="XYM",i=3),i!==4){for(let s=0,o=e.length/4;s<o;s++)e[s*i]=e[s*4],e[s*i+1]=e[s*4+1],n.hasZ&&(e[s*i+2]=e[s*4+2]),n.hasM&&(e[s*i+2]=e[s*4+3]);if(e.length=e.length/4*i,t)for(let s=0,o=t.length;s<o;s++)t[s]=t[s]/4*i}return r}function Cy(n,e){const t=B({},oy,n,e);if(t)return t}function Ly(n,e){const t=B({},ly,n,e);if(t){const r=n.getAttribute("author");return r!==null&&(t.author=r),t}}function Fy(n,e){const t=e[e.length-1],r=n.getAttribute("minlat"),i=n.getAttribute("minlon"),s=n.getAttribute("maxlat"),o=n.getAttribute("maxlon");i!==null&&r!==null&&o!==null&&s!==null&&(t.bounds=[[parseFloat(i),parseFloat(r)],[parseFloat(o),parseFloat(s)]])}function My(n,e){const t=e[e.length-1],r=n.getAttribute("id"),i=n.getAttribute("domain");r!==null&&i!==null&&(t.email=`${r}@${i}`)}function zi(n,e){const t=e[e.length-1],r=n.getAttribute("href");r!==null&&(t.link=r),Nr(sy,n,e)}function co(n,e){const t=e[e.length-1];t.extensionsNode_=n}function Oy(n,e){const t=B({},fy,n,e);if(t){const r=e[e.length-1],i=r.flatCoordinates,s=r.layoutOptions;Sl(i,s,n,t)}}function Ny(n,e){const t=B({},gy,n,e);if(t){const r=e[e.length-1],i=r.flatCoordinates,s=r.layoutOptions;Sl(i,s,n,t)}}function Dy(n,e){const t=e[e.length-1];Nr(py,n,e);const r=t.flatCoordinates;t.ends.push(r.length)}function Rf(n,e){const t=e[0],r=B({flatCoordinates:[],layoutOptions:{}},hy,n,e);if(!r)return;const i=r.flatCoordinates;delete r.flatCoordinates;const s=r.layoutOptions;delete r.layoutOptions;const o=Rl(s,i),a=new yr(i,o);ut(a,!1,t);const l=new Ft(a);return l.setProperties(r,!0),l}function Pf(n,e){const t=e[0],r=B({flatCoordinates:[],ends:[],layoutOptions:{}},dy,n,e);if(!r)return;const i=r.flatCoordinates;delete r.flatCoordinates;const s=r.ends;delete r.ends;const o=r.layoutOptions;delete r.layoutOptions;const a=Rl(o,i,s),l=new Mi(i,a,s);ut(l,!1,t);const u=new Ft(l);return u.setProperties(r,!0),u}function Af(n,e){const t=e[0],r=B({},my,n,e);if(!r)return;const i={},s=Sl([],i,n,r),o=Rl(i,s),a=new zt(s,o);ut(a,!1,t);const l=new Ft(a);return l.setProperties(r,!0),l}function Pl(n,e,t){n.setAttribute("href",e);const i=t[t.length-1].properties,s=[i.linkText,i.linkType];Pe({node:n},_y,zn,s,t,yy)}function Al(n,e,t){const r=t[t.length-1],s=r.node.namespaceURI,o=r.properties;switch(n.setAttributeNS(null,"lat",String(e[1])),n.setAttributeNS(null,"lon",String(e[0])),r.geometryLayout){case"XYZM":e[3]!==0&&(o.time=e[3]);case"XYZ":e[2]!==0&&(o.ele=e[2]);break;case"XYM":e[2]!==0&&(o.time=e[2]);break}const l=n.nodeName=="rtept"?Ey[s]:Ry[s],u=dl(o,l);Pe({node:n,properties:o},Py,zn,u,t,l)}function Uy(n,e,t){const r=t[0],i=e.getProperties(),s={node:n};s.properties=i;const o=e.getGeometry();if(o.getType()=="LineString"){const h=ut(o,!0,r);s.geometryLayout=h.getLayout(),i.rtept=h.getCoordinates()}const a=t[t.length-1].node,l=by[a.namespaceURI],u=dl(i,l);Pe(s,xy,zn,u,t,l)}function By(n,e,t){const r=t[0],i=e.getProperties(),s={node:n};s.properties=i;const o=e.getGeometry();if(o.getType()=="MultiLineString"){const h=ut(o,!0,r);i.trkseg=h.getLineStrings()}const a=t[t.length-1].node,l=wy[a.namespaceURI],u=dl(i,l);Pe(s,vy,zn,u,t,l)}function Gy(n,e,t){const r={node:n};r.geometryLayout=e.getLayout(),r.properties={},Pe(r,Sy,Ty,e.getCoordinates(),t)}function zy(n,e,t){const r=t[0],i=t[t.length-1];i.properties=e.getProperties();const s=e.getGeometry();if(s.getType()=="Point"){const o=ut(s,!0,r);i.geometryLayout=o.getLayout(),Al(n,o.getCoordinates(),t)}}const ky=/^B(\d{2})(\d{2})(\d{2})(\d{2})(\d{5})([NS])(\d{3})(\d{5})([EW])([AV])(\d{5})(\d{5})/,$y=/^H.([A-Z]{3}).*?:(.*)/,jy=/^HFDTE(\d{2})(\d{2})(\d{2})/,Vy=/^HFDTEDATE:(\d{2})(\d{2})(\d{2}),(\d{2})/,Xy=/\r\n|\r|\n/;class Wy extends xf{constructor(e){super(),e=e||{},this.dataProjection=ue("EPSG:4326"),this.altitudeMode_=e.altitudeMode?e.altitudeMode:"none",this.lad_=!1,this.lod_=!1,this.ladStart_=0,this.ladStop_=0,this.lodStart_=0,this.lodStop_=0}readFeatureFromText(e,t){const r=this.altitudeMode_,i=e.split(Xy),s={},o=[];let a=2e3,l=0,u=1,h=-1,c,f;for(c=0,f=i.length;c<f;++c){const m=i[c];let _;if(m.charAt(0)=="B"){if(_=ky.exec(m),_){const y=parseInt(_[1],10),b=parseInt(_[2],10),v=parseInt(_[3],10);let x=parseInt(_[4],10)+parseInt(_[5],10)/6e4;this.lad_&&(x+=parseInt(m.slice(this.ladStart_,this.ladStop_),10)/6e4/10**(this.ladStop_-this.ladStart_)),_[6]=="S"&&(x=-x);let E=parseInt(_[7],10)+parseInt(_[8],10)/6e4;if(this.lod_&&(E+=parseInt(m.slice(this.lodStart_,this.lodStop_),10)/6e4/10**(this.lodStop_-this.lodStart_)),_[9]=="W"&&(E=-E),o.push(E,x),r!="none"){let A;r=="gps"?A=parseInt(_[11],10):r=="barometric"?A=parseInt(_[12],10):A=0,o.push(A)}let S=Date.UTC(a,l,u,y,b,v);S<h&&(S=Date.UTC(a,l,u+1,y,b,v)),o.push(S/1e3),h=S}}else if(m.charAt(0)=="H")_=Vy.exec(m),_?(u=parseInt(_[1],10),l=parseInt(_[2],10)-1,a=2e3+parseInt(_[3],10)):(_=jy.exec(m),_?(u=parseInt(_[1],10),l=parseInt(_[2],10)-1,a=2e3+parseInt(_[3],10)):(_=$y.exec(m),_&&(s[_[1]]=_[2].trim())));else if(m.charAt(0)=="I"){const y=parseInt(m.slice(1,3),10);for(let b=0;b<y;b++){const v=m.slice(7+b*7,10+b*7);if(v==="LAD"||v==="LOD"){const x=parseInt(m.slice(3+b*7,5+b*7),10)-1,E=parseInt(m.slice(5+b*7,7+b*7),10);v==="LAD"?(this.lad_=!0,this.ladStart_=x,this.ladStop_=E):v==="LOD"&&(this.lod_=!0,this.lodStart_=x,this.lodStop_=E)}}}}if(o.length===0)return null;const p=r=="none"?"XYM":"XYZM",d=new yr(o,p),g=new Ft(ut(d,!1,t));return g.setProperties(s,!0),g}readFeaturesFromText(e,t){const r=this.readFeatureFromText(e,t);return r?[r]:[]}}const We={VERSION1:"version1",VERSION2:"version2",VERSION3:"version3"},on={};on[We.VERSION1]={level0:{supports:[],formats:[],qualities:["native"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["native"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["native","color","grey","bitonal"]}};on[We.VERSION2]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByDistortedWh","sizeByWh"],formats:["jpg","png"],qualities:["default","bitonal"]}};on[We.VERSION3]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","regionSquare","sizeByW","sizeByH","sizeByWh"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionSquare","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["default"]}};on.none={none:{supports:[],formats:[],qualities:[]}};const Zy=/^https?:\/\/library\.stanford\.edu\/iiif\/image-api\/(?:1\.1\/)?compliance\.html#level[0-2]$/,ac=/^https?:\/\/iiif\.io\/api\/image\/2\/level[0-2](?:\.json)?$/,qy=/(^https?:\/\/iiif\.io\/api\/image\/3\/level[0-2](?:\.json)?$)|(^level[0-2]$)/;function Hy(n){let e=n.getComplianceLevelSupportedFeatures();return e===void 0&&(e=on[We.VERSION1].level0),{url:n.imageInfo["@id"]===void 0?void 0:n.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),supports:e.supports,formats:[...e.formats,n.imageInfo.formats===void 0?[]:n.imageInfo.formats],qualities:[...e.qualities,n.imageInfo.qualities===void 0?[]:n.imageInfo.qualities],resolutions:n.imageInfo.scale_factors,tileSize:n.imageInfo.tile_width!==void 0?n.imageInfo.tile_height!==void 0?[n.imageInfo.tile_width,n.imageInfo.tile_height]:[n.imageInfo.tile_width,n.imageInfo.tile_width]:n.imageInfo.tile_height!=null?[n.imageInfo.tile_height,n.imageInfo.tile_height]:void 0}}function Yy(n){const e=n.getComplianceLevelSupportedFeatures(),t=Array.isArray(n.imageInfo.profile)&&n.imageInfo.profile.length>1,r=t&&n.imageInfo.profile[1].supports?n.imageInfo.profile[1].supports:[],i=t&&n.imageInfo.profile[1].formats?n.imageInfo.profile[1].formats:[],s=t&&n.imageInfo.profile[1].qualities?n.imageInfo.profile[1].qualities:[];return{url:n.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),sizes:n.imageInfo.sizes===void 0?void 0:n.imageInfo.sizes.map(function(o){return[o.width,o.height]}),tileSize:n.imageInfo.tiles===void 0?void 0:[n.imageInfo.tiles.map(function(o){return o.width})[0],n.imageInfo.tiles.map(function(o){return o.height===void 0?o.width:o.height})[0]],resolutions:n.imageInfo.tiles===void 0?void 0:n.imageInfo.tiles.map(function(o){return o.scaleFactors})[0],supports:[...e.supports,...r],formats:[...e.formats,...i],qualities:[...e.qualities,...s]}}function Ky(n){const e=n.getComplianceLevelSupportedFeatures(),t=n.imageInfo.extraFormats===void 0?e.formats:[...e.formats,...n.imageInfo.extraFormats],r=n.imageInfo.preferredFormats!==void 0&&Array.isArray(n.imageInfo.preferredFormats)&&n.imageInfo.preferredFormats.length>0?n.imageInfo.preferredFormats.filter(function(i){return["jpg","png","gif"].includes(i)}).reduce(function(i,s){return i===void 0&&t.includes(s)?s:i},void 0):void 0;return{url:n.imageInfo.id,sizes:n.imageInfo.sizes===void 0?void 0:n.imageInfo.sizes.map(function(i){return[i.width,i.height]}),tileSize:n.imageInfo.tiles===void 0?void 0:[n.imageInfo.tiles.map(function(i){return i.width})[0],n.imageInfo.tiles.map(function(i){return i.height})[0]],resolutions:n.imageInfo.tiles===void 0?void 0:n.imageInfo.tiles.map(function(i){return i.scaleFactors})[0],supports:n.imageInfo.extraFeatures===void 0?e.supports:[...e.supports,...n.imageInfo.extraFeatures],formats:t,qualities:n.imageInfo.extraQualities===void 0?e.qualities:[...e.qualities,...n.imageInfo.extraQualities],preferredFormat:r}}const ho={};ho[We.VERSION1]=Hy;ho[We.VERSION2]=Yy;ho[We.VERSION3]=Ky;class Jy{constructor(e){this.setImageInfo(e)}setImageInfo(e){typeof e=="string"?this.imageInfo=JSON.parse(e):this.imageInfo=e}getImageApiVersion(){if(this.imageInfo===void 0)return;let e=this.imageInfo["@context"]||"ol-no-context";typeof e=="string"&&(e=[e]);for(let t=0;t<e.length;t++)switch(e[t]){case"http://library.stanford.edu/iiif/image-api/1.1/context.json":case"http://iiif.io/api/image/1/context.json":return We.VERSION1;case"http://iiif.io/api/image/2/context.json":return We.VERSION2;case"http://iiif.io/api/image/3/context.json":return We.VERSION3;case"ol-no-context":if(this.getComplianceLevelEntryFromProfile(We.VERSION1)&&this.imageInfo.identifier)return We.VERSION1;break}Mt(!1,"Cannot determine IIIF Image API version from provided image information JSON")}getComplianceLevelEntryFromProfile(e){if(!(this.imageInfo===void 0||this.imageInfo.profile===void 0))switch(e===void 0&&(e=this.getImageApiVersion()),e){case We.VERSION1:if(Zy.test(this.imageInfo.profile))return this.imageInfo.profile;break;case We.VERSION3:if(qy.test(this.imageInfo.profile))return this.imageInfo.profile;break;case We.VERSION2:if(typeof this.imageInfo.profile=="string"&&ac.test(this.imageInfo.profile))return this.imageInfo.profile;if(Array.isArray(this.imageInfo.profile)&&this.imageInfo.profile.length>0&&typeof this.imageInfo.profile[0]=="string"&&ac.test(this.imageInfo.profile[0]))return this.imageInfo.profile[0];break}}getComplianceLevelFromProfile(e){const t=this.getComplianceLevelEntryFromProfile(e);if(t===void 0)return;const r=t.match(/level[0-2](?:\.json)?$/g);return Array.isArray(r)?r[0].replace(".json",""):void 0}getComplianceLevelSupportedFeatures(){if(this.imageInfo===void 0)return;const e=this.getImageApiVersion(),t=this.getComplianceLevelFromProfile(e);return t===void 0?on.none.none:on[e][t]}getTileSourceOptions(e){const t=e||{},r=this.getImageApiVersion();if(r===void 0)return;const i=r===void 0?void 0:ho[r](this);if(i!==void 0)return{url:i.url,version:r,size:[this.imageInfo.width,this.imageInfo.height],sizes:i.sizes,format:t.format!==void 0&&i.formats.includes(t.format)?t.format:i.preferredFormat!==void 0?i.preferredFormat:"jpg",supports:i.supports,quality:t.quality&&i.qualities.includes(t.quality)?t.quality:i.qualities.includes("native")?"native":"default",resolutions:Array.isArray(i.resolutions)?i.resolutions.sort(function(s,o){return o-s}):void 0,tileSize:i.tileSize}}}class Il{read(e){if(!e)return null;if(typeof e=="string"){const t=Ss(e);return this.readFromDocument(t)}return Rs(e)?this.readFromDocument(e):this.readFromNode(e)}readFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readFromNode(t);return null}readFromNode(e){cl()}}const Qy="http://www.w3.org/1999/xlink";function jn(n){return n.getAttributeNS(Qy,"href")}const mt=[null,"http://www.opengis.net/ows/1.1"],e_=k(mt,{ServiceIdentification:w(T_),ServiceProvider:w(R_),OperationsMetadata:w(w_)});class If extends Il{constructor(){super()}readFromNode(e){const t=B({},e_,e,[]);return t||null}}const t_=k(mt,{DeliveryPoint:w(D),City:w(D),AdministrativeArea:w(D),PostalCode:w(D),Country:w(D),ElectronicMailAddress:w(D)}),r_=k(mt,{Value:we(P_)}),n_=k(mt,{AllowedValues:w(g_)}),i_=k(mt,{Phone:w(v_),Address:w(p_)}),s_=k(mt,{HTTP:w(x_)}),o_=k(mt,{Get:we(b_),Post:void 0}),a_=k(mt,{DCP:w(__)}),l_=k(mt,{Operation:E_}),u_=k(mt,{Voice:w(D),Facsimile:w(D)}),c_=k(mt,{Constraint:we(m_)}),h_=k(mt,{IndividualName:w(D),PositionName:w(D),ContactInfo:w(y_)}),f_=k(mt,{Abstract:w(D),AccessConstraints:w(D),Fees:w(D),Title:w(D),ServiceTypeVersion:w(D),ServiceType:w(D)}),d_=k(mt,{ProviderName:w(D),ProviderSite:w(jn),ServiceContact:w(S_)});function p_(n,e){return B({},t_,n,e)}function g_(n,e){return B({},r_,n,e)}function m_(n,e){const t=n.getAttribute("name");if(t)return B({name:t},n_,n,e)}function y_(n,e){return B({},i_,n,e)}function __(n,e){return B({},s_,n,e)}function b_(n,e){const t=jn(n);if(t)return B({href:t},c_,n,e)}function x_(n,e){return B({},o_,n,e)}function E_(n,e){const t=n.getAttribute("name"),r=B({},a_,n,e);if(!r)return;const i=e[e.length-1];i[t]=r}function w_(n,e){return B({},l_,n,e)}function v_(n,e){return B({},u_,n,e)}function T_(n,e){return B({},f_,n,e)}function S_(n,e){return B({},h_,n,e)}function R_(n,e){return B({},d_,n,e)}function P_(n,e){return D(n)}function lc(n,e,t,r,i,s){i!==void 0?(i=i,s=s!==void 0?s:0):(i=[],s=0);let o=e;for(;o<t;){const a=n[o++];i[s++]=n[o++],i[s++]=a;for(let l=2;l<r;++l)i[s++]=n[o++]}return i.length=s,i}class A_ extends xf{constructor(e){super(),e=e||{},this.dataProjection=ue("EPSG:4326"),this.factor_=e.factor?e.factor:1e5,this.geometryLayout_=e.geometryLayout?e.geometryLayout:"XY"}readFeatureFromText(e,t){const r=this.readGeometryFromText(e,t);return new Ft(r)}readFeaturesFromText(e,t){return[this.readFeatureFromText(e,t)]}readGeometryFromText(e,t){const r=ng(this.geometryLayout_),i=C_(e,r,this.factor_);lc(i,0,i.length,r,i);const s=ig(i,0,i.length,r),o=new yr(s,this.geometryLayout_);return ut(o,!1,this.adaptOptions(t))}writeFeatureText(e,t){const r=e.getGeometry();if(r)return this.writeGeometryText(r,t);throw new Error("Expected `feature` to have a geometry")}writeFeaturesText(e,t){return this.writeFeatureText(e[0],t)}writeGeometryText(e,t){e=ut(e,!0,this.adaptOptions(t));const r=e.getFlatCoordinates(),i=e.getStride();return lc(r,0,r.length,i,r),I_(r,i,this.factor_)}}function I_(n,e,t){t=t||1e5;let r;const i=new Array(e);for(r=0;r<e;++r)i[r]=0;for(let s=0,o=n.length;s<o;)for(r=0;r<e;++r,++s){const a=n[s],l=a-i[r];i[r]=a,n[s]=l}return L_(n,t)}function C_(n,e,t){t=t||1e5;let r;const i=new Array(e);for(r=0;r<e;++r)i[r]=0;const s=F_(n,t);for(let o=0,a=s.length;o<a;)for(r=0;r<e;++r,++o)i[r]+=s[o],s[o]=i[r];return s}function L_(n,e){e=e||1e5;for(let t=0,r=n.length;t<r;++t)n[t]=Math.round(n[t]*e);return M_(n)}function F_(n,e){e=e||1e5;const t=O_(n);for(let r=0,i=t.length;r<i;++r)t[r]/=e;return t}function M_(n){for(let e=0,t=n.length;e<t;++e){const r=n[e];n[e]=r<0?~(r<<1):r<<1}return N_(n)}function O_(n){const e=D_(n);for(let t=0,r=e.length;t<r;++t){const i=e[t];e[t]=i&1?~(i>>1):i>>1}return e}function N_(n){let e="";for(let t=0,r=n.length;t<r;++t)e+=U_(n[t]);return e}function D_(n){const e=[];let t=0,r=0;for(let i=0,s=n.length;i<s;++i){const o=n.charCodeAt(i)-63;t|=(o&31)<<r,o<32?(e.push(t),t=0,r=0):r+=5}return e}function U_(n){let e,t="";for(;n>=32;)e=(32|n&31)+63,t+=String.fromCharCode(e),n>>=5;return e=n+63,t+=String.fromCharCode(e),t}class ge extends O{constructor(e){e=e||{},super(e),this.schemaLocation=e.schemaLocation?e.schemaLocation:this.namespace+" http://schemas.opengis.net/gml/3.2.1/gml.xsd"}writeGeometryElement(e,t,r){const i=r[r.length-1];r[r.length-1]=Object.assign({multiCurve:!0,multiSurface:!0},i),super.writeGeometryElement(e,t,r)}}ge.prototype.namespace="http://www.opengis.net/gml/3.2";ge.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml/3.2":{pos:q(O.prototype.readFlatPos),posList:q(O.prototype.readFlatPosList),coordinates:q(oe.prototype.readFlatCoordinates)}};ge.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml/3.2":{interior:O.prototype.interiorParser,exterior:O.prototype.exteriorParser}};ge.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml/3.2":{Point:q(j.prototype.readPoint),MultiPoint:q(j.prototype.readMultiPoint),LineString:q(j.prototype.readLineString),MultiLineString:q(j.prototype.readMultiLineString),LinearRing:q(j.prototype.readLinearRing),Polygon:q(j.prototype.readPolygon),MultiPolygon:q(j.prototype.readMultiPolygon),Surface:q(ge.prototype.readSurface),MultiSurface:q(O.prototype.readMultiSurface),Curve:q(ge.prototype.readCurve),MultiCurve:q(O.prototype.readMultiCurve),Envelope:q(ge.prototype.readEnvelope)}};ge.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml/3.2":{curveMember:W(O.prototype.curveMemberParser),curveMembers:W(O.prototype.curveMemberParser)}};ge.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{surfaceMember:W(O.prototype.surfaceMemberParser),surfaceMembers:W(O.prototype.surfaceMemberParser)}};ge.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:W(j.prototype.readLineString),Curve:W(O.prototype.readCurve)}};ge.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:W(j.prototype.readPolygon),Surface:W(O.prototype.readSurface)}};ge.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{patches:q(O.prototype.readPatch)}};ge.prototype.CURVE_PARSERS={"http://www.opengis.net/gml/3.2":{segments:q(O.prototype.readSegment)}};ge.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml/3.2":{lowerCorner:W(O.prototype.readFlatPosList),upperCorner:W(O.prototype.readFlatPosList)}};ge.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml/3.2":{PolygonPatch:q(O.prototype.readPolygonPatch)}};ge.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml/3.2":{LineStringSegment:of(O.prototype.readLineStringSegment)}};ge.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml/3.2":{pointMember:W(j.prototype.pointMemberParser),pointMembers:W(j.prototype.pointMemberParser)}};ge.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml/3.2":{lineStringMember:W(j.prototype.lineStringMemberParser),lineStringMembers:W(j.prototype.lineStringMemberParser)}};ge.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml/3.2":{polygonMember:W(j.prototype.polygonMemberParser),polygonMembers:W(j.prototype.polygonMemberParser)}};ge.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Point:W(j.prototype.readFlatCoordinatesFromNode)}};ge.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:W(j.prototype.readLineString)}};ge.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:W(j.prototype.readPolygon)}};ge.prototype.RING_PARSERS={"http://www.opengis.net/gml/3.2":{LinearRing:q(j.prototype.readFlatLinearRing),Ring:q(ge.prototype.readFlatCurveRing)}};ge.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml/3.2":{exterior:T(O.prototype.writeRing),interior:T(O.prototype.writeRing)}};ge.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lowerCorner:T(ae),upperCorner:T(ae)}};ge.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{surfaceMember:T(O.prototype.writeSurfaceOrPolygonMember),polygonMember:T(O.prototype.writeSurfaceOrPolygonMember)}};ge.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{pointMember:T(O.prototype.writePointMember)}};ge.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lineStringMember:T(O.prototype.writeLineStringOrCurveMember),curveMember:T(O.prototype.writeLineStringOrCurveMember)}};ge.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml/3.2":{Curve:T(O.prototype.writeCurveOrLineString),MultiCurve:T(O.prototype.writeMultiCurveOrLineString),Point:T(ge.prototype.writePoint),MultiPoint:T(O.prototype.writeMultiPoint),LineString:T(O.prototype.writeCurveOrLineString),MultiLineString:T(O.prototype.writeMultiCurveOrLineString),LinearRing:T(O.prototype.writeLinearRing),Polygon:T(O.prototype.writeSurfaceOrPolygon),MultiPolygon:T(O.prototype.writeMultiSurfaceOrPolygon),Surface:T(O.prototype.writeSurfaceOrPolygon),MultiSurface:T(O.prototype.writeMultiSurfaceOrPolygon),Envelope:T(O.prototype.writeEnvelope)}};class Cf{constructor(e){this.tagName_=e}getTagName(){return this.tagName_}}class B_ extends Cf{constructor(e,t){super(e),this.conditions=t,Mt(this.conditions.length>=2,"At least 2 conditions are required")}}class G_ extends B_{constructor(e){super("And",Array.prototype.slice.call(arguments))}}class z_ extends Cf{constructor(e,t,r){if(super("BBOX"),this.geometryName=e,this.extent=t,t.length!==4)throw new Error("Expected an extent with four values ([minX, minY, maxX, maxY])");this.srsName=r}}function k_(n){const e=[null].concat(Array.prototype.slice.call(arguments));return new(Function.prototype.bind.apply(G_,e))}function $_(n,e,t){return new z_(n,e,t)}const uc={"http://www.opengis.net/gml":{boundedBy:w(j.prototype.readExtentElement,"bounds")},"http://www.opengis.net/wfs/2.0":{member:W(j.prototype.readFeaturesInternal)}},j_={"http://www.opengis.net/wfs":{totalInserted:w(je),totalUpdated:w(je),totalDeleted:w(je)},"http://www.opengis.net/wfs/2.0":{totalInserted:w(je),totalUpdated:w(je),totalDeleted:w(je)}},V_={"http://www.opengis.net/wfs":{TransactionSummary:w(hc,"transactionSummary"),InsertResults:w(dc,"insertIds")},"http://www.opengis.net/wfs/2.0":{TransactionSummary:w(hc,"transactionSummary"),InsertResults:w(dc,"insertIds")}},X_={"http://www.opengis.net/wfs":{PropertyName:T(ae)},"http://www.opengis.net/wfs/2.0":{PropertyName:T(ae)}},Lf={"http://www.opengis.net/wfs":{Insert:T(pc),Update:T(mc),Delete:T(gc),Property:T(yc),Native:T(_c)},"http://www.opengis.net/wfs/2.0":{Insert:T(pc),Update:T(mc),Delete:T(gc),Property:T(yc),Native:T(_c)}},Ff="feature",Cl="http://www.w3.org/2000/xmlns/",Ll={"2.0.0":"http://www.opengis.net/ogc/1.1","1.1.0":"http://www.opengis.net/ogc","1.0.0":"http://www.opengis.net/ogc"},Ca={"2.0.0":"http://www.opengis.net/wfs/2.0","1.1.0":"http://www.opengis.net/wfs","1.0.0":"http://www.opengis.net/wfs"},Fl={"2.0.0":"http://www.opengis.net/fes/2.0","1.1.0":"http://www.opengis.net/fes","1.0.0":"http://www.opengis.net/fes"},cc={"2.0.0":"http://www.opengis.net/wfs/2.0 http://schemas.opengis.net/wfs/2.0/wfs.xsd","1.1.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd","1.0.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.0.0/wfs.xsd"},Ml={"2.0.0":ge,"1.1.0":O,"1.0.0":oe},W_="1.1.0";class Z_ extends io{constructor(e){super(),e=e||{},this.version_=e.version?e.version:W_,this.featureType_=e.featureType,this.featureNS_=e.featureNS,this.gmlFormat_=e.gmlFormat?e.gmlFormat:new Ml[this.version_],this.schemaLocation_=e.schemaLocation?e.schemaLocation:cc[this.version_]}getFeatureType(){return this.featureType_}setFeatureType(e){this.featureType_=e}readFeaturesFromNode(e,t){const r={node:e};Object.assign(r,{featureType:this.featureType_,featureNS:this.featureNS_}),Object.assign(r,this.getReadOptions(e,t||{}));const i=[r];let s;this.version_==="2.0.0"?s=uc:s=this.gmlFormat_.FEATURE_COLLECTION_PARSERS;let o=B([],s,e,i,this.gmlFormat_);return o||(o=[]),o}readTransactionResponse(e){if(e){if(typeof e=="string"){const t=Ss(e);return this.readTransactionResponseFromDocument(t)}return Rs(e)?this.readTransactionResponseFromDocument(e):this.readTransactionResponseFromNode(e)}}readFeatureCollectionMetadata(e){if(e){if(typeof e=="string"){const t=Ss(e);return this.readFeatureCollectionMetadataFromDocument(t)}return Rs(e)?this.readFeatureCollectionMetadataFromDocument(e):this.readFeatureCollectionMetadataFromNode(e)}}readFeatureCollectionMetadataFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readFeatureCollectionMetadataFromNode(t)}readFeatureCollectionMetadataFromNode(e){const t={},r=Cr(e.getAttribute("numberOfFeatures"));return t.numberOfFeatures=r,B(t,uc,e,[],this.gmlFormat_)}readTransactionResponseFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readTransactionResponseFromNode(t)}readTransactionResponseFromNode(e){return B({},V_,e,[])}writeGetFeature(e){const t=ee(Ca[this.version_],"GetFeature");t.setAttribute("service","WFS"),t.setAttribute("version",this.version_),e.handle&&t.setAttribute("handle",e.handle),e.outputFormat&&t.setAttribute("outputFormat",e.outputFormat),e.maxFeatures!==void 0&&t.setAttribute("maxFeatures",String(e.maxFeatures)),e.resultType&&t.setAttribute("resultType",e.resultType),e.startIndex!==void 0&&t.setAttribute("startIndex",String(e.startIndex)),e.count!==void 0&&t.setAttribute("count",String(e.count)),e.viewParams!==void 0&&t.setAttribute("viewParams",e.viewParams),t.setAttributeNS(Ei,"xsi:schemaLocation",this.schemaLocation_);const r={node:t};if(Object.assign(r,{version:this.version_,srsName:e.srsName,featureNS:e.featureNS?e.featureNS:this.featureNS_,featurePrefix:e.featurePrefix,propertyNames:e.propertyNames?e.propertyNames:[]}),Mt(Array.isArray(e.featureTypes),"`options.featureTypes` must be an Array"),typeof e.featureTypes[0]=="string"){let i=e.filter;e.bbox&&(Mt(e.geometryName,"`options.geometryName` must also be provided when `options.bbox` is set"),i=this.combineBboxAndFilter(e.geometryName,e.bbox,e.srsName,i)),Object.assign(r,{geometryName:e.geometryName,filter:i}),Ac(t,e.featureTypes,[r])}else e.featureTypes.forEach(i=>{const s=this.combineBboxAndFilter(i.geometryName,i.bbox,e.srsName,e.filter);Object.assign(r,{geometryName:i.geometryName,filter:s}),Ac(t,[i.name],[r])});return t}combineBboxAndFilter(e,t,r,i){const s=$_(e,t,r);return i?k_(i,s):s}writeTransaction(e,t,r,i){const s=[],o=i.version?i.version:this.version_,a=ee(Ca[o],"Transaction");a.setAttribute("service","WFS"),a.setAttribute("version",o);let l;i&&(l=i.gmlOptions?i.gmlOptions:{},i.handle&&a.setAttribute("handle",i.handle)),a.setAttributeNS(Ei,"xsi:schemaLocation",cc[o]);const u=q_(a,l,o,i);return e&&rs("Insert",e,s,u),t&&rs("Update",t,s,u),r&&rs("Delete",r,s,u),i.nativeElements&&rs("Native",i.nativeElements,s,u),a}readProjectionFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readProjectionFromNode(t);return null}readProjectionFromNode(e){if(e.firstElementChild&&e.firstElementChild.firstElementChild){e=e.firstElementChild.firstElementChild;for(let t=e.firstElementChild;t;t=t.nextElementSibling)if(!(t.childNodes.length===0||t.childNodes.length===1&&t.firstChild.nodeType===3)){const r=[{}];return this.gmlFormat_.readGeometryElement(t,r),ue(r.pop().srsName)}}return null}}function q_(n,e,t,r){const i=r.featurePrefix?r.featurePrefix:Ff;let s;return t==="1.0.0"?s=2:t==="1.1.0"?s=3:t==="2.0.0"&&(s=3.2),Object.assign({node:n},{version:t,featureNS:r.featureNS,featureType:r.featureType,featurePrefix:i,gmlVersion:s,hasZ:r.hasZ,srsName:r.srsName},e)}function rs(n,e,t,r){Pe(r,Lf,St(n),e,t)}function hc(n,e){return B({},j_,n,e)}const H_={"http://www.opengis.net/ogc":{FeatureId:W(function(n,e){return n.getAttribute("fid")})},"http://www.opengis.net/ogc/1.1":{FeatureId:W(function(n,e){return n.getAttribute("fid")})}};function fc(n,e){Nr(H_,n,e)}const Y_={"http://www.opengis.net/wfs":{Feature:fc},"http://www.opengis.net/wfs/2.0":{Feature:fc}};function dc(n,e){return B([],Y_,n,e)}function pc(n,e,t){const r=t[t.length-1],i=r.featureType,s=r.featureNS,o=r.gmlVersion,a=ee(s,i);n.appendChild(a),o===2?oe.prototype.writeFeatureElement(a,e,t):o===3?O.prototype.writeFeatureElement(a,e,t):ge.prototype.writeFeatureElement(a,e,t)}function Mf(n,e,t){const i=t[t.length-1].version,s=Ll[i],o=ee(s,"Filter"),a=ee(s,"FeatureId");o.appendChild(a),a.setAttribute("fid",e),n.appendChild(o)}function Ol(n,e){n=n||Ff;const t=n+":";return e.startsWith(t)?e:t+e}function gc(n,e,t){const r=t[t.length-1];Mt(e.getId()!==void 0,"Features must have an id set");const i=r.featureType,s=r.featurePrefix,o=r.featureNS,a=Ol(s,i);n.setAttribute("typeName",a),n.setAttributeNS(Cl,"xmlns:"+s,o);const l=e.getId();l!==void 0&&Mf(n,l,t)}function mc(n,e,t){const r=t[t.length-1];Mt(e.getId()!==void 0,"Features must have an id set");const i=r.version,s=r.featureType,o=r.featurePrefix,a=r.featureNS,l=Ol(o,s),u=e.getGeometryName();n.setAttribute("typeName",l),n.setAttributeNS(Cl,"xmlns:"+o,a);const h=e.getId();if(h!==void 0){const c=e.getKeys(),f=[];for(let p=0,d=c.length;p<d;p++){const g=e.get(c[p]);if(g!==void 0){let m=c[p];g&&typeof g.getSimplifiedGeometry=="function"&&(m=u),f.push({name:m,value:g})}}Pe({version:i,gmlVersion:r.gmlVersion,node:n,hasZ:r.hasZ,srsName:r.srsName},Lf,St("Property"),f,t),Mf(n,h,t)}}function yc(n,e,t){const r=t[t.length-1],i=r.version,s=Ca[i],a=ee(s,i==="2.0.0"?"ValueReference":"Name"),l=r.gmlVersion;if(n.appendChild(a),ae(a,e.name),e.value!==void 0&&e.value!==null){const u=ee(s,"Value");n.appendChild(u),e.value&&typeof e.value.getSimplifiedGeometry=="function"?l===2?oe.prototype.writeGeometryElement(u,e.value,t):l===3?O.prototype.writeGeometryElement(u,e.value,t):ge.prototype.writeGeometryElement(u,e.value,t):ae(u,e.value)}}function _c(n,e,t){e.vendorId&&n.setAttribute("vendorId",e.vendorId),e.safeToIgnore!==void 0&&n.setAttribute("safeToIgnore",String(e.safeToIgnore)),e.value!==void 0&&ae(n,e.value)}const fo={"http://www.opengis.net/wfs":{Query:T(bc)},"http://www.opengis.net/wfs/2.0":{Query:T(bc)},"http://www.opengis.net/ogc":{During:T(wc),And:T(ns),Or:T(ns),Not:T(vc),BBOX:T(xc),Contains:T(Pr),Intersects:T(Pr),Within:T(Pr),DWithin:T(Ec),PropertyIsEqualTo:T(At),PropertyIsNotEqualTo:T(At),PropertyIsLessThan:T(At),PropertyIsLessThanOrEqualTo:T(At),PropertyIsGreaterThan:T(At),PropertyIsGreaterThanOrEqualTo:T(At),PropertyIsNull:T(Tc),PropertyIsBetween:T(Sc),PropertyIsLike:T(Rc)},"http://www.opengis.net/fes/2.0":{During:T(wc),And:T(ns),Or:T(ns),Not:T(vc),BBOX:T(xc),Contains:T(Pr),Disjoint:T(Pr),Intersects:T(Pr),ResourceId:T(J_),Within:T(Pr),DWithin:T(Ec),PropertyIsEqualTo:T(At),PropertyIsNotEqualTo:T(At),PropertyIsLessThan:T(At),PropertyIsLessThanOrEqualTo:T(At),PropertyIsGreaterThan:T(At),PropertyIsGreaterThanOrEqualTo:T(At),PropertyIsNull:T(Tc),PropertyIsBetween:T(Sc),PropertyIsLike:T(Rc)}};function bc(n,e,t){const r=t[t.length-1],i=r.version,s=r.featurePrefix,o=r.featureNS,a=r.propertyNames,l=r.srsName;let u;s?u=Ol(s,e):u=e;let h;i==="2.0.0"?h="typeNames":h="typeName",n.setAttribute(h,u),l&&n.setAttribute("srsName",l),o&&n.setAttributeNS(Cl,"xmlns:"+s,o);const c=Object.assign({},r);c.node=n,Pe(c,X_,St("PropertyName"),a,t);const f=r.filter;if(f){const p=ee(po(i),"Filter");n.appendChild(p),K_(p,f,t)}}function K_(n,e,t){const r=t[t.length-1],i={node:n};Object.assign(i,{context:r}),Pe(i,fo,St(e.getTagName()),[e],t)}function xc(n,e,t){const r=t[t.length-1],s=r.context.version;r.srsName=e.srsName;const o=Ml[s];Vn(s,n,e.geometryName),o.prototype.writeGeometryElement(n,e.extent,t)}function J_(n,e,t){n.setAttribute("rid",e.rid)}function Pr(n,e,t){const r=t[t.length-1],s=r.context.version;r.srsName=e.srsName;const o=Ml[s];Vn(s,n,e.geometryName),o.prototype.writeGeometryElement(n,e.geometry,t)}function Ec(n,e,t){const s=t[t.length-1].context.version;Pr(n,e,t);const o=ee(po(s),"Distance");ae(o,e.distance.toString()),s==="2.0.0"?o.setAttribute("uom",e.unit):o.setAttribute("units",e.unit),n.appendChild(o)}function wc(n,e,t){const s=t[t.length-1].context.version;Ls(Fl[s],"ValueReference",n,e.propertyName);const o=ee(gr,"TimePeriod");n.appendChild(o);const a=ee(gr,"begin");o.appendChild(a),Pc(a,e.begin);const l=ee(gr,"end");o.appendChild(l),Pc(l,e.end)}function ns(n,e,t){const i=t[t.length-1].context,s={node:n};Object.assign(s,{context:i});const o=e.conditions;for(let a=0,l=o.length;a<l;++a){const u=o[a];Pe(s,fo,St(u.getTagName()),[u],t)}}function vc(n,e,t){const i=t[t.length-1].context,s={node:n};Object.assign(s,{context:i});const o=e.condition;Pe(s,fo,St(o.getTagName()),[o],t)}function At(n,e,t){const s=t[t.length-1].context.version;e.matchCase!==void 0&&n.setAttribute("matchCase",e.matchCase.toString()),Vn(s,n,e.propertyName),Fs(s,n,""+e.expression)}function Tc(n,e,t){const s=t[t.length-1].context.version;Vn(s,n,e.propertyName)}function Sc(n,e,t){const s=t[t.length-1].context.version,o=po(s);Vn(s,n,e.propertyName);const a=ee(o,"LowerBoundary");n.appendChild(a),Fs(s,a,""+e.lowerBoundary);const l=ee(o,"UpperBoundary");n.appendChild(l),Fs(s,l,""+e.upperBoundary)}function Rc(n,e,t){const s=t[t.length-1].context.version;n.setAttribute("wildCard",e.wildCard),n.setAttribute("singleChar",e.singleChar),n.setAttribute("escapeChar",e.escapeChar),e.matchCase!==void 0&&n.setAttribute("matchCase",e.matchCase.toString()),Vn(s,n,e.propertyName),Fs(s,n,""+e.pattern)}function Ls(n,e,t,r){const i=ee(n,e);ae(i,r),t.appendChild(i)}function Fs(n,e,t){Ls(po(n),"Literal",e,t)}function Vn(n,e,t){n==="2.0.0"?Ls(Fl[n],"ValueReference",e,t):Ls(Ll[n],"PropertyName",e,t)}function Pc(n,e){const t=ee(gr,"TimeInstant");n.appendChild(t);const r=ee(gr,"timePosition");t.appendChild(r),ae(r,e)}function Ac(n,e,t){const r=t[t.length-1],i=Object.assign({},r);i.node=n,Pe(i,fo,St("Query"),e,t)}function po(n){let e;return n==="2.0.0"?e=Fl[n]:e=Ll[n],e}const Te={POINT:1,LINE_STRING:2,POLYGON:3,MULTI_POINT:4,MULTI_LINE_STRING:5,MULTI_POLYGON:6,GEOMETRY_COLLECTION:7,POLYHEDRAL_SURFACE:15,TIN:16,TRIANGLE:17};class Ic{constructor(e){this.view_=e,this.pos_=0,this.initialized_=!1,this.isLittleEndian_=!1,this.hasZ_=!1,this.hasM_=!1,this.srid_=null,this.layout_="XY"}readUint8(){return this.view_.getUint8(this.pos_++)}readUint32(e){return this.view_.getUint32((this.pos_+=4)-4,e!==void 0?e:this.isLittleEndian_)}readDouble(e){return this.view_.getFloat64((this.pos_+=8)-8,e!==void 0?e:this.isLittleEndian_)}readPoint(){const e=[];return e.push(this.readDouble()),e.push(this.readDouble()),this.hasZ_&&e.push(this.readDouble()),this.hasM_&&e.push(this.readDouble()),e}readLineString(){const e=this.readUint32(),t=[];for(let r=0;r<e;r++)t.push(this.readPoint());return t}readPolygon(){const e=this.readUint32(),t=[];for(let r=0;r<e;r++)t.push(this.readLineString());return t}readWkbHeader(e){const r=this.readUint8()>0,i=this.readUint32(r),s=Math.floor((i&268435455)/1e3),o=!!(i&2147483648)||s===1||s===3,a=!!(i&1073741824)||s===2||s===3,l=!!(i&536870912),u=(i&268435455)%1e3,h=["XY",o?"Z":"",a?"M":""].join(""),c=l?this.readUint32(r):null;if(e!==void 0&&e!==u)throw new Error("Unexpected WKB geometry type "+u);if(this.initialized_){if(this.isLittleEndian_!==r)throw new Error("Inconsistent endian");if(this.layout_!==h)throw new Error("Inconsistent geometry layout");if(c&&this.srid_!==c)throw new Error("Inconsistent coordinate system (SRID)")}else this.isLittleEndian_=r,this.hasZ_=o,this.hasM_=a,this.layout_=h,this.srid_=c,this.initialized_=!0;return u}readWkbPayload(e){switch(e){case Te.POINT:return this.readPoint();case Te.LINE_STRING:return this.readLineString();case Te.POLYGON:case Te.TRIANGLE:return this.readPolygon();case Te.MULTI_POINT:return this.readMultiPoint();case Te.MULTI_LINE_STRING:return this.readMultiLineString();case Te.MULTI_POLYGON:case Te.POLYHEDRAL_SURFACE:case Te.TIN:return this.readMultiPolygon();case Te.GEOMETRY_COLLECTION:return this.readGeometryCollection();default:throw new Error("Unsupported WKB geometry type "+e+" is found")}}readWkbBlock(e){return this.readWkbPayload(this.readWkbHeader(e))}readWkbCollection(e,t){const r=this.readUint32(),i=[];for(let s=0;s<r;s++){const o=e.call(this,t);o&&i.push(o)}return i}readMultiPoint(){return this.readWkbCollection(this.readWkbBlock,Te.POINT)}readMultiLineString(){return this.readWkbCollection(this.readWkbBlock,Te.LINE_STRING)}readMultiPolygon(){return this.readWkbCollection(this.readWkbBlock,Te.POLYGON)}readGeometryCollection(){return this.readWkbCollection(this.readGeometry)}readGeometry(){const e=this.readWkbHeader(),t=this.readWkbPayload(e);switch(e){case Te.POINT:return new zt(t,this.layout_);case Te.LINE_STRING:return new yr(t,this.layout_);case Te.POLYGON:case Te.TRIANGLE:return new Cn(t,this.layout_);case Te.MULTI_POINT:return new sl(t,this.layout_);case Te.MULTI_LINE_STRING:return new Mi(t,this.layout_);case Te.MULTI_POLYGON:case Te.POLYHEDRAL_SURFACE:case Te.TIN:return new ro(t,this.layout_);case Te.GEOMETRY_COLLECTION:return new gi(t);default:return null}}getSrid(){return this.srid_}}class Q_{constructor(e){e=e||{},this.layout_=e.layout,this.isLittleEndian_=e.littleEndian!==!1,this.isEWKB_=e.ewkb!==!1,this.writeQueue_=[],this.nodata_=Object.assign({X:0,Y:0,Z:0,M:0},e.nodata)}writeUint8(e){this.writeQueue_.push([1,e])}writeUint32(e){this.writeQueue_.push([4,e])}writeDouble(e){this.writeQueue_.push([8,e])}writePoint(e,t){const r=Object.assign.apply(null,t.split("").map((i,s)=>({[i]:e[s]})));for(const i of this.layout_)this.writeDouble(i in r?r[i]:this.nodata_[i])}writeLineString(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writePoint(e[r],t)}writePolygon(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeLineString(e[r],t)}writeWkbHeader(e,t){e%=1e3,this.layout_.includes("Z")&&(e+=this.isEWKB_?2147483648:1e3),this.layout_.includes("M")&&(e+=this.isEWKB_?1073741824:2e3),this.isEWKB_&&Number.isInteger(t)&&(e|=536870912),this.writeUint8(this.isLittleEndian_?1:0),this.writeUint32(e),this.isEWKB_&&Number.isInteger(t)&&this.writeUint32(t)}writeMultiPoint(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(1),this.writePoint(e[r],t)}writeMultiLineString(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(2),this.writeLineString(e[r],t)}writeMultiPolygon(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(3),this.writePolygon(e[r],t)}writeGeometryCollection(e){this.writeUint32(e.length);for(let t=0;t<e.length;t++)this.writeGeometry(e[t])}findMinimumLayout(e,t="XYZM"){const r=(i,s)=>i===s?i:i==="XYZM"?s:s==="XYZM"?i:"XY";if(e instanceof Zu)return r(e.getLayout(),t);if(e instanceof gi){const i=e.getGeometriesArray();for(let s=0;s<i.length&&t!=="XY";s++)t=this.findMinimumLayout(i[s],t)}return t}writeGeometry(e,t){const r={Point:Te.POINT,LineString:Te.LINE_STRING,Polygon:Te.POLYGON,MultiPoint:Te.MULTI_POINT,MultiLineString:Te.MULTI_LINE_STRING,MultiPolygon:Te.MULTI_POLYGON,GeometryCollection:Te.GEOMETRY_COLLECTION},i=e.getType(),s=r[i];if(!s)throw new Error("GeometryType "+i+" is not supported");this.layout_||(this.layout_=this.findMinimumLayout(e)),this.writeWkbHeader(s,t),e instanceof Zu?{Point:this.writePoint,LineString:this.writeLineString,Polygon:this.writePolygon,MultiPoint:this.writeMultiPoint,MultiLineString:this.writeMultiLineString,MultiPolygon:this.writeMultiPolygon}[i].call(this,e.getCoordinates(),e.getLayout()):e instanceof gi&&this.writeGeometryCollection(e.getGeometriesArray())}getBuffer(){const e=this.writeQueue_.reduce((s,o)=>s+o[0],0),t=new ArrayBuffer(e),r=new DataView(t);let i=0;return this.writeQueue_.forEach(s=>{switch(s[0]){case 1:r.setUint8(i,s[1]);break;case 4:r.setUint32(i,s[1],this.isLittleEndian_);break;case 8:r.setFloat64(i,s[1],this.isLittleEndian_);break}i+=s[0]}),t}}class e0 extends sg{constructor(e){super(),e=e||{},this.splitCollection=!!e.splitCollection,this.viewCache_=null,this.hex_=e.hex!==!1,this.littleEndian_=e.littleEndian!==!1,this.ewkb_=e.ewkb!==!1,this.layout_=e.geometryLayout,this.nodataZ_=e.nodataZ||0,this.nodataM_=e.nodataM||0,this.srid_=e.srid}getType(){return this.hex_?"text":"arraybuffer"}readFeature(e,t){return new Ft({geometry:this.readGeometry(e,t)})}readFeatures(e,t){let r=[];const i=this.readGeometry(e,t);return this.splitCollection&&i instanceof gi?r=i.getGeometriesArray():r=[i],r.map(s=>new Ft({geometry:s}))}readGeometry(e,t){const r=Cc(e);if(!r)return null;const s=new Ic(r).readGeometry();return this.viewCache_=r,t=this.getReadOptions(e,t),this.viewCache_=null,ut(s,!1,t)}readProjection(e){const t=this.viewCache_||Cc(e);if(!t)return;const r=new Ic(t);return r.readWkbHeader(),r.getSrid()&&ue("EPSG:"+r.getSrid())||void 0}writeFeature(e,t){return this.writeGeometry(e.getGeometry(),t)}writeFeatures(e,t){return this.writeGeometry(new gi(e.map(r=>r.getGeometry())),t)}writeGeometry(e,t){t=this.adaptOptions(t);const r=new Q_({layout:this.layout_,littleEndian:this.littleEndian_,ewkb:this.ewkb_,nodata:{Z:this.nodataZ_,M:this.nodataM_}});let i=Number.isInteger(this.srid_)?Number(this.srid_):null;if(this.srid_!==!1&&!Number.isInteger(this.srid_)){const o=t.dataProjection&&ue(t.dataProjection);if(o){const a=o.getCode();a.startsWith("EPSG:")&&(i=Number(a.substring(5)))}}r.writeGeometry(ut(e,!0,t),i);const s=r.getBuffer();return this.hex_?t0(s):s}}function t0(n){const e=new Uint8Array(n);return Array.from(e.values()).map(t=>(t<16?"0":"")+Number(t).toString(16).toUpperCase()).join("")}function r0(n){const e=new Uint8Array(n.length/2);for(let t=0;t<n.length/2;t++)e[t]=parseInt(n.substr(t*2,2),16);return new DataView(e.buffer)}function Cc(n){return typeof n=="string"?r0(n):ArrayBuffer.isView(n)?n instanceof DataView?n:new DataView(n.buffer,n.byteOffset,n.byteLength):n instanceof ArrayBuffer?new DataView(n):null}const He=[null,"http://www.opengis.net/wms","http://www.opengis.net/sld"];function ki(n){return og(n[0].version,"1.3")>=0}const n0=k(He,{Service:w(S0),Capability:w(T0)}),i0=k(He,{Request:w(O0),Exception:w(I0),Layer:w(C0),UserDefinedSymbolization:w(w0)});class s0 extends Il{constructor(){super(),this.version=void 0}readFromNode(e){this.version=e.getAttribute("version").trim();const t=B({version:this.version},n0,e,[]);return t||null}}const Of={Name:w(D),Title:w(D),Abstract:w(D),KeywordList:w(zf),OnlineResource:w(jn),ContactInformation:w(R0),Fees:w(D),AccessConstraints:w(D)},o0=k(He,Of),a0=k(He,{...Of,LayerLimit:w(je),MaxWidth:w(je),MaxHeight:w(je)}),l0=k(He,{ContactPersonPrimary:w(P0),ContactPosition:w(D),ContactAddress:w(A0),ContactVoiceTelephone:w(D),ContactFacsimileTelephone:w(D),ContactElectronicMailAddress:w(D)}),u0=k(He,{ContactPerson:w(D),ContactOrganization:w(D)}),c0=k(He,{AddressType:w(D),Address:w(D),City:w(D),StateOrProvince:w(D),PostCode:w(D),Country:w(D)}),h0=k(He,{Format:W(D)}),Nf={Name:w(D),Title:w(D),Abstract:w(D),KeywordList:w(zf),BoundingBox:we(Bf),Dimension:we(L0),Attribution:w(E0),AuthorityURL:we(U0),Identifier:we(D),MetadataURL:we(B0),DataURL:we(br),FeatureListURL:we(br),Style:we(G0),Layer:we(go)},Df=k(He,{...Nf,SRS:we(D),Extent:w(F0),ScaleHint:we(M0),LatLonBoundingBox:w((n,e)=>Bf(n,e,!1)),Layer:we(go)}),Uf=k(He,{...Nf,CRS:we(D),EX_GeographicBoundingBox:w(v0),MinScaleDenominator:w(lt),MaxScaleDenominator:w(lt),Layer:we(go)}),f0=k(He,{Title:w(D),OnlineResource:w(jn),LogoURL:w(Gf)}),d0=k(He,{westBoundLongitude:w(lt),eastBoundLongitude:w(lt),southBoundLatitude:w(lt),northBoundLatitude:w(lt)}),p0=k(He,{GetCapabilities:w(ti),GetMap:w(ti),GetFeatureInfo:w(ti),DescribeLayer:w(ti),GetLegendGraphic:w(ti)}),g0=k(He,{Format:we(D),DCPType:we(N0)}),m0=k(He,{HTTP:w(D0)}),y0=k(He,{Get:w(br),Post:w(br)}),_0=k(He,{Name:w(D),Title:w(D),Abstract:w(D),LegendURL:we(Gf),StyleSheetURL:w(br),StyleURL:w(br)}),b0=k(He,{Format:w(D),OnlineResource:w(jn)}),x0=k(He,{Keyword:W(D)});function E0(n,e){return B({},f0,n,e)}function w0(n,e){return{SupportSLD:!!bt(n.getAttribute("SupportSLD")),UserLayer:!!bt(n.getAttribute("UserLayer")),UserStyle:!!bt(n.getAttribute("UserStyle")),RemoteWFS:!!bt(n.getAttribute("RemoteWFS")),InlineFeatureData:!!bt(n.getAttribute("InlineFeatureData")),RemoteWCS:!!bt(n.getAttribute("RemoteWCS"))}}function Bf(n,e,t=!0){const r=[Qt(n.getAttribute("minx")),Qt(n.getAttribute("miny")),Qt(n.getAttribute("maxx")),Qt(n.getAttribute("maxy"))],i=[Qt(n.getAttribute("resx")),Qt(n.getAttribute("resy"))],s={extent:r,res:i};return t&&(ki(e)?s.crs=n.getAttribute("CRS"):s.srs=n.getAttribute("SRS")),s}function v0(n,e){const t=B({},d0,n,e);if(!t)return;const r=t.westBoundLongitude,i=t.southBoundLatitude,s=t.eastBoundLongitude,o=t.northBoundLatitude;if(!(r===void 0||i===void 0||s===void 0||o===void 0))return[r,i,s,o]}function T0(n,e){return B({},i0,n,e)}function S0(n,e){return B({},ki(e)?a0:o0,n,e)}function R0(n,e){return B({},l0,n,e)}function P0(n,e){return B({},u0,n,e)}function A0(n,e){return B({},c0,n,e)}function I0(n,e){return B([],h0,n,e)}function C0(n,e){const t=B({},ki(e)?Uf:Df,n,e);return t.Layer===void 0?Object.assign(t,go(n,e)):t}function go(n,e){const t=ki(e),r=e[e.length-1],i=B({},t?Uf:Df,n,e);if(!i)return;let s=bt(n.getAttribute("queryable"));s===void 0&&(s=r.queryable),i.queryable=s!==void 0?s:!1;let o=Cr(n.getAttribute("cascaded"));o===void 0&&(o=r.cascaded),i.cascaded=o;let a=bt(n.getAttribute("opaque"));a===void 0&&(a=r.opaque),i.opaque=a!==void 0?a:!1;let l=bt(n.getAttribute("noSubsets"));l===void 0&&(l=r.noSubsets),i.noSubsets=l!==void 0?l:!1;let u=Qt(n.getAttribute("fixedWidth"));u||(u=r.fixedWidth),i.fixedWidth=u;let h=Qt(n.getAttribute("fixedHeight"));h||(h=r.fixedHeight),i.fixedHeight=h;const c=["Style","AuthorityURL"];t?c.push("CRS"):c.push("SRS","Dimension"),c.forEach(function(p){if(p in r){const d=i[p]||[];i[p]=d.concat(r[p])}});const f=["BoundingBox","Attribution"];return t?f.push("Dimension","EX_GeographicBoundingBox","MinScaleDenominator","MaxScaleDenominator"):f.push("LatLonBoundingBox","ScaleHint","Extent"),f.forEach(function(p){if(!(p in i)){const d=r[p];i[p]=d}}),i}function L0(n,e){const t={name:n.getAttribute("name"),units:n.getAttribute("units"),unitSymbol:n.getAttribute("unitSymbol")};return ki(e)&&Object.assign(t,{default:n.getAttribute("default"),multipleValues:bt(n.getAttribute("multipleValues")),nearestValue:bt(n.getAttribute("nearestValue")),current:bt(n.getAttribute("current")),values:D(n)}),t}function F0(n,e){return{name:n.getAttribute("name"),default:n.getAttribute("default"),nearestValue:bt(n.getAttribute("nearestValue"))}}function M0(n,e){return{min:Qt(n.getAttribute("min")),max:Qt(n.getAttribute("max"))}}function br(n,e){return B({},b0,n,e)}function O0(n,e){return B({},p0,n,e)}function N0(n,e){return B({},m0,n,e)}function D0(n,e){return B({},y0,n,e)}function ti(n,e){return B({},g0,n,e)}function Gf(n,e){const t=br(n,e);if(t){const r=[Cr(n.getAttribute("width")),Cr(n.getAttribute("height"))];return t.size=r,t}}function U0(n,e){const t=br(n,e);if(t)return t.name=n.getAttribute("name"),t}function B0(n,e){const t=br(n,e);if(t)return t.type=n.getAttribute("type"),t}function G0(n,e){return B({},_0,n,e)}function zf(n,e){return B([],x0,n,e)}const z0="_feature",k0="_layer";class $0 extends io{constructor(e){super(),e=e||{},this.featureNS_="http://mapserver.gis.umn.edu/mapserver",this.gmlFormat_=new oe,this.layers_=e.layers?e.layers:null}getLayers(){return this.layers_}setLayers(e){this.layers_=e}readFeatures_(e,t){e.setAttribute("namespaceURI",this.featureNS_);const r=e.localName;let i=[];if(e.childNodes.length===0)return i;if(r=="msGMLOutput")for(let s=0,o=e.childNodes.length;s<o;s++){const a=e.childNodes[s];if(a.nodeType!==Node.ELEMENT_NODE)continue;const l=a,u=t[0],h=k0,c=l.localName.replace(h,"");if(this.layers_&&!this.layers_.includes(c))continue;const f=c+z0;u.featureType=f,u.featureNS=this.featureNS_;const p={};p[f]=W(this.gmlFormat_.readFeatureElement,this.gmlFormat_);const d=k([u.featureNS,null],p);l.setAttribute("namespaceURI",this.featureNS_);const g=B([],d,l,t,this.gmlFormat_);g&&Es(i,g)}if(r=="FeatureCollection"){const s=B([],this.gmlFormat_.FEATURE_COLLECTION_PARSERS,e,[{}],this.gmlFormat_);s&&(i=s)}return i}readFeaturesFromNode(e,t){const r={};return t&&Object.assign(r,this.getReadOptions(e,t)),this.readFeatures_(e,[r])}}const ur=[null,"http://www.opengis.net/wmts/1.0"],Xn=[null,"http://www.opengis.net/ows/1.1"],j0=k(ur,{Contents:w(Q0)});let Nl=class extends Il{constructor(){super(),this.owsParser_=new If}readFromNode(e){let t=e.getAttribute("version");t&&(t=t.trim());let r=this.owsParser_.readFromNode(e);return r?(r.version=t,r=B(r,j0,e,[]),r||null):null}};const V0=k(ur,{Layer:we(eb),TileMatrixSet:we(tb)}),X0=k(ur,{Style:we(rb),Format:we(D),TileMatrixSetLink:we(nb),Dimension:we(ib),ResourceURL:we(sb)},k(Xn,{Title:w(D),Abstract:w(D),WGS84BoundingBox:w($f),BoundingBox:we(ob),Identifier:w(D)})),W0=k(ur,{LegendURL:we(ab)},k(Xn,{Title:w(D),Identifier:w(D)})),Z0=k(ur,{TileMatrixSet:w(D),TileMatrixSetLimits:w(ub)}),q0=k(ur,{TileMatrixLimits:W(cb)}),H0=k(ur,{TileMatrix:w(D),MinTileRow:w(je),MaxTileRow:w(je),MinTileCol:w(je),MaxTileCol:w(je)}),Y0=k(ur,{Default:w(D),Value:we(D)},k(Xn,{Identifier:w(D)})),kf=k(Xn,{LowerCorner:W(La),UpperCorner:W(La)}),K0=k(ur,{WellKnownScaleSet:w(D),TileMatrix:we(lb)},k(Xn,{SupportedCRS:w(D),Identifier:w(D),BoundingBox:w($f)})),J0=k(ur,{TopLeftCorner:w(La),ScaleDenominator:w(lt),TileWidth:w(je),TileHeight:w(je),MatrixWidth:w(je),MatrixHeight:w(je)},k(Xn,{Identifier:w(D)}));function Q0(n,e){return B({},V0,n,e)}function eb(n,e){return B({},X0,n,e)}function tb(n,e){return B({},K0,n,e)}function rb(n,e){const t=B({},W0,n,e);if(!t)return;const r=n.getAttribute("isDefault")==="true";return t.isDefault=r,t}function nb(n,e){return B({},Z0,n,e)}function ib(n,e){return B({},Y0,n,e)}function sb(n,e){const t=n.getAttribute("format"),r=n.getAttribute("template"),i=n.getAttribute("resourceType"),s={};return t&&(s.format=t),r&&(s.template=r),i&&(s.resourceType=i),s}function $f(n,e){const t=B([],kf,n,e);if(t.length==2)return hl(t)}function ob(n,e){const t=n.getAttribute("crs"),r=B([],kf,n,e);if(r.length==2)return{extent:hl(r),crs:t}}function ab(n,e){const t={};return t.format=n.getAttribute("format"),t.href=jn(n),t}function La(n,e){const t=D(n).split(/\s+/);if(!t||t.length!=2)return;const r=+t[0],i=+t[1];if(!(isNaN(r)||isNaN(i)))return[r,i]}function lb(n,e){return B({},J0,n,e)}function ub(n,e){return B([],q0,n,e)}function cb(n,e){return B({},H0,n,e)}window.eoxMapAdvancedOlFormats={EsriJSON:Um,GML:Tl,GPX:cy,IGC:Wy,IIIFInfo:Jy,KML:Ug,OWS:If,Polyline:A_,TopoJSON:Dg,WFS:Z_,WKB:e0,WKT:Rm,WMSCapabilities:s0,WMSGetFeatureInfo:$0,WMTSCapabilities:Nl};function jf(n,e,t){const r=[];let i=n(0),s=n(1),o=e(i),a=e(s);const l=[s,i],u=[a,o],h=[1,0],c={};let f=1e5,p,d,g,m,_,y;for(;--f>0&&h.length>0;)g=h.pop(),i=l.pop(),o=u.pop(),y=g.toString(),y in c||(r.push(o[0],o[1]),c[y]=!0),m=h.pop(),s=l.pop(),a=u.pop(),_=(g+m)/2,p=n(_),d=e(p),bg(d[0],d[1],o[0],o[1],a[0],a[1])<t?(r.push(a[0],a[1]),y=m.toString(),c[y]=!0):(h.push(m,_,_,g),u.push(a,d,d,o),l.push(s,p,p,i));return r}function hb(n,e,t,r,i){const s=ue("EPSG:4326");return jf(function(o){return[n,e+(t-e)*o]},_s(s,r),i)}function fb(n,e,t,r,i){const s=ue("EPSG:4326");return jf(function(o){return[e+(t-e)*o,n]},_s(s,r),i)}function db(n){if(!(n.context instanceof CanvasRenderingContext2D))throw new Error("Only works for render events from Canvas 2D layers");const e=n.inversePixelTransform[0],t=n.inversePixelTransform[1],r=Math.sqrt(e*e+t*t),i=n.frameState,s=mi(n.inversePixelTransform.slice(),i.coordinateToPixelTransform),o=Bg(i.viewState.resolution,r);let a;return new Gg(n.context,r,i.extent,s,i.viewState.rotation,o,a)}const pb=new Lr({color:"rgba(0,0,0,0.2)"}),gb=[90,45,30,20,10,5,2,1,30/60,20/60,10/60,5/60,2/60,1/60,30/3600,20/3600,10/3600,5/3600,2/3600,1/3600];class mb extends Ni{constructor(e){e=e||{};const t=Object.assign({updateWhileAnimating:!0,updateWhileInteracting:!0,renderBuffer:0},e);delete t.maxLines,delete t.strokeStyle,delete t.targetSize,delete t.showLabels,delete t.lonLabelFormatter,delete t.latLabelFormatter,delete t.lonLabelPosition,delete t.latLabelPosition,delete t.lonLabelStyle,delete t.latLabelStyle,delete t.intervals,super(t),this.projection_=null,this.maxLat_=1/0,this.maxLon_=1/0,this.minLat_=-1/0,this.minLon_=-1/0,this.maxX_=1/0,this.maxY_=1/0,this.minX_=-1/0,this.minY_=-1/0,this.targetSize_=e.targetSize!==void 0?e.targetSize:100,this.maxLines_=e.maxLines!==void 0?e.maxLines:100,this.meridians_=[],this.parallels_=[],this.strokeStyle_=e.strokeStyle!==void 0?e.strokeStyle:pb,this.fromLonLatTransform_=void 0,this.toLonLatTransform_=void 0,this.projectionCenterLonLat_=null,this.bottomLeft_=null,this.bottomRight_=null,this.topLeft_=null,this.topRight_=null,this.meridiansLabels_=null,this.parallelsLabels_=null,e.showLabels&&(this.lonLabelFormatter_=e.lonLabelFormatter==null?qu.bind(this,"EW"):e.lonLabelFormatter,this.latLabelFormatter_=e.latLabelFormatter==null?qu.bind(this,"NS"):e.latLabelFormatter,this.lonLabelPosition_=e.lonLabelPosition==null?0:e.lonLabelPosition,this.latLabelPosition_=e.latLabelPosition==null?1:e.latLabelPosition,this.lonLabelStyleBase_=new er({text:e.lonLabelStyle!==void 0?e.lonLabelStyle.clone():new Ta({font:"12px Calibri,sans-serif",textBaseline:"bottom",fill:new Fr({color:"rgba(0,0,0,1)"}),stroke:new Lr({color:"rgba(255,255,255,1)",width:3})})}),this.lonLabelStyle_=r=>{const i=r.get("graticule_label");return this.lonLabelStyleBase_.getText().setText(i),this.lonLabelStyleBase_},this.latLabelStyleBase_=new er({text:e.latLabelStyle!==void 0?e.latLabelStyle.clone():new Ta({font:"12px Calibri,sans-serif",textAlign:"right",fill:new Fr({color:"rgba(0,0,0,1)"}),stroke:new Lr({color:"rgba(255,255,255,1)",width:3})})}),this.latLabelStyle_=r=>{const i=r.get("graticule_label");return this.latLabelStyleBase_.getText().setText(i),this.latLabelStyleBase_},this.meridiansLabels_=[],this.parallelsLabels_=[],this.addEventListener(Hr.POSTRENDER,this.drawLabels_.bind(this))),this.intervals_=e.intervals!==void 0?e.intervals:gb,this.setSource(new Dr({loader:this.loaderFunction.bind(this),strategy:this.strategyFunction.bind(this),features:new Pm,overlaps:!1,useSpatialIndex:!1,wrapX:e.wrapX})),this.featurePool_=[],this.lineStyle_=new er({stroke:this.strokeStyle_}),this.loadedExtent_=null,this.renderedExtent_=null,this.renderedResolution_=null,this.setRenderOrder(null)}strategyFunction(e,t){let r=e.slice();return this.projection_&&this.getSource().getWrapX()&&xg(r,this.projection_),this.loadedExtent_&&(Eg(this.loadedExtent_,r,t)?r=this.loadedExtent_.slice():this.getSource().removeLoadedExtent(this.loadedExtent_)),[r]}loaderFunction(e,t,r){this.loadedExtent_=e;const i=this.getSource(),s=this.getExtent()||[-1/0,-1/0,1/0,1/0],o=rr(s,e);if(this.renderedExtent_&&bi(this.renderedExtent_,o)&&this.renderedResolution_===t||(this.renderedExtent_=o,this.renderedResolution_=t,no(o)))return;const a=nr(o),l=t*t/4;(!this.projection_||!li(this.projection_,r))&&this.updateProjectionInfo_(r),this.createGraticule_(o,a,t,l);let h=this.meridians_.length+this.parallels_.length;this.meridiansLabels_&&(h+=this.meridians_.length),this.parallelsLabels_&&(h+=this.parallels_.length);let c;for(;h>this.featurePool_.length;)c=new Ft,this.featurePool_.push(c);const f=i.getFeaturesCollection();f.clear();let p=0,d,g;for(d=0,g=this.meridians_.length;d<g;++d)c=this.featurePool_[p++],c.setGeometry(this.meridians_[d]),c.setStyle(this.lineStyle_),f.push(c);for(d=0,g=this.parallels_.length;d<g;++d)c=this.featurePool_[p++],c.setGeometry(this.parallels_[d]),c.setStyle(this.lineStyle_),f.push(c)}addMeridian_(e,t,r,i,s,o){const a=this.getMeridian_(e,t,r,i,o);if(Ln(a.getExtent(),s)){if(this.meridiansLabels_){const l=this.lonLabelFormatter_(e);o in this.meridiansLabels_?this.meridiansLabels_[o].text=l:this.meridiansLabels_[o]={geom:new zt([]),text:l}}this.meridians_[o++]=a}return o}addParallel_(e,t,r,i,s,o){const a=this.getParallel_(e,t,r,i,o);if(Ln(a.getExtent(),s)){if(this.parallelsLabels_){const l=this.latLabelFormatter_(e);o in this.parallelsLabels_?this.parallelsLabels_[o].text=l:this.parallelsLabels_[o]={geom:new zt([]),text:l}}this.parallels_[o++]=a}return o}drawLabels_(e){const t=e.frameState.viewState.rotation,r=e.frameState.viewState.resolution,i=e.frameState.size,s=e.frameState.extent,o=nr(s);let a=s;if(t){const d=i[0]*r,g=i[1]*r;a=[o[0]-d/2,o[1]-g/2,o[0]+d/2,o[1]+g/2]}let l=0,u=0,h=this.latLabelPosition_<.5;const c=this.projection_.getExtent(),f=it(c);if(this.getSource().getWrapX()&&this.projection_.canWrapX()&&!xs(c,s)){l=Math.floor((s[0]-c[0])/f),u=Math.ceil((s[2]-c[2])/f);const d=Math.abs(t)>Math.PI/2;h=h!==d}const p=db(e);for(let d=l;d<=u;++d){let g=this.meridians_.length+this.parallels_.length,m,_,y,b;if(this.meridiansLabels_)for(_=0,y=this.meridiansLabels_.length;_<y;++_){const v=this.meridians_[_];if(!t&&d===0)b=this.getMeridianPoint_(v,s,_);else{const x=v.clone();x.translate(d*f,0),x.rotate(-t,o),b=this.getMeridianPoint_(x,a,_),b.rotate(t,o)}m=this.featurePool_[g++],m.setGeometry(b),m.set("graticule_label",this.meridiansLabels_[_].text),p.drawFeature(m,this.lonLabelStyle_(m))}if(this.parallelsLabels_&&(d===l&&h||d===u&&!h))for(_=0,y=this.parallels_.length;_<y;++_){const v=this.parallels_[_];if(!t&&d===0)b=this.getParallelPoint_(v,s,_);else{const x=v.clone();x.translate(d*f,0),x.rotate(-t,o),b=this.getParallelPoint_(x,a,_),b.rotate(t,o)}m=this.featurePool_[g++],m.setGeometry(b),m.set("graticule_label",this.parallelsLabels_[_].text),p.drawFeature(m,this.latLabelStyle_(m))}}}createGraticule_(e,t,r,i){const s=this.getInterval_(r);if(s==-1){this.meridians_.length=0,this.parallels_.length=0,this.meridiansLabels_&&(this.meridiansLabels_.length=0),this.parallelsLabels_&&(this.parallelsLabels_.length=0);return}let o=!1;const a=this.projection_.getExtent(),l=it(a);this.getSource().getWrapX()&&this.projection_.canWrapX()&&!xs(a,e)&&(it(e)>=l?(e[0]=a[0],e[2]=a[2]):o=!0);const u=[Ue(t[0],this.minX_,this.maxX_),Ue(t[1],this.minY_,this.maxY_)],h=this.toLonLatTransform_(u);isNaN(h[1])&&(h[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_);let c=Ue(h[0],this.minLon_,this.maxLon_),f=Ue(h[1],this.minLat_,this.maxLat_);const p=this.maxLines_;let d,g,m,_,y=e;o||(y=[Ue(e[0],this.minX_,this.maxX_),Ue(e[1],this.minY_,this.maxY_),Ue(e[2],this.minX_,this.maxX_),Ue(e[3],this.minY_,this.maxY_)]);const b=Fn(y,this.toLonLatTransform_,void 0,8);let v=b[3],x=b[2],E=b[1],S=b[0];if(o||(vn(y,this.bottomLeft_)&&(S=this.minLon_,E=this.minLat_),vn(y,this.bottomRight_)&&(x=this.maxLon_,E=this.minLat_),vn(y,this.topLeft_)&&(S=this.minLon_,v=this.maxLat_),vn(y,this.topRight_)&&(x=this.maxLon_,v=this.maxLat_),v=Ue(v,f,this.maxLat_),x=Ue(x,c,this.maxLon_),E=Ue(E,this.minLat_,f),S=Ue(S,this.minLon_,c)),c=Math.floor(c/s)*s,_=Ue(c,this.minLon_,this.maxLon_),g=this.addMeridian_(_,E,v,i,e,0),d=0,o)for(;(_-=s)>=S&&d++<p;)g=this.addMeridian_(_,E,v,i,e,g);else for(;_!=this.minLon_&&d++<p;)_=Math.max(_-s,this.minLon_),g=this.addMeridian_(_,E,v,i,e,g);if(_=Ue(c,this.minLon_,this.maxLon_),d=0,o)for(;(_+=s)<=x&&d++<p;)g=this.addMeridian_(_,E,v,i,e,g);else for(;_!=this.maxLon_&&d++<p;)_=Math.min(_+s,this.maxLon_),g=this.addMeridian_(_,E,v,i,e,g);for(this.meridians_.length=g,this.meridiansLabels_&&(this.meridiansLabels_.length=g),f=Math.floor(f/s)*s,m=Ue(f,this.minLat_,this.maxLat_),g=this.addParallel_(m,S,x,i,e,0),d=0;m!=this.minLat_&&d++<p;)m=Math.max(m-s,this.minLat_),g=this.addParallel_(m,S,x,i,e,g);for(m=Ue(f,this.minLat_,this.maxLat_),d=0;m!=this.maxLat_&&d++<p;)m=Math.min(m+s,this.maxLat_),g=this.addParallel_(m,S,x,i,e,g);this.parallels_.length=g,this.parallelsLabels_&&(this.parallelsLabels_.length=g)}getInterval_(e){const t=this.projectionCenterLonLat_[0],r=this.projectionCenterLonLat_[1];let i=-1;const s=Math.pow(this.targetSize_*e,2),o=[],a=[];for(let l=0,u=this.intervals_.length;l<u;++l){const h=Ue(this.intervals_[l]/2,0,90),c=Ue(r,-90+h,90-h);if(o[0]=t-h,o[1]=c-h,a[0]=t+h,a[1]=c+h,this.fromLonLatTransform_(o,o),this.fromLonLatTransform_(a,a),Math.pow(a[0]-o[0],2)+Math.pow(a[1]-o[1],2)<=s)break;i=this.intervals_[l]}return i}getMeridian_(e,t,r,i,s){const o=hb(e,t,r,this.projection_,i);let a=this.meridians_[s];return a?(a.setFlatCoordinates("XY",o),a.changed()):(a=new yr(o,"XY"),this.meridians_[s]=a),a}getMeridianPoint_(e,t,r){const i=e.getFlatCoordinates();let s=1,o=i.length-1;i[s]>i[o]&&(s=o,o=1);const a=Math.max(t[1],i[s]),l=Math.min(t[3],i[o]),u=Ue(t[1]+Math.abs(t[1]-t[3])*this.lonLabelPosition_,a,l),c=[i[s-1]+(i[o-1]-i[s-1])*(u-i[s])/(i[o]-i[s]),u],f=this.meridiansLabels_[r].geom;return f.setCoordinates(c),f}getMeridians(){return this.meridians_}getParallel_(e,t,r,i,s){const o=fb(e,t,r,this.projection_,i);let a=this.parallels_[s];return a?(a.setFlatCoordinates("XY",o),a.changed()):a=new yr(o,"XY"),a}getParallelPoint_(e,t,r){const i=e.getFlatCoordinates();let s=0,o=i.length-2;i[s]>i[o]&&(s=o,o=0);const a=Math.max(t[0],i[s]),l=Math.min(t[2],i[o]),u=Ue(t[0]+Math.abs(t[0]-t[2])*this.latLabelPosition_,a,l),h=i[s+1]+(i[o+1]-i[s+1])*(u-i[s])/(i[o]-i[s]),c=[u,h],f=this.parallelsLabels_[r].geom;return f.setCoordinates(c),f}getParallels(){return this.parallels_}updateProjectionInfo_(e){const t=ue("EPSG:4326"),r=e.getWorldExtent();this.maxLat_=r[3],this.maxLon_=r[2],this.minLat_=r[1],this.minLon_=r[0];const i=_s(e,t);if(this.minLon_<this.maxLon_)this.toLonLatTransform_=i;else{const o=this.minLon_+this.maxLon_/2;this.maxLon_+=360,this.toLonLatTransform_=function(a,l,u){u=u||2;const h=i(a,l,u);for(let c=0,f=h.length;c<f;c+=u)h[c]<o&&(h[c]+=360);return h}}this.fromLonLatTransform_=_s(t,e);const s=Fn([this.minLon_,this.minLat_,this.maxLon_,this.maxLat_],this.fromLonLatTransform_,void 0,8);this.minX_=s[0],this.maxX_=s[2],this.minY_=s[1],this.maxY_=s[3],this.bottomLeft_=this.fromLonLatTransform_([this.minLon_,this.minLat_]),this.bottomRight_=this.fromLonLatTransform_([this.maxLon_,this.minLat_]),this.topLeft_=this.fromLonLatTransform_([this.minLon_,this.maxLat_]),this.topRight_=this.fromLonLatTransform_([this.maxLon_,this.maxLat_]),this.projectionCenterLonLat_=this.toLonLatTransform_(nr(e.getExtent())),isNaN(this.projectionCenterLonLat_[1])&&(this.projectionCenterLonLat_[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_),this.projection_=e}}function hn(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function Ms(n,e){return n[0]=e[0],n[1]=e[1],n[4]=e[2],n[5]=e[3],n[12]=e[4],n[13]=e[5],n}function Fa(n,e,t,r,i,s,o){o=o??hn();const a=1/(n-e),l=1/(t-r),u=1/(i-s);return o[0]=-2*a,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=-2*l,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2*u,o[11]=0,o[12]=(n+e)*a,o[13]=(r+t)*l,o[14]=(s+i)*u,o[15]=1,o}function Lc(n,e,t,r,i){return i=i??hn(),i[0]=n[0]*e,i[1]=n[1]*e,i[2]=n[2]*e,i[3]=n[3]*e,i[4]=n[4]*t,i[5]=n[5]*t,i[6]=n[6]*t,i[7]=n[7]*t,i[8]=n[8]*r,i[9]=n[9]*r,i[10]=n[10]*r,i[11]=n[11]*r,i[12]=n[12],i[13]=n[13],i[14]=n[14],i[15]=n[15],i}function yb(n,e,t,r,i){i=i??hn();let s,o,a,l,u,h,c,f,p,d,g,m;return n===i?(i[12]=n[0]*e+n[4]*t+n[8]*r+n[12],i[13]=n[1]*e+n[5]*t+n[9]*r+n[13],i[14]=n[2]*e+n[6]*t+n[10]*r+n[14],i[15]=n[3]*e+n[7]*t+n[11]*r+n[15]):(s=n[0],o=n[1],a=n[2],l=n[3],u=n[4],h=n[5],c=n[6],f=n[7],p=n[8],d=n[9],g=n[10],m=n[11],i[0]=s,i[1]=o,i[2]=a,i[3]=l,i[4]=u,i[5]=h,i[6]=c,i[7]=f,i[8]=p,i[9]=d,i[10]=g,i[11]=m,i[12]=s*e+u*t+p*r+n[12],i[13]=o*e+h*t+d*r+n[13],i[14]=a*e+c*t+g*r+n[14],i[15]=l*e+f*t+m*r+n[15]),i}function _b(n,e,t,r){return r=r??hn(),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=n,r[13]=e,r[14]=t,r[15]=1,r}const $i=34962,ji=34963,Dl=35044,Os=35048,bb=5121,xb=5123,Eb=5125,Vf=5126,Fc=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function wb(n,e){e=Object.assign({preserveDrawingBuffer:!0,antialias:!zg},e);const t=Fc.length;for(let r=0;r<t;++r)try{const i=n.getContext(Fc[r],e);if(i)return i}catch{}return null}const vb={STATIC_DRAW:Dl};class Mn{constructor(e,t){this.array_=null,this.type_=e,Mt(e===$i||e===ji,"A `WebGLArrayBuffer` must either be of type `ELEMENT_ARRAY_BUFFER` or `ARRAY_BUFFER`"),this.usage_=t!==void 0?t:vb.STATIC_DRAW}ofSize(e){return this.array_=new(is(this.type_))(e),this}fromArray(e){return this.array_=is(this.type_).from(e),this}fromArrayBuffer(e){return this.array_=new(is(this.type_))(e),this}getType(){return this.type_}getArray(){return this.array_}setArray(e){const t=is(this.type_);if(!(e instanceof t))throw new Error(`Expected ${t}`);this.array_=e}getUsage(){return this.usage_}getSize(){return this.array_?this.array_.length:0}}function is(n){switch(n){case $i:return Float32Array;case ji:return Uint32Array;default:return Float32Array}}const ss={LOST:"webglcontextlost",RESTORED:"webglcontextrestored"},Tb=`
  precision mediump float;

  attribute vec2 a_position;
  varying vec2 v_texCoord;
  varying vec2 v_screenCoord;

  uniform vec2 u_screenSize;

  void main() {
    v_texCoord = a_position * 0.5 + 0.5;
    v_screenCoord = v_texCoord * u_screenSize;
    gl_Position = vec4(a_position, 0.0, 1.0);
  }
`,Sb=`
  precision mediump float;

  uniform sampler2D u_image;
  uniform float u_opacity;

  varying vec2 v_texCoord;

  void main() {
    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
  }
`;class Mc{constructor(e){this.gl_=e.webGlContext;const t=this.gl_;this.scaleRatio_=e.scaleRatio||1,this.renderTargetTexture_=t.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=t.createFramebuffer(),this.depthBuffer_=t.createRenderbuffer();const r=t.createShader(t.VERTEX_SHADER);t.shaderSource(r,e.vertexShader||Tb),t.compileShader(r);const i=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(i,e.fragmentShader||Sb),t.compileShader(i),this.renderTargetProgram_=t.createProgram(),t.attachShader(this.renderTargetProgram_,r),t.attachShader(this.renderTargetProgram_,i),t.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=t.createBuffer();const s=[-1,-1,1,-1,-1,1,1,-1,1,1,-1,1];t.bindBuffer(t.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),t.bufferData(t.ARRAY_BUFFER,new Float32Array(s),t.STATIC_DRAW),this.renderTargetAttribLocation_=t.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],e.uniforms&&Object.keys(e.uniforms).forEach(o=>{this.uniforms_.push({value:e.uniforms[o],location:t.getUniformLocation(this.renderTargetProgram_,o)})})}getRenderTargetTexture(){return this.renderTargetTexture_}getGL(){return this.gl_}init(e){const t=this.getGL(),r=[t.drawingBufferWidth*this.scaleRatio_,t.drawingBufferHeight*this.scaleRatio_];if(t.bindFramebuffer(t.FRAMEBUFFER,this.getFrameBuffer()),t.bindRenderbuffer(t.RENDERBUFFER,this.getDepthBuffer()),t.viewport(0,0,r[0],r[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==r[0]||this.renderTargetTextureSize_[1]!==r[1]){this.renderTargetTextureSize_=r;const i=0,s=t.RGBA,o=0,a=t.RGBA,l=t.UNSIGNED_BYTE,u=null;t.bindTexture(t.TEXTURE_2D,this.renderTargetTexture_),t.texImage2D(t.TEXTURE_2D,i,s,r[0],r[1],o,a,l,u),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.renderTargetTexture_,0),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,r[0],r[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer_)}}apply(e,t,r,i){const s=this.getGL(),o=e.size;if(s.bindFramebuffer(s.FRAMEBUFFER,t?t.getFrameBuffer():null),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.renderTargetTexture_),!t){const l=me(s.canvas);if(!e.renderTargets[l]){const u=s.getContextAttributes();u&&u.preserveDrawingBuffer&&(s.clearColor(0,0,0,0),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)),e.renderTargets[l]=!0}}s.disable(s.DEPTH_TEST),s.enable(s.BLEND),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA),s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.bindBuffer(s.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),s.useProgram(this.renderTargetProgram_),s.enableVertexAttribArray(this.renderTargetAttribLocation_),s.vertexAttribPointer(this.renderTargetAttribLocation_,2,s.FLOAT,!1,0,0),s.uniform2f(this.renderTargetUniformLocation_,o[0],o[1]),s.uniform1i(this.renderTargetTextureLocation_,0);const a=e.layerStatesArray[e.layerIndex].opacity;s.uniform1f(this.renderTargetOpacityLocation_,a),this.applyUniforms(e),r&&r(s,e),s.drawArrays(s.TRIANGLES,0,6),i&&i(s,e)}getFrameBuffer(){return this.frameBuffer_}getDepthBuffer(){return this.depthBuffer_}applyUniforms(e){const t=this.getGL();let r,i=1;this.uniforms_.forEach(function(s){if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof ImageData)s.texture||(s.texture=t.createTexture()),t.activeTexture(t[`TEXTURE${i}`]),t.bindTexture(t.TEXTURE_2D,s.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r instanceof ImageData?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,r.width,r.height,0,t.UNSIGNED_BYTE,new Uint8Array(r.data)):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.uniform1i(s.location,i++);else if(Array.isArray(r))switch(r.length){case 2:t.uniform2f(s.location,r[0],r[1]);return;case 3:t.uniform3f(s.location,r[0],r[1],r[2]);return;case 4:t.uniform4f(s.location,r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(s.location,r)})}}const Jt={PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix",TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution",ROTATION:"u_rotation",VIEWPORT_SIZE_PX:"u_viewportSizePx",PIXEL_RATIO:"u_pixelRatio",HIT_DETECTION:"u_hitDetection"},Ve={UNSIGNED_BYTE:bb,UNSIGNED_SHORT:xb,UNSIGNED_INT:Eb,FLOAT:Vf},Ns={};function Oc(n){return"shared/"+n}let Nc=0;function Rb(){const n="unique/"+Nc;return Nc+=1,n}function Pb(n){let e=Ns[n];if(!e){const t=document.createElement("canvas");t.width=1,t.height=1,t.style.position="absolute",t.style.left="0",e={users:0,context:wb(t)},Ns[n]=e}return e.users+=1,e.context}function Ab(n){const e=Ns[n];if(!e||(e.users-=1,e.users>0))return;const t=e.context,r=t.getExtension("WEBGL_lose_context");r&&r.loseContext();const i=t.canvas;i.width=1,i.height=1,delete Ns[n]}class Ib extends rf{constructor(e){super(),e=e||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=e.canvasCacheKey?Oc(e.canvasCacheKey):Rb(),this.gl_=Pb(this.canvasCacheKey_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.needsToBeRecreated_=!1;const t=this.gl_.canvas;t.addEventListener(ss.LOST,this.boundHandleWebGLContextLost_),t.addEventListener(ss.RESTORED,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=nt(),this.offsetScaleMatrix_=nt(),this.tmpMat4_=hn(),this.uniformLocationsByProgram_={},this.attribLocationsByProgram_={},this.uniforms_=[],e.uniforms&&this.setUniforms(e.uniforms),this.postProcessPasses_=e.postProcesses?e.postProcesses.map(r=>new Mc({webGlContext:this.gl_,scaleRatio:r.scaleRatio,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,uniforms:r.uniforms})):[new Mc({webGlContext:this.gl_})],this.shaderCompileErrors_=null,this.startTime_=Date.now(),this.maxAttributeCount_=this.gl_.getParameter(this.gl_.MAX_VERTEX_ATTRIBS)}setUniforms(e){this.uniforms_=[],this.addUniforms(e)}addUniforms(e){for(const t in e)this.uniforms_.push({name:t,value:e[t]})}canvasCacheKeyMatches(e){return this.canvasCacheKey_===Oc(e)}getExtension(e){if(e in this.extensionCache_)return this.extensionCache_[e];const t=this.gl_.getExtension(e);return this.extensionCache_[e]=t,t}bindBuffer(e){const t=this.gl_,r=me(e);let i=this.bufferCache_[r];if(!i){const s=t.createBuffer();i={buffer:e,webGlBuffer:s},this.bufferCache_[r]=i}t.bindBuffer(e.getType(),i.webGlBuffer)}flushBufferData(e){const t=this.gl_;this.bindBuffer(e),t.bufferData(e.getType(),e.getArray(),e.getUsage())}deleteBuffer(e){const t=me(e);delete this.bufferCache_[t]}disposeInternal(){const e=this.gl_.canvas;e.removeEventListener(ss.LOST,this.boundHandleWebGLContextLost_),e.removeEventListener(ss.RESTORED,this.boundHandleWebGLContextRestored_),Ab(this.canvasCacheKey_),delete this.gl_}prepareDraw(e,t,r){const i=this.gl_,s=this.getCanvas(),o=e.size,a=e.pixelRatio;(s.width!==o[0]*a||s.height!==o[1]*a)&&(s.width=o[0]*a,s.height=o[1]*a,s.style.width=o[0]+"px",s.style.height=o[1]+"px");for(let l=this.postProcessPasses_.length-1;l>=0;l--)this.postProcessPasses_[l].init(e);i.bindTexture(i.TEXTURE_2D,null),i.clearColor(0,0,0,0),i.depthRange(0,1),i.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.enable(i.BLEND),i.blendFunc(i.ONE,t?i.ZERO:i.ONE_MINUS_SRC_ALPHA),r?(i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL)):i.disable(i.DEPTH_TEST)}bindFrameBuffer(e,t){const r=this.getGL();r.bindFramebuffer(r.FRAMEBUFFER,e),t&&r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,t,0)}bindInitialFrameBuffer(){const e=this.getGL(),t=this.postProcessPasses_[0].getFrameBuffer();e.bindFramebuffer(e.FRAMEBUFFER,t);const r=this.postProcessPasses_[0].getRenderTargetTexture();e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r,0)}bindTexture(e,t,r){const i=this.gl_;i.activeTexture(i.TEXTURE0+t),i.bindTexture(i.TEXTURE_2D,e),i.uniform1i(this.getUniformLocation(r),t)}bindAttribute(e,t,r){const i=this.getGL();this.bindBuffer(e);const s=this.getAttributeLocation(t);i.enableVertexAttribArray(s),i.vertexAttribPointer(s,r,i.FLOAT,!1,0,0)}prepareDrawToRenderTarget(e,t,r,i){const s=this.gl_,o=t.getSize();s.bindFramebuffer(s.FRAMEBUFFER,t.getFramebuffer()),s.bindRenderbuffer(s.RENDERBUFFER,t.getDepthbuffer()),s.viewport(0,0,o[0],o[1]),s.bindTexture(s.TEXTURE_2D,t.getTexture()),s.clearColor(0,0,0,0),s.depthRange(0,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.enable(s.BLEND),s.blendFunc(s.ONE,r?s.ZERO:s.ONE_MINUS_SRC_ALPHA),i?(s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL)):s.disable(s.DEPTH_TEST)}drawElements(e,t){const r=this.gl_;this.getExtension("OES_element_index_uint");const i=r.UNSIGNED_INT,s=4,o=t-e,a=e*s;r.drawElements(r.TRIANGLES,o,i,a)}finalizeDraw(e,t,r){for(let i=0,s=this.postProcessPasses_.length;i<s;i++)i===s-1?this.postProcessPasses_[i].apply(e,null,t,r):this.postProcessPasses_[i].apply(e,this.postProcessPasses_[i+1])}getCanvas(){return this.gl_.canvas}getGL(){return this.gl_}applyFrameState(e){const t=e.size,r=e.viewState.rotation,i=e.pixelRatio;this.setUniformFloatValue(Jt.TIME,(Date.now()-this.startTime_)*.001),this.setUniformFloatValue(Jt.ZOOM,e.viewState.zoom),this.setUniformFloatValue(Jt.RESOLUTION,e.viewState.resolution),this.setUniformFloatValue(Jt.PIXEL_RATIO,i),this.setUniformFloatVec2(Jt.VIEWPORT_SIZE_PX,[t[0],t[1]]),this.setUniformFloatValue(Jt.ROTATION,r)}applyHitDetectionUniform(e){const t=this.getUniformLocation(Jt.HIT_DETECTION);this.getGL().uniform1i(t,e?1:0),e&&this.setUniformFloatValue(Jt.PIXEL_RATIO,.5)}applyUniforms(e){const t=this.gl_;let r,i=0;this.uniforms_.forEach(s=>{if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof HTMLImageElement||r instanceof ImageData||r instanceof WebGLTexture){r instanceof WebGLTexture&&!s.texture?(s.prevValue=void 0,s.texture=r):s.texture||(s.prevValue=void 0,s.texture=t.createTexture()),this.bindTexture(s.texture,i,s.name),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const o=!(r instanceof HTMLImageElement)||r.complete;!(r instanceof WebGLTexture)&&o&&s.prevValue!==r&&(s.prevValue=r,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)),i++}else if(Array.isArray(r)&&r.length===6)this.setUniformMatrixValue(s.name,Ms(this.tmpMat4_,r));else if(Array.isArray(r)&&r.length<=4)switch(r.length){case 2:t.uniform2f(this.getUniformLocation(s.name),r[0],r[1]);return;case 3:t.uniform3f(this.getUniformLocation(s.name),r[0],r[1],r[2]);return;case 4:t.uniform4f(this.getUniformLocation(s.name),r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(this.getUniformLocation(s.name),r)})}useProgram(e,t){this.disableAllAttributes_(),this.gl_.useProgram(e),this.currentProgram_=e,t&&(this.applyFrameState(t),this.applyUniforms(t))}compileShader(e,t){const r=this.gl_,i=r.createShader(t);return r.shaderSource(i,e),r.compileShader(i),i}getProgram(e,t){const r=this.gl_,i=this.compileShader(e,r.FRAGMENT_SHADER),s=this.compileShader(t,r.VERTEX_SHADER),o=r.createProgram();if(r.attachShader(o,i),r.attachShader(o,s),r.linkProgram(o),!r.getShaderParameter(i,r.COMPILE_STATUS)){const a=`Fragment shader compilation failed: ${r.getShaderInfoLog(i)}`;throw new Error(a)}if(r.deleteShader(i),!r.getShaderParameter(s,r.COMPILE_STATUS)){const a=`Vertex shader compilation failed: ${r.getShaderInfoLog(s)}`;throw new Error(a)}if(r.deleteShader(s),!r.getProgramParameter(o,r.LINK_STATUS)){const a=`GL program linking failed: ${r.getProgramInfoLog(o)}`;throw new Error(a)}return o}getUniformLocation(e){const t=me(this.currentProgram_);return this.uniformLocationsByProgram_[t]===void 0&&(this.uniformLocationsByProgram_[t]={}),this.uniformLocationsByProgram_[t][e]===void 0&&(this.uniformLocationsByProgram_[t][e]=this.gl_.getUniformLocation(this.currentProgram_,e)),this.uniformLocationsByProgram_[t][e]}getAttributeLocation(e){const t=me(this.currentProgram_);return this.attribLocationsByProgram_[t]===void 0&&(this.attribLocationsByProgram_[t]={}),this.attribLocationsByProgram_[t][e]===void 0&&(this.attribLocationsByProgram_[t][e]=this.gl_.getAttribLocation(this.currentProgram_,e)),this.attribLocationsByProgram_[t][e]}makeProjectionTransform(e,t){const r=e.size,i=e.viewState.rotation,s=e.viewState.resolution,o=e.viewState.center;return al(t,0,0,2/(s*r[0]),2/(s*r[1]),-i,-o[0],-o[1]),t}setUniformFloatValue(e,t){this.gl_.uniform1f(this.getUniformLocation(e),t)}setUniformFloatVec2(e,t){this.gl_.uniform2fv(this.getUniformLocation(e),t)}setUniformFloatVec4(e,t){this.gl_.uniform4fv(this.getUniformLocation(e),t)}setUniformMatrixValue(e,t){this.gl_.uniformMatrix4fv(this.getUniformLocation(e),!1,t)}disableAllAttributes_(){for(let e=0;e<this.maxAttributeCount_;e++)this.gl_.disableVertexAttribArray(e)}enableAttributeArray_(e,t,r,i,s){const o=this.getAttributeLocation(e);o<0||(this.gl_.enableVertexAttribArray(o),this.gl_.vertexAttribPointer(o,t,r,!1,i,s))}enableAttributes(e){const t=Cb(e);let r=0;for(let i=0;i<e.length;i++){const s=e[i];this.enableAttributeArray_(s.name,s.size,s.type||Vf,t,r),r+=s.size*Xf(s.type)}}handleWebGLContextLost(e){wg(this.bufferCache_),this.currentProgram_=null,e.preventDefault()}handleWebGLContextRestored(){this.needsToBeRecreated_=!0}needsToBeRecreated(){return this.needsToBeRecreated_}createTexture(e,t,r,i){const s=this.gl_;r=r||s.createTexture();const o=i?s.NEAREST:s.LINEAR;s.bindTexture(s.TEXTURE_2D,r),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);const a=0,l=s.RGBA,u=0,h=s.RGBA,c=s.UNSIGNED_BYTE;return t instanceof Uint8Array?s.texImage2D(s.TEXTURE_2D,a,l,e[0],e[1],u,h,c,t):t?s.texImage2D(s.TEXTURE_2D,a,l,h,c,t):s.texImage2D(s.TEXTURE_2D,a,l,e[0],e[1],u,h,c,null),r}}function Cb(n){let e=0;for(let t=0;t<n.length;t++){const r=n[t];e+=r.size*Xf(r.type)}return e}function Xf(n){switch(n){case Ve.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case Ve.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case Ve.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case Ve.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}class Lb extends vg{constructor(e){super(),this.tile,this.handleTileChange_=this.handleTileChange_.bind(this),this.gutter=e.gutter||0,this.helper=e.helper,this.loaded=!1,this.ready=!1}setTile(e){if(e!==this.tile)if(this.tile&&this.tile.removeEventListener(ft.CHANGE,this.handleTileChange_),this.tile=e,this.loaded=e.getState()===Q.LOADED,this.loaded)this.uploadTile();else{if(e instanceof pl){const t=e.getImage();t instanceof Image&&!t.crossOrigin&&(t.crossOrigin="anonymous")}e.addEventListener(ft.CHANGE,this.handleTileChange_)}}uploadTile(){cl()}setReady(){this.ready=!0,this.dispatchEvent(ft.CHANGE)}handleTileChange_(){this.tile.getState()===Q.LOADED&&(this.loaded=!0,this.uploadTile())}setHelper(e){this.helper=e,this.helper&&this.loaded&&this.uploadTile()}disposeInternal(){this.setHelper(null),this.tile.removeEventListener(ft.CHANGE,this.handleTileChange_)}}function Wf(n,e,t){const r=t?n.LINEAR:n.NEAREST;n.bindTexture(n.TEXTURE_2D,e),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,r),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,r)}function Fb(n,e,t,r){Wf(n,e,r),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t)}function Dc(n,e,t,r,i,s){const o=n.getGL();let a,l;t instanceof Float32Array?(a=o.FLOAT,n.getExtension("OES_texture_float"),l=n.getExtension("OES_texture_float_linear")!==null):(a=o.UNSIGNED_BYTE,l=!0),Wf(o,e,s&&l);const u=t.byteLength/r[1];let h=1;u%8===0?h=8:u%4===0?h=4:u%2===0&&(h=2);let c;switch(i){case 1:{c=o.LUMINANCE;break}case 2:{c=o.LUMINANCE_ALPHA;break}case 3:{c=o.RGB;break}case 4:{c=o.RGBA;break}default:throw new Error(`Unsupported number of bands: ${i}`)}const f=o.getParameter(o.UNPACK_ALIGNMENT);o.pixelStorei(o.UNPACK_ALIGNMENT,h),o.texImage2D(o.TEXTURE_2D,0,c,r[0],r[1],0,c,a,t),o.pixelStorei(o.UNPACK_ALIGNMENT,f)}let _n=null;function Mb(){_n=Br(1,1,void 0,{willReadFrequently:!0})}class Ob extends Lb{constructor(e){super(e),this.textures=[],this.renderSize_=Vt(e.grid.getTileSize(e.tile.tileCoord[0])),this.bandCount=NaN;const t=new Mn($i,Dl);t.fromArray([0,1,1,1,1,0,0,0]),this.helper.flushBufferData(t),this.coords=t,this.setTile(e.tile)}setHelper(e){var r;const t=(r=this.helper)==null?void 0:r.getGL();if(t){this.helper.deleteBuffer(this.coords);for(let i=0;i<this.textures.length;++i)t.deleteTexture(this.textures[i])}super.setHelper(e),e&&e.flushBufferData(this.coords)}uploadTile(){const e=this.helper,t=e.getGL(),r=this.tile;this.textures.length=0;let i;r instanceof pl||r instanceof kg?i=r.getImage():i=r.getData();const s=Ra(i);if(s){const y=t.createTexture();this.textures.push(y),this.bandCount=4,Fb(t,y,s,r.interpolate),this.setReady();return}i=Sa(i);const o=r.getSize(),a=[o[0]+2*this.gutter,o[1]+2*this.gutter],l=i instanceof Float32Array,u=a[0]*a[1],h=l?Float32Array:Uint8Array,c=h.BYTES_PER_ELEMENT,f=i.byteLength/a[1];this.bandCount=Math.floor(f/c/a[0]);const p=Math.ceil(this.bandCount/4);if(p===1){const y=t.createTexture();this.textures.push(y),Dc(e,y,i,a,this.bandCount,r.interpolate),this.setReady();return}const d=new Array(p);for(let y=0;y<p;++y){const b=t.createTexture();this.textures.push(b);const v=y<p-1?4:(this.bandCount-1)%4+1;d[y]=new h(u*v)}let g=0,m=0;const _=a[0]*this.bandCount;for(let y=0;y<a[1];++y){for(let b=0;b<_;++b){const v=i[m+b],x=Math.floor(g/this.bandCount),E=b%this.bandCount,S=Math.floor(E/4),A=d[S],P=A.length/u,R=E%4;A[x*P+R]=v,++g}m+=f/c}for(let y=0;y<p;++y){const b=this.textures[y],v=d[y],x=v.length/u;Dc(e,b,v,a,x,r.interpolate)}this.setReady()}getImagePixelData_(e,t,r){const i=this.gutter,s=this.renderSize_[0],o=this.renderSize_[1];_n||Mb(),_n.clearRect(0,0,1,1);const a=e.width,l=e.height,u=a-2*i,h=l-2*i,c=i+Math.floor(u*(t/s)),f=i+Math.floor(h*(r/o));let p;try{_n.drawImage(e,c,f,1,1,0,0,1,1),p=_n.getImageData(0,0,1,1).data}catch{return _n=null,null}return p}getArrayPixelData_(e,t,r,i){const s=this.gutter,o=this.renderSize_[0],a=this.renderSize_[1],l=t[0],u=t[1],h=l+2*s,c=u+2*s,f=s+Math.floor(l*(r/o)),p=s+Math.floor(u*(i/a));if(e instanceof DataView){const g=e.byteLength/(h*c),m=g*(p*h+f),_=e.buffer.slice(m,m+g);return new DataView(_)}const d=this.bandCount*(p*h+f);return e.slice(d,d+this.bandCount)}getPixelData(e,t){if(!this.loaded)return null;if(this.tile instanceof gl){const r=this.tile.getData(),i=Sa(r);if(i){const s=this.tile.getSize();return this.getArrayPixelData_(i,s,e,t)}return this.getImagePixelData_(Ra(r),e,t)}return this.getImagePixelData_(this.tile.getImage(),e,t)}}class Vi extends $g{constructor(e,t){super(e),t=t||{},this.inversePixelTransform_=nt(),this.postProcesses_=t.postProcesses,this.uniforms_=t.uniforms,this.helper,this.onMapChanged_=()=>{this.clearCache(),this.removeHelper()},e.addChangeListener(Ia.MAP,this.onMapChanged_),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(Hr.PRECOMPOSE)){const i=new Xo(Hr.PRECOMPOSE,void 0,t,e);r.dispatchEvent(i)}}dispatchPostComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(Hr.POSTCOMPOSE)){const i=new Xo(Hr.POSTCOMPOSE,void 0,t,e);r.dispatchEvent(i)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getRenderSource()){let t=!0,r=-1,i;for(let o=0,a=e.layerStatesArray.length;o<a;o++){const l=e.layerStatesArray[o].layer,u=l.getRenderer();if(!(u instanceof Vi)){t=!0;continue}const h=l.getClassName();if((t||h!==i)&&(r+=1,t=!1),i=h,u===this)break}const s="map/"+e.mapId+"/group/"+r;(!this.helper||!this.helper.canvasCacheKeyMatches(s)||this.helper.needsToBeRecreated())&&(this.removeHelper(),this.helper=new Ib({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:s}),i&&(this.helper.getCanvas().className=i),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}clearCache(){}disposeInternal(){var e;this.clearCache(),this.removeHelper(),(e=this.getLayer())==null||e.removeChangeListener(Ia.MAP,this.onMapChanged_),super.disposeInternal()}dispatchRenderEvent_(e,t,r){const i=this.getLayer();if(i.hasListener(e)){al(this.inversePixelTransform_,0,0,r.pixelRatio,-r.pixelRatio,0,0,-r.size[1]);const s=new Xo(e,this.inversePixelTransform_,r,t);i.dispatchEvent(s)}}preRender(e,t){this.dispatchRenderEvent_(Hr.PRERENDER,e,t)}postRender(e,t){this.dispatchRenderEvent_(Hr.POSTRENDER,e,t)}}const Nb={TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",RESOLUTION:"u_resolution",ZOOM:"u_zoom",GLOBAL_ALPHA:"u_globalAlpha",PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix"};function Uc(n){return 1/(n+2)}function Db(){return{tileIds:new Set,representationsByZ:{}}}function Bc(n,e){return n.tileIds.has(me(e))}function Gc(n,e,t){const r=n.representationsByZ;t in r||(r[t]=new Set),r[t].add(e),n.tileIds.add(me(e.tile))}function Zo(n,e){const t=n.layerStatesArray[n.layerIndex];t.extent&&(e=rr(e,Jh(t.extent,n.viewState.projection)));const r=t.layer.getRenderSource();if(!r.getWrapX()){const i=r.getTileGridForProjection(n.viewState.projection).getExtent();i&&(e=rr(e,i))}return e}function Ma(n,e){return`${me(n)},${n.getKey()},${n.getRevision()},${yn(e)}`}class Ub extends Vi{constructor(e,t){super(e,{uniforms:t.uniforms,postProcesses:t.postProcesses}),this.renderComplete=!1,this.tileTransform_=nt(),this.tempMat4=hn(),this.tempTileRange_=new jg(0,0,0,0),this.tempTileCoord_=Pa(0,0,0),this.tempSize_=[0,0];const r=t.cacheSize!==void 0?t.cacheSize:512;this.tileRepresentationCache=new lf(r),this.frameState=null,this.renderedProjection_=void 0}reset(e){super.reset({uniforms:e.uniforms})}prepareFrameInternal(e){this.renderedProjection_?e.viewState.projection!==this.renderedProjection_&&(this.clearCache(),this.renderedProjection_=e.viewState.projection):this.renderedProjection_=e.viewState.projection;const r=this.getLayer().getRenderSource();return!r||no(Zo(e,e.extent))?!1:r.getState()==="ready"}createTileRepresentation(e){return cl()}enqueueTiles(e,t,r,i,s){const o=e.viewState,a=this.getLayer(),l=a.getRenderSource(),u=l.getTileGridForProjection(o.projection),h=l.getGutterForProjection(o.projection),c=me(l);c in e.wantedTiles||(e.wantedTiles[c]={});const f=e.wantedTiles[c],p=this.tileRepresentationCache,d=a.getMapInternal(),g=Math.max(r-s,u.getMinZoom(),u.getZForResolution(Math.min(a.getMaxResolution(),d?d.getView().getResolutionForZoom(Math.max(a.getMinZoom(),0)):u.getResolution(0)),l.zDirection)),m=o.rotation,_=m?Tg(o.center,o.resolution,m,e.size):void 0;for(let y=r;y>=g;--y){const b=u.getTileRangeForExtentAndZ(t,y,this.tempTileRange_),v=u.getResolution(y);for(let x=b.minX;x<=b.maxX;++x)for(let E=b.minY;E<=b.maxY;++E){if(m&&!u.tileCoordIntersectsViewport([y,x,E],_))continue;const S=Pa(y,x,E,this.tempTileCoord_),A=Ma(l,S);let P,R;if(p.containsKey(A)&&(P=p.get(A),R=P.tile),(!P||P.tile.key!==l.getKey())&&(R=l.getTile(y,x,E,e.pixelRatio,o.projection),!R)||Bc(i,R))continue;P?P.setTile(R):(P=this.createTileRepresentation({tile:R,grid:u,helper:this.helper,gutter:h}),p.set(A,P)),Gc(i,P,y);const I=R.getKey();f[I]=!0,R.getState()===Q.IDLE&&(e.tileQueue.isKeyQueued(I)||e.tileQueue.enqueue([R,c,u.getTileCoordCenter(S),v]))}}}beforeTilesRender(e,t){this.helper.prepareDraw(this.frameState,!t,!0)}beforeTilesMaskRender(e){return!1}renderTile(e,t,r,i,s,o,a,l,u,h,c){}renderTileMask(e,t,r,i){}drawTile_(e,t,r,i,s,o,a){if(!t.ready)return;const u=t.tile.tileCoord,h=yn(u),c=h in o?o[h]:1,f=a.getResolution(r),p=Vt(a.getTileSize(r),this.tempSize_),d=a.getOrigin(r),g=a.getTileCoordExtent(u),m=c<1?-1:Uc(r);c<1&&(e.animate=!0);const _=e.viewState,y=_.center[0],b=_.center[1],v=p[0]+2*i,x=p[1]+2*i,E=v/x,S=(y-d[0])/(p[0]*f),A=(d[1]-b)/(p[1]*f),P=_.resolution/f,R=u[1],I=u[2];ag(this.tileTransform_),Hu(this.tileTransform_,2/(e.size[0]*P/v),-2/(e.size[1]*P/v)),lg(this.tileTransform_,_.rotation),Hu(this.tileTransform_,1,1/E),ll(this.tileTransform_,(p[0]*(R-S)-i)/v,(p[1]*(I-A)-i)/x),this.renderTile(t,this.tileTransform_,e,s,f,p,d,g,m,i,c)}renderFrame(e){this.frameState=e,this.renderComplete=!0;const t=this.helper.getGL();this.preRender(t,e);const r=e.viewState,i=this.getLayer(),s=i.getRenderSource(),o=s.getTileGridForProjection(r.projection),a=s.getGutterForProjection(r.projection),l=Zo(e,e.extent),u=o.getZForResolution(r.resolution,s.zDirection),h=Db(),c=i.getPreload();if(e.nextExtent){const b=o.getZForResolution(r.nextResolution,s.zDirection),v=Zo(e,e.nextExtent);this.enqueueTiles(e,v,b,h,c)}this.enqueueTiles(e,l,u,h,0),c>0&&setTimeout(()=>{this.enqueueTiles(e,l,u-1,h,c-1)},0);const f={};let p=!1;const d=h.representationsByZ;if(u in d){const b=me(this),v=e.time;for(const x of d[u]){const E=x.tile;if(E.getState()===Q.EMPTY)continue;const S=E.tileCoord;if(x.ready){const R=E.getAlpha(b,v);if(R===1){E.endTransition(b);continue}p=!0;const I=yn(S);f[I]=R}if(this.renderComplete=!1,this.findAltTiles_(o,S,u+1,h))continue;const P=o.getMinZoom();for(let R=u-1;R>=P&&!this.findAltTiles_(o,S,R,h);--R);}}const g=Object.keys(d).map(Number).sort(Sg);if(this.beforeTilesMaskRender(e))for(let b=0,v=g.length;b<v;++b){const x=g[b];for(const E of d[x]){const S=E.tile.tileCoord;if(yn(S)in f)continue;const P=o.getTileCoordExtent(S);this.renderTileMask(E,x,P,Uc(x))}}this.beforeTilesRender(e,p);for(let b=0,v=g.length;b<v;++b){const x=g[b];for(const E of d[x]){const S=E.tile.tileCoord;yn(S)in f||this.drawTile_(e,E,x,a,l,f,o)}}if(u in d)for(const b of d[u]){const v=b.tile.tileCoord;yn(v)in f&&this.drawTile_(e,b,u,a,l,f,o)}this.beforeFinalize(e),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const _=this.helper.getCanvas(),y=this.tileRepresentationCache;for(;y.canExpireCache();)y.pop().dispose();return this.postRender(t,e),_}beforeFinalize(e){}findAltTiles_(e,t,r,i){const s=e.getTileRangeForTileCoordAndZ(t,r,this.tempTileRange_);if(!s)return!1;let o=!0;const a=this.tileRepresentationCache,l=this.getLayer().getRenderSource();for(let u=s.minX;u<=s.maxX;++u)for(let h=s.minY;h<=s.maxY;++h){const c=Ma(l,[r,u,h]);let f=!1;if(a.containsKey(c)){const p=a.get(c);p.ready&&!Bc(i,p.tile)&&(Gc(i,p,r),f=!0)}f||(o=!1)}return o}clearCache(){super.clearCache();const e=this.tileRepresentationCache;e.forEach(t=>t.dispose()),e.clear()}afterHelperCreated(){super.afterHelperCreated(),this.tileRepresentationCache.forEach(e=>e.setHelper(this.helper))}disposeInternal(){super.disposeInternal(),delete this.frameState}}const K={...Nb,TILE_TEXTURE_ARRAY:"u_tileTextures",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",TEXTURE_RESOLUTION:"u_textureResolution",TEXTURE_ORIGIN_X:"u_textureOriginX",TEXTURE_ORIGIN_Y:"u_textureOriginY"},ps={TEXTURE_COORD:"a_textureCoord"},Bb=[{name:ps.TEXTURE_COORD,size:2,type:Ve.FLOAT}];class Gb extends Ub{constructor(e,t){super(e,t),this.program_,this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.indices_=new Mn(ji,Dl),this.indices_.fromArray([0,1,3,1,2,3]),this.paletteTextures_=t.paletteTextures||[]}reset(e){if(super.reset(e),this.helper){const t=this.helper.getGL();for(const r of this.paletteTextures_)r.delete(t)}if(this.vertexShader_=e.vertexShader,this.fragmentShader_=e.fragmentShader,this.paletteTextures_=e.paletteTextures||[],this.helper){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_);const t=this.helper.getGL();for(const r of this.paletteTextures_)r.getTexture(t)}}afterHelperCreated(){super.afterHelperCreated();const e=this.helper.getGL();for(const t of this.paletteTextures_)t.getTexture(e);this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}removeHelper(){if(this.helper){const e=this.helper.getGL();for(const t of this.paletteTextures_)t.delete(e)}super.removeHelper()}createTileRepresentation(e){return new Ob(e)}beforeTilesRender(e,t){super.beforeTilesRender(e,t),this.helper.useProgram(this.program_,e)}renderTile(e,t,r,i,s,o,a,l,u,h,c){const f=this.helper.getGL();this.helper.bindBuffer(e.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(Bb);let p=0;for(;p<e.textures.length;){const E=`${K.TILE_TEXTURE_ARRAY}[${p}]`;this.helper.bindTexture(e.textures[p],p,E),++p}for(let E=0;E<this.paletteTextures_.length;++E){const S=this.paletteTextures_[E],A=S.getTexture(f);this.helper.bindTexture(A,p,S.name),++p}const d=r.viewState,g=o[0]+2*h,m=o[1]+2*h,y=e.tile.tileCoord,b=y[1],v=y[2];this.helper.setUniformMatrixValue(K.TILE_TRANSFORM,Ms(this.tempMat4,t)),this.helper.setUniformFloatValue(K.TRANSITION_ALPHA,c),this.helper.setUniformFloatValue(K.DEPTH,u);let x=i;h>0&&(x=l,rr(x,i,x)),this.helper.setUniformFloatVec4(K.RENDER_EXTENT,x),this.helper.setUniformFloatValue(K.RESOLUTION,d.resolution),this.helper.setUniformFloatValue(K.ZOOM,d.zoom),this.helper.setUniformFloatValue(K.TEXTURE_PIXEL_WIDTH,g),this.helper.setUniformFloatValue(K.TEXTURE_PIXEL_HEIGHT,m),this.helper.setUniformFloatValue(K.TEXTURE_RESOLUTION,s),this.helper.setUniformFloatValue(K.TEXTURE_ORIGIN_X,a[0]+b*o[0]*s-h*s),this.helper.setUniformFloatValue(K.TEXTURE_ORIGIN_Y,a[1]-v*o[1]*s+h*s),this.helper.drawElements(0,this.indices_.getSize())}getData(e){if(!this.helper.getGL())return null;const r=this.frameState;if(!r)return null;const i=this.getLayer(),s=_r(r.pixelToCoordinateTransform,e.slice()),o=r.viewState,a=i.getExtent();if(a&&!vn(Jh(a,o.projection),s))return null;const l=i.getSources(hl([s]),o.resolution);let u,h,c;for(u=l.length-1;u>=0;--u)if(h=l[u],h.getState()==="ready"){if(c=h.getTileGridForProjection(o.projection),h.getWrapX())break;const p=c.getExtent();if(!p||vn(p,s))break}if(u<0)return null;const f=this.tileRepresentationCache;for(let p=c.getZForResolution(o.resolution);p>=c.getMinZoom();--p){const d=c.getTileCoordForCoordAndZ(s,p),g=Ma(h,d);if(!f.containsKey(g))continue;const m=f.get(g);if(m.tile.getState()===Q.EMPTY)return null;if(!m.loaded)continue;const y=c.getOrigin(p),b=Vt(c.getTileSize(p)),v=c.getResolution(p),x=(s[0]-y[0])/v-d[1]*b[0],E=(y[1]-s[1])/v-d[2]*b[1];return m.getPixelData(x,E)}return null}disposeInternal(){const e=this.helper;if(e){const t=e.getGL();for(const r of this.paletteTextures_)r.delete(t);this.paletteTextures_.length=0,t.deleteProgram(this.program_),delete this.program_,e.deleteBuffer(this.indices_)}super.disposeInternal(),delete this.indices_}}class zb{constructor(e,t){this.name=e,this.data=t,this.texture_=null}getTexture(e){if(!this.texture_){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.data.length/4,1,0,e.RGBA,e.UNSIGNED_BYTE,this.data),this.texture_=t}return this.texture_}delete(e){this.texture_&&e.deleteTexture(this.texture_),this.texture_=null}}function kb(n,e){return`operator_${n}_${Object.keys(e.functions).length}`}function Ur(n){const e=n.toString();return e.includes(".")?e:e+".0"}function Ul(n){if(n.length<2||n.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${n.length}(${n.map(Ur).join(", ")})`}function gs(n){const e=Di(n),t=e.length>3?e[3]:1;return Ul([e[0]/255,e[1]/255,e[2]/255,t])}function $b(n){const e=Vt(n);return Ul(e)}const qo={};let jb=0;function On(n){return n in qo||(qo[n]=jb++),qo[n]}function fr(n){return Ur(On(n))}function mo(n){return"u_var_"+n}function Bl(){return{variables:{},properties:{},functions:{},bandCount:0,featureId:!1,geometryType:!1}}const Ho="getBandValue",Zf="u_paletteTextures",qf="featureId",Hf="geometryType",Oa=-9999999;function Vb(n,e,t,r){const i=Vg(n,e,t);return Gl(i,e,r)}function be(n){return(e,t,r)=>{const i=t.args.length,s=new Array(i);for(let o=0;o<i;++o)s[o]=Gl(t.args[o],r,e);return n(s,e)}}const Xb={[te.Get]:(n,e)=>{const r=e.args[0].value;return r in n.properties||(n.properties[r]={name:r,type:e.type}),"a_prop_"+r},[te.Id]:n=>(n.featureId=!0,"a_"+qf),[te.GeometryType]:n=>(n.geometryType=!0,"a_"+Hf),[te.LineMetric]:()=>"currentLineMetric",[te.Var]:(n,e)=>{const r=e.args[0].value;return r in n.variables||(n.variables[r]={name:r,type:e.type}),mo(r)},[te.Has]:(n,e)=>{const r=e.args[0].value;return r in n.properties||(n.properties[r]={name:r,type:e.type}),`(a_prop_${r} != ${Ur(Oa)})`},[te.Resolution]:()=>"u_resolution",[te.Zoom]:()=>"u_zoom",[te.Time]:()=>"u_time",[te.Any]:be(n=>`(${n.join(" || ")})`),[te.All]:be(n=>`(${n.join(" && ")})`),[te.Not]:be(([n])=>`(!${n})`),[te.Equal]:be(([n,e])=>`(${n} == ${e})`),[te.NotEqual]:be(([n,e])=>`(${n} != ${e})`),[te.GreaterThan]:be(([n,e])=>`(${n} > ${e})`),[te.GreaterThanOrEqualTo]:be(([n,e])=>`(${n} >= ${e})`),[te.LessThan]:be(([n,e])=>`(${n} < ${e})`),[te.LessThanOrEqualTo]:be(([n,e])=>`(${n} <= ${e})`),[te.Multiply]:be(n=>`(${n.join(" * ")})`),[te.Divide]:be(([n,e])=>`(${n} / ${e})`),[te.Add]:be(n=>`(${n.join(" + ")})`),[te.Subtract]:be(([n,e])=>`(${n} - ${e})`),[te.Clamp]:be(([n,e,t])=>`clamp(${n}, ${e}, ${t})`),[te.Mod]:be(([n,e])=>`mod(${n}, ${e})`),[te.Pow]:be(([n,e])=>`pow(${n}, ${e})`),[te.Abs]:be(([n])=>`abs(${n})`),[te.Floor]:be(([n])=>`floor(${n})`),[te.Ceil]:be(([n])=>`ceil(${n})`),[te.Round]:be(([n])=>`floor(${n} + 0.5)`),[te.Sin]:be(([n])=>`sin(${n})`),[te.Cos]:be(([n])=>`cos(${n})`),[te.Atan]:be(([n,e])=>e!==void 0?`atan(${n}, ${e})`:`atan(${n})`),[te.Sqrt]:be(([n])=>`sqrt(${n})`),[te.Match]:be(n=>{const e=n[0],t=n[n.length-1];let r=null;for(let i=n.length-3;i>=1;i-=2){const s=n[i],o=n[i+1];r=`(${e} == ${s} ? ${o} : ${r||t})`}return r}),[te.Between]:be(([n,e,t])=>`(${n} >= ${e} && ${n} <= ${t})`),[te.Interpolate]:be(([n,e,...t])=>{let r="";for(let i=0;i<t.length-2;i+=2){const s=t[i],o=r||t[i+1],a=t[i+2],l=t[i+3];let u;n===Ur(1)?u=`(${e} - ${s}) / (${a} - ${s})`:u=`(pow(${n}, (${e} - ${s})) - 1.0) / (pow(${n}, (${a} - ${s})) - 1.0)`,r=`mix(${o}, ${l}, clamp(${u}, 0.0, 1.0))`}return r}),[te.Case]:be(n=>{const e=n[n.length-1];let t=null;for(let r=n.length-3;r>=0;r-=2){const i=n[r],s=n[r+1];t=`(${i} ? ${s} : ${t||e})`}return t}),[te.In]:be(([n,...e],t)=>{const r=kb("in",t),i=[];for(let s=0;s<e.length;s+=1)i.push(`  if (inputValue == ${e[s]}) { return true; }`);return t.functions[r]=`bool ${r}(float inputValue) {
${i.join(`
`)}
  return false;
}`,`${r}(${n})`}),[te.Array]:be(n=>`vec${n.length}(${n.join(", ")})`),[te.Color]:be(n=>{if(n.length===1)return`vec4(vec3(${n[0]} / 255.0), 1.0)`;if(n.length===2)return`vec4(vec3(${n[0]} / 255.0), ${n[1]})`;const e=n.slice(0,3).map(r=>`${r} / 255.0`);if(n.length===3)return`vec4(${e.join(", ")}, 1.0)`;const t=n[3];return`vec4(${e.join(", ")}, ${t})`}),[te.Band]:be(([n,e,t],r)=>{if(!(Ho in r.functions)){let i="";const s=r.bandCount||1;for(let o=0;o<s;o++){const a=Math.floor(o/4);let l=o%4;o===s-1&&l===1&&(l=3);const u=`${K.TILE_TEXTURE_ARRAY}[${a}]`;i+=`  if (band == ${o+1}.0) {
    return texture2D(${u}, v_textureCoord + vec2(dx, dy))[${l}];
  }
`}r.functions[Ho]=`float getBandValue(float band, float xOffset, float yOffset) {
  float dx = xOffset / ${K.TEXTURE_PIXEL_WIDTH};
  float dy = yOffset / ${K.TEXTURE_PIXEL_HEIGHT};
${i}
}`}return`${Ho}(${n}, ${e??"0.0"}, ${t??"0.0"})`}),[te.Palette]:(n,e)=>{const[t,...r]=e.args,i=r.length,s=new Uint8Array(i*4);for(let u=0;u<r.length;u++){const h=r[u].value,c=Di(h),f=u*4;s[f]=c[0],s[f+1]=c[1],s[f+2]=c[2],s[f+3]=c[3]*255}n.paletteTextures||(n.paletteTextures=[]);const o=`${Zf}[${n.paletteTextures.length}]`,a=new zb(o,s);n.paletteTextures.push(a);const l=Gl(t,ye,n);return`texture2D(${o}, vec2((${l} + 0.5) / ${i}.0, 0.5))`}};function Gl(n,e,t){if(n instanceof Xg){const r=Xb[n.operator];if(r===void 0)throw new Error(`No compiler defined for this operator: ${JSON.stringify(n.operator)}`);return r(t,n,e)}if((n.type&ye)>0)return Ur(n.value);if((n.type&oo)>0)return n.value.toString();if((n.type&wi)>0)return fr(n.value.toString());if((n.type&gt)>0)return gs(n.value);if((n.type&sn)>0)return Ul(n.value);if((n.type&ln)>0)return $b(n.value);throw new Error(`Unexpected expression ${n.value} (expected type ${Wg(e)})`)}function Wb(){return{"fill-color":"rgba(255,255,255,0.4)","stroke-color":"#3399CC","stroke-width":1.25,"circle-radius":5,"circle-fill-color":"rgba(255,255,255,0.4)","circle-stroke-width":1.25,"circle-stroke-color":"#3399CC"}}const zc=.985,fn=`#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif
uniform mat4 u_projectionMatrix;
uniform mat4 u_screenToWorldMatrix;
uniform vec2 u_viewportSizePx;
uniform float u_pixelRatio;
uniform float u_globalAlpha;
uniform float u_time;
uniform float u_zoom;
uniform float u_resolution;
uniform float u_rotation;
uniform vec4 u_renderExtent;
uniform vec2 u_patternOrigin;
uniform float u_depth;
uniform mediump int u_hitDetection;

const float PI = 3.141592653589793238;
const float TWO_PI = 2.0 * PI;
float currentLineMetric = 0.; // an actual value will be used in the stroke shaders
`,dn=Wb();class Yf{constructor(){this.uniforms_=[],this.attributes_=[],this.hasSymbol_=!1,this.symbolSizeExpression_=`vec2(${Ur(dn["circle-radius"])} + ${Ur(dn["circle-stroke-width"]*.5)})`,this.symbolRotationExpression_="0.0",this.symbolOffsetExpression_="vec2(0.0)",this.symbolColorExpression_=gs(dn["circle-fill-color"]),this.texCoordExpression_="vec4(0.0, 0.0, 1.0, 1.0)",this.discardExpression_="false",this.symbolRotateWithView_=!1,this.hasStroke_=!1,this.strokeWidthExpression_=Ur(dn["stroke-width"]),this.strokeColorExpression_=gs(dn["stroke-color"]),this.strokeOffsetExpression_="0.",this.strokeCapExpression_=fr("round"),this.strokeJoinExpression_=fr("round"),this.strokeMiterLimitExpression_="10.",this.strokeDistanceFieldExpression_="-1000.",this.hasFill_=!1,this.fillColorExpression_=gs(dn["fill-color"]),this.vertexShaderFunctions_=[],this.fragmentShaderFunctions_=[]}addUniform(e,t){return this.uniforms_.push({name:e,type:t}),this}addAttribute(e,t,r,i){return this.attributes_.push({name:e,type:t,varyingName:e.replace(/^a_/,"v_"),varyingType:i??t,varyingExpression:r??e}),this}setSymbolSizeExpression(e){return this.hasSymbol_=!0,this.symbolSizeExpression_=e,this}getSymbolSizeExpression(){return this.symbolSizeExpression_}setSymbolRotationExpression(e){return this.symbolRotationExpression_=e,this}setSymbolOffsetExpression(e){return this.symbolOffsetExpression_=e,this}getSymbolOffsetExpression(){return this.symbolOffsetExpression_}setSymbolColorExpression(e){return this.hasSymbol_=!0,this.symbolColorExpression_=e,this}getSymbolColorExpression(){return this.symbolColorExpression_}setTextureCoordinateExpression(e){return this.texCoordExpression_=e,this}setFragmentDiscardExpression(e){return this.discardExpression_=e,this}getFragmentDiscardExpression(){return this.discardExpression_}setSymbolRotateWithView(e){return this.symbolRotateWithView_=e,this}setStrokeWidthExpression(e){return this.hasStroke_=!0,this.strokeWidthExpression_=e,this}setStrokeColorExpression(e){return this.hasStroke_=!0,this.strokeColorExpression_=e,this}getStrokeColorExpression(){return this.strokeColorExpression_}setStrokeOffsetExpression(e){return this.strokeOffsetExpression_=e,this}setStrokeCapExpression(e){return this.strokeCapExpression_=e,this}setStrokeJoinExpression(e){return this.strokeJoinExpression_=e,this}setStrokeMiterLimitExpression(e){return this.strokeMiterLimitExpression_=e,this}setStrokeDistanceFieldExpression(e){return this.strokeDistanceFieldExpression_=e,this}setFillColorExpression(e){return this.hasFill_=!0,this.fillColorExpression_=e,this}getFillColorExpression(){return this.fillColorExpression_}addVertexShaderFunction(e){return this.vertexShaderFunctions_.includes(e)?this:(this.vertexShaderFunctions_.push(e),this)}addFragmentShaderFunction(e){return this.fragmentShaderFunctions_.includes(e)?this:(this.fragmentShaderFunctions_.push(e),this)}getSymbolVertexShader(){return this.hasSymbol_?`${fn}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
attribute vec2 a_position;
attribute float a_index;
attribute vec4 a_hitColor;

varying vec2 v_texCoord;
varying vec2 v_quadCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 pxToScreen(vec2 coordPx) {
  vec2 scaled = coordPx / u_viewportSizePx / 0.5;
  return scaled;
}

vec2 screenToPx(vec2 coordScreen) {
  return (coordScreen * 0.5 + 0.5) * u_viewportSizePx;
}

void main(void) {
  v_quadSizePx = ${this.symbolSizeExpression_};
  vec2 halfSizePx = v_quadSizePx * 0.5;
  vec2 centerOffsetPx = ${this.symbolOffsetExpression_};
  vec2 offsetPx = centerOffsetPx;
  if (a_index == 0.0) {
    offsetPx -= halfSizePx;
  } else if (a_index == 1.0) {
    offsetPx += halfSizePx * vec2(1., -1.);
  } else if (a_index == 2.0) {
    offsetPx += halfSizePx;
  } else {
    offsetPx += halfSizePx * vec2(-1., 1.);
  }
  float angle = ${this.symbolRotationExpression_}${this.symbolRotateWithView_?" + u_rotation":""};
  float c = cos(-angle);
  float s = sin(-angle);
  offsetPx = vec2(c * offsetPx.x - s * offsetPx.y, s * offsetPx.x + c * offsetPx.y);
  vec4 center = u_projectionMatrix * vec4(a_position, 0.0, 1.0);
  gl_Position = center + vec4(pxToScreen(offsetPx), u_depth, 0.);
  vec4 texCoord = ${this.texCoordExpression_};
  float u = a_index == 0.0 || a_index == 3.0 ? texCoord.s : texCoord.p;
  float v = a_index == 2.0 || a_index == 3.0 ? texCoord.t : texCoord.q;
  v_texCoord = vec2(u, v);
  v_hitColor = a_hitColor;
  v_angle = angle;
  c = cos(-v_angle);
  s = sin(-v_angle);
  centerOffsetPx = vec2(c * centerOffsetPx.x - s * centerOffsetPx.y, s * centerOffsetPx.x + c * centerOffsetPx.y);
  v_centerPx = screenToPx(center.xy) + centerOffsetPx;
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getSymbolFragmentShader(){return this.hasSymbol_?`${fn}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
varying vec2 v_texCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}
  if (${this.discardExpression_}) { discard; }
  vec2 coordsPx = gl_FragCoord.xy / u_pixelRatio - v_centerPx; // relative to center
  float c = cos(v_angle);
  float s = sin(v_angle);
  coordsPx = vec2(c * coordsPx.x - s * coordsPx.y, s * coordsPx.x + c * coordsPx.y);
  gl_FragColor = ${this.symbolColorExpression_};
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.05) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getStrokeVertexShader(){return this.hasStroke_?`${fn}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
attribute vec2 a_segmentStart;
attribute vec2 a_segmentEnd;
attribute float a_measureStart;
attribute float a_measureEnd;
attribute float a_parameters;
attribute float a_distance;
attribute vec2 a_joinAngles;
attribute vec4 a_hitColor;

varying vec2 v_segmentStart;
varying vec2 v_segmentEnd;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distanceOffsetPx;
varying float v_measureStart;
varying float v_measureEnd;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

vec4 pxToScreen(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return vec4(screenPos, u_depth, 1.0);
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

vec2 getJoinOffsetDirection(vec2 normalPx, float joinAngle) {
  float halfAngle = joinAngle / 2.0;
  float c = cos(halfAngle);
  float s = sin(halfAngle);
  vec2 angleBisectorNormal = vec2(s * normalPx.x + c * normalPx.y, -c * normalPx.x + s * normalPx.y);
  float length = 1.0 / s;
  return angleBisectorNormal * length;
}

vec2 getOffsetPoint(vec2 point, vec2 normal, float joinAngle, float offsetPx) {
  // if on a cap or the join angle is too high, offset the line along the segment normal
  if (cos(joinAngle) > 0.998 || isCap(joinAngle)) {
    return point - normal * offsetPx;
  }
  // offset is applied along the inverted normal (positive offset goes "right" relative to line direction)
  return point - getJoinOffsetDirection(normal, joinAngle) * offsetPx;
}

void main(void) {
  v_angleStart = a_joinAngles.x;
  v_angleEnd = a_joinAngles.y;
  float vertexNumber = floor(abs(a_parameters) / 10000. + 0.5);
  currentLineMetric = vertexNumber < 1.5 ? a_measureStart : a_measureEnd;
  // we're reading the fractional part while keeping the sign (so -4.12 gives -0.12, 3.45 gives 0.45)
  float angleTangentSum = fract(abs(a_parameters) / 10000.) * 10000. * sign(a_parameters);

  float lineWidth = ${this.strokeWidthExpression_};
  float lineOffsetPx = ${this.strokeOffsetExpression_};

  // compute segment start/end in px with offset
  vec2 segmentStartPx = worldToPx(a_segmentStart);
  vec2 segmentEndPx = worldToPx(a_segmentEnd);
  vec2 tangentPx = normalize(segmentEndPx - segmentStartPx);
  vec2 normalPx = vec2(-tangentPx.y, tangentPx.x);
  segmentStartPx = getOffsetPoint(segmentStartPx, normalPx, v_angleStart, lineOffsetPx),
  segmentEndPx = getOffsetPoint(segmentEndPx, normalPx, v_angleEnd, lineOffsetPx);

  // compute current vertex position
  float normalDir = vertexNumber < 0.5 || (vertexNumber > 1.5 && vertexNumber < 2.5) ? 1.0 : -1.0;
  float tangentDir = vertexNumber < 1.5 ? 1.0 : -1.0;
  float angle = vertexNumber < 1.5 ? v_angleStart : v_angleEnd;
  vec2 joinDirection;
  vec2 positionPx = vertexNumber < 1.5 ? segmentStartPx : segmentEndPx;
  // if angle is too high, do not make a proper join
  if (cos(angle) > ${zc} || isCap(angle)) {
    joinDirection = normalPx * normalDir - tangentPx * tangentDir;
  } else {
    joinDirection = getJoinOffsetDirection(normalPx * normalDir, angle);
  }
  positionPx = positionPx + joinDirection * (lineWidth * 0.5 + 1.); // adding 1 pixel for antialiasing
  gl_Position = pxToScreen(positionPx);

  v_segmentStart = segmentStartPx;
  v_segmentEnd = segmentEndPx;
  v_width = lineWidth;
  v_hitColor = a_hitColor;
  v_distanceOffsetPx = a_distance / u_resolution - (lineOffsetPx * angleTangentSum);
  v_measureStart = a_measureStart;
  v_measureEnd = a_measureEnd;
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getStrokeFragmentShader(){return this.hasStroke_?`${fn}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
varying vec2 v_segmentStart;
varying vec2 v_segmentEnd;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distanceOffsetPx;
varying float v_measureStart;
varying float v_measureEnd;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

float segmentDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  vec2 tangent = normalize(end - start);
  vec2 normal = vec2(-tangent.y, tangent.x);
  vec2 startToPoint = point - start;
  return abs(dot(startToPoint, normal)) - width * 0.5;
}

float buttCapDistanceField(vec2 point, vec2 start, vec2 end) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  return dot(startToPoint, -tangent);
}

float squareCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return buttCapDistanceField(point, start, end) - width * 0.5;
}

float roundCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  float onSegment = max(0., 1000. * dot(point - start, end - start)); // this is very high when inside the segment
  return length(point - start) - width * 0.5 - onSegment;
}

float roundJoinDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return roundCapDistanceField(point, start, end, width);
}

float bevelJoinField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  float c = cos(joinAngle * 0.5);
  float s = sin(joinAngle * 0.5);
  float direction = -sign(sin(joinAngle));
  vec2 bisector = vec2(c * tangent.x - s * tangent.y, s * tangent.x + c * tangent.y);
  float radius = width * 0.5 * s;
  return dot(startToPoint, bisector * direction) - radius;
}

float miterJoinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  if (cos(joinAngle) > ${zc}) { // avoid risking a division by zero
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  float miterLength = 1. / sin(joinAngle * 0.5);
  float miterLimit = ${this.strokeMiterLimitExpression_};
  if (miterLength > miterLimit) {
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  return -1000.;
}

float capDistanceField(vec2 point, vec2 start, vec2 end, float width, float capType) {
   if (capType == ${fr("butt")}) {
    return buttCapDistanceField(point, start, end);
  } else if (capType == ${fr("square")}) {
    return squareCapDistanceField(point, start, end, width);
  }
  return roundCapDistanceField(point, start, end, width);
}

float joinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float joinType) {
  if (joinType == ${fr("bevel")}) {
    return bevelJoinField(point, start, end, width, joinAngle);
  } else if (joinType == ${fr("miter")}) {
    return miterJoinDistanceField(point, start, end, width, joinAngle);
  }
  return roundJoinDistanceField(point, start, end, width);
}

float computeSegmentPointDistance(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float capType, float joinType) {
  if (isCap(joinAngle)) {
    return capDistanceField(point, start, end, width, capType);
  }
  return joinDistanceField(point, start, end, width, joinAngle, joinType);
}

float distanceFromSegment(vec2 point, vec2 start, vec2 end) {
  vec2 tangent = end - start;
  vec2 startToPoint = point - start;
  // inspire by capsule fn in https://iquilezles.org/articles/distfunctions/
  float h = clamp(dot(startToPoint, tangent) / dot(tangent, tangent), 0.0, 1.0);
  return length(startToPoint - tangent * h);
}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}

  vec2 currentPoint = gl_FragCoord.xy / u_pixelRatio;
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(currentPoint);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif

  float segmentLength = length(v_segmentEnd - v_segmentStart);
  vec2 segmentTangent = (v_segmentEnd - v_segmentStart) / segmentLength;
  vec2 segmentNormal = vec2(-segmentTangent.y, segmentTangent.x);
  vec2 startToPoint = currentPoint - v_segmentStart;
  float lengthToPoint = max(0., min(dot(segmentTangent, startToPoint), segmentLength));
  float currentLengthPx = lengthToPoint + v_distanceOffsetPx;
  float currentRadiusPx = distanceFromSegment(currentPoint, v_segmentStart, v_segmentEnd);
  float currentRadiusRatio = dot(segmentNormal, startToPoint) * 2. / v_width;
  currentLineMetric = mix(
    v_measureStart,
    v_measureEnd,
    lengthToPoint / max(segmentLength, 1.17549429e-38)
  );

  if (${this.discardExpression_}) { discard; }

  float capType = ${this.strokeCapExpression_};
  float joinType = ${this.strokeJoinExpression_};
  float segmentStartDistance = computeSegmentPointDistance(currentPoint, v_segmentStart, v_segmentEnd, v_width, v_angleStart, capType, joinType);
  float segmentEndDistance = computeSegmentPointDistance(currentPoint, v_segmentEnd, v_segmentStart, v_width, v_angleEnd, capType, joinType);
  float distanceField = max(
    segmentDistanceField(currentPoint, v_segmentStart, v_segmentEnd, v_width),
    max(segmentStartDistance, segmentEndDistance)
  );
  distanceField = max(distanceField, ${this.strokeDistanceFieldExpression_});

  vec4 color = ${this.strokeColorExpression_};
  color.a *= smoothstep(0.5, -0.5, distanceField);
  gl_FragColor = color;
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getFillVertexShader(){return this.hasFill_?`${fn}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
attribute vec2 a_position;
attribute vec4 a_hitColor;

varying vec4 v_hitColor;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
void main(void) {
  gl_Position = u_projectionMatrix * vec4(a_position, u_depth, 1.0);
  v_hitColor = a_hitColor;
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getFillFragmentShader(){return this.hasFill_?`${fn}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
varying vec4 v_hitColor;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}
vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}
  vec2 pxPos = gl_FragCoord.xy / u_pixelRatio;
  vec2 pxOrigin = worldToPx(u_patternOrigin);
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(pxPos);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif
  if (${this.discardExpression_}) { discard; }
  gl_FragColor = ${this.fillColorExpression_};
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}}function H(n,e,t){const r=uf();return Vb(e,t,r,n)}function Zb(n){const e=Di(n),t=e[0]*256,r=e[1],i=e[2]*256,s=Math.round(e[3]*255);return[t+r,i+s]}const qb=`vec4 unpackColor(vec2 packedColor) {
  return vec4(
    fract(floor(packedColor[0] / 256.0) / 256.0),
    fract(packedColor[0] / 256.0),
    fract(floor(packedColor[1] / 256.0) / 256.0),
    fract(packedColor[1] / 256.0)
  );
}`;function zl(n){return n===gt||n===ln?2:n===sn?4:1}function Na(n){const e=zl(n);return e>1?`vec${e}`:"float"}function Kf(n,e){for(const t in e.variables){const r=e.variables[t],i=mo(r.name);let s=Na(r.type);r.type===gt&&(s="vec4"),n.addUniform(i,s)}for(const t in e.properties){const r=e.properties[t],i=Na(r.type),s=`a_prop_${r.name}`;r.type===gt?(n.addAttribute(s,i,`unpackColor(${s})`,"vec4"),n.addVertexShaderFunction(qb)):n.addAttribute(s,i)}for(const t in e.functions)n.addVertexShaderFunction(e.functions[t]),n.addFragmentShaderFunction(e.functions[t])}function Jf(n,e){const t={};for(const r in n.variables){const i=n.variables[r],s=mo(i.name);t[s]=()=>{const o=e[i.name];if(typeof o=="number")return o;if(typeof o=="boolean")return o?1:0;if(i.type===gt){const a=[...Di(o||"#eee")];return a[0]/=255,a[1]/=255,a[2]/=255,a[3]??(a[3]=1),a}return typeof o=="string"?On(o):o}}return t}function Qf(n){const e={};for(const t in n.properties){const r=n.properties[t],i=s=>{const o=s.get(r.name);return r.type===gt?Zb([...Di(o||"#eee")]):typeof o=="string"?On(o):typeof o=="boolean"?o?1:0:o};e[`prop_${r.name}`]={size:zl(r.type),callback:i}}return e}class Ds{constructor(){this.globalCounter_=0,this.refToFeature_=new Map,this.uidToRef_=new Map,this.freeGlobalRef_=[],this.polygonBatch={entries:{},geometriesCount:0,verticesCount:0,ringsCount:0},this.pointBatch={entries:{},geometriesCount:0},this.lineStringBatch={entries:{},geometriesCount:0,verticesCount:0}}addFeatures(e,t){for(let r=0;r<e.length;r++)this.addFeature(e[r],t)}addFeature(e,t){let r=e.getGeometry();r&&(t&&(r=r.clone(),r.applyTransform(t)),this.addGeometry_(r,e))}clearFeatureEntryInPointBatch_(e){const t=me(e),r=this.pointBatch.entries[t];if(r)return this.pointBatch.geometriesCount-=r.flatCoordss.length,delete this.pointBatch.entries[t],r}clearFeatureEntryInLineStringBatch_(e){const t=me(e),r=this.lineStringBatch.entries[t];if(r)return this.lineStringBatch.verticesCount-=r.verticesCount,this.lineStringBatch.geometriesCount-=r.flatCoordss.length,delete this.lineStringBatch.entries[t],r}clearFeatureEntryInPolygonBatch_(e){const t=me(e),r=this.polygonBatch.entries[t];if(r)return this.polygonBatch.verticesCount-=r.verticesCount,this.polygonBatch.ringsCount-=r.ringsCount,this.polygonBatch.geometriesCount-=r.flatCoordss.length,delete this.polygonBatch.entries[t],r}addGeometry_(e,t){var i;const r=e.getType();switch(r){case"GeometryCollection":{const s=e.getGeometriesArray();for(const o of s)this.addGeometry_(o,t);break}case"MultiPolygon":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEndss(),t,me(t),s.getStride());break}case"MultiLineString":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEnds(),t,me(t),s.getStride());break}case"MultiPoint":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),null,t,me(t),s.getStride());break}case"Polygon":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEnds(),t,me(t),s.getStride());break}case"Point":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),null,t,me(t),s.getStride());break}case"LineString":case"LinearRing":{const s=e,o=s.getStride();this.addCoordinates_(r,s.getFlatCoordinates(),null,t,me(t),o,(i=s.getLayout)==null?void 0:i.call(s));break}}}addCoordinates_(e,t,r,i,s,o,a){let l;switch(e){case"MultiPolygon":{const u=r;for(let h=0,c=u.length;h<c;h++){let f=u[h];const p=h>0?u[h-1]:null,d=p?p[p.length-1]:0,g=f[f.length-1];f=d>0?f.map(m=>m-d):f,this.addCoordinates_("Polygon",t.slice(d,g),f,i,s,o,a)}break}case"MultiLineString":{const u=r;for(let h=0,c=u.length;h<c;h++){const f=h>0?u[h-1]:0;this.addCoordinates_("LineString",t.slice(f,u[h]),null,i,s,o,a)}break}case"MultiPoint":for(let u=0,h=t.length;u<h;u+=o)this.addCoordinates_("Point",t.slice(u,u+2),null,i,s,null,null);break;case"Polygon":{const u=r;if(i instanceof Qh){const f=ug(t,u);if(f.length>1){this.addCoordinates_("MultiPolygon",t,f,i,s,o,a);return}}this.polygonBatch.entries[s]||(this.polygonBatch.entries[s]=this.addRefToEntry_(s,{feature:i,flatCoordss:[],verticesCount:0,ringsCount:0,ringsVerticesCounts:[]})),l=t.length/o;const h=r.length,c=r.map((f,p,d)=>p>0?(f-d[p-1])/o:f/o);this.polygonBatch.verticesCount+=l,this.polygonBatch.ringsCount+=h,this.polygonBatch.geometriesCount++,this.polygonBatch.entries[s].flatCoordss.push(Hb(t,o)),this.polygonBatch.entries[s].ringsVerticesCounts.push(c),this.polygonBatch.entries[s].verticesCount+=l,this.polygonBatch.entries[s].ringsCount+=h;for(let f=0,p=u.length;f<p;f++){const d=f>0?u[f-1]:0;this.addCoordinates_("LinearRing",t.slice(d,u[f]),null,i,s,o,a)}break}case"Point":this.pointBatch.entries[s]||(this.pointBatch.entries[s]=this.addRefToEntry_(s,{feature:i,flatCoordss:[]})),this.pointBatch.geometriesCount++,this.pointBatch.entries[s].flatCoordss.push(t);break;case"LineString":case"LinearRing":this.lineStringBatch.entries[s]||(this.lineStringBatch.entries[s]=this.addRefToEntry_(s,{feature:i,flatCoordss:[],verticesCount:0})),l=t.length/o,this.lineStringBatch.verticesCount+=l,this.lineStringBatch.geometriesCount++,this.lineStringBatch.entries[s].flatCoordss.push(Yb(t,o,a)),this.lineStringBatch.entries[s].verticesCount+=l;break}}addRefToEntry_(e,t){const r=this.uidToRef_.get(e),i=r||this.freeGlobalRef_.pop()||++this.globalCounter_;return t.ref=i,r||(this.refToFeature_.set(i,t.feature),this.uidToRef_.set(e,i)),t}removeRef_(e,t){if(!e)throw new Error("This feature has no ref: "+t);this.refToFeature_.delete(e),this.uidToRef_.delete(t),this.freeGlobalRef_.push(e)}changeFeature(e,t){if(!this.uidToRef_.get(me(e)))return;this.removeFeature(e);let r=e.getGeometry();r&&(t&&(r=r.clone(),r.applyTransform(t)),this.addGeometry_(r,e))}removeFeature(e){let t=this.clearFeatureEntryInPointBatch_(e);t=this.clearFeatureEntryInPolygonBatch_(e)||t,t=this.clearFeatureEntryInLineStringBatch_(e)||t,t&&this.removeRef_(t.ref,me(t.feature))}clear(){this.polygonBatch.entries={},this.polygonBatch.geometriesCount=0,this.polygonBatch.verticesCount=0,this.polygonBatch.ringsCount=0,this.lineStringBatch.entries={},this.lineStringBatch.geometriesCount=0,this.lineStringBatch.verticesCount=0,this.pointBatch.entries={},this.pointBatch.geometriesCount=0,this.globalCounter_=0,this.freeGlobalRef_=[],this.refToFeature_.clear(),this.uidToRef_.clear()}getFeatureFromRef(e){return this.refToFeature_.get(e)}isEmpty(){return this.globalCounter_===0}filter(e){const t=new Ds;t.globalCounter_=this.globalCounter_,t.uidToRef_=this.uidToRef_,t.refToFeature_=this.refToFeature_;let r=!0;for(const i of this.refToFeature_.values())e(i)&&(t.addFeature(i),r=!1);return r?new Ds:t}}function Hb(n,e){return e===2?n:n.filter((t,r)=>r%e<2)}function Yb(n,e,t){return e===3&&t==="XYM"?n:e===4?n.filter((r,i)=>i%e!==2):e===3?n.map((r,i)=>i%e!==2?r:0):new Array(n.length*1.5).fill(0).map((r,i)=>i%3===2?0:n[Math.round(i/1.5)])}function ed(){const n='function t(t,n,x=2){const o=n&&n.length,i=o?n[0]*x:t.length;let u=e(t,0,i,x,!0);const l=[];if(!u||u.next===u.prev)return l;let c,h,y;if(o&&(u=function(t,n,r,x){const o=[];for(let r=0,i=n.length;r<i;r++){const u=e(t,n[r]*x,r<i-1?n[r+1]*x:t.length,x,!1);u===u.next&&(u.steiner=!0),o.push(a(u))}o.sort(f);for(let t=0;t<o.length;t++)r=s(o[t],r);return r}(t,n,u,x)),t.length>80*x){c=1/0,h=1/0;let e=-1/0,n=-1/0;for(let r=x;r<i;r+=x){const x=t[r],o=t[r+1];x<c&&(c=x),o<h&&(h=o),x>e&&(e=x),o>n&&(n=o)}y=Math.max(e-c,n-h),y=0!==y?32767/y:0}return r(u,l,x,c,h,y,0),l}function e(t,e,n,r,x){let o;if(x===function(t,e,n,r){let x=0;for(let o=e,i=n-r;o<n;o+=r)x+=(t[i]-t[o])*(t[o+1]+t[i+1]),i=o;return x}(t,e,n,r)>0)for(let x=e;x<n;x+=r)o=w(x/r|0,t[x],t[x+1],o);else for(let x=n-r;x>=e;x-=r)o=w(x/r|0,t[x],t[x+1],o);return o&&g(o,o.next)&&(A(o),o=o.next),o}function n(t,e){if(!t)return t;e||(e=t);let n,r=t;do{if(n=!1,r.steiner||!g(r,r.next)&&0!==v(r.prev,r,r.next))r=r.next;else{if(A(r),r=e=r.prev,r===r.next)break;n=!0}}while(n||r!==e);return e}function r(t,e,f,s,l,a,h){if(!t)return;!h&&a&&function(t,e,n,r){let x=t;do{0===x.z&&(x.z=c(x.x,x.y,e,n,r)),x.prevZ=x.prev,x.nextZ=x.next,x=x.next}while(x!==t);x.prevZ.nextZ=null,x.prevZ=null,function(t){let e,n=1;do{let r,x=t;t=null;let o=null;for(e=0;x;){e++;let i=x,u=0;for(let t=0;t<n&&(u++,i=i.nextZ,i);t++);let f=n;for(;u>0||f>0&&i;)0!==u&&(0===f||!i||x.z<=i.z)?(r=x,x=x.nextZ,u--):(r=i,i=i.nextZ,f--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;x=i}o.nextZ=null,n*=2}while(e>1)}(x)}(t,s,l,a);let y=t;for(;t.prev!==t.next;){const c=t.prev,p=t.next;if(a?o(t,s,l,a):x(t))e.push(c.i,t.i,p.i),A(t),t=p.next,y=p.next;else if((t=p)===y){h?1===h?r(t=i(n(t),e),e,f,s,l,a,2):2===h&&u(t,e,f,s,l,a):r(n(t),e,f,s,l,a,1);break}}}function x(t){const e=t.prev,n=t,r=t.next;if(v(e,n,r)>=0)return!1;const x=e.x,o=n.x,i=r.x,u=e.y,f=n.y,s=r.y,l=Math.min(x,o,i),c=Math.min(u,f,s),a=Math.max(x,o,i),h=Math.max(u,f,s);let p=r.next;for(;p!==e;){if(p.x>=l&&p.x<=a&&p.y>=c&&p.y<=h&&y(x,u,o,f,i,s,p.x,p.y)&&v(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function o(t,e,n,r){const x=t.prev,o=t,i=t.next;if(v(x,o,i)>=0)return!1;const u=x.x,f=o.x,s=i.x,l=x.y,a=o.y,h=i.y,p=Math.min(u,f,s),g=Math.min(l,a,h),b=Math.max(u,f,s),M=Math.max(l,a,h),m=c(p,g,e,n,r),Z=c(b,M,e,n,r);let d=t.prevZ,w=t.nextZ;for(;d&&d.z>=m&&w&&w.z<=Z;){if(d.x>=p&&d.x<=b&&d.y>=g&&d.y<=M&&d!==x&&d!==i&&y(u,l,f,a,s,h,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;if(d=d.prevZ,w.x>=p&&w.x<=b&&w.y>=g&&w.y<=M&&w!==x&&w!==i&&y(u,l,f,a,s,h,w.x,w.y)&&v(w.prev,w,w.next)>=0)return!1;w=w.nextZ}for(;d&&d.z>=m;){if(d.x>=p&&d.x<=b&&d.y>=g&&d.y<=M&&d!==x&&d!==i&&y(u,l,f,a,s,h,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;d=d.prevZ}for(;w&&w.z<=Z;){if(w.x>=p&&w.x<=b&&w.y>=g&&w.y<=M&&w!==x&&w!==i&&y(u,l,f,a,s,h,w.x,w.y)&&v(w.prev,w,w.next)>=0)return!1;w=w.nextZ}return!0}function i(t,e){let r=t;do{const n=r.prev,x=r.next.next;!g(n,x)&&b(n,r,r.next,x)&&Z(n,x)&&Z(x,n)&&(e.push(n.i,r.i,x.i),A(r),A(r.next),r=t=x),r=r.next}while(r!==t);return n(r)}function u(t,e,x,o,i,u){let f=t;do{let t=f.next.next;for(;t!==f.prev;){if(f.i!==t.i&&p(f,t)){let s=d(f,t);return f=n(f,f.next),s=n(s,s.next),r(f,e,x,o,i,u,0),void r(s,e,x,o,i,u,0)}t=t.next}f=f.next}while(f!==t)}function f(t,e){let n=t.x-e.x;if(0===n&&(n=t.y-e.y,0===n)){n=(t.next.y-t.y)/(t.next.x-t.x)-(e.next.y-e.y)/(e.next.x-e.x)}return n}function s(t,e){const r=function(t,e){let n=e;const r=t.x,x=t.y;let o,i=-1/0;if(g(t,n))return n;do{if(g(t,n.next))return n.next;if(x<=n.y&&x>=n.next.y&&n.next.y!==n.y){const t=n.x+(x-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(t<=r&&t>i&&(i=t,o=n.x<n.next.x?n:n.next,t===r))return o}n=n.next}while(n!==e);if(!o)return null;const u=o,f=o.x,s=o.y;let c=1/0;n=o;do{if(r>=n.x&&n.x>=f&&r!==n.x&&h(x<s?r:i,x,f,s,x<s?i:r,x,n.x,n.y)){const e=Math.abs(x-n.y)/(r-n.x);Z(n,t)&&(e<c||e===c&&(n.x>o.x||n.x===o.x&&l(o,n)))&&(o=n,c=e)}n=n.next}while(n!==u);return o}(t,e);if(!r)return e;const x=d(r,t);return n(x,x.next),n(r,r.next)}function l(t,e){return v(t.prev,t,e.prev)<0&&v(e.next,t,t.next)<0}function c(t,e,n,r,x){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*x|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*x|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function a(t){let e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function h(t,e,n,r,x,o,i,u){return(x-i)*(e-u)>=(t-i)*(o-u)&&(t-i)*(r-u)>=(n-i)*(e-u)&&(n-i)*(o-u)>=(x-i)*(r-u)}function y(t,e,n,r,x,o,i,u){return!(t===i&&e===u)&&h(t,e,n,r,x,o,i,u)}function p(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&b(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(Z(t,e)&&Z(e,t)&&function(t,e){let n=t,r=!1;const x=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&x<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(v(t.prev,t,e.prev)||v(t,e.prev,e))||g(t,e)&&v(t.prev,t,t.next)>0&&v(e.prev,e,e.next)>0)}function v(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function g(t,e){return t.x===e.x&&t.y===e.y}function b(t,e,n,r){const x=m(v(t,e,n)),o=m(v(t,e,r)),i=m(v(n,r,t)),u=m(v(n,r,e));return x!==o&&i!==u||(!(0!==x||!M(t,n,e))||(!(0!==o||!M(t,r,e))||(!(0!==i||!M(n,t,r))||!(0!==u||!M(n,e,r)))))}function M(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function m(t){return t>0?1:t<0?-1:0}function Z(t,e){return v(t.prev,t,t.next)<0?v(t,e,t.next)>=0&&v(t,t.prev,e)>=0:v(t,e,t.prev)<0||v(t,t.next,e)<0}function d(t,e){const n=E(t.i,t.x,t.y),r=E(e.i,e.x,e.y),x=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=x,x.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function w(t,e,n,r){const x=E(t,e,n);return r?(x.next=r.next,x.prev=r,r.next.prev=x,r.next=x):(x.prev=x,x.next=x),x}function A(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function E(t,e,n){return{i:t,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function I(t,e){const n=e[0],r=e[1];return e[0]=t[0]*n+t[2]*r+t[4],e[1]=t[1]*n+t[3]*r+t[5],e}function z(t,e){const n=(r=e)[0]*r[3]-r[1]*r[2];var r;!function(t,e){if(!t)throw new Error(e)}(0!==n,"Transformation matrix cannot be inverted");const x=e[0],o=e[1],i=e[2],u=e[3],f=e[4],s=e[5];return t[0]=u/n,t[1]=-o/n,t[2]=-i/n,t[3]=x/n,t[4]=(i*s-u*f)/n,t[5]=-(x*s-o*f)/n,t}new Array(6);const F=[],P={vertexPosition:0,indexPosition:0};function B(t,e,n,r,x){t[e+0]=n,t[e+1]=r,t[e+2]=x}function N(t,e,n,r,x,o){const i=3+x,u=t[e+0],f=t[e+1],s=F;s.length=x;for(let n=0;n<s.length;n++)s[n]=t[e+2+n];let l=o?o.vertexPosition:0,c=o?o.indexPosition:0;const a=l/i;return B(n,l,u,f,0),s.length&&n.set(s,l+3),l+=i,B(n,l,u,f,1),s.length&&n.set(s,l+3),l+=i,B(n,l,u,f,2),s.length&&n.set(s,l+3),l+=i,B(n,l,u,f,3),s.length&&n.set(s,l+3),l+=i,r[c++]=a,r[c++]=a+1,r[c++]=a+3,r[c++]=a+1,r[c++]=a+2,r[c++]=a+3,P.vertexPosition=l,P.indexPosition=c,P}function R(t,e,n,r,x,o,i,u,f,s,l){const c=10+u.length,a=o.length/c,h=[t[e+0],t[e+1]],y=[t[n],t[n+1]],p=t[e+2],v=t[n+2],g=I(f,[...h]),b=I(f,[...y]);function M(t,e,n){const r=Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])),x=[(e[0]-t[0])/r,(e[1]-t[1])/r],o=[-x[1],x[0]],i=Math.sqrt((n[0]-t[0])*(n[0]-t[0])+(n[1]-t[1])*(n[1]-t[1])),u=[(n[0]-t[0])/i,(n[1]-t[1])/i],f=0===r||0===i?0:Math.acos((s=u[0]*x[0]+u[1]*x[1],l=-1,c=1,Math.min(Math.max(s,l),c)));var s,l,c;return u[0]*o[0]+u[1]*o[1]>0?f:2*Math.PI-f}let m=-1,Z=-1,d=l;const w=null!==x;if(null!==r){m=M(g,b,I(f,[...[t[r],t[r+1]]])),Math.cos(m)<=.985&&(d+=Math.tan((m-Math.PI)/2))}if(w){Z=M(b,g,I(f,[...[t[x],t[x+1]]])),Math.cos(Z)<=.985&&(d+=Math.tan((Math.PI-Z)/2))}function A(t,e){return 0===e?1e4*t:Math.sign(e)*(1e4*t+Math.abs(e))}return o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(0,l)),o.push(...u),o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(1,l)),o.push(...u),o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(2,l)),o.push(...u),o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(3,l)),o.push(...u),i.push(a,a+1,a+2,a+1,a+3,a+2),{length:s+Math.sqrt((b[0]-g[0])*(b[0]-g[0])+(b[1]-g[1])*(b[1]-g[1])),angle:d}}function S(e,n,r,x,o){const i=2+o;let u=n;const f=e.slice(u,u+o);u+=o;const s=e[u++];let l=0;const c=new Array(s-1);for(let t=0;t<s;t++)l+=e[u++],t<s-1&&(c[t]=l);const a=e.slice(u,u+2*l),h=t(a,c,2);for(let t=0;t<h.length;t++)x.push(h[t]+r.length/i);for(let t=0;t<a.length;t+=2)r.push(a[t],a[t+1],...f);return u+2*l}const T="GENERATE_POLYGON_BUFFERS",_="GENERATE_POINT_BUFFERS",O="GENERATE_LINE_STRING_BUFFERS",U=self;U.onmessage=t=>{const e=t.data;switch(e.type){case _:{const t=3,n=2,r=e.customAttributesSize,x=n+r,o=new Float32Array(e.renderInstructions),i=o.length/x,u=4*i*(r+t),f=new Uint32Array(6*i),s=new Float32Array(u);let l;for(let t=0;t<o.length;t+=x)l=N(o,t,s,f,r,l);const c=Object.assign({vertexBuffer:s.buffer,indexBuffer:f.buffer,renderInstructions:o.buffer},e);U.postMessage(c,[s.buffer,f.buffer,o.buffer]);break}case O:{const t=[],n=[],r=e.customAttributesSize,x=3,o=new Float32Array(e.renderInstructions);let i=0;const u=[1,0,0,1,0,0];let f,s;for(z(u,e.renderInstructionsTransform);i<o.length;){s=Array.from(o.slice(i,i+r)),i+=r,f=o[i++];const e=i,l=i+(f-1)*x,c=o[e]===o[l]&&o[e+1]===o[l+1];let a=0,h=0;for(let r=0;r<f-1;r++){let y=null;r>0?y=i+(r-1)*x:c&&(y=l-x);let p=null;r<f-2?p=i+(r+2)*x:c&&(p=e+x);const v=R(o,i+r*x,i+(r+1)*x,y,p,t,n,s,u,a,h);a=v.length,h=v.angle}i+=f*x}const l=Uint32Array.from(n),c=Float32Array.from(t),a=Object.assign({vertexBuffer:c.buffer,indexBuffer:l.buffer,renderInstructions:o.buffer},e);U.postMessage(a,[c.buffer,l.buffer,o.buffer]);break}case T:{const t=[],n=[],r=e.customAttributesSize,x=new Float32Array(e.renderInstructions);let o=0;for(;o<x.length;)o=S(x,o,t,n,r);const i=Uint32Array.from(n),u=Float32Array.from(t),f=Object.assign({vertexBuffer:u.buffer,indexBuffer:i.buffer,renderInstructions:x.buffer},e);U.postMessage(f,[u.buffer,i.buffer,x.buffer]);break}}};';return new Worker(typeof Blob>"u"?"data:application/javascript;base64,"+Buffer.from(n,"binary").toString("base64"):URL.createObjectURL(new Blob([n],{type:"application/javascript"})))}const ui={GENERATE_POLYGON_BUFFERS:"GENERATE_POLYGON_BUFFERS",GENERATE_POINT_BUFFERS:"GENERATE_POINT_BUFFERS",GENERATE_LINE_STRING_BUFFERS:"GENERATE_LINE_STRING_BUFFERS"};function td(n,e){e=e||[];const t=256,r=t-1;return e[0]=Math.floor(n/t/t/t)/r,e[1]=Math.floor(n/t/t)%t/r,e[2]=Math.floor(n/t)%t/r,e[3]=n%t/r,e}function rd(n){let e=0;const t=256,r=t-1;return e+=Math.round(n[0]*t*t*t*r),e+=Math.round(n[1]*t*t*r),e+=Math.round(n[2]*t*r),e+=Math.round(n[3]*r),e}function kl(n,e,t,r){let i=0;for(const s in e){const o=e[s],a=o.callback.call(t,t.feature);let l=(a==null?void 0:a[0])??a;l===Oa&&console.warn('The "has" operator might return false positives.'),l===void 0?l=Oa:l===null&&(l=0),n[r+i++]=l,!(!o.size||o.size===1)&&(n[r+i++]=a[1],!(o.size<3)&&(n[r+i++]=a[2],!(o.size<4)&&(n[r+i++]=a[3])))}return i}function yo(n){return Object.keys(n).reduce((e,t)=>e+(n[t].size||1),0)}function Kb(n,e,t,r){const i=(2+yo(t))*n.geometriesCount;(!e||e.length!==i)&&(e=new Float32Array(i));const s=[];let o=0;for(const a in n.entries){const l=n.entries[a];for(let u=0,h=l.flatCoordss.length;u<h;u++)s[0]=l.flatCoordss[u][0],s[1]=l.flatCoordss[u][1],_r(r,s),e[o++]=s[0],e[o++]=s[1],o+=kl(e,t,l,o)}return e}function Jb(n,e,t,r){const i=3*n.verticesCount+(1+yo(t))*n.geometriesCount;(!e||e.length!==i)&&(e=new Float32Array(i));const s=[];let o=0;for(const a in n.entries){const l=n.entries[a];for(let u=0,h=l.flatCoordss.length;u<h;u++){s.length=l.flatCoordss[u].length,ef(l.flatCoordss[u],0,s.length,3,r,s,3),o+=kl(e,t,l,o),e[o++]=s.length/3;for(let c=0,f=s.length;c<f;c+=3)e[o++]=s[c],e[o++]=s[c+1],e[o++]=s[c+2]}}return e}function Qb(n,e,t,r){const i=2*n.verticesCount+(1+yo(t))*n.geometriesCount+n.ringsCount;(!e||e.length!==i)&&(e=new Float32Array(i));const s=[];let o=0;for(const a in n.entries){const l=n.entries[a];for(let u=0,h=l.flatCoordss.length;u<h;u++){s.length=l.flatCoordss[u].length,ef(l.flatCoordss[u],0,s.length,2,r,s),o+=kl(e,t,l,o),e[o++]=l.ringsVerticesCounts[u].length;for(let c=0,f=l.ringsVerticesCounts[u].length;c<f;c++)e[o++]=l.ringsVerticesCounts[u][c];for(let c=0,f=s.length;c<f;c+=2)e[o++]=s[c],e[o++]=s[c+1]}}return e}function Us(n){return(JSON.stringify(n).split("").reduce((t,r)=>(t<<5)-t+r.charCodeAt(0),0)>>>0).toString()}function $l(n,e,t,r){if(`${r}radius`in n&&r!=="icon-"){let i=H(t,n[`${r}radius`],ye);if(`${r}radius2`in n){const s=H(t,n[`${r}radius2`],ye);i=`max(${i}, ${s})`}`${r}stroke-width`in n&&(i=`(${i} + ${H(t,n[`${r}stroke-width`],ye)} * 0.5)`),e.setSymbolSizeExpression(`vec2(${i} * 2. + 0.5)`)}if(`${r}scale`in n){const i=H(t,n[`${r}scale`],ln);e.setSymbolSizeExpression(`${e.getSymbolSizeExpression()} * ${i}`)}`${r}displacement`in n&&e.setSymbolOffsetExpression(H(t,n[`${r}displacement`],sn)),`${r}rotation`in n&&e.setSymbolRotationExpression(H(t,n[`${r}rotation`],ye)),`${r}rotate-with-view`in n&&e.setSymbolRotateWithView(!!n[`${r}rotate-with-view`])}function nd(n,e,t,r,i){let s="vec4(0.)";if(e!==null&&(s=e),t!==null&&r!==null){const l=`smoothstep(-${r} + 0.63, -${r} - 0.58, ${n})`;s=`mix(${t}, ${s}, ${l})`}const o=`(1.0 - smoothstep(-0.63, 0.58, ${n}))`;let a=`${s} * vec4(1.0, 1.0, 1.0, ${o})`;return i!==null&&(a=`${a} * vec4(1.0, 1.0, 1.0, ${i})`),a}function jl(n,e,t,r,i){const s=new Image;s.crossOrigin=n[`${r}cross-origin`]===void 0?"anonymous":n[`${r}cross-origin`],Mt(typeof n[`${r}src`]=="string",`WebGL layers do not support expressions for the ${r}src style property`),s.src=n[`${r}src`],t[`u_texture${i}_size`]=()=>s.complete?[s.width,s.height]:[0,0],e.addUniform(`u_texture${i}_size`,"vec2");const o=`u_texture${i}_size`;return t[`u_texture${i}`]=s,e.addUniform(`u_texture${i}`,"sampler2D"),o}function Vl(n,e,t,r,i){let s=H(t,n[`${e}offset`],ln);if(`${e}offset-origin`in n)switch(n[`${e}offset-origin`]){case"top-right":s=`vec2(${r}.x, 0.) + ${i} * vec2(-1., 0.) + ${s} * vec2(-1., 1.)`;break;case"bottom-left":s=`vec2(0., ${r}.y) + ${i} * vec2(0., -1.) + ${s} * vec2(1., -1.)`;break;case"bottom-right":s=`${r} - ${i} - ${s}`;break}return s}function ex(n,e,t,r){r.functions.circleDistanceField=`float circleDistanceField(vec2 point, float radius) {
  return length(point) - radius;
}`,$l(n,e,r,"circle-");let i=null;"circle-opacity"in n&&(i=H(r,n["circle-opacity"],ye));let s="coordsPx";"circle-scale"in n&&(s=`coordsPx / ${H(r,n["circle-scale"],ln)}`);let o=null;"circle-fill-color"in n&&(o=H(r,n["circle-fill-color"],gt));let a=null;"circle-stroke-color"in n&&(a=H(r,n["circle-stroke-color"],gt));let l=H(r,n["circle-radius"],ye),u=null;"circle-stroke-width"in n&&(u=H(r,n["circle-stroke-width"],ye),l=`(${l} + ${u} * 0.5)`);const h=`circleDistanceField(${s}, ${l})`,c=nd(h,o,a,u,i);e.setSymbolColorExpression(c)}function tx(n,e,t,r){r.functions.round=`float round(float v) {
  return sign(v) * floor(abs(v) + 0.5);
}`,r.functions.starDistanceField=`float starDistanceField(vec2 point, float numPoints, float radius, float radius2, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round(beta / alpha) * alpha; // angle in sector
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  vec2 tipToPoint = inSector + vec2(-radius, 0.);
  vec2 edgeNormal = vec2(radius2 * sin(alpha * 0.5), -radius2 * cos(alpha * 0.5) + radius);
  return dot(normalize(edgeNormal), tipToPoint);
}`,r.functions.regularDistanceField=`float regularDistanceField(vec2 point, float numPoints, float radius, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float radiusIn = radius * cos(PI / numPoints);
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round((beta - alpha * 0.5) / alpha) * alpha + alpha * 0.5; // angle in sector from mid
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  return inSector.x - radiusIn;
}`,$l(n,e,r,"shape-");let i=null;"shape-opacity"in n&&(i=H(r,n["shape-opacity"],ye));let s="coordsPx";"shape-scale"in n&&(s=`coordsPx / ${H(r,n["shape-scale"],ln)}`);let o=null;"shape-fill-color"in n&&(o=H(r,n["shape-fill-color"],gt));let a=null;"shape-stroke-color"in n&&(a=H(r,n["shape-stroke-color"],gt));let l=null;"shape-stroke-width"in n&&(l=H(r,n["shape-stroke-width"],ye));const u=H(r,n["shape-points"],ye);let h="0.";"shape-angle"in n&&(h=H(r,n["shape-angle"],ye));let c,f=H(r,n["shape-radius"],ye);if(l!==null&&(f=`${f} + ${l} * 0.5`),"shape-radius2"in n){let d=H(r,n["shape-radius2"],ye);l!==null&&(d=`${d} + ${l} * 0.5`),c=`starDistanceField(${s}, ${u}, ${f}, ${d}, ${h})`}else c=`regularDistanceField(${s}, ${u}, ${f}, ${h})`;const p=nd(c,o,a,l,i);e.setSymbolColorExpression(p)}function rx(n,e,t,r){let i="vec4(1.0)";"icon-color"in n&&(i=H(r,n["icon-color"],gt)),"icon-opacity"in n&&(i=`${i} * vec4(1.0, 1.0, 1.0, ${H(r,n["icon-opacity"],ye)})`);const s=Us(n["icon-src"]),o=jl(n,e,t,"icon-",s);if(e.setSymbolColorExpression(`${i} * texture2D(u_texture${s}, v_texCoord)`).setSymbolSizeExpression(o),"icon-width"in n&&"icon-height"in n&&e.setSymbolSizeExpression(`vec2(${H(r,n["icon-width"],ye)}, ${H(r,n["icon-height"],ye)})`),"icon-offset"in n&&"icon-size"in n){const a=H(r,n["icon-size"],sn),l=e.getSymbolSizeExpression();e.setSymbolSizeExpression(a);const u=Vl(n,"icon-",r,"v_quadSizePx",a);e.setTextureCoordinateExpression(`(vec4((${u}).xyxy) + vec4(0., 0., ${a})) / (${l}).xyxy`)}if($l(n,e,r,"icon-"),"icon-anchor"in n){const a=H(r,n["icon-anchor"],sn);let l="1.0";"icon-scale"in n&&(l=H(r,n["icon-scale"],ln));let u;n["icon-anchor-x-units"]==="pixels"&&n["icon-anchor-y-units"]==="pixels"?u=`${a} * ${l}`:n["icon-anchor-x-units"]==="pixels"?u=`${a} * vec2(vec2(${l}).x, v_quadSizePx.y)`:n["icon-anchor-y-units"]==="pixels"?u=`${a} * vec2(v_quadSizePx.x, vec2(${l}).x)`:u=`${a} * v_quadSizePx`;let h=`v_quadSizePx * vec2(0.5, -0.5) + ${u} * vec2(-1., 1.)`;if("icon-anchor-origin"in n)switch(n["icon-anchor-origin"]){case"top-right":h=`v_quadSizePx * -0.5 + ${u}`;break;case"bottom-left":h=`v_quadSizePx * 0.5 - ${u}`;break;case"bottom-right":h=`v_quadSizePx * vec2(-0.5, 0.5) + ${u} * vec2(1., -1.)`;break}e.setSymbolOffsetExpression(`${e.getSymbolOffsetExpression()} + ${h}`)}}function nx(n,e,t,r){if("stroke-color"in n&&e.setStrokeColorExpression(H(r,n["stroke-color"],gt)),"stroke-pattern-src"in n){const i=Us(n["stroke-pattern-src"]),s=jl(n,e,t,"stroke-pattern-",i);let o=s,a="vec2(0.)";"stroke-pattern-offset"in n&&"stroke-pattern-size"in n&&(o=H(r,n["stroke-pattern-size"],sn),a=Vl(n,"stroke-pattern-",r,s,o));let l="0.";"stroke-pattern-spacing"in n&&(l=H(r,n["stroke-pattern-spacing"],ye)),r.functions.sampleStrokePattern=`vec4 sampleStrokePattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, float spacingPx, float currentLengthPx, float currentRadiusRatio, float lineWidth) {
  float currentLengthScaled = currentLengthPx * sampleSize.y / lineWidth;
  float spacingScaled = spacingPx * sampleSize.y / lineWidth;
  float uCoordPx = mod(currentLengthScaled, (sampleSize.x + spacingScaled));
  // make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  uCoordPx = clamp(uCoordPx, 0.5, sampleSize.x - 0.5);
  float vCoordPx = (-currentRadiusRatio * 0.5 + 0.5) * sampleSize.y;
  vec2 texCoord = (vec2(uCoordPx, vCoordPx) + textureOffset) / textureSize;
  return texture2D(texture, texCoord);
}`;const u=`u_texture${i}`;let h="1.";"stroke-color"in n&&(h=e.getStrokeColorExpression()),e.setStrokeColorExpression(`${h} * sampleStrokePattern(${u}, ${s}, ${a}, ${o}, ${l}, currentLengthPx, currentRadiusRatio, v_width)`)}if("stroke-width"in n&&e.setStrokeWidthExpression(H(r,n["stroke-width"],ye)),"stroke-offset"in n&&e.setStrokeOffsetExpression(H(r,n["stroke-offset"],ye)),"stroke-line-cap"in n&&e.setStrokeCapExpression(H(r,n["stroke-line-cap"],wi)),"stroke-line-join"in n&&e.setStrokeJoinExpression(H(r,n["stroke-line-join"],wi)),"stroke-miter-limit"in n&&e.setStrokeMiterLimitExpression(H(r,n["stroke-miter-limit"],ye)),"stroke-line-dash"in n){r.functions.getSingleDashDistance=`float getSingleDashDistance(float distance, float radius, float dashOffset, float dashLength, float dashLengthTotal, float capType, float lineWidth) {
  float localDistance = mod(distance, dashLengthTotal);
  float distanceSegment = abs(localDistance - dashOffset - dashLength * 0.5) - dashLength * 0.5;
  distanceSegment = min(distanceSegment, dashLengthTotal - localDistance);
  if (capType == ${fr("square")}) {
    distanceSegment -= lineWidth * 0.5;
  } else if (capType == ${fr("round")}) {
    distanceSegment = min(distanceSegment, sqrt(distanceSegment * distanceSegment + radius * radius) - lineWidth * 0.5);
  }
  return distanceSegment;
}`;let i=n["stroke-line-dash"].map(p=>H(r,p,ye));i.length%2===1&&(i=[...i,...i]);let s="0.";"stroke-line-dash-offset"in n&&(s=H(r,n["stroke-line-dash-offset"],ye));const a=`dashDistanceField_${Us(n["stroke-line-dash"])}`,l=i.map((p,d)=>`float dashLength${d}`).join(", "),u=i.map((p,d)=>`dashLength${d}`).join(" + ");let h="0.",c=`getSingleDashDistance(distance, radius, ${h}, dashLength0, totalDashLength, capType, lineWidth)`;for(let p=2;p<i.length;p+=2)h=`${h} + dashLength${p-2} + dashLength${p-1}`,c=`min(${c}, getSingleDashDistance(distance, radius, ${h}, dashLength${p}, totalDashLength, capType, lineWidth))`;r.functions[a]=`float ${a}(float distance, float radius, float capType, float lineWidth, ${l}) {
  float totalDashLength = ${u};
  return ${c};
}`;const f=i.map((p,d)=>`${p}`).join(", ");e.setStrokeDistanceFieldExpression(`${a}(currentLengthPx + ${s}, currentRadiusPx, capType, v_width, ${f})`)}}function ix(n,e,t,r){if("fill-color"in n&&e.setFillColorExpression(H(r,n["fill-color"],gt)),"fill-pattern-src"in n){const i=Us(n["fill-pattern-src"]),s=jl(n,e,t,"fill-pattern-",i);let o=s,a="vec2(0.)";"fill-pattern-offset"in n&&"fill-pattern-size"in n&&(o=H(r,n["fill-pattern-size"],sn),a=Vl(n,"fill-pattern-",r,s,o)),r.functions.sampleFillPattern=`vec4 sampleFillPattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, vec2 pxOrigin, vec2 pxPosition) {
  float scaleRatio = pow(2., mod(u_zoom + 0.5, 1.) - 0.5);
  vec2 pxRelativePos = pxPosition - pxOrigin;
  // rotate the relative position from origin by the current view rotation
  pxRelativePos = vec2(pxRelativePos.x * cos(u_rotation) - pxRelativePos.y * sin(u_rotation), pxRelativePos.x * sin(u_rotation) + pxRelativePos.y * cos(u_rotation));
  // sample position is computed according to the sample offset & size
  vec2 samplePos = mod(pxRelativePos / scaleRatio, sampleSize);
  // also make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  samplePos = clamp(samplePos, vec2(0.5), sampleSize - vec2(0.5));
  samplePos.y = sampleSize.y - samplePos.y; // invert y axis so that images appear upright
  return texture2D(texture, (samplePos + textureOffset) / textureSize);
}`;const l=`u_texture${i}`;let u="1.";"fill-color"in n&&(u=e.getFillColorExpression()),e.setFillColorExpression(`${u} * sampleFillPattern(${l}, ${s}, ${a}, ${o}, pxOrigin, pxPos)`)}}function id(n,e,t){const r=Bl(),i=new Yf,s={};if("icon-src"in n?rx(n,i,s,r):"shape-points"in n?tx(n,i,s,r):"circle-radius"in n&&ex(n,i,s,r),nx(n,i,s,r),ix(n,i,s,r),t){const l=H(r,t,oo);i.setFragmentDiscardExpression(`!${l}`)}const o={};function a(l,u,h,c){if(!r[l])return;const f=Na(h),p=zl(h);i.addAttribute(`a_${u}`,f),o[u]={size:p,callback:c}}return a("geometryType",Hf,wi,l=>On(cf(l.getGeometry()))),a("featureId",qf,wi|ye,l=>{const u=l.getId()??null;return typeof u=="string"?On(u):u}),Kf(i,r),{builder:i,attributes:{...o,...Qf(r)},uniforms:{...s,...Jf(r,e)}}}function sx(n){const e=Array.isArray(n)?n:[n];if("style"in e[0]){const t=[],r=e,i=[];for(const s of r){const o=Array.isArray(s.style)?s.style:[s.style];let a=s.filter;s.else&&i.length&&(a=["all",...i.map(u=>["!",u])],s.filter&&a.push(s.filter),a.length<3&&(a=a[1])),s.filter&&i.push(s.filter);const l=o.map(u=>({style:u,...a&&{filter:a}}));t.push(...l)}return t}return"builder"in e[0]?e:e.map(t=>({style:t}))}const ox=[];let Yo;function ax(){return Yo||(Yo=ed()),Yo}let lx=0;const Zt={POSITION:"a_position",INDEX:"a_index",SEGMENT_START:"a_segmentStart",SEGMENT_END:"a_segmentEnd",MEASURE_START:"a_measureStart",MEASURE_END:"a_measureEnd",PARAMETERS:"a_parameters",JOIN_ANGLES:"a_joinAngles",DISTANCE:"a_distance"};class ux{constructor(e,t,r,i,s){this.helper_,this.hitDetectionEnabled_=!!i;let o=e;if(!("builder"in e)){const h=e,c=id(h.style,t,h.filter);o={builder:c.builder,attributes:c.attributes,uniforms:c.uniforms}}this.fillProgram_,this.strokeProgram_,this.symbolProgram_,this.hasFill_=!!o.builder.getFillVertexShader(),this.hasFill_&&(this.fillVertexShader_=o.builder.getFillVertexShader(),this.fillFragmentShader_=o.builder.getFillFragmentShader()),this.hasStroke_=!!o.builder.getStrokeVertexShader(),this.hasStroke_&&(this.strokeVertexShader_=o.builder.getStrokeVertexShader(),this.strokeFragmentShader_=o.builder.getStrokeFragmentShader()),this.hasSymbol_=!!o.builder.getSymbolVertexShader(),this.hasSymbol_&&(this.symbolVertexShader_=o.builder.getSymbolVertexShader(),this.symbolFragmentShader_=o.builder.getSymbolFragmentShader()),this.featureFilter_=null,s&&(this.featureFilter_=this.computeFeatureFilter(s));const l=this.hitDetectionEnabled_?{hitColor:{callback(){return td(this.ref,ox)},size:4}}:{};this.customAttributes_=Object.assign({},l,o.attributes),this.uniforms_=o.uniforms;const u=Object.entries(this.customAttributes_).map(([h,c])=>({name:`a_${h}`,size:c.size||1,type:Ve.FLOAT}));this.polygonAttributesDesc_=[{name:Zt.POSITION,size:2,type:Ve.FLOAT},...u],this.lineStringAttributesDesc_=[{name:Zt.SEGMENT_START,size:2,type:Ve.FLOAT},{name:Zt.MEASURE_START,size:1,type:Ve.FLOAT},{name:Zt.SEGMENT_END,size:2,type:Ve.FLOAT},{name:Zt.MEASURE_END,size:1,type:Ve.FLOAT},{name:Zt.JOIN_ANGLES,size:2,type:Ve.FLOAT},{name:Zt.DISTANCE,size:1,type:Ve.FLOAT},{name:Zt.PARAMETERS,size:1,type:Ve.FLOAT},...u],this.pointAttributesDesc_=[{name:Zt.POSITION,size:2,type:Ve.FLOAT},{name:Zt.INDEX,size:1,type:Ve.FLOAT},...u],this.setHelper(r)}computeFeatureFilter(e){const t=uf();let r;try{r=Zg(e,oo,t)}catch{return null}if(t.mapState||t.variables.size>0)return null;const i=qg();return s=>{if(i.properties=s.getPropertiesInternal(),t.featureId){const o=s.getId();o!==void 0?i.featureId=o:i.featureId=null}return i.geometryType=cf(s.getGeometry()),r(i)}}async generateBuffers(e,t){let r=e;if(this.featureFilter_&&(r=r.filter(this.featureFilter_),r.isEmpty()))return null;const i=this.generateRenderInstructions_(r,t),[s,o,a]=await Promise.all([this.generateBuffersForType_(i.polygonInstructions,"Polygon",t),this.generateBuffersForType_(i.lineStringInstructions,"LineString",t),this.generateBuffersForType_(i.pointInstructions,"Point",t)]),l=yi(nt(),t);return{polygonBuffers:s,lineStringBuffers:o,pointBuffers:a,invertVerticesTransform:l}}generateRenderInstructions_(e,t){const r=this.hasFill_?Qb(e.polygonBatch,new Float32Array(0),this.customAttributes_,t):null,i=this.hasStroke_?Jb(e.lineStringBatch,new Float32Array(0),this.customAttributes_,t):null,s=this.hasSymbol_?Kb(e.pointBatch,new Float32Array(0),this.customAttributes_,t):null;return{polygonInstructions:r,lineStringInstructions:i,pointInstructions:s}}generateBuffersForType_(e,t,r){if(e===null)return null;const i=lx++;let s;switch(t){case"Polygon":s=ui.GENERATE_POLYGON_BUFFERS;break;case"LineString":s=ui.GENERATE_LINE_STRING_BUFFERS;break;case"Point":s=ui.GENERATE_POINT_BUFFERS;break}const o={id:i,type:s,renderInstructions:e.buffer,renderInstructionsTransform:r,customAttributesSize:yo(this.customAttributes_)},a=ax();return a.postMessage(o,[e.buffer]),e=null,new Promise(l=>{const u=h=>{const c=h.data;if(c.id!==i||(a.removeEventListener("message",u),!this.helper_.getGL()))return;const f=new Mn($i,Os).fromArrayBuffer(c.vertexBuffer),p=new Mn(ji,Os).fromArrayBuffer(c.indexBuffer);this.helper_.flushBufferData(f),this.helper_.flushBufferData(p),l([p,f])};a.addEventListener("message",u)})}render(e,t,r){this.hasFill_&&this.renderInternal_(e.polygonBuffers[0],e.polygonBuffers[1],this.fillProgram_,this.polygonAttributesDesc_,t,r),this.hasStroke_&&this.renderInternal_(e.lineStringBuffers[0],e.lineStringBuffers[1],this.strokeProgram_,this.lineStringAttributesDesc_,t,r),this.hasSymbol_&&this.renderInternal_(e.pointBuffers[0],e.pointBuffers[1],this.symbolProgram_,this.pointAttributesDesc_,t,r)}renderInternal_(e,t,r,i,s,o){const a=e.getSize();a!==0&&(this.helper_.useProgram(r,s),this.helper_.bindBuffer(t),this.helper_.bindBuffer(e),this.helper_.enableAttributes(i),o(),this.helper_.drawElements(0,a))}setHelper(e,t=null){this.helper_=e,this.hasFill_&&(this.fillProgram_=this.helper_.getProgram(this.fillFragmentShader_,this.fillVertexShader_)),this.hasStroke_&&(this.strokeProgram_=this.helper_.getProgram(this.strokeFragmentShader_,this.strokeVertexShader_)),this.hasSymbol_&&(this.symbolProgram_=this.helper_.getProgram(this.symbolFragmentShader_,this.symbolVertexShader_)),this.helper_.addUniforms(this.uniforms_),t&&(t.polygonBuffers&&(this.helper_.flushBufferData(t.polygonBuffers[0]),this.helper_.flushBufferData(t.polygonBuffers[1])),t.lineStringBuffers&&(this.helper_.flushBufferData(t.lineStringBuffers[0]),this.helper_.flushBufferData(t.lineStringBuffers[1])),t.pointBuffers&&(this.helper_.flushBufferData(t.pointBuffers[0]),this.helper_.flushBufferData(t.pointBuffers[1])))}}const qt=new Uint8Array(4);class sd{constructor(e,t){this.helper_=e;const r=e.getGL();this.texture_=r.createTexture(),this.framebuffer_=r.createFramebuffer(),this.depthbuffer_=r.createRenderbuffer(),this.size_=t||[1,1],this.data_=new Uint8Array(0),this.dataCacheDirty_=!0,this.updateSize_()}setSize(e){Rg(e,this.size_)||(this.size_[0]=e[0],this.size_[1]=e[1],this.updateSize_())}getSize(){return this.size_}clearCachedData(){this.dataCacheDirty_=!0}readAll(){if(this.dataCacheDirty_){const e=this.size_,t=this.helper_.getGL();t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer_),t.readPixels(0,0,e[0],e[1],t.RGBA,t.UNSIGNED_BYTE,this.data_),this.dataCacheDirty_=!1}return this.data_}readPixel(e,t){if(e<0||t<0||e>this.size_[0]||t>=this.size_[1])return qt[0]=0,qt[1]=0,qt[2]=0,qt[3]=0,qt;this.readAll();const r=Math.floor(e)+(this.size_[1]-Math.floor(t)-1)*this.size_[0];return qt[0]=this.data_[r*4],qt[1]=this.data_[r*4+1],qt[2]=this.data_[r*4+2],qt[3]=this.data_[r*4+3],qt}getTexture(){return this.texture_}getFramebuffer(){return this.framebuffer_}getDepthbuffer(){return this.depthbuffer_}updateSize_(){const e=this.size_,t=this.helper_.getGL();this.texture_=this.helper_.createTexture(e,null,this.texture_),t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer_),t.viewport(0,0,e[0],e[1]),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture_,0),t.bindRenderbuffer(t.RENDERBUFFER,this.depthbuffer_),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e[0],e[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthbuffer_),this.data_=new Uint8Array(e[0]*e[1]*4)}}function od(n,e){const t=n.viewState.projection,i=e.getSource().getWrapX()&&t.canWrapX(),s=t.getExtent(),o=n.extent,a=i?it(s):null,l=i?Math.ceil((o[2]-s[2])/a)+1:1;return[i?Math.floor((o[0]-s[0])/a):0,l,a]}const pn={...Jt,RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",GLOBAL_ALPHA:"u_globalAlpha"};class ad extends Vi{constructor(e,t){const r={[pn.RENDER_EXTENT]:[0,0,0,0],[pn.PATTERN_ORIGIN]:[0,0],[pn.GLOBAL_ALPHA]:1};super(e,{uniforms:r,postProcesses:t.postProcesses}),this.hitDetectionEnabled_=!t.disableHitDetection,this.hitRenderTarget_,this.sourceRevision_=-1,this.previousExtent_=Oi(),this.currentTransform_=nt(),this.tmpCoords_=[0,0],this.tmpTransform_=nt(),this.tmpMat4_=hn(),this.currentFrameStateTransform_=nt(),this.styleVariables_={},this.styles_=[],this.styleRenderers_=[],this.buffers_=[],this.applyOptions_(t),this.batch_=new Ds,this.initialFeaturesAdded_=!1,this.sourceListenKeys_=null}addInitialFeatures_(e){const t=this.getLayer().getSource();let r;this.batch_.addFeatures(t.getFeatures(),r),this.sourceListenKeys_=[dr(t,Mr.ADDFEATURE,this.handleSourceFeatureAdded_.bind(this,r)),dr(t,Mr.CHANGEFEATURE,this.handleSourceFeatureChanged_.bind(this,r),this),dr(t,Mr.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),dr(t,Mr.CLEAR,this.handleSourceFeatureClear_,this)]}applyOptions_(e){this.styleVariables_=e.variables,this.styles_=sx(e.style)}createRenderers_(){this.buffers_=[],this.styleRenderers_=this.styles_.map(e=>new ux(e,this.styleVariables_,this.helper,this.hitDetectionEnabled_,"filter"in e?e.filter:null))}reset(e){this.applyOptions_(e),this.helper&&this.createRenderers_(),super.reset(e)}afterHelperCreated(){this.styleRenderers_.length?this.styleRenderers_.forEach((e,t)=>e.setHelper(this.helper,this.buffers_[t])):this.createRenderers_(),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new sd(this.helper))}handleSourceFeatureAdded_(e,t){const r=t.feature;this.batch_.addFeature(r,e)}handleSourceFeatureChanged_(e,t){const r=t.feature;this.batch_.changeFeature(r,e)}handleSourceFeatureDelete_(e){const t=e.feature;this.batch_.removeFeature(t)}handleSourceFeatureClear_(){this.batch_.clear()}applyUniforms_(e){cg(this.tmpTransform_,this.currentFrameStateTransform_),mi(this.tmpTransform_,e),this.helper.setUniformMatrixValue(pn.PROJECTION_MATRIX,Ms(this.tmpMat4_,this.tmpTransform_)),yi(this.tmpTransform_,this.tmpTransform_),this.helper.setUniformMatrixValue(pn.SCREEN_TO_WORLD_MATRIX,Ms(this.tmpMat4_,this.tmpTransform_)),this.tmpCoords_[0]=0,this.tmpCoords_[1]=0,yi(this.tmpTransform_,e),_r(this.tmpTransform_,this.tmpCoords_),this.helper.setUniformFloatVec2(pn.PATTERN_ORIGIN,this.tmpCoords_)}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[r,i,s]=od(e,this.getLayer());this.helper.prepareDraw(e),this.renderWorlds(e,!1,r,i,s),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const o=this.helper.getCanvas();return this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,r,i,s),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),o}prepareFrameInternal(e){this.initialFeaturesAdded_||(this.addInitialFeatures_(e),this.initialFeaturesAdded_=!0);const t=this.getLayer(),r=t.getSource(),i=e.viewState,s=!e.viewHints[Gr.ANIMATING]&&!e.viewHints[Gr.INTERACTING],o=!bi(this.previousExtent_,e.extent),a=this.sourceRevision_<r.getRevision();if(a&&(this.sourceRevision_=r.getRevision()),s&&(o||a)){const l=i.projection,u=i.resolution,h=t instanceof ao?t.getRenderBuffer():0,c=fl(e.extent,h*u);r.loadFeatures(c,u,l),this.ready=!1;const f=this.helper.makeProjectionTransform(e,nt()),p=this.styleRenderers_.map((d,g)=>d.generateBuffers(this.batch_,f).then(m=>{this.buffers_[g]&&this.disposeBuffers(this.buffers_[g]),this.buffers_[g]=m}));Promise.all(p).then(()=>{this.ready=!0,this.getLayer().changed()}),this.previousExtent_=e.extent.slice()}return!0}renderWorlds(e,t,r,i,s){let o=r;t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0));do{this.helper.makeProjectionTransform(e,this.currentFrameStateTransform_),ll(this.currentFrameStateTransform_,o*s,0);for(let a=0,l=this.styleRenderers_.length;a<l;a++){const u=this.styleRenderers_[a],h=this.buffers_[a];h&&u.render(h,e,()=>{this.applyUniforms_(h.invertVerticesTransform),this.helper.applyHitDetectionUniform(t)})}}while(++o<i)}forEachFeatureAtCoordinate(e,t,r,i,s){if(Mt(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.styleRenderers_.length||!this.hitDetectionEnabled_)return;const o=_r(t.coordinateToPixelTransform,e.slice()),a=this.hitRenderTarget_.readPixel(o[0]/2,o[1]/2),l=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],u=rd(l),h=this.batch_.getFeatureFromRef(u);if(h)return i(h,this.getLayer(),null)}disposeBuffers(e){const t=r=>{for(const i of r)i&&this.helper.deleteBuffer(i)};e.pointBuffers&&t(e.pointBuffers),e.lineStringBuffers&&t(e.lineStringBuffers),e.polygonBuffers&&t(e.polygonBuffers)}disposeInternal(){this.buffers_.forEach(e=>{e&&this.disposeBuffers(e)}),this.sourceListenKeys_&&(this.sourceListenKeys_.forEach(function(e){ws(e)}),this.sourceListenKeys_=null),super.disposeInternal()}renderDeclutter(){}}const hr={BLUR:"blur",GRADIENT:"gradient",RADIUS:"radius"},cx=["#00f","#0ff","#0f0","#ff0","#f00"];class hx extends ao{constructor(e){e=e||{};const t=Object.assign({},e);delete t.gradient,delete t.radius,delete t.blur,delete t.weight,super(t),this.filter_=e.filter??!0,this.styleVariables_=e.variables||{},this.gradient_=null,this.addChangeListener(hr.GRADIENT,this.handleGradientChanged_),this.setGradient(e.gradient?e.gradient:cx),this.setBlur(e.blur!==void 0?e.blur:15),this.setRadius(e.radius!==void 0?e.radius:8);const r=e.weight?e.weight:"weight";this.weight_=r,this.setRenderOrder(null)}getBlur(){return this.get(hr.BLUR)}getGradient(){return this.get(hr.GRADIENT)}getRadius(){return this.get(hr.RADIUS)}handleGradientChanged_(){this.gradient_=fx(this.getGradient())}setBlur(e){const t=this.get(hr.BLUR);if(this.set(hr.BLUR,e),typeof e=="number"&&typeof t=="number"){this.changed();return}this.clearRenderer()}setGradient(e){this.set(hr.GRADIENT,e)}setRadius(e){const t=this.get(hr.RADIUS);if(this.set(hr.RADIUS,e),typeof e=="number"&&typeof t=="number"){this.changed();return}this.clearRenderer()}setFilter(e){this.filter_=e,this.changed(),this.clearRenderer()}setWeight(e){this.weight_=e,this.changed(),this.clearRenderer()}createRenderer(){const e=new Yf,t=Bl(),r=H(t,this.filter_,oo);let i=H(t,this.getRadius(),ye),s=H(t,this.getBlur(),ye);const o={};typeof this.getBlur()=="number"&&(s="a_blur",o.a_blur=()=>this.getBlur(),e.addUniform("a_blur","float")),typeof this.getRadius()=="number"&&(i="a_radius",o.a_radius=()=>this.getRadius(),e.addUniform("a_radius","float"));const a={};let l=null;if(typeof this.weight_=="string"||typeof this.weight_=="function"){const c=typeof this.weight_=="string"?f=>f.get(this.weight_):this.weight_;a.prop_weight={size:1,callback:f=>{const p=c(f);return p!==void 0?Ue(p,0,1):1}},l="a_prop_weight",e.addAttribute("a_prop_weight","float")}else{const c=["clamp",this.weight_,0,1];l=H(t,c,ye)}e.addFragmentShaderFunction(`float getBlurSlope() {
  float blur = max(1., ${s});
  float radius = ${i};
  return radius / blur;
}`).setSymbolSizeExpression(`vec2(${i} + ${s}) * 2.`).setSymbolColorExpression(`vec4(smoothstep(0., 1., (1. - length(coordsPx * 2. / v_quadSizePx)) * getBlurSlope()) * ${l})`).setStrokeColorExpression(`vec4(smoothstep(0., 1., (1. - length(currentRadiusPx * 2. / v_width)) * getBlurSlope()) * ${l})`).setStrokeWidthExpression(`(${i} + ${s}) * 2.`).setFillColorExpression(`vec4(${l})`).setFragmentDiscardExpression(`!${r}`),Kf(e,t);const u=Qf(t),h=Jf(t,this.styleVariables_);return new ad(this,{className:this.getClassName(),variables:this.styleVariables_,style:{builder:e,attributes:{...u,...a},uniforms:{...h,...o}},disableHitDetection:!1,postProcesses:[{fragmentShader:`
            precision mediump float;

            uniform sampler2D u_image;
            uniform sampler2D u_gradientTexture;
            uniform float u_opacity;

            varying vec2 v_texCoord;

            void main() {
              vec4 color = texture2D(u_image, v_texCoord);
              gl_FragColor.a = color.a * u_opacity;
              gl_FragColor.rgb = texture2D(u_gradientTexture, vec2(0.5, color.a)).rgb;
              gl_FragColor.rgb *= gl_FragColor.a;
            }`,uniforms:{u_gradientTexture:()=>this.gradient_,u_opacity:()=>this.getOpacity()}}]})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}renderDeclutter(){}}function fx(n){const r=Br(1,256),i=r.createLinearGradient(0,0,1,256),s=1/(n.length-1);for(let o=0,a=n.length;o<a;++o)i.addColorStop(o*s,n[o]);return r.fillStyle=i,r.fillRect(0,0,1,256),r.canvas}class Xl extends hf{constructor(e,t,r,i,s){const o=s!==void 0?Yr.IDLE:Yr.LOADED;super(e,t,r,o),this.loader_=s!==void 0?s:null,this.canvas_=i,this.error_=null}getError(){return this.error_}handleLoad_(e){e?(this.error_=e,this.state=Yr.ERROR):this.state=Yr.LOADED,this.changed()}load(){this.state==Yr.IDLE&&(this.state=Yr.LOADING,this.changed(),this.loader_(this.handleLoad_.bind(this)))}getImage(){return this.canvas_}}class dx extends Hg{constructor(e){super(e),this.vectorRenderer_=new Yg(e),this.layerImageRatio_=e.getImageRatio(),this.coordinateToVectorPixelTransform_=nt(),this.renderedPixelToCoordinateTransform_=null}disposeInternal(){this.vectorRenderer_.dispose(),super.disposeInternal()}getFeatures(e){if(!this.vectorRenderer_)return Promise.resolve([]);const t=_r(this.coordinateToVectorPixelTransform_,_r(this.renderedPixelToCoordinateTransform_,e.slice()));return this.vectorRenderer_.getFeatures(t)}handleFontsChanged(){this.vectorRenderer_.handleFontsChanged()}prepareFrame(e){var h;const t=e.pixelRatio,r=e.viewState,i=r.resolution,s=e.viewHints,o=this.vectorRenderer_;let a=e.extent;this.layerImageRatio_!==1&&(a=a.slice(0),nf(a,this.layerImageRatio_));const l=it(a)/i,u=jt(a)/i;if(!s[Gr.ANIMATING]&&!s[Gr.INTERACTING]&&!no(a)){o.useContainer(null,null);const c=o.context,f=e.layerStatesArray[e.layerIndex],p=Object.assign({},f,{opacity:1}),d=Object.assign({},e,{extent:a,size:[l,u],viewState:Object.assign({},e.viewState,{rotation:0}),layerStatesArray:[p],layerIndex:0,declutter:null}),g=this.getLayer().getDeclutter();g&&(d.declutter={[g]:new Kg(9)});const m=new Xl(a,i,t,c.canvas,function(_){o.prepareFrame(d)&&o.replayGroupChanged&&(o.clipping=!1,o.renderFrame(d,null),o.renderDeclutter(d),o.renderDeferred(d),_())});m.addEventListener(ft.CHANGE,()=>{if(m.getState()!==Yr.LOADED)return;this.image=m;const _=m.getPixelRatio(),y=Jg(m.getResolution())*t/_;this.renderedResolution=y,this.coordinateToVectorPixelTransform_=al(this.coordinateToVectorPixelTransform_,l/2,u/2,1/y,-1/y,0,-r.center[0],-r.center[1])}),m.load()}return this.image&&(this.renderedPixelToCoordinateTransform_=e.pixelToCoordinateTransform.slice()),!((h=this.getLayer().getSource())!=null&&h.loading)&&!!this.image}preRender(){}postRender(){}renderDeclutter(){}forEachFeatureAtCoordinate(e,t,r,i,s){return this.vectorRenderer_?this.vectorRenderer_.forEachFeatureAtCoordinate(e,t,r,i,s):super.forEachFeatureAtCoordinate(e,t,r,i,s)}}class px extends ao{constructor(e){e=e||{};const t=Object.assign({},e);delete t.imageRatio,super(t),this.imageRatio_=e.imageRatio!==void 0?e.imageRatio:1}getImageRatio(){return this.imageRatio_}createRenderer(){return new dx(this)}}class gx extends Vi{constructor(e,t){const r=t.uniforms||{},i=nt();r[Jt.PROJECTION_MATRIX]=i,super(e,{uniforms:r,postProcesses:t.postProcesses}),this.sourceRevision_=-1,this.verticesBuffer_=new Mn($i,Os),this.indicesBuffer_=new Mn(ji,Os),this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.program_,this.hitDetectionEnabled_=t.hitDetectionEnabled??!0;const s=t.attributes?t.attributes.map(function(a){return{name:"a_"+a.name,size:1,type:Ve.FLOAT}}):[];this.attributes=[{name:"a_position",size:2,type:Ve.FLOAT},{name:"a_index",size:1,type:Ve.FLOAT}],this.hitDetectionEnabled_&&(this.attributes.push({name:"a_hitColor",size:4,type:Ve.FLOAT}),this.attributes.push({name:"a_featureUid",size:1,type:Ve.FLOAT})),this.attributes.push(...s),this.customAttributes=t.attributes?t.attributes:[],this.previousExtent_=Oi(),this.currentTransform_=i,this.renderTransform_=nt(),this.invertRenderTransform_=nt(),this.renderInstructions_=new Float32Array(0),this.hitRenderTarget_,this.lastSentId=0,this.worker_=ed(),this.worker_.addEventListener("message",a=>{const l=a.data;if(l.type===ui.GENERATE_POINT_BUFFERS){const u=l.projectionTransform;this.verticesBuffer_.fromArrayBuffer(l.vertexBuffer),this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.fromArrayBuffer(l.indexBuffer),this.helper.flushBufferData(this.indicesBuffer_),this.renderTransform_=u,yi(this.invertRenderTransform_,this.renderTransform_),this.renderInstructions_=new Float32Array(a.data.renderInstructions),l.id===this.lastSentId&&(this.ready=!0),this.getLayer().changed()}}),this.featureCache_={},this.featureCount_=0;const o=this.getLayer().getSource();this.sourceListenKeys_=[dr(o,Mr.ADDFEATURE,this.handleSourceFeatureAdded_,this),dr(o,Mr.CHANGEFEATURE,this.handleSourceFeatureChanged_,this),dr(o,Mr.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),dr(o,Mr.CLEAR,this.handleSourceFeatureClear_,this)],o.forEachFeature(a=>{const l=a.getGeometry();l&&l.getType()==="Point"&&(this.featureCache_[me(a)]={feature:a,properties:a.getProperties(),flatCoordinates:l.getFlatCoordinates()},this.featureCount_++)})}afterHelperCreated(){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new sd(this.helper)),this.verticesBuffer_.getArray()&&this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.getArray()&&this.helper.flushBufferData(this.indicesBuffer_)}handleSourceFeatureAdded_(e){const t=e.feature,r=t.getGeometry();r&&r.getType()==="Point"&&(this.featureCache_[me(t)]={feature:t,properties:t.getProperties(),flatCoordinates:r.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureChanged_(e){const t=e.feature,r=me(t),i=this.featureCache_[r],s=t.getGeometry();i?s&&s.getType()==="Point"?(i.properties=t.getProperties(),i.flatCoordinates=s.getFlatCoordinates()):(delete this.featureCache_[r],this.featureCount_--):s&&s.getType()==="Point"&&(this.featureCache_[r]={feature:t,properties:t.getProperties(),flatCoordinates:s.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureDelete_(e){const t=e.feature,r=me(t);r in this.featureCache_&&(delete this.featureCache_[r],this.featureCount_--)}handleSourceFeatureClear_(){this.featureCache_={},this.featureCount_=0}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[r,i,s]=od(e,this.getLayer());return this.renderWorlds(e,!1,r,i,s),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent),this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,r,i,s),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),this.helper.getCanvas()}prepareFrameInternal(e){const t=this.getLayer(),r=t.getSource(),i=e.viewState,s=!e.viewHints[Gr.ANIMATING]&&!e.viewHints[Gr.INTERACTING],o=!bi(this.previousExtent_,e.extent),a=this.sourceRevision_<r.getRevision();if(a&&(this.sourceRevision_=r.getRevision()),s&&(o||a)){const l=i.projection,u=i.resolution,h=t instanceof ao?t.getRenderBuffer():0,c=fl(e.extent,h*u);r.loadFeatures(c,u,l),this.rebuildBuffers_(e),this.previousExtent_=e.extent.slice()}return this.helper.useProgram(this.program_,e),this.helper.prepareDraw(e),this.helper.bindBuffer(this.verticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),this.helper.enableAttributes(this.attributes),!0}rebuildBuffers_(e){const t=nt();this.helper.makeProjectionTransform(e,t);const i=(this.hitDetectionEnabled_?7:2)+this.customAttributes.length,s=i*this.featureCount_,o=this.renderInstructions_&&this.renderInstructions_.length===s?this.renderInstructions_:new Float32Array(s);this.renderInstructions_=null;let a=[];const l=[];let u=-1;e.viewState.projection;for(const c in this.featureCache_){const f=this.featureCache_[c];if(a[0]=f.flatCoordinates[0],a[1]=f.flatCoordinates[1],_r(t,a),o[++u]=a[0],o[++u]=a[1],this.hitDetectionEnabled_){const p=td(u+5,l);o[++u]=p[0],o[++u]=p[1],o[++u]=p[2],o[++u]=p[3],o[++u]=Number(c)}for(let p=0;p<this.customAttributes.length;p++){const d=this.customAttributes[p].callback(f.feature,f.properties);o[++u]=d}}const h={id:++this.lastSentId,type:ui.GENERATE_POINT_BUFFERS,renderInstructions:o.buffer,customAttributesSize:i-2};h.projectionTransform=t,this.ready=!1,this.worker_.postMessage(h,[o.buffer])}forEachFeatureAtCoordinate(e,t,r,i,s){if(Mt(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.renderInstructions_||!this.hitDetectionEnabled_)return;const o=_r(t.coordinateToPixelTransform,e.slice()),a=this.hitRenderTarget_.readPixel(o[0]/2,o[1]/2),l=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],u=rd(l),h=this.renderInstructions_[u],c=Math.floor(h).toString(),p=this.getLayer().getSource().getFeatureByUid(c);if(p)return i(p,this.getLayer(),null)}renderWorlds(e,t,r,i,s){let o=r;this.helper.useProgram(this.program_,e),t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0)),this.helper.bindBuffer(this.verticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),this.helper.enableAttributes(this.attributes);do{this.helper.makeProjectionTransform(e,this.currentTransform_),ll(this.currentTransform_,o*s,0),mi(this.currentTransform_,this.invertRenderTransform_),this.helper.applyUniforms(e),this.helper.applyHitDetectionUniform(t);const a=this.indicesBuffer_.getSize();this.helper.drawElements(0,a)}while(++o<i)}disposeInternal(){this.worker_.terminate(),this.sourceListenKeys_.forEach(function(e){ws(e)}),this.sourceListenKeys_=null,super.disposeInternal()}renderDeclutter(){}}class mx extends lo{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.parseResult_=id(e.style,this.styleVariables_,e.filter),this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){const e=Object.keys(this.parseResult_.attributes).map(t=>({name:t,...this.parseResult_.attributes[t]}));return new gx(this,{vertexShader:this.parseResult_.builder.getSymbolVertexShader(),fragmentShader:this.parseResult_.builder.getSymbolFragmentShader(),hitDetectionEnabled:!this.hitDetectionDisabled_,uniforms:this.parseResult_.uniforms,attributes:e})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}function kc(n,e){const t=`
    attribute vec2 ${ps.TEXTURE_COORD};
    uniform mat4 ${K.TILE_TRANSFORM};
    uniform float ${K.TEXTURE_PIXEL_WIDTH};
    uniform float ${K.TEXTURE_PIXEL_HEIGHT};
    uniform float ${K.TEXTURE_RESOLUTION};
    uniform float ${K.TEXTURE_ORIGIN_X};
    uniform float ${K.TEXTURE_ORIGIN_Y};
    uniform float ${K.DEPTH};

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;

    void main() {
      v_textureCoord = ${ps.TEXTURE_COORD};
      v_mapCoord = vec2(
        ${K.TEXTURE_ORIGIN_X} + ${K.TEXTURE_RESOLUTION} * ${K.TEXTURE_PIXEL_WIDTH} * v_textureCoord[0],
        ${K.TEXTURE_ORIGIN_Y} - ${K.TEXTURE_RESOLUTION} * ${K.TEXTURE_PIXEL_HEIGHT} * v_textureCoord[1]
      );
      gl_Position = ${K.TILE_TRANSFORM} * vec4(${ps.TEXTURE_COORD}, ${K.DEPTH}, 1.0);
    }
  `,r={...Bl(),bandCount:e},i=[];if(n.color!==void 0){const c=H(r,n.color,gt);i.push(`color = ${c};`)}if(n.contrast!==void 0){const c=H(r,n.contrast,ye);i.push(`color.rgb = clamp((${c} + 1.0) * color.rgb - (${c} / 2.0), vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(n.exposure!==void 0){const c=H(r,n.exposure,ye);i.push(`color.rgb = clamp((${c} + 1.0) * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(n.saturation!==void 0){const c=H(r,n.saturation,ye);i.push(`
      float saturation = ${c} + 1.0;
      float sr = (1.0 - saturation) * 0.2126;
      float sg = (1.0 - saturation) * 0.7152;
      float sb = (1.0 - saturation) * 0.0722;
      mat3 saturationMatrix = mat3(
        sr + saturation, sr, sr,
        sg, sg + saturation, sg,
        sb, sb, sb + saturation
      );
      color.rgb = clamp(saturationMatrix * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));
    `)}if(n.gamma!==void 0){const c=H(r,n.gamma,ye);i.push(`color.rgb = pow(color.rgb, vec3(1.0 / ${c}));`)}if(n.brightness!==void 0){const c=H(r,n.brightness,ye);i.push(`color.rgb = clamp(color.rgb + ${c}, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}const s={},o=Object.keys(r.variables).length;if(o>1&&!n.variables)throw new Error(`Missing variables in style (expected ${r.variables})`);for(let c=0;c<o;++c){const f=r.variables[Object.keys(r.variables)[c]];if(!(f.name in n.variables))throw new Error(`Missing '${f.name}' in style variables`);const p=mo(f.name);s[p]=function(){let d=n.variables[f.name];return typeof d=="string"&&(d=On(d)),d!==void 0?d:-9999999}}const a=Object.keys(s).map(function(c){return`uniform float ${c};`}),l=Math.ceil(e/4);a.push(`uniform sampler2D ${K.TILE_TEXTURE_ARRAY}[${l}];`),r.paletteTextures&&a.push(`uniform sampler2D ${Zf}[${r.paletteTextures.length}];`);const u=Object.keys(r.functions).map(function(c){return r.functions[c]}),h=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    #else
    precision mediump float;
    #endif

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;
    uniform vec4 ${K.RENDER_EXTENT};
    uniform float ${K.TRANSITION_ALPHA};
    uniform float ${K.TEXTURE_PIXEL_WIDTH};
    uniform float ${K.TEXTURE_PIXEL_HEIGHT};
    uniform float ${K.RESOLUTION};
    uniform float ${K.ZOOM};

    ${a.join(`
`)}

    ${u.join(`
`)}

    void main() {
      if (
        v_mapCoord[0] < ${K.RENDER_EXTENT}[0] ||
        v_mapCoord[1] < ${K.RENDER_EXTENT}[1] ||
        v_mapCoord[0] > ${K.RENDER_EXTENT}[2] ||
        v_mapCoord[1] > ${K.RENDER_EXTENT}[3]
      ) {
        discard;
      }

      vec4 color = texture2D(${K.TILE_TEXTURE_ARRAY}[0],  v_textureCoord);

      ${i.join(`
`)}

      gl_FragColor = color;
      gl_FragColor.rgb *= gl_FragColor.a;
      gl_FragColor *= ${K.TRANSITION_ALPHA};
    }`;return{vertexShader:t,fragmentShader:h,uniforms:s,paletteTextures:r.paletteTextures}}class Bs extends Qg{constructor(e){e=e?Object.assign({},e):{};const t=e.style||{};delete e.style,super(e),this.sources_=e.sources,this.renderedSource_=null,this.renderedResolution_=NaN,this.style_=t,this.styleVariables_=this.style_.variables||{},this.handleSourceUpdate_(),this.addChangeListener(Ia.SOURCE,this.handleSourceUpdate_)}getSources(e,t){const r=this.getSource();return this.sources_?typeof this.sources_=="function"?this.sources_(e,t):this.sources_:r?[r]:[]}getRenderSource(){return this.renderedSource_||this.getSource()}getSourceState(){const e=this.getRenderSource();return e?e.getState():"undefined"}handleSourceUpdate_(){this.hasRenderer()&&this.getRenderer().clearCache();const e=this.getSource();if(e)if(e.getState()==="loading"){const t=()=>{e.getState()==="ready"&&(e.removeEventListener("change",t),this.setStyle(this.style_))};e.addEventListener("change",t)}else this.setStyle(this.style_)}getSourceBandCount_(){const e=Number.MAX_SAFE_INTEGER,t=this.getSources([-e,-e,e,e],e);return t&&t.length&&"bandCount"in t[0]?t[0].bandCount:4}createRenderer(){const e=kc(this.style_,this.getSourceBandCount_());return new Gb(this,{vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,cacheSize:this.getCacheSize(),paletteTextures:e.paletteTextures})}renderSources(e,t){const r=this.getRenderer();let i;for(let s=0,o=t.length;s<o;++s)this.renderedSource_=t[s],r.prepareFrame(e)&&(i=r.renderFrame(e));return i}render(e,t){this.rendered=!0;const r=e.viewState,i=this.getSources(e.extent,r.resolution);let s=!0;for(let a=0,l=i.length;a<l;++a){const u=i[a],h=u.getState();if(h=="loading"){const c=()=>{u.getState()=="ready"&&(u.removeEventListener("change",c),this.changed())};u.addEventListener("change",c)}s=s&&h=="ready"}const o=this.renderSources(e,i);if(this.getRenderer().renderComplete&&s)return this.renderedResolution_=r.resolution,o;if(this.renderedResolution_>.5*r.resolution){const a=this.getSources(e.extent,this.renderedResolution_).filter(l=>!i.includes(l));if(a.length>0)return this.renderSources(e,a)}return o}setStyle(e){if(this.styleVariables_=e.variables||{},this.style_=e,this.hasRenderer()){const t=kc(this.style_,this.getSourceBandCount_());this.getRenderer().reset({vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,uniforms:t.uniforms,paletteTextures:t.paletteTextures}),this.changed()}}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}Bs.prototype.dispose;class yx extends lo{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.style_=e.style,this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){return new ad(this,{style:this.style_,variables:this.styleVariables_,disableHitDetection:this.hitDetectionDisabled_})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}setStyle(e){this.style_=e,this.clearRenderer(),this.changed()}}var xt=Uint8Array,Tn=Uint16Array,_x=Int32Array,ld=new xt([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),ud=new xt([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),bx=new xt([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),cd=function(n,e){for(var t=new Tn(31),r=0;r<31;++r)t[r]=e+=1<<n[r-1];for(var i=new _x(t[30]),r=1;r<30;++r)for(var s=t[r];s<t[r+1];++s)i[s]=s-t[r]<<5|r;return{b:t,r:i}},hd=cd(ld,2),fd=hd.b,xx=hd.r;fd[28]=258,xx[258]=28;var Ex=cd(ud,0),wx=Ex.b,Da=new Tn(32768);for(var Me=0;Me<32768;++Me){var Sr=(Me&43690)>>1|(Me&21845)<<1;Sr=(Sr&52428)>>2|(Sr&13107)<<2,Sr=(Sr&61680)>>4|(Sr&3855)<<4,Da[Me]=((Sr&65280)>>8|(Sr&255)<<8)>>1}var ci=function(n,e,t){for(var r=n.length,i=0,s=new Tn(e);i<r;++i)n[i]&&++s[n[i]-1];var o=new Tn(e);for(i=1;i<e;++i)o[i]=o[i-1]+s[i-1]<<1;var a;if(t){a=new Tn(1<<e);var l=15-e;for(i=0;i<r;++i)if(n[i])for(var u=i<<4|n[i],h=e-n[i],c=o[n[i]-1]++<<h,f=c|(1<<h)-1;c<=f;++c)a[Da[c]>>l]=u}else for(a=new Tn(r),i=0;i<r;++i)n[i]&&(a[i]=Da[o[n[i]-1]++]>>15-n[i]);return a},Xi=new xt(288);for(var Me=0;Me<144;++Me)Xi[Me]=8;for(var Me=144;Me<256;++Me)Xi[Me]=9;for(var Me=256;Me<280;++Me)Xi[Me]=7;for(var Me=280;Me<288;++Me)Xi[Me]=8;var dd=new xt(32);for(var Me=0;Me<32;++Me)dd[Me]=5;var vx=ci(Xi,9,1),Tx=ci(dd,5,1),Ko=function(n){for(var e=n[0],t=1;t<n.length;++t)n[t]>e&&(e=n[t]);return e},Dt=function(n,e,t){var r=e/8|0;return(n[r]|n[r+1]<<8)>>(e&7)&t},Jo=function(n,e){var t=e/8|0;return(n[t]|n[t+1]<<8|n[t+2]<<16)>>(e&7)},Sx=function(n){return(n+7)/8|0},Rx=function(n,e,t){return(t==null||t>n.length)&&(t=n.length),new xt(n.subarray(e,t))},Px=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],_t=function(n,e,t){var r=new Error(e||Px[n]);if(r.code=n,Error.captureStackTrace&&Error.captureStackTrace(r,_t),!t)throw r;return r},Wl=function(n,e,t,r){var i=n.length,s=0;if(!i||e.f&&!e.l)return t||new xt(0);var o=!t,a=o||e.i!=2,l=e.i;o&&(t=new xt(i*3));var u=function(Ot){var cr=t.length;if(Ot>cr){var ce=new xt(Math.max(cr*2,Ot));ce.set(t),t=ce}},h=e.f||0,c=e.p||0,f=e.b||0,p=e.l,d=e.d,g=e.m,m=e.n,_=i*8;do{if(!p){h=Dt(n,c,1);var y=Dt(n,c+1,3);if(c+=3,y)if(y==1)p=vx,d=Tx,g=9,m=5;else if(y==2){var E=Dt(n,c,31)+257,S=Dt(n,c+10,15)+4,A=E+Dt(n,c+5,31)+1;c+=14;for(var P=new xt(A),R=new xt(19),I=0;I<S;++I)R[bx[I]]=Dt(n,c+I*3,7);c+=S*3;for(var N=Ko(R),X=(1<<N)-1,M=ci(R,N,1),I=0;I<A;){var F=M[Dt(n,c,X)];c+=F&15;var b=F>>4;if(b<16)P[I++]=b;else{var $=0,z=0;for(b==16?(z=3+Dt(n,c,3),c+=2,$=P[I-1]):b==17?(z=3+Dt(n,c,7),c+=3):b==18&&(z=11+Dt(n,c,127),c+=7);z--;)P[I++]=$}}var ne=P.subarray(0,E),Z=P.subarray(E);g=Ko(ne),m=Ko(Z),p=ci(ne,g,1),d=ci(Z,m,1)}else _t(1);else{var b=Sx(c)+4,v=n[b-4]|n[b-3]<<8,x=b+v;if(x>i){l&&_t(0);break}a&&u(f+v),t.set(n.subarray(b,x),f),e.b=f+=v,e.p=c=x*8,e.f=h;continue}if(c>_){l&&_t(0);break}}a&&u(f+131072);for(var C=(1<<g)-1,he=(1<<m)-1,ve=c;;ve=c){var $=p[Jo(n,c)&C],Y=$>>4;if(c+=$&15,c>_){l&&_t(0);break}if($||_t(2),Y<256)t[f++]=Y;else if(Y==256){ve=c,p=null;break}else{var Le=Y-254;if(Y>264){var I=Y-257,fe=ld[I];Le=Dt(n,c,(1<<fe)-1)+fd[I],c+=fe}var _e=d[Jo(n,c)&he],Ie=_e>>4;_e||_t(3),c+=_e&15;var Z=wx[Ie];if(Ie>3){var fe=ud[Ie];Z+=Jo(n,c)&(1<<fe)-1,c+=fe}if(c>_){l&&_t(0);break}a&&u(f+131072);var Ne=f+Le;if(f<Z){var Xe=s-Z,G=Math.min(Z,Ne);for(Xe+f<0&&_t(3);f<G;++f)t[f]=r[Xe+f]}for(;f<Ne;++f)t[f]=t[f-Z]}}e.l=p,e.p=ve,e.b=f,e.f=h,p&&(h=1,e.m=g,e.d=d,e.n=m)}while(!h);return f!=t.length&&o?Rx(t,0,f):t.subarray(0,f)},Ax=new xt(0),Ix=function(n){(n[0]!=31||n[1]!=139||n[2]!=8)&&_t(6,"invalid gzip data");var e=n[3],t=10;e&4&&(t+=(n[10]|n[11]<<8)+2);for(var r=(e>>3&1)+(e>>4&1);r>0;r-=!n[t++]);return t+(e&2)},Cx=function(n){var e=n.length;return(n[e-4]|n[e-3]<<8|n[e-2]<<16|n[e-1]<<24)>>>0},Lx=function(n,e){return((n[0]&15)!=8||n[0]>>4>7||(n[0]<<8|n[1])%31)&&_t(6,"invalid zlib data"),(n[1]>>5&1)==1&&_t(6,"invalid zlib data: "+(n[1]&32?"need":"unexpected")+" dictionary"),(n[1]>>3&4)+2};function Fx(n,e){return Wl(n,{i:2},e,e)}function Mx(n,e){var t=Ix(n);return t+8>n.length&&_t(6,"invalid gzip data"),Wl(n.subarray(t,-8),{i:2},new xt(Cx(n)),e)}function Ox(n,e){return Wl(n.subarray(Lx(n),-4),{i:2},e,e)}function Nx(n,e){return n[0]==31&&n[1]==139&&n[2]==8?Mx(n,e):(n[0]&15)!=8||n[0]>>4>7||(n[0]<<8|n[1])%31?Fx(n,e):Ox(n,e)}var Dx=typeof TextDecoder<"u"&&new TextDecoder,Ux=0;try{Dx.decode(Ax,{stream:!0}),Ux=1}catch{}var Bx=Object.defineProperty,hi=Math.pow,Ae=(n,e)=>Bx(n,"name",{value:e,configurable:!0}),Je=(n,e,t)=>new Promise((r,i)=>{var s=l=>{try{a(t.next(l))}catch(u){i(u)}},o=l=>{try{a(t.throw(l))}catch(u){i(u)}},a=l=>l.done?r(l.value):Promise.resolve(l.value).then(s,o);a((t=t.apply(n,e)).next())});Ae((n,e)=>{let t=!1,r="",i=L.GridLayer.extend({createTile:Ae((s,o)=>{let a=document.createElement("img"),l=new AbortController,u=l.signal;return a.cancel=()=>{l.abort()},t||(n.getHeader().then(h=>{h.tileType===1?console.error("Error: archive contains MVT vector tiles, but leafletRasterLayer is for displaying raster tiles. See https://github.com/protomaps/PMTiles/tree/main/js for details."):h.tileType===2?r="image/png":h.tileType===3?r="image/jpeg":h.tileType===4?r="image/webp":h.tileType===5&&(r="image/avif")}),t=!0),n.getZxy(s.z,s.x,s.y,u).then(h=>{if(h){let c=new Blob([h.data],{type:r}),f=window.URL.createObjectURL(c);a.src=f,a.cancel=void 0,o(void 0,a)}}).catch(h=>{if(h.name!=="AbortError")throw h}),a},"createTile"),_removeTile:Ae(function(s){let o=this._tiles[s];o&&(o.el.cancel&&o.el.cancel(),o.el.width=0,o.el.height=0,o.el.deleted=!0,L.DomUtil.remove(o.el),delete this._tiles[s],this.fire("tileunload",{tile:o.el,coords:this._keyToTileCoords(s)}))},"_removeTile")});return new i(e)},"leafletRasterLayer");var Gx=Ae(n=>(e,t)=>{if(t instanceof AbortController)return n(e,t);let r=new AbortController;return n(e,r).then(i=>t(void 0,i.data,i.cacheControl||"",i.expires||""),i=>t(i)).catch(i=>t(i)),{cancel:Ae(()=>r.abort(),"cancel")}},"v3compat"),zx=class{constructor(e){this.tilev4=Ae((t,r)=>Je(this,null,function*(){if(t.type==="json"){let p=t.url.substr(10),d=this.tiles.get(p);if(d||(d=new vi(p),this.tiles.set(p,d)),this.metadata)return{data:yield d.getTileJson(t.url)};let g=yield d.getHeader();return(g.minLon>=g.maxLon||g.minLat>=g.maxLat)&&console.error(`Bounds of PMTiles archive ${g.minLon},${g.minLat},${g.maxLon},${g.maxLat} are not valid.`),{data:{tiles:[`${t.url}/{z}/{x}/{y}`],minzoom:g.minZoom,maxzoom:g.maxZoom,bounds:[g.minLon,g.minLat,g.maxLon,g.maxLat]}}}let i=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),s=t.url.match(i);if(!s)throw new Error("Invalid PMTiles protocol URL");let o=s[1],a=this.tiles.get(o);a||(a=new vi(o),this.tiles.set(o,a));let l=s[2],u=s[3],h=s[4],c=yield a.getHeader(),f=yield a==null?void 0:a.getZxy(+l,+u,+h,r.signal);if(f)return{data:new Uint8Array(f.data),cacheControl:f.cacheControl,expires:f.expires};if(c.tileType===1){if(this.errorOnMissingTile)throw new Error("Tile not found.");return{data:new Uint8Array}}return{data:null}}),"tilev4"),this.tile=Gx(this.tilev4),this.tiles=new Map,this.metadata=(e==null?void 0:e.metadata)||!1,this.errorOnMissingTile=(e==null?void 0:e.errorOnMissingTile)||!1}add(e){this.tiles.set(e.source.getKey(),e)}get(e){return this.tiles.get(e)}};Ae(zx,"Protocol");function pd(n,e){return(e>>>0)*4294967296+(n>>>0)}Ae(pd,"toNum");function gd(n,e){let t=e.buf,r=t[e.pos++],i=(r&112)>>4;if(r<128||(r=t[e.pos++],i|=(r&127)<<3,r<128)||(r=t[e.pos++],i|=(r&127)<<10,r<128)||(r=t[e.pos++],i|=(r&127)<<17,r<128)||(r=t[e.pos++],i|=(r&127)<<24,r<128)||(r=t[e.pos++],i|=(r&1)<<31,r<128))return pd(n,i);throw new Error("Expected varint not more than 10 bytes")}Ae(gd,"readVarintRemainder");function bn(n){let e=n.buf,t=e[n.pos++],r=t&127;return t<128||(t=e[n.pos++],r|=(t&127)<<7,t<128)||(t=e[n.pos++],r|=(t&127)<<14,t<128)||(t=e[n.pos++],r|=(t&127)<<21,t<128)?r:(t=e[n.pos],r|=(t&15)<<28,gd(r,n))}Ae(bn,"readVarint");function Zl(n,e,t,r){if(r===0){t===1&&(e[0]=n-1-e[0],e[1]=n-1-e[1]);let i=e[0];e[0]=e[1],e[1]=i}}Ae(Zl,"rotate");function md(n,e){let t=hi(2,n),r=e,i=e,s=e,o=[0,0],a=1;for(;a<t;)r=1&s/2,i=1&(s^r),Zl(a,o,r,i),o[0]+=a*r,o[1]+=a*i,s=s/4,a*=2;return[n,o[0],o[1]]}Ae(md,"idOnLevel");var kx=[0,1,5,21,85,341,1365,5461,21845,87381,349525,1398101,5592405,22369621,89478485,357913941,1431655765,5726623061,22906492245,91625968981,366503875925,1466015503701,5864062014805,23456248059221,93824992236885,375299968947541,0x5555555555555];function yd(n,e,t){if(n>26)throw new Error("Tile zoom level exceeds max safe number limit (26)");if(e>hi(2,n)-1||t>hi(2,n)-1)throw new Error("tile x/y outside zoom level bounds");let r=kx[n],i=hi(2,n),s=0,o=0,a=0,l=[e,t],u=i/2;for(;u>0;)s=(l[0]&u)>0?1:0,o=(l[1]&u)>0?1:0,a+=u*u*(3*s^o),Zl(u,l,s,o),u=u/2;return r+a}Ae(yd,"zxyToTileId");function $x(n){let e=0;for(let t=0;t<27;t++){let r=(1<<t)*(1<<t);if(e+r>n)return md(t,n-e);e+=r}throw new Error("Tile zoom level exceeds max safe number limit (26)")}Ae($x,"tileIdToZxy");var jx=(n=>(n[n.Unknown=0]="Unknown",n[n.None=1]="None",n[n.Gzip=2]="Gzip",n[n.Brotli=3]="Brotli",n[n.Zstd=4]="Zstd",n))(jx||{});function _o(n,e){return Je(this,null,function*(){if(e===1||e===0)return n;if(e===2){if(typeof globalThis.DecompressionStream>"u")return Nx(new Uint8Array(n));let t=new Response(n).body;if(!t)throw new Error("Failed to read response stream");let r=t.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(r).arrayBuffer()}throw new Error("Compression method not supported")})}Ae(_o,"defaultDecompress");var xn=(n=>(n[n.Unknown=0]="Unknown",n[n.Mvt=1]="Mvt",n[n.Png=2]="Png",n[n.Jpeg=3]="Jpeg",n[n.Webp=4]="Webp",n[n.Avif=5]="Avif",n))(xn||{});function _d(n){return n===1?".mvt":n===2?".png":n===3?".jpg":n===4?".webp":n===5?".avif":""}Ae(_d,"tileTypeExt");var Vx=127;function bd(n,e){let t=0,r=n.length-1;for(;t<=r;){let i=r+t>>1,s=e-n[i].tileId;if(s>0)t=i+1;else if(s<0)r=i-1;else return n[i]}return r>=0&&(n[r].runLength===0||e-n[r].tileId<n[r].runLength)?n[r]:null}Ae(bd,"findTile");var Xx=class{constructor(e){this.file=e}getKey(){return this.file.name}getBytes(e,t){return Je(this,null,function*(){return{data:yield this.file.slice(e,e+t).arrayBuffer()}})}};Ae(Xx,"FileSource");var xd=class{constructor(e,t=new Headers){this.url=e,this.customHeaders=t,this.mustReload=!1;let r="";"navigator"in globalThis&&(r=globalThis.navigator.userAgent||"");let i=r.indexOf("Windows")>-1,s=/Chrome|Chromium|Edg|OPR|Brave/.test(r);this.chromeWindowsNoCache=!1,i&&s&&(this.chromeWindowsNoCache=!0)}getKey(){return this.url}setHeaders(e){this.customHeaders=e}getBytes(e,t,r,i){return Je(this,null,function*(){let s,o;r?o=r:(s=new AbortController,o=s.signal);let a=new Headers(this.customHeaders);a.set("range",`bytes=${e}-${e+t-1}`);let l;this.mustReload?l="reload":this.chromeWindowsNoCache&&(l="no-store");let u=yield fetch(this.url,{signal:o,cache:l,headers:a});if(e===0&&u.status===416){let f=u.headers.get("Content-Range");if(!f||!f.startsWith("bytes */"))throw new Error("Missing content-length on 416 response");let p=+f.substr(8);u=yield fetch(this.url,{signal:o,cache:"reload",headers:{range:`bytes=0-${p-1}`}})}let h=u.headers.get("Etag");if(h!=null&&h.startsWith("W/")&&(h=null),u.status===416||i&&h&&h!==i)throw this.mustReload=!0,new Ua(`Server returned non-matching ETag ${i} after one retry. Check browser extensions and servers for issues that may affect correct ETag headers.`);if(u.status>=300)throw new Error(`Bad response code: ${u.status}`);let c=u.headers.get("Content-Length");if(u.status===200&&(!c||+c>t))throw s&&s.abort(),new Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield u.arrayBuffer(),etag:h||void 0,cacheControl:u.headers.get("Cache-Control")||void 0,expires:u.headers.get("Expires")||void 0}})}};Ae(xd,"FetchSource");var Wx=xd;function It(n,e){let t=n.getUint32(e+4,!0),r=n.getUint32(e+0,!0);return t*hi(2,32)+r}Ae(It,"getUint64");function Ed(n,e){let t=new DataView(n),r=t.getUint8(7);if(r>3)throw new Error(`Archive is spec version ${r} but this library supports up to spec version 3`);return{specVersion:r,rootDirectoryOffset:It(t,8),rootDirectoryLength:It(t,16),jsonMetadataOffset:It(t,24),jsonMetadataLength:It(t,32),leafDirectoryOffset:It(t,40),leafDirectoryLength:It(t,48),tileDataOffset:It(t,56),tileDataLength:It(t,64),numAddressedTiles:It(t,72),numTileEntries:It(t,80),numTileContents:It(t,88),clustered:t.getUint8(96)===1,internalCompression:t.getUint8(97),tileCompression:t.getUint8(98),tileType:t.getUint8(99),minZoom:t.getUint8(100),maxZoom:t.getUint8(101),minLon:t.getInt32(102,!0)/1e7,minLat:t.getInt32(106,!0)/1e7,maxLon:t.getInt32(110,!0)/1e7,maxLat:t.getInt32(114,!0)/1e7,centerZoom:t.getUint8(118),centerLon:t.getInt32(119,!0)/1e7,centerLat:t.getInt32(123,!0)/1e7,etag:e}}Ae(Ed,"bytesToHeader");function ql(n){let e={buf:new Uint8Array(n),pos:0},t=bn(e),r=[],i=0;for(let s=0;s<t;s++){let o=bn(e);r.push({tileId:i+o,offset:0,length:0,runLength:1}),i+=o}for(let s=0;s<t;s++)r[s].runLength=bn(e);for(let s=0;s<t;s++)r[s].length=bn(e);for(let s=0;s<t;s++){let o=bn(e);o===0&&s>0?r[s].offset=r[s-1].offset+r[s-1].length:r[s].offset=o-1}return r}Ae(ql,"deserializeIndex");var wd=class extends Error{};Ae(wd,"EtagMismatch");var Ua=wd;function Hl(n,e){return Je(this,null,function*(){let t=yield n.getBytes(0,16384);if(new DataView(t.data).getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");let r=t.data.slice(0,Vx),i=Ed(r,t.etag),s=t.data.slice(i.rootDirectoryOffset,i.rootDirectoryOffset+i.rootDirectoryLength),o=`${n.getKey()}|${i.etag||""}|${i.rootDirectoryOffset}|${i.rootDirectoryLength}`,a=ql(yield e(s,i.internalCompression));return[i,[o,a.length,a]]})}Ae(Hl,"getHeaderAndRoot");function Yl(n,e,t,r,i){return Je(this,null,function*(){let s=yield n.getBytes(t,r,void 0,i.etag),o=yield e(s.data,i.internalCompression),a=ql(o);if(a.length===0)throw new Error("Empty directory is invalid");return a})}Ae(Yl,"getDirectory");var Zx=class{constructor(e=100,t=!0,r=_o){this.cache=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=r}getHeader(e){return Je(this,null,function*(){let t=e.getKey(),r=this.cache.get(t);if(r)return r.lastUsed=this.counter++,r.data;let i=yield Hl(e,this.decompress);return i[1]&&this.cache.set(i[1][0],{lastUsed:this.counter++,data:i[1][2]}),this.cache.set(t,{lastUsed:this.counter++,data:i[0]}),this.prune(),i[0]})}getDirectory(e,t,r,i){return Je(this,null,function*(){let s=`${e.getKey()}|${i.etag||""}|${t}|${r}`,o=this.cache.get(s);if(o)return o.lastUsed=this.counter++,o.data;let a=yield Yl(e,this.decompress,t,r,i);return this.cache.set(s,{lastUsed:this.counter++,data:a}),this.prune(),a})}prune(){if(this.cache.size>this.maxCacheEntries){let e=1/0,t;this.cache.forEach((r,i)=>{r.lastUsed<e&&(e=r.lastUsed,t=i)}),t&&this.cache.delete(t)}}invalidate(e){return Je(this,null,function*(){this.cache.delete(e.getKey())})}};Ae(Zx,"ResolvedValueCache");var vd=class{constructor(e=100,t=!0,r=_o){this.cache=new Map,this.invalidations=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=r}getHeader(e){return Je(this,null,function*(){let t=e.getKey(),r=this.cache.get(t);if(r)return r.lastUsed=this.counter++,yield r.data;let i=new Promise((s,o)=>{Hl(e,this.decompress).then(a=>{a[1]&&this.cache.set(a[1][0],{lastUsed:this.counter++,data:Promise.resolve(a[1][2])}),s(a[0]),this.prune()}).catch(a=>{o(a)})});return this.cache.set(t,{lastUsed:this.counter++,data:i}),i})}getDirectory(e,t,r,i){return Je(this,null,function*(){let s=`${e.getKey()}|${i.etag||""}|${t}|${r}`,o=this.cache.get(s);if(o)return o.lastUsed=this.counter++,yield o.data;let a=new Promise((l,u)=>{Yl(e,this.decompress,t,r,i).then(h=>{l(h),this.prune()}).catch(h=>{u(h)})});return this.cache.set(s,{lastUsed:this.counter++,data:a}),a})}prune(){if(this.cache.size>=this.maxCacheEntries){let e=1/0,t;this.cache.forEach((r,i)=>{r.lastUsed<e&&(e=r.lastUsed,t=i)}),t&&this.cache.delete(t)}}invalidate(e){return Je(this,null,function*(){let t=e.getKey();if(this.invalidations.get(t))return yield this.invalidations.get(t);this.cache.delete(e.getKey());let r=new Promise((i,s)=>{this.getHeader(e).then(o=>{i(),this.invalidations.delete(t)}).catch(o=>{s(o)})});this.invalidations.set(t,r)})}};Ae(vd,"SharedPromiseCache");var qx=vd,Td=class{constructor(e,t,r){typeof e=="string"?this.source=new Wx(e):this.source=e,r?this.decompress=r:this.decompress=_o,t?this.cache=t:this.cache=new qx}getHeader(){return Je(this,null,function*(){return yield this.cache.getHeader(this.source)})}getZxyAttempt(e,t,r,i){return Je(this,null,function*(){let s=yd(e,t,r),o=yield this.cache.getHeader(this.source);if(e<o.minZoom||e>o.maxZoom)return;let a=o.rootDirectoryOffset,l=o.rootDirectoryLength;for(let u=0;u<=3;u++){let h=yield this.cache.getDirectory(this.source,a,l,o),c=bd(h,s);if(c){if(c.runLength>0){let f=yield this.source.getBytes(o.tileDataOffset+c.offset,c.length,i,o.etag);return{data:yield this.decompress(f.data,o.tileCompression),cacheControl:f.cacheControl,expires:f.expires}}a=o.leafDirectoryOffset+c.offset,l=c.length}else return}throw new Error("Maximum directory depth exceeded")})}getZxy(e,t,r,i){return Je(this,null,function*(){try{return yield this.getZxyAttempt(e,t,r,i)}catch(s){if(s instanceof Ua)return this.cache.invalidate(this.source),yield this.getZxyAttempt(e,t,r,i);throw s}})}getMetadataAttempt(){return Je(this,null,function*(){let e=yield this.cache.getHeader(this.source),t=yield this.source.getBytes(e.jsonMetadataOffset,e.jsonMetadataLength,void 0,e.etag),r=yield this.decompress(t.data,e.internalCompression),i=new TextDecoder("utf-8");return JSON.parse(i.decode(r))})}getMetadata(){return Je(this,null,function*(){try{return yield this.getMetadataAttempt()}catch(e){if(e instanceof Ua)return this.cache.invalidate(this.source),yield this.getMetadataAttempt();throw e}})}getTileJson(e){return Je(this,null,function*(){let t=yield this.getHeader(),r=yield this.getMetadata(),i=_d(t.tileType);return{tilejson:"3.0.0",scheme:"xyz",tiles:[`${e}/{z}/{x}/{y}${i}`],vector_layers:r.vector_layers,attribution:r.attribution,description:r.description,name:r.name,version:r.version,bounds:[t.minLon,t.minLat,t.maxLon,t.maxLat],center:[t.centerLon,t.centerLat,t.centerZoom],minzoom:t.minZoom,maxzoom:t.maxZoom}})}};Ae(Td,"PMTiles");var vi=Td;class Hx extends sf{constructor(e){super(ft.ERROR),this.error=e}}function st(n){return(e,...t)=>Yx(n,e,t)}function Wn(n,e){return st(Sd(n,e).get)}const{apply:Yx,getOwnPropertyDescriptor:Sd,getPrototypeOf:Kl,ownKeys:Kx}=Reflect,{iterator:Wi,toStringTag:Jx}=Symbol,Qx=Object,{create:Jl,defineProperty:eE}=Qx,tE=Array,rE=tE.prototype,Rd=rE[Wi],nE=st(Rd),Pd=ArrayBuffer,iE=Pd.prototype;Wn(iE,"byteLength");const $c=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:null;$c&&Wn($c.prototype,"byteLength");const Ad=Kl(Uint8Array);Ad.from;const dt=Ad.prototype;dt[Wi];st(dt.keys);st(dt.values);st(dt.entries);st(dt.set);st(dt.reverse);st(dt.fill);st(dt.copyWithin);st(dt.sort);st(dt.slice);st(dt.subarray);Wn(dt,"buffer");Wn(dt,"byteOffset");Wn(dt,"length");Wn(dt,Jx);const sE=Uint8Array,Id=Uint16Array,Ql=Uint32Array,oE=Float32Array,Ti=Kl([][Wi]()),Cd=st(Ti.next),aE=st(function*(){}().next),lE=Kl(Ti),uE=DataView.prototype,cE=st(uE.getUint16),eu=WeakMap,Ld=eu.prototype,Fd=st(Ld.get),hE=st(Ld.set),Md=new eu,fE=Jl(null,{next:{value:function(){const e=Fd(Md,this);return Cd(e)}},[Wi]:{value:function(){return this}}});function dE(n){if(n[Wi]===Rd&&Ti.next===Cd)return n;const e=Jl(fE);return hE(Md,e,nE(n)),e}const pE=new eu,gE=Jl(lE,{next:{value:function(){const e=Fd(pE,this);return aE(e)},writable:!0,configurable:!0}});for(const n of Kx(Ti))n!=="next"&&eE(gE,n,Sd(Ti,n));const Od=new Pd(4),mE=new oE(Od),yE=new Ql(Od),Ht=new Id(512),Yt=new sE(512);for(let n=0;n<256;++n){const e=n-127;e<-24?(Ht[n]=0,Ht[n|256]=32768,Yt[n]=24,Yt[n|256]=24):e<-14?(Ht[n]=1024>>-e-14,Ht[n|256]=1024>>-e-14|32768,Yt[n]=-e-1,Yt[n|256]=-e-1):e<=15?(Ht[n]=e+15<<10,Ht[n|256]=e+15<<10|32768,Yt[n]=13,Yt[n|256]=13):e<128?(Ht[n]=31744,Ht[n|256]=64512,Yt[n]=24,Yt[n|256]=24):(Ht[n]=31744,Ht[n|256]=64512,Yt[n]=13,Yt[n|256]=13)}const tu=new Ql(2048);for(let n=1;n<1024;++n){let e=n<<13,t=0;for(;!(e&8388608);)e<<=1,t-=8388608;e&=-8388609,t+=947912704,tu[n]=e|t}for(let n=1024;n<2048;++n)tu[n]=939524096+(n-1024<<13);const Zn=new Ql(64);for(let n=1;n<31;++n)Zn[n]=n<<23;Zn[31]=1199570944;Zn[32]=2147483648;for(let n=33;n<63;++n)Zn[n]=2147483648+(n-32<<23);Zn[63]=3347054592;const Nd=new Id(64);for(let n=1;n<64;++n)n!==32&&(Nd[n]=1024);function _E(n){const e=n>>10;return yE[0]=tu[Nd[e]+(n&1023)]+Zn[e],mE[0]}function Dd(n,e,...t){return _E(cE(n,e,...dE(t)))}var ru={exports:{}};function Ud(n,e,t){const r=t&&t.debug||!1;r&&console.log("[xml-utils] getting "+e+" in "+n);const i=typeof n=="object"?n.outer:n,s=i.slice(0,i.indexOf(">")+1),o=['"',"'"];for(let a=0;a<o.length;a++){const l=o[a],u=e+"\\="+l+"([^"+l+"]*)"+l;r&&console.log("[xml-utils] pattern:",u);const c=new RegExp(u).exec(s);if(r&&console.log("[xml-utils] match:",c),c)return c[1]}}ru.exports=Ud;ru.exports.default=Ud;var bE=ru.exports;const Qo=wf(bE);var nu={exports:{}},iu={exports:{}},su={exports:{}};function Bd(n,e,t){const i=new RegExp(e).exec(n.slice(t));return i?t+i.index:-1}su.exports=Bd;su.exports.default=Bd;var xE=su.exports,ou={exports:{}};function Gd(n,e,t){const i=new RegExp(e).exec(n.slice(t));return i?t+i.index+i[0].length-1:-1}ou.exports=Gd;ou.exports.default=Gd;var EE=ou.exports,au={exports:{}};function zd(n,e){const t=new RegExp(e,"g"),r=n.match(t);return r?r.length:0}au.exports=zd;au.exports.default=zd;var wE=au.exports;const vE=xE,ea=EE,jc=wE;function kd(n,e,t){const r=t&&t.debug||!1,i=!(t&&typeof t.nested===!1),s=t&&t.startIndex||0;r&&console.log("[xml-utils] starting findTagByName with",e," and ",t);const o=vE(n,`<${e}[ 
>/]`,s);if(r&&console.log("[xml-utils] start:",o),o===-1)return;const a=n.slice(o+e.length);let l=ea(a,"^[^<]*[ /]>",0);const u=l!==-1&&a[l-1]==="/";if(r&&console.log("[xml-utils] selfClosing:",u),u===!1)if(i){let p=0,d=1,g=0;for(;(l=ea(a,"[ /]"+e+">",p))!==-1;){const m=a.substring(p,l+1);if(d+=jc(m,"<"+e+`[ 
	>]`),g+=jc(m,"</"+e+">"),g>=d)break;p=l}}else l=ea(a,"[ /]"+e+">",0);const h=o+e.length+l+1;if(r&&console.log("[xml-utils] end:",h),h===-1)return;const c=n.slice(o,h);let f;return u?f=null:f=c.slice(c.indexOf(">")+1,c.lastIndexOf("<")),{inner:f,outer:c,start:o,end:h}}iu.exports=kd;iu.exports.default=kd;var TE=iu.exports;const SE=TE;function $d(n,e,t){const r=[],i=t&&t.debug||!1,s=t&&typeof t.nested=="boolean"?t.nested:!0;let o=t&&t.startIndex||0,a;for(;a=SE(n,e,{debug:i,startIndex:o});)s?o=a.start+1+e.length:o=a.end,r.push(a);return i&&console.log("findTagsByName found",r.length,"tags"),r}nu.exports=$d;nu.exports.default=$d;var RE=nu.exports;const PE=wf(RE),fi={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop",33550:"ModelPixelScale",33922:"ModelTiepoint",34264:"ModelTransformation",34735:"GeoKeyDirectory",34736:"GeoDoubleParams",34737:"GeoAsciiParams",50674:"LercParameters"},Kt={};for(const n in fi)fi.hasOwnProperty(n)&&(Kt[fi[n]]=parseInt(n,10));const AE=[Kt.BitsPerSample,Kt.ExtraSamples,Kt.SampleFormat,Kt.StripByteCounts,Kt.StripOffsets,Kt.StripRowCounts,Kt.TileByteCounts,Kt.TileOffsets,Kt.SubIFDs],ta={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE",13:"IFD",16:"LONG8",17:"SLONG8",18:"IFD8"},ie={};for(const n in ta)ta.hasOwnProperty(n)&&(ie[ta[n]]=parseInt(n,10));const pt={WhiteIsZero:0,BlackIsZero:1,RGB:2,Palette:3,CMYK:5,YCbCr:6,CIELab:8,ICCLab:9},IE={Unspecified:0},NR={AddCompression:1},DR={None:0,Deflate:1,Zstandard:2},CE={1024:"GTModelTypeGeoKey",1025:"GTRasterTypeGeoKey",1026:"GTCitationGeoKey",2048:"GeographicTypeGeoKey",2049:"GeogCitationGeoKey",2050:"GeogGeodeticDatumGeoKey",2051:"GeogPrimeMeridianGeoKey",2052:"GeogLinearUnitsGeoKey",2053:"GeogLinearUnitSizeGeoKey",2054:"GeogAngularUnitsGeoKey",2055:"GeogAngularUnitSizeGeoKey",2056:"GeogEllipsoidGeoKey",2057:"GeogSemiMajorAxisGeoKey",2058:"GeogSemiMinorAxisGeoKey",2059:"GeogInvFlatteningGeoKey",2060:"GeogAzimuthUnitsGeoKey",2061:"GeogPrimeMeridianLongGeoKey",2062:"GeogTOWGS84GeoKey",3072:"ProjectedCSTypeGeoKey",3073:"PCSCitationGeoKey",3074:"ProjectionGeoKey",3075:"ProjCoordTransGeoKey",3076:"ProjLinearUnitsGeoKey",3077:"ProjLinearUnitSizeGeoKey",3078:"ProjStdParallel1GeoKey",3079:"ProjStdParallel2GeoKey",3080:"ProjNatOriginLongGeoKey",3081:"ProjNatOriginLatGeoKey",3082:"ProjFalseEastingGeoKey",3083:"ProjFalseNorthingGeoKey",3084:"ProjFalseOriginLongGeoKey",3085:"ProjFalseOriginLatGeoKey",3086:"ProjFalseOriginEastingGeoKey",3087:"ProjFalseOriginNorthingGeoKey",3088:"ProjCenterLongGeoKey",3089:"ProjCenterLatGeoKey",3090:"ProjCenterEastingGeoKey",3091:"ProjCenterNorthingGeoKey",3092:"ProjScaleAtNatOriginGeoKey",3093:"ProjScaleAtCenterGeoKey",3094:"ProjAzimuthAngleGeoKey",3095:"ProjStraightVertPoleLongGeoKey",3096:"ProjRectifiedGridAngleGeoKey",4096:"VerticalCSTypeGeoKey",4097:"VerticalCitationGeoKey",4098:"VerticalDatumGeoKey",4099:"VerticalUnitsGeoKey"};function LE(n,e){const{width:t,height:r}=n,i=new Uint8Array(t*r*3);let s;for(let o=0,a=0;o<n.length;++o,a+=3)s=256-n[o]/e*256,i[a]=s,i[a+1]=s,i[a+2]=s;return i}function FE(n,e){const{width:t,height:r}=n,i=new Uint8Array(t*r*3);let s;for(let o=0,a=0;o<n.length;++o,a+=3)s=n[o]/e*256,i[a]=s,i[a+1]=s,i[a+2]=s;return i}function ME(n,e){const{width:t,height:r}=n,i=new Uint8Array(t*r*3),s=e.length/3,o=e.length/3*2;for(let a=0,l=0;a<n.length;++a,l+=3){const u=n[a];i[l]=e[u]/65536*256,i[l+1]=e[u+s]/65536*256,i[l+2]=e[u+o]/65536*256}return i}function OE(n){const{width:e,height:t}=n,r=new Uint8Array(e*t*3);for(let i=0,s=0;i<n.length;i+=4,s+=3){const o=n[i],a=n[i+1],l=n[i+2],u=n[i+3];r[s]=255*((255-o)/256)*((255-u)/256),r[s+1]=255*((255-a)/256)*((255-u)/256),r[s+2]=255*((255-l)/256)*((255-u)/256)}return r}function NE(n){const{width:e,height:t}=n,r=new Uint8ClampedArray(e*t*3);for(let i=0,s=0;i<n.length;i+=3,s+=3){const o=n[i],a=n[i+1],l=n[i+2];r[s]=o+1.402*(l-128),r[s+1]=o-.34414*(a-128)-.71414*(l-128),r[s+2]=o+1.772*(a-128)}return r}const DE=.95047,UE=1,BE=1.08883;function GE(n){const{width:e,height:t}=n,r=new Uint8Array(e*t*3);for(let i=0,s=0;i<n.length;i+=3,s+=3){const o=n[i+0],a=n[i+1]<<24>>24,l=n[i+2]<<24>>24;let u=(o+16)/116,h=a/500+u,c=u-l/200,f,p,d;h=DE*(h*h*h>.008856?h*h*h:(h-16/116)/7.787),u=UE*(u*u*u>.008856?u*u*u:(u-16/116)/7.787),c=BE*(c*c*c>.008856?c*c*c:(c-16/116)/7.787),f=h*3.2406+u*-1.5372+c*-.4986,p=h*-.9689+u*1.8758+c*.0415,d=h*.0557+u*-.204+c*1.057,f=f>.0031308?1.055*f**(1/2.4)-.055:12.92*f,p=p>.0031308?1.055*p**(1/2.4)-.055:12.92*p,d=d>.0031308?1.055*d**(1/2.4)-.055:12.92*d,r[s]=Math.max(0,Math.min(1,f))*255,r[s+1]=Math.max(0,Math.min(1,p))*255,r[s+2]=Math.max(0,Math.min(1,d))*255}return r}const jd=new Map;function jr(n,e){Array.isArray(n)||(n=[n]),n.forEach(t=>jd.set(t,e))}async function Vd(n){const e=jd.get(n.Compression);if(!e)throw new Error(`Unknown compression method identifier: ${n.Compression}`);const t=await e();return new t(n)}jr([void 0,1],()=>$r(()=>import("./raw.DxtaBMev.js"),__vite__mapDeps([0,1])).then(n=>n.default));jr(5,()=>$r(()=>import("./lzw.BikwkTY2.js"),__vite__mapDeps([2,1])).then(n=>n.default));jr(6,()=>{throw new Error("old style JPEG compression is not supported.")});jr(7,()=>$r(()=>import("./jpeg.CbvpOiPg.js"),__vite__mapDeps([3,1])).then(n=>n.default));jr([8,32946],()=>$r(()=>import("./deflate.B4_27dB1.js"),__vite__mapDeps([4,5,1])).then(n=>n.default));jr(32773,()=>$r(()=>import("./packbits.D6Qr5eNi.js"),__vite__mapDeps([6,1])).then(n=>n.default));jr(34887,()=>$r(()=>import("./lerc.Dhuk8PcV.js"),__vite__mapDeps([7,5,8,1,9,10,11,12,13,14,15])).then(async n=>(await n.zstd.init(),n)).then(n=>n.default));jr(50001,()=>$r(()=>import("./webimage.CU41Mh7j.js"),__vite__mapDeps([16,1])).then(n=>n.default));function bo(n,e,t,r=1){return new(Object.getPrototypeOf(n)).constructor(e*t*r)}function zE(n,e,t,r,i){const s=e/r,o=t/i;return n.map(a=>{const l=bo(a,r,i);for(let u=0;u<i;++u){const h=Math.min(Math.round(o*u),t-1);for(let c=0;c<r;++c){const f=Math.min(Math.round(s*c),e-1),p=a[h*e+f];l[u*r+c]=p}}return l})}function Rn(n,e,t){return(1-t)*n+t*e}function kE(n,e,t,r,i){const s=e/r,o=t/i;return n.map(a=>{const l=bo(a,r,i);for(let u=0;u<i;++u){const h=o*u,c=Math.floor(h),f=Math.min(Math.ceil(h),t-1);for(let p=0;p<r;++p){const d=s*p,g=d%1,m=Math.floor(d),_=Math.min(Math.ceil(d),e-1),y=a[c*e+m],b=a[c*e+_],v=a[f*e+m],x=a[f*e+_],E=Rn(Rn(y,b,g),Rn(v,x,g),h%1);l[u*r+p]=E}}return l})}function $E(n,e,t,r,i,s="nearest"){switch(s.toLowerCase()){case"nearest":return zE(n,e,t,r,i);case"bilinear":case"linear":return kE(n,e,t,r,i);default:throw new Error(`Unsupported resampling method: '${s}'`)}}function jE(n,e,t,r,i,s){const o=e/r,a=t/i,l=bo(n,r,i,s);for(let u=0;u<i;++u){const h=Math.min(Math.round(a*u),t-1);for(let c=0;c<r;++c){const f=Math.min(Math.round(o*c),e-1);for(let p=0;p<s;++p){const d=n[h*e*s+f*s+p];l[u*r*s+c*s+p]=d}}}return l}function VE(n,e,t,r,i,s){const o=e/r,a=t/i,l=bo(n,r,i,s);for(let u=0;u<i;++u){const h=a*u,c=Math.floor(h),f=Math.min(Math.ceil(h),t-1);for(let p=0;p<r;++p){const d=o*p,g=d%1,m=Math.floor(d),_=Math.min(Math.ceil(d),e-1);for(let y=0;y<s;++y){const b=n[c*e*s+m*s+y],v=n[c*e*s+_*s+y],x=n[f*e*s+m*s+y],E=n[f*e*s+_*s+y],S=Rn(Rn(b,v,g),Rn(x,E,g),h%1);l[u*r*s+p*s+y]=S}}}return l}function XE(n,e,t,r,i,s,o="nearest"){switch(o.toLowerCase()){case"nearest":return jE(n,e,t,r,i,s);case"bilinear":case"linear":return VE(n,e,t,r,i,s);default:throw new Error(`Unsupported resampling method: '${o}'`)}}function WE(n,e,t){let r=0;for(let i=e;i<t;++i)r+=n[i];return r}function Ba(n,e,t){switch(n){case 1:if(e<=8)return new Uint8Array(t);if(e<=16)return new Uint16Array(t);if(e<=32)return new Uint32Array(t);break;case 2:if(e===8)return new Int8Array(t);if(e===16)return new Int16Array(t);if(e===32)return new Int32Array(t);break;case 3:switch(e){case 16:case 32:return new Float32Array(t);case 64:return new Float64Array(t)}break}throw Error("Unsupported data format/bitsPerSample")}function ZE(n,e){return(n===1||n===2)&&e<=32&&e%8===0?!1:!(n===3&&(e===16||e===32||e===64))}function qE(n,e,t,r,i,s,o){const a=new DataView(n),l=t===2?o*s:o*s*r,u=t===2?1:r,h=Ba(e,i,l),c=parseInt("1".repeat(i),2);if(e===1){let f;t===1?f=r*i:f=i;let p=s*f;p&7&&(p=p+7&-8);for(let d=0;d<o;++d){const g=d*p;for(let m=0;m<s;++m){const _=g+m*u*i;for(let y=0;y<u;++y){const b=_+y*i,v=(d*s+m)*u+y,x=Math.floor(b/8),E=b%8;if(E+i<=8)h[v]=a.getUint8(x)>>8-i-E&c;else if(E+i<=16)h[v]=a.getUint16(x)>>16-i-E&c;else if(E+i<=24){const S=a.getUint16(x)<<8|a.getUint8(x+2);h[v]=S>>24-i-E&c}else h[v]=a.getUint32(x)>>32-i-E&c}}}}return h.buffer}class Xd{constructor(e,t,r,i,s,o){this.fileDirectory=e,this.geoKeys=t,this.dataView=r,this.littleEndian=i,this.tiles=s?{}:null,this.isTiled=!e.StripOffsets;const a=e.PlanarConfiguration;if(this.planarConfiguration=typeof a>"u"?1:a,this.planarConfiguration!==1&&this.planarConfiguration!==2)throw new Error("Invalid planar configuration.");this.source=o}getFileDirectory(){return this.fileDirectory}getGeoKeys(){return this.geoKeys}getWidth(){return this.fileDirectory.ImageWidth}getHeight(){return this.fileDirectory.ImageLength}getSamplesPerPixel(){return typeof this.fileDirectory.SamplesPerPixel<"u"?this.fileDirectory.SamplesPerPixel:1}getTileWidth(){return this.isTiled?this.fileDirectory.TileWidth:this.getWidth()}getTileHeight(){return this.isTiled?this.fileDirectory.TileLength:typeof this.fileDirectory.RowsPerStrip<"u"?Math.min(this.fileDirectory.RowsPerStrip,this.getHeight()):this.getHeight()}getBlockWidth(){return this.getTileWidth()}getBlockHeight(e){return this.isTiled||(e+1)*this.getTileHeight()<=this.getHeight()?this.getTileHeight():this.getHeight()-e*this.getTileHeight()}getBytesPerPixel(){let e=0;for(let t=0;t<this.fileDirectory.BitsPerSample.length;++t)e+=this.getSampleByteSize(t);return e}getSampleByteSize(e){if(e>=this.fileDirectory.BitsPerSample.length)throw new RangeError(`Sample index ${e} is out of range.`);return Math.ceil(this.fileDirectory.BitsPerSample[e]/8)}getReaderForSample(e){const t=this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1,r=this.fileDirectory.BitsPerSample[e];switch(t){case 1:if(r<=8)return DataView.prototype.getUint8;if(r<=16)return DataView.prototype.getUint16;if(r<=32)return DataView.prototype.getUint32;break;case 2:if(r<=8)return DataView.prototype.getInt8;if(r<=16)return DataView.prototype.getInt16;if(r<=32)return DataView.prototype.getInt32;break;case 3:switch(r){case 16:return function(i,s){return Dd(this,i,s)};case 32:return DataView.prototype.getFloat32;case 64:return DataView.prototype.getFloat64}break}throw Error("Unsupported data format/bitsPerSample")}getSampleFormat(e=0){return this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1}getBitsPerSample(e=0){return this.fileDirectory.BitsPerSample[e]}getArrayForSample(e,t){const r=this.getSampleFormat(e),i=this.getBitsPerSample(e);return Ba(r,i,t)}async getTileOrStrip(e,t,r,i,s){const o=Math.ceil(this.getWidth()/this.getTileWidth()),a=Math.ceil(this.getHeight()/this.getTileHeight());let l;const{tiles:u}=this;this.planarConfiguration===1?l=t*o+e:this.planarConfiguration===2&&(l=r*o*a+t*o+e);let h,c;this.isTiled?(h=this.fileDirectory.TileOffsets[l],c=this.fileDirectory.TileByteCounts[l]):(h=this.fileDirectory.StripOffsets[l],c=this.fileDirectory.StripByteCounts[l]);const f=(await this.source.fetch([{offset:h,length:c}],s))[0];let p;return u===null||!u[l]?(p=(async()=>{let d=await i.decode(this.fileDirectory,f);const g=this.getSampleFormat(),m=this.getBitsPerSample();return ZE(g,m)&&(d=qE(d,g,this.planarConfiguration,this.getSamplesPerPixel(),m,this.getTileWidth(),this.getBlockHeight(t))),d})(),u!==null&&(u[l]=p)):p=u[l],{x:e,y:t,sample:r,data:await p}}async _readRaster(e,t,r,i,s,o,a,l,u){const h=this.getTileWidth(),c=this.getTileHeight(),f=this.getWidth(),p=this.getHeight(),d=Math.max(Math.floor(e[0]/h),0),g=Math.min(Math.ceil(e[2]/h),Math.ceil(f/h)),m=Math.max(Math.floor(e[1]/c),0),_=Math.min(Math.ceil(e[3]/c),Math.ceil(p/c)),y=e[2]-e[0];let b=this.getBytesPerPixel();const v=[],x=[];for(let A=0;A<t.length;++A)this.planarConfiguration===1?v.push(WE(this.fileDirectory.BitsPerSample,0,t[A])/8):v.push(0),x.push(this.getReaderForSample(t[A]));const E=[],{littleEndian:S}=this;for(let A=m;A<_;++A)for(let P=d;P<g;++P){let R;this.planarConfiguration===1&&(R=this.getTileOrStrip(P,A,0,s,u));for(let I=0;I<t.length;++I){const N=I,X=t[I];this.planarConfiguration===2&&(b=this.getSampleByteSize(X),R=this.getTileOrStrip(P,A,X,s,u));const M=R.then(F=>{const $=F.data,z=new DataView($),ne=this.getBlockHeight(F.y),Z=F.y*c,C=F.x*h,he=Z+ne,ve=(F.x+1)*h,Y=x[N],Le=Math.min(ne,ne-(he-e[3]),p-Z),fe=Math.min(h,h-(ve-e[2]),f-C);for(let _e=Math.max(0,e[1]-Z);_e<Le;++_e)for(let Ie=Math.max(0,e[0]-C);Ie<fe;++Ie){const Ne=(_e*h+Ie)*b,Xe=Y.call(z,Ne+v[N],S);let G;i?(G=(_e+Z-e[1])*y*t.length+(Ie+C-e[0])*t.length+N,r[G]=Xe):(G=(_e+Z-e[1])*y+Ie+C-e[0],r[N][G]=Xe)}});E.push(M)}}if(await Promise.all(E),o&&e[2]-e[0]!==o||a&&e[3]-e[1]!==a){let A;return i?A=XE(r,e[2]-e[0],e[3]-e[1],o,a,t.length,l):A=$E(r,e[2]-e[0],e[3]-e[1],o,a,l),A.width=o,A.height=a,A}return r.width=o||e[2]-e[0],r.height=a||e[3]-e[1],r}async readRasters({window:e,samples:t=[],interleave:r,pool:i=null,width:s,height:o,resampleMethod:a,fillValue:l,signal:u}={}){const h=e||[0,0,this.getWidth(),this.getHeight()];if(h[0]>h[2]||h[1]>h[3])throw new Error("Invalid subsets");const c=h[2]-h[0],f=h[3]-h[1],p=c*f,d=this.getSamplesPerPixel();if(!t||!t.length)for(let y=0;y<d;++y)t.push(y);else for(let y=0;y<t.length;++y)if(t[y]>=d)return Promise.reject(new RangeError(`Invalid sample index '${t[y]}'.`));let g;if(r){const y=this.fileDirectory.SampleFormat?Math.max.apply(null,this.fileDirectory.SampleFormat):1,b=Math.max.apply(null,this.fileDirectory.BitsPerSample);g=Ba(y,b,p*t.length),l&&g.fill(l)}else{g=[];for(let y=0;y<t.length;++y){const b=this.getArrayForSample(t[y],p);Array.isArray(l)&&y<l.length?b.fill(l[y]):l&&!Array.isArray(l)&&b.fill(l),g.push(b)}}const m=i||await Vd(this.fileDirectory);return await this._readRaster(h,t,g,r,m,s,o,a,u)}async readRGB({window:e,interleave:t=!0,pool:r=null,width:i,height:s,resampleMethod:o,enableAlpha:a=!1,signal:l}={}){const u=e||[0,0,this.getWidth(),this.getHeight()];if(u[0]>u[2]||u[1]>u[3])throw new Error("Invalid subsets");const h=this.fileDirectory.PhotometricInterpretation;if(h===pt.RGB){let _=[0,1,2];if(this.fileDirectory.ExtraSamples!==IE.Unspecified&&a){_=[];for(let y=0;y<this.fileDirectory.BitsPerSample.length;y+=1)_.push(y)}return this.readRasters({window:e,interleave:t,samples:_,pool:r,width:i,height:s,resampleMethod:o,signal:l})}let c;switch(h){case pt.WhiteIsZero:case pt.BlackIsZero:case pt.Palette:c=[0];break;case pt.CMYK:c=[0,1,2,3];break;case pt.YCbCr:case pt.CIELab:c=[0,1,2];break;default:throw new Error("Invalid or unsupported photometric interpretation.")}const f={window:u,interleave:!0,samples:c,pool:r,width:i,height:s,resampleMethod:o,signal:l},{fileDirectory:p}=this,d=await this.readRasters(f),g=2**this.fileDirectory.BitsPerSample[0];let m;switch(h){case pt.WhiteIsZero:m=LE(d,g);break;case pt.BlackIsZero:m=FE(d,g);break;case pt.Palette:m=ME(d,p.ColorMap);break;case pt.CMYK:m=OE(d);break;case pt.YCbCr:m=NE(d);break;case pt.CIELab:m=GE(d);break;default:throw new Error("Unsupported photometric interpretation.")}if(!t){const _=new Uint8Array(m.length/3),y=new Uint8Array(m.length/3),b=new Uint8Array(m.length/3);for(let v=0,x=0;v<m.length;v+=3,++x)_[x]=m[v],y[x]=m[v+1],b[x]=m[v+2];m=[_,y,b]}return m.width=d.width,m.height=d.height,m}getTiePoints(){if(!this.fileDirectory.ModelTiepoint)return[];const e=[];for(let t=0;t<this.fileDirectory.ModelTiepoint.length;t+=6)e.push({i:this.fileDirectory.ModelTiepoint[t],j:this.fileDirectory.ModelTiepoint[t+1],k:this.fileDirectory.ModelTiepoint[t+2],x:this.fileDirectory.ModelTiepoint[t+3],y:this.fileDirectory.ModelTiepoint[t+4],z:this.fileDirectory.ModelTiepoint[t+5]});return e}getGDALMetadata(e=null){const t={};if(!this.fileDirectory.GDAL_METADATA)return null;const r=this.fileDirectory.GDAL_METADATA;let i=PE(r,"Item");e===null?i=i.filter(s=>Qo(s,"sample")===void 0):i=i.filter(s=>Number(Qo(s,"sample"))===e);for(let s=0;s<i.length;++s){const o=i[s];t[Qo(o,"name")]=o.inner}return t}getGDALNoData(){if(!this.fileDirectory.GDAL_NODATA)return null;const e=this.fileDirectory.GDAL_NODATA;return Number(e.substring(0,e.length-1))}getOrigin(){const e=this.fileDirectory.ModelTiepoint,t=this.fileDirectory.ModelTransformation;if(e&&e.length===6)return[e[3],e[4],e[5]];if(t)return[t[3],t[7],t[11]];throw new Error("The image does not have an affine transformation.")}getResolution(e=null){const t=this.fileDirectory.ModelPixelScale,r=this.fileDirectory.ModelTransformation;if(t)return[t[0],-t[1],t[2]];if(r)return r[1]===0&&r[4]===0?[r[0],-r[5],r[10]]:[Math.sqrt(r[0]*r[0]+r[4]*r[4]),-Math.sqrt(r[1]*r[1]+r[5]*r[5]),r[10]];if(e){const[i,s,o]=e.getResolution();return[i*e.getWidth()/this.getWidth(),s*e.getHeight()/this.getHeight(),o*e.getWidth()/this.getWidth()]}throw new Error("The image does not have an affine transformation.")}pixelIsArea(){return this.geoKeys.GTRasterTypeGeoKey===1}getBoundingBox(e=!1){const t=this.getHeight(),r=this.getWidth();if(this.fileDirectory.ModelTransformation&&!e){const[i,s,o,a,l,u,h,c]=this.fileDirectory.ModelTransformation,p=[[0,0],[0,t],[r,0],[r,t]].map(([m,_])=>[a+i*m+s*_,c+l*m+u*_]),d=p.map(m=>m[0]),g=p.map(m=>m[1]);return[Math.min(...d),Math.min(...g),Math.max(...d),Math.max(...g)]}else{const i=this.getOrigin(),s=this.getResolution(),o=i[0],a=i[1],l=o+s[0]*r,u=a+s[1]*t;return[Math.min(o,l),Math.min(a,u),Math.max(o,l),Math.max(a,u)]}}}class HE{constructor(e){this._dataView=new DataView(e)}get buffer(){return this._dataView.buffer}getUint64(e,t){const r=this.getUint32(e,t),i=this.getUint32(e+4,t);let s;if(t){if(s=r+2**32*i,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}if(s=2**32*r+i,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}getInt64(e,t){let r=0;const i=(this._dataView.getUint8(e+(t?7:0))&128)>0;let s=!0;for(let o=0;o<8;o++){let a=this._dataView.getUint8(e+(t?o:7-o));i&&(s?a!==0&&(a=~(a-1)&255,s=!1):a=~a&255),r+=a*256**o}return i&&(r=-r),r}getUint8(e,t){return this._dataView.getUint8(e,t)}getInt8(e,t){return this._dataView.getInt8(e,t)}getUint16(e,t){return this._dataView.getUint16(e,t)}getInt16(e,t){return this._dataView.getInt16(e,t)}getUint32(e,t){return this._dataView.getUint32(e,t)}getInt32(e,t){return this._dataView.getInt32(e,t)}getFloat16(e,t){return Dd(this._dataView,e,t)}getFloat32(e,t){return this._dataView.getFloat32(e,t)}getFloat64(e,t){return this._dataView.getFloat64(e,t)}}class YE{constructor(e,t,r,i){this._dataView=new DataView(e),this._sliceOffset=t,this._littleEndian=r,this._bigTiff=i}get sliceOffset(){return this._sliceOffset}get sliceTop(){return this._sliceOffset+this.buffer.byteLength}get littleEndian(){return this._littleEndian}get bigTiff(){return this._bigTiff}get buffer(){return this._dataView.buffer}covers(e,t){return this.sliceOffset<=e&&this.sliceTop>=e+t}readUint8(e){return this._dataView.getUint8(e-this._sliceOffset,this._littleEndian)}readInt8(e){return this._dataView.getInt8(e-this._sliceOffset,this._littleEndian)}readUint16(e){return this._dataView.getUint16(e-this._sliceOffset,this._littleEndian)}readInt16(e){return this._dataView.getInt16(e-this._sliceOffset,this._littleEndian)}readUint32(e){return this._dataView.getUint32(e-this._sliceOffset,this._littleEndian)}readInt32(e){return this._dataView.getInt32(e-this._sliceOffset,this._littleEndian)}readFloat32(e){return this._dataView.getFloat32(e-this._sliceOffset,this._littleEndian)}readFloat64(e){return this._dataView.getFloat64(e-this._sliceOffset,this._littleEndian)}readUint64(e){const t=this.readUint32(e),r=this.readUint32(e+4);let i;if(this._littleEndian){if(i=t+2**32*r,!Number.isSafeInteger(i))throw new Error(`${i} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return i}if(i=2**32*t+r,!Number.isSafeInteger(i))throw new Error(`${i} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return i}readInt64(e){let t=0;const r=(this._dataView.getUint8(e+(this._littleEndian?7:0))&128)>0;let i=!0;for(let s=0;s<8;s++){let o=this._dataView.getUint8(e+(this._littleEndian?s:7-s));r&&(i?o!==0&&(o=~(o-1)&255,i=!1):o=~o&255),t+=o*256**s}return r&&(t=-t),t}readOffset(e){return this._bigTiff?this.readUint64(e):this.readUint32(e)}}const KE=typeof navigator<"u"&&navigator.hardwareConcurrency||2;class JE{constructor(e=KE,t){this.workers=null,this._awaitingDecoder=null,this.size=e,this.messageId=0,e&&(this._awaitingDecoder=t?Promise.resolve(t):new Promise(r=>{$r(()=>import("./decoder.tqM1uIvc.js"),[]).then(i=>{r(i.create)})}),this._awaitingDecoder.then(r=>{this._awaitingDecoder=null,this.workers=[];for(let i=0;i<e;i++)this.workers.push({worker:r(),idle:!0})}))}async decode(e,t){return this._awaitingDecoder&&await this._awaitingDecoder,this.size===0?Vd(e).then(r=>r.decode(e,t)):new Promise(r=>{const i=this.workers.find(a=>a.idle)||this.workers[Math.floor(Math.random()*this.size)];i.idle=!1;const s=this.messageId++,o=a=>{a.data.id===s&&(i.idle=!0,r(a.data.decoded),i.worker.removeEventListener("message",o))};i.worker.addEventListener("message",o),i.worker.postMessage({fileDirectory:e,buffer:t,id:s},[t])})}destroy(){this.workers&&(this.workers.forEach(e=>{e.worker.terminate()}),this.workers=null)}}const Vc=`\r
\r
`;function Wd(n){if(typeof Object.fromEntries<"u")return Object.fromEntries(n);const e={};for(const[t,r]of n)e[t.toLowerCase()]=r;return e}function QE(n){const e=n.split(`\r
`).map(t=>{const r=t.split(":").map(i=>i.trim());return r[0]=r[0].toLowerCase(),r});return Wd(e)}function ew(n){const[e,...t]=n.split(";").map(i=>i.trim()),r=t.map(i=>i.split("="));return{type:e,params:Wd(r)}}function Ga(n){let e,t,r;return n&&([,e,t,r]=n.match(/bytes (\d+)-(\d+)\/(\d+)/),e=parseInt(e,10),t=parseInt(t,10),r=parseInt(r,10)),{start:e,end:t,total:r}}function tw(n,e){let t=null;const r=new TextDecoder("ascii"),i=[],s=`--${e}`,o=`${s}--`;for(let a=0;a<10;++a)r.decode(new Uint8Array(n,a,s.length))===s&&(t=a);if(t===null)throw new Error("Could not find initial boundary");for(;t<n.byteLength;){const a=r.decode(new Uint8Array(n,t,Math.min(s.length+1024,n.byteLength-t)));if(a.length===0||a.startsWith(o))break;if(!a.startsWith(s))throw new Error("Part does not start with boundary");const l=a.substr(s.length+2);if(l.length===0)break;const u=l.indexOf(Vc),h=QE(l.substr(0,u)),{start:c,end:f,total:p}=Ga(h["content-range"]),d=t+s.length+u+Vc.length,g=parseInt(f,10)+1-parseInt(c,10);i.push({headers:h,data:n.slice(d,d+g),offset:c,length:g,fileSize:p}),t=d+g+4}return i}class lu{async fetch(e,t=void 0){return Promise.all(e.map(r=>this.fetchSlice(r,t)))}async fetchSlice(e){throw new Error(`fetching of slice ${e} not possible, not implemented`)}get fileSize(){return null}async close(){}}class rw extends Map{constructor(e={}){if(super(),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof e.maxAge=="number"&&e.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=e.maxSize,this.maxAge=e.maxAge||Number.POSITIVE_INFINITY,this.onEviction=e.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(e){if(typeof this.onEviction=="function")for(const[t,r]of e)this.onEviction(t,r.value)}_deleteIfExpired(e,t){return typeof t.expiry=="number"&&t.expiry<=Date.now()?(typeof this.onEviction=="function"&&this.onEviction(e,t.value),this.delete(e)):!1}_getOrDeleteIfExpired(e,t){if(this._deleteIfExpired(e,t)===!1)return t.value}_getItemValue(e,t){return t.expiry?this._getOrDeleteIfExpired(e,t):t.value}_peek(e,t){const r=t.get(e);return this._getItemValue(e,r)}_set(e,t){this.cache.set(e,t),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(e,t){this.oldCache.delete(e),this._set(e,t)}*_entriesAscending(){for(const e of this.oldCache){const[t,r]=e;this.cache.has(t)||this._deleteIfExpired(t,r)===!1&&(yield e)}for(const e of this.cache){const[t,r]=e;this._deleteIfExpired(t,r)===!1&&(yield e)}}get(e){if(this.cache.has(e)){const t=this.cache.get(e);return this._getItemValue(e,t)}if(this.oldCache.has(e)){const t=this.oldCache.get(e);if(this._deleteIfExpired(e,t)===!1)return this._moveToRecent(e,t),t.value}}set(e,t,{maxAge:r=this.maxAge}={}){const i=typeof r=="number"&&r!==Number.POSITIVE_INFINITY?Date.now()+r:void 0;return this.cache.has(e)?this.cache.set(e,{value:t,expiry:i}):this._set(e,{value:t,expiry:i}),this}has(e){return this.cache.has(e)?!this._deleteIfExpired(e,this.cache.get(e)):this.oldCache.has(e)?!this._deleteIfExpired(e,this.oldCache.get(e)):!1}peek(e){if(this.cache.has(e))return this._peek(e,this.cache);if(this.oldCache.has(e))return this._peek(e,this.oldCache)}delete(e){const t=this.cache.delete(e);return t&&this._size--,this.oldCache.delete(e)||t}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(e){if(!(e&&e>0))throw new TypeError("`maxSize` must be a number greater than 0");const t=[...this._entriesAscending()],r=t.length-e;r<0?(this.cache=new Map(t),this.oldCache=new Map,this._size=t.length):(r>0&&this._emitEvictions(t.slice(0,r)),this.oldCache=new Map(t.slice(r)),this.cache=new Map,this._size=0),this.maxSize=e}*keys(){for(const[e]of this)yield e}*values(){for(const[,e]of this)yield e}*[Symbol.iterator](){for(const e of this.cache){const[t,r]=e;this._deleteIfExpired(t,r)===!1&&(yield[t,r.value])}for(const e of this.oldCache){const[t,r]=e;this.cache.has(t)||this._deleteIfExpired(t,r)===!1&&(yield[t,r.value])}}*entriesDescending(){let e=[...this.cache];for(let t=e.length-1;t>=0;--t){const r=e[t],[i,s]=r;this._deleteIfExpired(i,s)===!1&&(yield[i,s.value])}e=[...this.oldCache];for(let t=e.length-1;t>=0;--t){const r=e[t],[i,s]=r;this.cache.has(i)||this._deleteIfExpired(i,s)===!1&&(yield[i,s.value])}}*entriesAscending(){for(const[e,t]of this._entriesAscending())yield[e,t.value]}get size(){if(!this._size)return this.oldCache.size;let e=0;for(const t of this.oldCache.keys())this.cache.has(t)||e++;return Math.min(this._size+e,this.maxSize)}entries(){return this.entriesAscending()}forEach(e,t=this){for(const[r,i]of this.entriesAscending())e.call(t,i,r,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}async function nw(n){return new Promise(e=>setTimeout(e,n))}function iw(n,e){const t=Array.isArray(n)?n:Array.from(n),r=Array.isArray(e)?e:Array.from(e);return t.map((i,s)=>[i,r[s]])}class Nn extends Error{constructor(e){super(e),Error.captureStackTrace&&Error.captureStackTrace(this,Nn),this.name="AbortError"}}class sw extends Error{constructor(e,t){super(t),this.errors=e,this.message=t,this.name="AggregateError"}}const ow=sw;class aw{constructor(e,t,r=null){this.offset=e,this.length=t,this.data=r}get top(){return this.offset+this.length}}class Xc{constructor(e,t,r){this.offset=e,this.length=t,this.blockIds=r}}class lw extends lu{constructor(e,{blockSize:t=65536,cacheSize:r=100}={}){super(),this.source=e,this.blockSize=t,this.blockCache=new rw({maxSize:r,onEviction:(i,s)=>{this.evictedBlocks.set(i,s)}}),this.evictedBlocks=new Map,this.blockRequests=new Map,this.blockIdsToFetch=new Set,this.abortedBlockIds=new Set}get fileSize(){return this.source.fileSize}async fetch(e,t){const r=[],i=[],s=[];this.evictedBlocks.clear();for(const{offset:f,length:p}of e){let d=f+p;const{fileSize:g}=this;g!==null&&(d=Math.min(d,g));const m=Math.floor(f/this.blockSize)*this.blockSize;for(let _=m;_<d;_+=this.blockSize){const y=Math.floor(_/this.blockSize);!this.blockCache.has(y)&&!this.blockRequests.has(y)&&(this.blockIdsToFetch.add(y),i.push(y)),this.blockRequests.has(y)&&r.push(this.blockRequests.get(y)),s.push(y)}}await nw(),this.fetchBlocks(t);const o=[];for(const f of i)this.blockRequests.has(f)&&o.push(this.blockRequests.get(f));await Promise.allSettled(r),await Promise.allSettled(o);const a=[],l=s.filter(f=>this.abortedBlockIds.has(f)||!this.blockCache.has(f));if(l.forEach(f=>this.blockIdsToFetch.add(f)),l.length>0&&t&&!t.aborted){this.fetchBlocks(null);for(const f of l){const p=this.blockRequests.get(f);if(!p)throw new Error(`Block ${f} is not in the block requests`);a.push(p)}await Promise.allSettled(a)}if(t&&t.aborted)throw new Nn("Request was aborted");const u=s.map(f=>this.blockCache.get(f)||this.evictedBlocks.get(f)),h=u.filter(f=>!f);if(h.length)throw new ow(h,"Request failed");const c=new Map(iw(s,u));return this.readSliceData(e,c)}fetchBlocks(e){if(this.blockIdsToFetch.size>0){const t=this.groupBlocks(this.blockIdsToFetch),r=this.source.fetch(t,e);for(let i=0;i<t.length;++i){const s=t[i];for(const o of s.blockIds)this.blockRequests.set(o,(async()=>{try{const a=(await r)[i],l=o*this.blockSize,u=l-a.offset,h=Math.min(u+this.blockSize,a.data.byteLength),c=a.data.slice(u,h),f=new aw(l,c.byteLength,c,o);this.blockCache.set(o,f),this.abortedBlockIds.delete(o)}catch(a){if(a.name==="AbortError")a.signal=e,this.blockCache.delete(o),this.abortedBlockIds.add(o);else throw a}finally{this.blockRequests.delete(o)}})())}this.blockIdsToFetch.clear()}}groupBlocks(e){const t=Array.from(e).sort((o,a)=>o-a);if(t.length===0)return[];let r=[],i=null;const s=[];for(const o of t)i===null||i+1===o?(r.push(o),i=o):(s.push(new Xc(r[0]*this.blockSize,r.length*this.blockSize,r)),r=[o],i=o);return s.push(new Xc(r[0]*this.blockSize,r.length*this.blockSize,r)),s}readSliceData(e,t){return e.map(r=>{let i=r.offset+r.length;this.fileSize!==null&&(i=Math.min(this.fileSize,i));const s=Math.floor(r.offset/this.blockSize),o=Math.floor(i/this.blockSize),a=new ArrayBuffer(r.length),l=new Uint8Array(a);for(let u=s;u<=o;++u){const h=t.get(u),c=h.offset-r.offset,f=h.top-i;let p=0,d=0,g;c<0?p=-c:c>0&&(d=c),f<0?g=h.length-p:g=i-h.offset-p;const m=new Uint8Array(h.data,p,g);l.set(m,d)}return a})}}class uu{get ok(){return this.status>=200&&this.status<=299}get status(){throw new Error("not implemented")}getHeader(e){throw new Error("not implemented")}async getData(){throw new Error("not implemented")}}class cu{constructor(e){this.url=e}async request({headers:e,signal:t}={}){throw new Error("request is not implemented")}}class uw extends uu{constructor(e){super(),this.response=e}get status(){return this.response.status}getHeader(e){return this.response.headers.get(e)}async getData(){return this.response.arrayBuffer?await this.response.arrayBuffer():(await this.response.buffer()).buffer}}class cw extends cu{constructor(e,t){super(e),this.credentials=t}async request({headers:e,signal:t}={}){const r=await fetch(this.url,{headers:e,credentials:this.credentials,signal:t});return new uw(r)}}class hw extends uu{constructor(e,t){super(),this.xhr=e,this.data=t}get status(){return this.xhr.status}getHeader(e){return this.xhr.getResponseHeader(e)}async getData(){return this.data}}class fw extends cu{constructRequest(e,t){return new Promise((r,i)=>{const s=new XMLHttpRequest;s.open("GET",this.url),s.responseType="arraybuffer";for(const[o,a]of Object.entries(e))s.setRequestHeader(o,a);s.onload=()=>{const o=s.response;r(new hw(s,o))},s.onerror=i,s.onabort=()=>i(new Nn("Request aborted")),s.send(),t&&(t.aborted&&s.abort(),t.addEventListener("abort",()=>s.abort()))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}const ra={};class dw extends uu{constructor(e,t){super(),this.response=e,this.dataPromise=t}get status(){return this.response.statusCode}getHeader(e){return this.response.headers[e]}async getData(){return await this.dataPromise}}class pw extends cu{constructor(e){super(e),this.parsedUrl=ra.parse(this.url),this.httpApi=(this.parsedUrl.protocol==="http:",ra)}constructRequest(e,t){return new Promise((r,i)=>{const s=this.httpApi.get({...this.parsedUrl,headers:e},o=>{const a=new Promise(l=>{const u=[];o.on("data",h=>{u.push(h)}),o.on("end",()=>{const h=Buffer.concat(u).buffer;l(h)}),o.on("error",i)});r(new dw(o,a))});s.on("error",i),t&&(t.aborted&&s.destroy(new Nn("Request aborted")),t.addEventListener("abort",()=>s.destroy(new Nn("Request aborted"))))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}class hu extends lu{constructor(e,t,r,i){super(),this.client=e,this.headers=t,this.maxRanges=r,this.allowFullFile=i,this._fileSize=null}async fetch(e,t){return this.maxRanges>=e.length?this.fetchSlices(e,t):(this.maxRanges>0&&e.length>1,Promise.all(e.map(r=>this.fetchSlice(r,t))))}async fetchSlices(e,t){const r=await this.client.request({headers:{...this.headers,Range:`bytes=${e.map(({offset:i,length:s})=>`${i}-${i+s}`).join(",")}`},signal:t});if(r.ok)if(r.status===206){const{type:i,params:s}=ew(r.getHeader("content-type"));if(i==="multipart/byteranges"){const c=tw(await r.getData(),s.boundary);return this._fileSize=c[0].fileSize||null,c}const o=await r.getData(),{start:a,end:l,total:u}=Ga(r.getHeader("content-range"));this._fileSize=u||null;const h=[{data:o,offset:a,length:l-a}];if(e.length>1){const c=await Promise.all(e.slice(1).map(f=>this.fetchSlice(f,t)));return h.concat(c)}return h}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const i=await r.getData();return this._fileSize=i.byteLength,[{data:i,offset:0,length:i.byteLength}]}else throw new Error("Error fetching data.")}async fetchSlice(e,t){const{offset:r,length:i}=e,s=await this.client.request({headers:{...this.headers,Range:`bytes=${r}-${r+i}`},signal:t});if(s.ok)if(s.status===206){const o=await s.getData(),{total:a}=Ga(s.getHeader("content-range"));return this._fileSize=a||null,{data:o,offset:r,length:i}}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const o=await s.getData();return this._fileSize=o.byteLength,{data:o,offset:0,length:o.byteLength}}else throw new Error("Error fetching data.")}get fileSize(){return this._fileSize}}function fu(n,{blockSize:e,cacheSize:t}){return e===null?n:new lw(n,{blockSize:e,cacheSize:t})}function gw(n,{headers:e={},credentials:t,maxRanges:r=0,allowFullFile:i=!1,...s}={}){const o=new cw(n,t),a=new hu(o,e,r,i);return fu(a,s)}function mw(n,{headers:e={},maxRanges:t=0,allowFullFile:r=!1,...i}={}){const s=new fw(n),o=new hu(s,e,t,r);return fu(o,i)}function yw(n,{headers:e={},maxRanges:t=0,allowFullFile:r=!1,...i}={}){const s=new pw(n),o=new hu(s,e,t,r);return fu(o,i)}function za(n,{forceXHR:e=!1,...t}={}){return typeof fetch=="function"&&!e?gw(n,t):typeof XMLHttpRequest<"u"?mw(n,t):yw(n,t)}class _w extends lu{constructor(e){super(),this.file=e}async fetchSlice(e,t){return new Promise((r,i)=>{const s=this.file.slice(e.offset,e.offset+e.length),o=new FileReader;o.onload=a=>r(a.target.result),o.onerror=i,o.onabort=i,o.readAsArrayBuffer(s),t&&t.addEventListener("abort",()=>o.abort())})}}function bw(n){return new _w(n)}function ka(n){switch(n){case ie.BYTE:case ie.ASCII:case ie.SBYTE:case ie.UNDEFINED:return 1;case ie.SHORT:case ie.SSHORT:return 2;case ie.LONG:case ie.SLONG:case ie.FLOAT:case ie.IFD:return 4;case ie.RATIONAL:case ie.SRATIONAL:case ie.DOUBLE:case ie.LONG8:case ie.SLONG8:case ie.IFD8:return 8;default:throw new RangeError(`Invalid field type: ${n}`)}}function xw(n){const e=n.GeoKeyDirectory;if(!e)return null;const t={};for(let r=4;r<=e[3]*4;r+=4){const i=CE[e[r]],s=e[r+1]?fi[e[r+1]]:null,o=e[r+2],a=e[r+3];let l=null;if(!s)l=a;else{if(l=n[s],typeof l>"u"||l===null)throw new Error(`Could not get value of geoKey '${i}'.`);typeof l=="string"?l=l.substring(a,a+o-1):l.subarray&&(l=l.subarray(a,a+o),o===1&&(l=l[0]))}t[i]=l}return t}function gn(n,e,t,r){let i=null,s=null;const o=ka(e);switch(e){case ie.BYTE:case ie.ASCII:case ie.UNDEFINED:i=new Uint8Array(t),s=n.readUint8;break;case ie.SBYTE:i=new Int8Array(t),s=n.readInt8;break;case ie.SHORT:i=new Uint16Array(t),s=n.readUint16;break;case ie.SSHORT:i=new Int16Array(t),s=n.readInt16;break;case ie.LONG:case ie.IFD:i=new Uint32Array(t),s=n.readUint32;break;case ie.SLONG:i=new Int32Array(t),s=n.readInt32;break;case ie.LONG8:case ie.IFD8:i=new Array(t),s=n.readUint64;break;case ie.SLONG8:i=new Array(t),s=n.readInt64;break;case ie.RATIONAL:i=new Uint32Array(t*2),s=n.readUint32;break;case ie.SRATIONAL:i=new Int32Array(t*2),s=n.readInt32;break;case ie.FLOAT:i=new Float32Array(t),s=n.readFloat32;break;case ie.DOUBLE:i=new Float64Array(t),s=n.readFloat64;break;default:throw new RangeError(`Invalid field type: ${e}`)}if(e===ie.RATIONAL||e===ie.SRATIONAL)for(let a=0;a<t;a+=2)i[a]=s.call(n,r+a*o),i[a+1]=s.call(n,r+(a*o+4));else for(let a=0;a<t;++a)i[a]=s.call(n,r+a*o);return e===ie.ASCII?new TextDecoder("utf-8").decode(i):i}class Ew{constructor(e,t,r){this.fileDirectory=e,this.geoKeyDirectory=t,this.nextIFDByteOffset=r}}class os extends Error{constructor(e){super(`No image at index ${e}`),this.index=e}}class Zd{async readRasters(e={}){const{window:t,width:r,height:i}=e;let{resX:s,resY:o,bbox:a}=e;const l=await this.getImage();let u=l;const h=await this.getImageCount(),c=l.getBoundingBox();if(t&&a)throw new Error('Both "bbox" and "window" passed.');if(r||i){if(t){const[d,g]=l.getOrigin(),[m,_]=l.getResolution();a=[d+t[0]*m,g+t[1]*_,d+t[2]*m,g+t[3]*_]}const p=a||c;if(r){if(s)throw new Error("Both width and resX passed");s=(p[2]-p[0])/r}if(i){if(o)throw new Error("Both width and resY passed");o=(p[3]-p[1])/i}}if(s||o){const p=[];for(let d=0;d<h;++d){const g=await this.getImage(d),{SubfileType:m,NewSubfileType:_}=g.fileDirectory;(d===0||m===2||_&1)&&p.push(g)}p.sort((d,g)=>d.getWidth()-g.getWidth());for(let d=0;d<p.length;++d){const g=p[d],m=(c[2]-c[0])/g.getWidth(),_=(c[3]-c[1])/g.getHeight();if(u=g,s&&s>m||o&&o>_)break}}let f=t;if(a){const[p,d]=l.getOrigin(),[g,m]=u.getResolution(l);f=[Math.round((a[0]-p)/g),Math.round((a[1]-d)/m),Math.round((a[2]-p)/g),Math.round((a[3]-d)/m)],f=[Math.min(f[0],f[2]),Math.min(f[1],f[3]),Math.max(f[0],f[2]),Math.max(f[1],f[3])]}return u.readRasters({...e,window:f})}}class Dn extends Zd{constructor(e,t,r,i,s={}){super(),this.source=e,this.littleEndian=t,this.bigTiff=r,this.firstIFDOffset=i,this.cache=s.cache||!1,this.ifdRequests=[],this.ghostValues=null}async getSlice(e,t){const r=this.bigTiff?4048:1024;return new YE((await this.source.fetch([{offset:e,length:typeof t<"u"?t:r}]))[0],e,this.littleEndian,this.bigTiff)}async parseFileDirectoryAt(e){const t=this.bigTiff?20:12,r=this.bigTiff?8:2;let i=await this.getSlice(e);const s=this.bigTiff?i.readUint64(e):i.readUint16(e),o=s*t+(this.bigTiff?16:6);i.covers(e,o)||(i=await this.getSlice(e,o));const a={};let l=e+(this.bigTiff?8:2);for(let c=0;c<s;l+=t,++c){const f=i.readUint16(l),p=i.readUint16(l+2),d=this.bigTiff?i.readUint64(l+4):i.readUint32(l+4);let g,m;const _=ka(p),y=l+(this.bigTiff?12:8);if(_*d<=(this.bigTiff?8:4))g=gn(i,p,d,y);else{const b=i.readOffset(y),v=ka(p)*d;if(i.covers(b,v))g=gn(i,p,d,b);else{const x=await this.getSlice(b,v);g=gn(x,p,d,b)}}d===1&&AE.indexOf(f)===-1&&!(p===ie.RATIONAL||p===ie.SRATIONAL)?m=g[0]:m=g,a[fi[f]]=m}const u=xw(a),h=i.readOffset(e+r+t*s);return new Ew(a,u,h)}async requestIFD(e){if(this.ifdRequests[e])return this.ifdRequests[e];if(e===0)return this.ifdRequests[e]=this.parseFileDirectoryAt(this.firstIFDOffset),this.ifdRequests[e];if(!this.ifdRequests[e-1])try{this.ifdRequests[e-1]=this.requestIFD(e-1)}catch(t){throw t instanceof os?new os(e):t}return this.ifdRequests[e]=(async()=>{const t=await this.ifdRequests[e-1];if(t.nextIFDByteOffset===0)throw new os(e);return this.parseFileDirectoryAt(t.nextIFDByteOffset)})(),this.ifdRequests[e]}async getImage(e=0){const t=await this.requestIFD(e);return new Xd(t.fileDirectory,t.geoKeyDirectory,this.dataView,this.littleEndian,this.cache,this.source)}async getImageCount(){let e=0,t=!0;for(;t;)try{await this.requestIFD(e),++e}catch(r){if(r instanceof os)t=!1;else throw r}return e}async getGhostValues(){const e=this.bigTiff?16:8;if(this.ghostValues)return this.ghostValues;const t="GDAL_STRUCTURAL_METADATA_SIZE=",r=t.length+100;let i=await this.getSlice(e,r);if(t===gn(i,ie.ASCII,t.length,e)){const o=gn(i,ie.ASCII,r,e).split(`
`)[0],a=Number(o.split("=")[1].split(" ")[0])+o.length;a>r&&(i=await this.getSlice(e,a));const l=gn(i,ie.ASCII,a,e);this.ghostValues={},l.split(`
`).filter(u=>u.length>0).map(u=>u.split("=")).forEach(([u,h])=>{this.ghostValues[u]=h})}return this.ghostValues}static async fromSource(e,t,r){const i=(await e.fetch([{offset:0,length:1024}],r))[0],s=new HE(i),o=s.getUint16(0,0);let a;if(o===18761)a=!0;else if(o===19789)a=!1;else throw new TypeError("Invalid byte order value.");const l=s.getUint16(2,a);let u;if(l===42)u=!1;else if(l===43){if(u=!0,s.getUint16(4,a)!==8)throw new Error("Unsupported offset byte-size.")}else throw new TypeError("Invalid magic number.");const h=u?s.getUint64(8,a):s.getUint32(4,a);return new Dn(e,a,u,h,t)}close(){return typeof this.source.close=="function"?this.source.close():!1}}class ww extends Zd{constructor(e,t){super(),this.mainFile=e,this.overviewFiles=t,this.imageFiles=[e].concat(t),this.fileDirectoriesPerFile=null,this.fileDirectoriesPerFileParsing=null,this.imageCount=null}async parseFileDirectoriesPerFile(){const e=[this.mainFile.parseFileDirectoryAt(this.mainFile.firstIFDOffset)].concat(this.overviewFiles.map(t=>t.parseFileDirectoryAt(t.firstIFDOffset)));return this.fileDirectoriesPerFile=await Promise.all(e),this.fileDirectoriesPerFile}async getImage(e=0){await this.getImageCount(),await this.parseFileDirectoriesPerFile();let t=0,r=0;for(let i=0;i<this.imageFiles.length;i++){const s=this.imageFiles[i];for(let o=0;o<this.imageCounts[i];o++){if(e===t){const a=await s.requestIFD(r);return new Xd(a.fileDirectory,a.geoKeyDirectory,s.dataView,s.littleEndian,s.cache,s.source)}t++,r++}r=0}throw new RangeError("Invalid image index")}async getImageCount(){if(this.imageCount!==null)return this.imageCount;const e=[this.mainFile.getImageCount()].concat(this.overviewFiles.map(t=>t.getImageCount()));return this.imageCounts=await Promise.all(e),this.imageCount=this.imageCounts.reduce((t,r)=>t+r,0),this.imageCount}}async function vw(n,e={},t){return Dn.fromSource(za(n,e),t)}async function Tw(n,e){return Dn.fromSource(bw(n),e)}async function Sw(n,e=[],t={},r){const i=await Dn.fromSource(za(n,t),r),s=await Promise.all(e.map(o=>Dn.fromSource(za(o,t))));return new ww(i,s)}const Rw=`
  attribute vec4 a_position;
  attribute vec4 a_texcoord;

  uniform mat4 u_matrix;
  uniform mat4 u_textureMatrix;

  varying vec2 v_texcoord;

  void main() {
    gl_Position = u_matrix * a_position;
    vec2 texcoord = (u_textureMatrix * a_texcoord).xy;
    v_texcoord = texcoord;
  }
`,Pw=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (
      v_texcoord.x < 0.0 ||
      v_texcoord.y < 0.0 ||
      v_texcoord.x > 1.0 ||
      v_texcoord.y > 1.0
    ) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;class Aw{constructor(e){this.gl_=e,this.program_=$a(e,Pw,Rw),this.positionLocation=e.getAttribLocation(this.program_,"a_position"),this.texcoordLocation=e.getAttribLocation(this.program_,"a_texcoord"),this.matrixLocation=e.getUniformLocation(this.program_,"u_matrix"),this.textureMatrixLocation=e.getUniformLocation(this.program_,"u_textureMatrix"),this.textureLocation=e.getUniformLocation(this.program_,"u_texture"),this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),this.positions=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.positions),e.STATIC_DRAW),this.texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer),this.texcoords=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.texcoords),e.STATIC_DRAW)}drawImage(e,t,r,i,s,o,a,l,u,h,c,f,p){const d=this.gl_;l===void 0&&(l=i),u===void 0&&(u=s),o===void 0&&(o=t),a===void 0&&(a=r),h===void 0&&(h=o),c===void 0&&(c=a),f===void 0&&(f=d.canvas.width),p===void 0&&(p=d.canvas.height),d.bindTexture(d.TEXTURE_2D,e),d.useProgram(this.program_),d.bindBuffer(d.ARRAY_BUFFER,this.positionBuffer),d.enableVertexAttribArray(this.positionLocation),d.vertexAttribPointer(this.positionLocation,2,d.FLOAT,!1,0,0),d.bindBuffer(d.ARRAY_BUFFER,this.texcoordBuffer),d.enableVertexAttribArray(this.texcoordLocation),d.vertexAttribPointer(this.texcoordLocation,2,d.FLOAT,!1,0,0);let g=Fa(0,f,0,p,-1,1);g=yb(g,l,u,0),g=Lc(g,h,c,1),d.uniformMatrix4fv(this.matrixLocation,!1,g);let m=_b(i/t,s/r,0);m=Lc(m,o/t,a/r,1),d.uniformMatrix4fv(this.textureMatrixLocation,!1,m),d.uniform1i(this.textureLocation,0),d.drawArrays(d.TRIANGLES,0,this.positions.length/2)}}function Wc(n,e,t){const r=n.createShader(e);if(r===null)throw new Error("Shader compilation failed");if(n.shaderSource(r,t),n.compileShader(r),!n.getShaderParameter(r,n.COMPILE_STATUS)){const i=n.getShaderInfoLog(r);throw i===null?new Error("Shader info log creation failed"):new Error(i)}return r}function $a(n,e,t){const r=n.createProgram(),i=Wc(n,n.VERTEX_SHADER,t),s=Wc(n,n.FRAGMENT_SHADER,e);if(r===null)throw new Error("Program creation failed");if(n.attachShader(r,i),n.attachShader(r,s),n.linkProgram(r),!n.getProgramParameter(r,n.LINK_STATUS))throw n.getProgramInfoLog(r)===null?new Error("Program info log creation failed"):new Error;return r}const Iw=`
  attribute vec4 a_position;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
  }
`,Cw=`
  precision mediump float;

  uniform vec4 u_val;
  void main() {
     gl_FragColor = u_val;
  }
`,Lw=`
  attribute vec4 a_position;
  attribute vec2 a_texcoord;

  varying vec2 v_texcoord;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
     v_texcoord = a_texcoord;
  }
`,Fw=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (v_texcoord.x < 0.0 || v_texcoord.x > 1.0 || v_texcoord.y < 0.0 || v_texcoord.y > 1.0) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;function Mw(n,e,t,r){let i;return t&&t.length?i=t.shift():em?i=new OffscreenCanvas(n||300,e||300):i=document.createElement("canvas"),n&&(i.width=n),e&&(i.height=e),i.getContext("webgl",r)}function Ow(n){const e=n.canvas;e.width=1,e.height=1,n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT|n.STENCIL_BUFFER_BIT)}const Zc=[];function Nw(n,e,t,r,i,s,o,a,l,u,h,c,f,p){const d=Math.round(r*e),g=Math.round(r*t);n.canvas.width=d,n.canvas.height=g;let m,_;if(_=n.createTexture(),n.bindTexture(n.TEXTURE_2D,_),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),f?(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR)):(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST)),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,d,g,0,n.RGBA,h,null),m=n.createFramebuffer(),n.bindFramebuffer(n.FRAMEBUFFER,m),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,_,0),m===null)throw new Error("Could not create framebuffer");if(_===null)throw new Error("Could not create texture");if(l.length===0)return{width:d,height:g,framebuffer:m,texture:_};const y=Oi();l.forEach(function(R,I,N){Pg(y,R.extent)});let b,v,x;const E=1/i;{if(b=n.createTexture(),_===null)throw new Error("Could not create texture");v=Math.round(it(y)*E),x=Math.round(jt(y)*E);const R=n.getParameter(n.MAX_TEXTURE_SIZE),I=Math.max(v,x),N=I>R?R/I:1,X=Math.round(v*N),M=Math.round(x*N);n.bindTexture(n.TEXTURE_2D,b),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),f?(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR)):(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST)),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,X,M,0,n.RGBA,h,null);const F=n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,F),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,b,0);const $=new Aw(n);l.forEach(function(z,ne,Z){const C=(z.extent[0]-y[0])*E*N,he=-(z.extent[3]-y[3])*E*N,ve=it(z.extent)*E*N,Y=jt(z.extent)*E*N;if(n.bindFramebuffer(n.FRAMEBUFFER,F),n.viewport(0,0,X,M),z.clipExtent){const Le=(z.clipExtent[0]-y[0])*E*N,fe=-(z.clipExtent[3]-y[3])*E*N,_e=it(z.clipExtent)*E*N,Ie=jt(z.clipExtent)*E*N;n.enable(n.SCISSOR_TEST),n.scissor(f?Le:Math.round(Le),f?fe:Math.round(fe),f?_e:Math.round(Le+_e)-Math.round(Le),f?Ie:Math.round(fe+Ie)-Math.round(fe))}$.drawImage(z.texture,z.width,z.height,u,u,z.width-2*u,z.height-2*u,f?C:Math.round(C),f?he:Math.round(he),f?ve:Math.round(C+ve)-Math.round(C),f?Y:Math.round(he+Y)-Math.round(he),X,M),n.disable(n.SCISSOR_TEST)}),n.deleteFramebuffer(F)}const S=vs(o),A=vs(y),P=R=>{const I=(R[0][0]-S[0])/s*r,N=-(R[0][1]-S[1])/s*r,X=(R[1][0]-S[0])/s*r,M=-(R[1][1]-S[1])/s*r,F=(R[2][0]-S[0])/s*r,$=-(R[2][1]-S[1])/s*r;return{u1:X,v1:M,u0:I,v0:N,u2:F,v2:$}};n.bindFramebuffer(n.FRAMEBUFFER,m),n.viewport(0,0,d,g);{const R=[],I=[],N=$a(n,Fw,Lw);n.useProgram(N);const X=n.getUniformLocation(N,"u_texture");n.bindTexture(n.TEXTURE_2D,b),n.uniform1i(X,0),a.getTriangles().forEach(function(C,he,ve){const Y=C.source,Le=C.target,{u1:fe,v1:_e,u0:Ie,v0:Ne,u2:Xe,v2:G}=P(Le),Ot=(Y[0][0]-A[0])/i/v,cr=-(Y[0][1]-A[1])/i/x,ce=(Y[1][0]-A[0])/i/v,Qi=-(Y[1][1]-A[1])/i/x,wr=(Y[2][0]-A[0])/i/v,Qe=-(Y[2][1]-A[1])/i/x;R.push(fe,_e,Ie,Ne,Xe,G),I.push(ce,Qi,Ot,cr,wr,Qe)});const M=Fa(0,d,g,0,-1,1),F=n.getUniformLocation(N,"u_matrix");n.uniformMatrix4fv(F,!1,M);const $=n.getAttribLocation(N,"a_position"),z=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,z),n.bufferData(n.ARRAY_BUFFER,new Float32Array(R),n.STATIC_DRAW),n.vertexAttribPointer($,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray($);const ne=n.getAttribLocation(N,"a_texcoord"),Z=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,Z),n.bufferData(n.ARRAY_BUFFER,new Float32Array(I),n.STATIC_DRAW),n.vertexAttribPointer(ne,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray(ne),n.drawArrays(n.TRIANGLES,0,R.length/2)}if(c){const R=$a(n,Cw,Iw);n.useProgram(R);const I=Fa(0,d,g,0,-1,1),N=n.getUniformLocation(R,"u_matrix");n.uniformMatrix4fv(N,!1,I);const X=Array.isArray(c)?c:[0,0,0,255],M=n.getUniformLocation(R,"u_val");n.uniform4fv(M,X);const F=n.getAttribLocation(R,"a_position"),$=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,$),n.vertexAttribPointer(F,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray(F);const z=a.getTriangles().reduce(function(ne,Z){const C=Z.target,{u1:he,v1:ve,u0:Y,v0:Le,u2:fe,v2:_e}=P(C);return ne.concat([he,ve,Y,Le,Y,Le,fe,_e,fe,_e,he,ve])},[]);n.bufferData(n.ARRAY_BUFFER,new Float32Array(z),n.STATIC_DRAW),n.drawArrays(n.LINES,0,z.length/2)}return{width:d,height:g,framebuffer:m,texture:_}}class Dw extends gl{constructor(e){super({tileCoord:e.tileCoord,loader:()=>Promise.resolve(new Uint8ClampedArray(4)),interpolate:e.interpolate,transition:e.transition}),this.renderEdges_=e.renderEdges!==void 0?e.renderEdges:!1,this.pixelRatio_=e.pixelRatio,this.gutter_=e.gutter,this.reprojData_=null,this.reprojError_=null,this.reprojSize_=void 0,this.sourceTileGrid_=e.sourceTileGrid,this.targetTileGrid_=e.targetTileGrid,this.wrappedTileCoord_=e.wrappedTileCoord||e.tileCoord,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;const t=e.sourceProj,r=t.getExtent(),i=e.sourceTileGrid.getExtent();this.clipExtent_=t.canWrapX()?i?rr(r,i):r:i;const s=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),o=this.targetTileGrid_.getExtent();let a=this.sourceTileGrid_.getExtent();const l=o?rr(s,o):s;if(Qu(l)===0){this.state=Q.EMPTY;return}r&&(a?a=rr(a,r):a=r);const u=this.targetTileGrid_.getResolution(this.wrappedTileCoord_[0]),h=e.targetProj,c=tm(t,h,l,u);if(!isFinite(c)||c<=0){this.state=Q.EMPTY;return}const f=e.errorThreshold!==void 0?e.errorThreshold:rm;if(this.triangulation_=new nm(t,h,l,a,c*f,u,e.transformMatrix),this.triangulation_.getTriangles().length===0){this.state=Q.EMPTY;return}this.sourceZ_=this.sourceTileGrid_.getZForResolution(c);let p=this.triangulation_.calculateSourceExtent();if(a&&(t.canWrapX()?(p[1]=Ue(p[1],a[1],a[3]),p[3]=Ue(p[3],a[1],a[3])):p=rr(p,a)),!Qu(p))this.state=Q.EMPTY;else{let d=0,g=0;t.canWrapX()&&(d=it(r),g=Math.floor((p[0]-r[0])/d)),Ag(p.slice(),t,!0).forEach(_=>{const y=this.sourceTileGrid_.getTileRangeForExtentAndZ(_,this.sourceZ_),b=e.getTileFunction;for(let v=y.minX;v<=y.maxX;v++)for(let x=y.minY;x<=y.maxY;x++){const E=b(this.sourceZ_,v,x,this.pixelRatio_);if(E){const S=g*d;this.sourceTiles_.push({tile:E,offset:S})}}++g}),this.sourceTiles_.length===0&&(this.state=Q.EMPTY)}}getSize(){return this.reprojSize_}getData(){return this.reprojData_}getError(){return this.reprojError_}reproject_(){const e=[];let t=!1;if(this.sourceTiles_.forEach(v=>{var he;const x=v.tile;if(!x||x.getState()!==Q.LOADED)return;const E=x.getSize(),S=this.gutter_;let A;const P=Sa(x.getData());P?A=P:(t=!0,A=im(Ra(x.getData())));const R=[E[0]+2*S,E[1]+2*S],I=A instanceof Float32Array,N=R[0]*R[1],X=I?Float32Array:Uint8ClampedArray,M=new X(A.buffer),F=X.BYTES_PER_ELEMENT,$=F*M.length/N,z=M.byteLength/R[1],ne=Math.floor(z/F/R[0]),Z=this.sourceTileGrid_.getTileCoordExtent(x.tileCoord);Z[0]+=v.offset,Z[2]+=v.offset;const C=(he=this.clipExtent_)==null?void 0:he.slice();C&&(C[0]+=v.offset,C[2]+=v.offset),e.push({extent:Z,clipExtent:C,data:M,dataType:X,bytesPerPixel:$,pixelSize:R,bandCount:ne})}),this.sourceTiles_.length=0,e.length===0){this.state=Q.ERROR,this.changed();return}const r=this.wrappedTileCoord_[0],i=this.targetTileGrid_.getTileSize(r),s=typeof i=="number"?i:i[0],o=typeof i=="number"?i:i[1],a=s*this.pixelRatio_,l=o*this.pixelRatio_,u=this.targetTileGrid_.getResolution(r),h=this.sourceTileGrid_.getResolution(this.sourceZ_),c=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),f=e[0].bandCount,p=new e[0].dataType(f*a*l),d=Mw(a,l,Zc,{premultipliedAlpha:!1,antialias:!1});let g;const m=d.RGBA;let _;e[0].dataType==Float32Array?(_=d.FLOAT,d.getExtension("WEBGL_color_buffer_float"),d.getExtension("OES_texture_float"),d.getExtension("EXT_float_blend"),g=d.getExtension("OES_texture_float_linear")!==null&&this.interpolate):(_=d.UNSIGNED_BYTE,g=this.interpolate);const y=4,b=Math.ceil(f/y);for(let v=b-1;v>=0;--v){const x=[];for(let X=0,M=e.length;X<M;++X){const F=e[X],$=F.pixelSize,z=$[0],ne=$[1],Z=new F.dataType(y*z*ne),C=F.data;let he=v*y;for(let Y=0,Le=Z.length;Y<Le;Y+=y)Z[Y]=C[he],Z[Y+1]=C[he+1],Z[Y+2]=C[he+2],Z[Y+3]=C[he+3],he+=f;const ve=d.createTexture();d.bindTexture(d.TEXTURE_2D,ve),g?(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR)):(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST)),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texImage2D(d.TEXTURE_2D,0,m,z,ne,0,m,_,Z),x.push({extent:F.extent,clipExtent:F.clipExtent,texture:ve,width:z,height:ne})}const{framebuffer:E,width:S,height:A}=Nw(d,s,o,this.pixelRatio_,h,u,c,this.triangulation_,x,this.gutter_,_,this.renderEdges_,g),P=S,R=A*y,I=new e[0].dataType(P*R);d.bindFramebuffer(d.FRAMEBUFFER,E),d.readPixels(0,0,S,A,d.RGBA,_,I);let N=v*y;for(let X=0,M=I.length;X<M;X+=y){const F=(P-1-(X/R|0))*R+X%R;p[N]=I[F],p[N+1]=I[F+1],p[N+2]=I[F+2],p[N+3]=I[F+3],N+=f}}if(Ow(d),Zc.push(d.canvas),t){const v=Br(s,o),x=new ImageData(p,s);v.putImageData(x,0,0),this.reprojData_=v.canvas}else this.reprojData_=p;this.reprojSize_=[Math.round(a),Math.round(l)],this.state=Q.LOADED,this.changed()}load(){if(this.state!==Q.IDLE&&this.state!==Q.ERROR)return;this.state=Q.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(({tile:t})=>{const r=t.getState();if(r!==Q.IDLE&&r!==Q.LOADING)return;e++;const i=dr(t,ft.CHANGE,()=>{const s=t.getState();(s==Q.LOADED||s==Q.ERROR||s==Q.EMPTY)&&(ws(i),e--,e===0&&(this.unlistenSources_(),this.reproject_()))});this.sourcesListenerKeys_.push(i)}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function({tile:t}){t.getState()==Q.IDLE&&t.load()})}unlistenSources_(){this.sourcesListenerKeys_.forEach(ws),this.sourcesListenerKeys_=null}}class Zi extends ml{constructor(e){const t=e.projection===void 0?"EPSG:3857":e.projection;let r=e.tileGrid;r===void 0&&t&&(r=kr({extent:un(t),maxResolution:e.maxResolution,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize})),super({cacheSize:.1,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,projection:t,tileGrid:r,state:e.state,wrapX:e.wrapX,transition:e.transition,interpolate:e.interpolate,key:e.key,zDirection:e.zDirection}),this.gutter_=e.gutter!==void 0?e.gutter:0,this.tileSize_=e.tileSize?Vt(e.tileSize):null,this.tileSizes_=null,this.tileLoadingKeys_={},this.loader_=e.loader,this.handleTileChange_=this.handleTileChange_.bind(this),this.bandCount=e.bandCount===void 0?4:e.bandCount,this.tileGridForProjection_={},this.crossOrigin_=e.crossOrigin||"anonymous",this.transformMatrix=null}setTileSizes(e){this.tileSizes_=e}getTileSize(e){if(this.tileSizes_)return this.tileSizes_[e];if(this.tileSize_)return this.tileSize_;const t=this.getTileGrid();return t?Vt(t.getTileSize(e)):[256,256]}getGutterForProjection(e){const t=this.getProjection();return(!t||li(t,e))&&!this.transformMatrix?this.gutter_:0}setLoader(e){this.loader_=e}getReprojTile_(e,t,r,i,s){const o=this.tileGrid||this.getTileGridForProjection(s||i),a=Math.max.apply(null,o.getResolutions().map((p,d)=>{const g=Vt(o.getTileSize(d)),m=this.getTileSize(d);return Math.max(m[0]/g[0],m[1]/g[1])})),l=this.getTileGridForProjection(i),u=[e,t,r],h=this.getTileCoordForTileUrlFunction(u,i),c=Object.assign({sourceProj:s||i,sourceTileGrid:o,targetProj:i,targetTileGrid:l,tileCoord:u,wrappedTileCoord:h,pixelRatio:a,gutter:this.gutter_,getTileFunction:(p,d,g,m)=>this.getTile(p,d,g,m),transformMatrix:this.transformMatrix},this.tileOptions),f=new Dw(c);return f.key=this.getKey(),f}getTile(e,t,r,i,s){var b;const o=this.getProjection();if(s&&(o&&!li(o,s)||this.transformMatrix))return this.getReprojTile_(e,t,r,s,o);const a=this.getTileSize(e),l=this.loader_,u=new AbortController,h={signal:u.signal,crossOrigin:this.crossOrigin_},c=this.getTileCoordForTileUrlFunction([e,t,r]);if(!c)return null;const f=c[0],p=c[1],d=c[2],g=(b=this.getTileGrid())==null?void 0:b.getFullTileRange(f);g&&(h.maxY=g.getHeight()-1);function m(){return xi(function(){return l(f,p,d,h)})}const _=Object.assign({tileCoord:[e,t,r],loader:m,size:a,controller:u},this.tileOptions),y=new gl(_);return y.key=this.getKey(),y.addEventListener(ft.CHANGE,this.handleTileChange_),y}handleTileChange_(e){const t=e.target,r=me(t),i=t.getState();let s;i==Q.LOADING?(this.tileLoadingKeys_[r]=!0,s=Wo.TILELOADSTART):r in this.tileLoadingKeys_&&(delete this.tileLoadingKeys_[r],s=i==Q.ERROR?Wo.TILELOADERROR:i==Q.LOADED?Wo.TILELOADEND:void 0),s&&this.dispatchEvent(new sm(s,t))}getTileGridForProjection(e){const t=this.getProjection();if(this.tileGrid&&(!t||li(t,e))&&!this.transformMatrix)return this.tileGrid;const r=me(e);return r in this.tileGridForProjection_||(this.tileGridForProjection_[r]=om(e)),this.tileGridForProjection_[r]}setTileGridForProjection(e,t){const r=ue(e);if(r){const i=me(r);i in this.tileGridForProjection_||(this.tileGridForProjection_[i]=t)}}}function Uw(n){return((n.fileDirectory.NewSubfileType||0)&4)===4}function Bw(n,e){if(!n)return!1;if(n===!0)return!0;if(e.getSamplesPerPixel()!==3)return!1;const t=e.fileDirectory.PhotometricInterpretation,r=pt;return t===r.CMYK||t===r.YCbCr||t===r.CIELab||t===r.ICCLab}const qc="STATISTICS_MAXIMUM",Hc="STATISTICS_MINIMUM",na=256;let ia;function Gw(){return ia||(ia=new JE),ia}function zw(n){try{return n.getBoundingBox(!0)}catch{return[0,0,n.getWidth(),n.getHeight()]}}function kw(n){try{return n.getOrigin().slice(0,2)}catch{return[0,n.getHeight()]}}function $w(n,e){try{return n.getResolution(e)}catch{return[e.getWidth()/n.getWidth(),e.getHeight()/n.getHeight()]}}function jw(n){const e=n.geoKeys;if(!e)return null;if(e.ProjectedCSTypeGeoKey&&e.ProjectedCSTypeGeoKey!==32767){const t="EPSG:"+e.ProjectedCSTypeGeoKey;let r=ue(t);if(!r){const i=Yu(e.ProjLinearUnitsGeoKey);i&&(r=new Ku({code:t,units:i}))}return r}if(e.GeographicTypeGeoKey&&e.GeographicTypeGeoKey!==32767){const t="EPSG:"+e.GeographicTypeGeoKey;let r=ue(t);if(!r){const i=Yu(e.GeogAngularUnitsGeoKey);i&&(r=new Ku({code:t,units:i}))}return r}return null}function Vw(n){return n.getImageCount().then(function(e){const t=new Array(e);for(let r=0;r<e;++r)t[r]=n.getImage(r);return Promise.all(t)})}function Xw(n,e){let t;return n.blob?t=Tw(n.blob):n.overviews?t=Sw(n.url,n.overviews,e):t=vw(n.url,e),t.then(Vw)}function oi(n,e,t,r,i){if(Array.isArray(n)){const s=n.length;if(!Array.isArray(e)||s!=e.length){const o=new Error(r);throw i(o),o}for(let o=0;o<s;++o)oi(n[o],e[o],t,r,i);return}if(e=e,Math.abs(n-e)>t*n)throw new Error(r)}function Ww(n){return n instanceof Int8Array?-128:n instanceof Int16Array?-32768:n instanceof Int32Array?-2147483648:n instanceof Float32Array?12e-39:0}function Zw(n){return n instanceof Int8Array?127:n instanceof Uint8Array||n instanceof Uint8ClampedArray?255:n instanceof Int16Array?32767:n instanceof Uint16Array?65535:n instanceof Int32Array?2147483647:n instanceof Uint32Array?4294967295:n instanceof Float32Array?34e37:255}class du extends Zi{constructor(e){super({state:"loading",tileGrid:null,projection:e.projection||null,transition:e.transition,interpolate:e.interpolate!==!1,wrapX:e.wrapX}),this.sourceInfo_=e.sources;const t=this.sourceInfo_.length;this.sourceOptions_=e.sourceOptions,this.sourceImagery_=new Array(t),this.sourceMasks_=new Array(t),this.resolutionFactors_=new Array(t),this.samplesPerPixel_,this.nodataValues_,this.metadata_,this.normalize_=e.normalize!==!1,this.addAlpha_=!1,this.error_=null,this.convertToRGB_=e.convertToRGB||!1,this.setKey(this.sourceInfo_.map(s=>s.url).join(","));const r=this,i=new Array(t);for(let s=0;s<t;++s)i[s]=Xw(this.sourceInfo_[s],this.sourceOptions_);Promise.all(i).then(function(s){r.configure_(s)}).catch(function(s){_i(s),r.error_=s,r.setState("error")})}getError(){return this.error_}determineProjection(e){const t=e[0];for(let r=t.length-1;r>=0;--r){const i=t[r],s=jw(i);if(s){this.projection=s;break}}}determineTransformMatrix(e){const t=e[0];for(let r=t.length-1;r>=0;--r){const s=t[r].fileDirectory.ModelTransformation;if(s){const[o,a,l,u,h,c,f,p]=s,d=mi(mi([1/Math.sqrt(o*o+h*h),0,0,-1/Math.sqrt(a*a+c*c),u,p],[o,h,a,c,0,0]),[1,0,0,1,-u,-p]);this.transformMatrix=d,this.addAlpha_=!0;break}}}configure_(e){let t,r,i,s,o;const a=new Array(e.length),l=new Array(e.length),u=new Array(e.length);let h=0;const c=e.length;for(let m=0;m<c;++m){const _=[],y=[];e[m].forEach(P=>{Uw(P)?y.push(P):_.push(P)});const b=_.length;if(y.length>0&&y.length!==b)throw new Error(`Expected one mask per image found ${y.length} masks and ${b} images`);let v,x;const E=new Array(b),S=new Array(b),A=new Array(b);l[m]=new Array(b),u[m]=new Array(b);for(let P=0;P<b;++P){const R=_[P],I=R.getGDALNoData();u[m][P]=R.getGDALMetadata(0),l[m][P]=I;const N=this.sourceInfo_[m].bands;a[m]=N?N.length:R.getSamplesPerPixel();const X=b-(P+1);v||(v=zw(R)),x||(x=kw(R));const M=$w(R,_[0]);A[X]=M[0];const F=[R.getTileWidth(),R.getTileHeight()];F[0]!==F[1]&&F[1]<na&&(F[0]=na,F[1]=na),E[X]=F;const $=M[0]/Math.abs(M[1]);S[X]=[F[0],F[1]/$]}if(t?rr(t,v,t):t=v,!r)r=x;else{const P=`Origin mismatch for source ${m}, got [${x}] but expected [${r}]`;oi(r,x,0,P,this.viewRejector)}if(!o)o=A,this.resolutionFactors_[m]=1;else{o.length-h>A.length&&(h=o.length-A.length);const P=o[o.length-1]/A[A.length-1];this.resolutionFactors_[m]=P;const R=A.map(N=>N*=P),I=`Resolution mismatch for source ${m}, got [${R}] but expected [${o}]`;oi(o.slice(h,o.length),R,.02,I,this.viewRejector)}i?oi(i.slice(h,i.length),S,.01,`Tile size mismatch for source ${m}`,this.viewRejector):i=S,s?oi(s.slice(h,s.length),E,0,`Tile size mismatch for source ${m}`,this.viewRejector):s=E,this.sourceImagery_[m]=_.reverse(),this.sourceMasks_[m]=y.reverse()}for(let m=0,_=this.sourceImagery_.length;m<_;++m){const y=this.sourceImagery_[m];for(;y.length<o.length;)y.unshift(void 0)}this.getProjection()||this.determineProjection(e),this.determineTransformMatrix(e),this.samplesPerPixel_=a,this.nodataValues_=l,this.metadata_=u;e:for(let m=0;m<c;++m){if(this.sourceInfo_[m].nodata!==void 0){this.addAlpha_=!0;break}if(this.sourceMasks_[m].length){this.addAlpha_=!0;break}const _=l[m],y=this.sourceInfo_[m].bands;if(y){for(let b=0;b<y.length;++b)if(_[y[b]-1]!==null){this.addAlpha_=!0;break e}continue}for(let b=0;b<_.length;++b)if(_[b]!==null){this.addAlpha_=!0;break e}}let f=this.addAlpha_?1:0;for(let m=0;m<c;++m)f+=a[m];this.bandCount=f;const p=new Ui({extent:t,minZoom:h,origin:r,resolutions:o,tileSizes:i});this.tileGrid=p,this.setTileSizes(s),this.setLoader(this.loadTile_.bind(this)),this.setState("ready");const d=1;o.length===2?o=[o[0],o[1],o[1]/2]:o.length===1&&(o=[o[0]*2,o[0],o[0]/2]);let g=t;if(this.transformMatrix){const m=yi(nt(),this.transformMatrix.slice()),_=hg(y=>_r(m,y));g=Fn(t,_)}this.viewResolver({showFullExtent:!0,projection:this.projection,resolutions:o,center:dg(nr(g),this.projection),extent:fg(g,this.projection),zoom:d})}loadTile_(e,t,r,i){const s=this.getTileSize(e),o=this.sourceImagery_.length,a=new Array(o*2),l=this.nodataValues_,u=this.sourceInfo_,h=Gw();for(let c=0;c<o;++c){const f=u[c],p=this.resolutionFactors_[c],d=[Math.round(t*(s[0]*p)),Math.round(r*(s[1]*p)),Math.round((t+1)*(s[0]*p)),Math.round((r+1)*(s[1]*p))],g=this.sourceImagery_[c][e];let m;f.bands&&(m=f.bands.map(function(x){return x-1}));let _;"nodata"in f&&f.nodata!==null?_=f.nodata:m?_=m.map(function(x){return l[c][x]}):_=l[c];const y={window:d,width:s[0],height:s[1],samples:m,fillValue:_,pool:h,interleave:!1,signal:i.signal};Bw(this.convertToRGB_,g)?a[c]=g.readRGB(y):a[c]=g.readRasters(y);const b=o+c,v=this.sourceMasks_[c][e];if(!v){a[b]=Promise.resolve(null);continue}a[b]=v.readRasters({window:d,width:s[0],height:s[1],samples:[0],pool:h,interleave:!1})}return Promise.all(a).then(this.composeTile_.bind(this,s)).catch(function(c){throw _i(c),c})}composeTile_(e,t){const r=this.metadata_,i=this.sourceInfo_,s=this.sourceImagery_.length,o=this.bandCount,a=this.samplesPerPixel_,l=this.nodataValues_,u=this.normalize_,h=this.addAlpha_,c=e[0]*e[1],f=c*o;let p;u?p=new Uint8Array(f):p=new Float32Array(f);let d=0;for(let g=0;g<c;++g){let m=h;for(let _=0;_<s;++_){const y=i[_];let b=y.min,v=y.max,x,E;if(u){const S=r[_][0];b===void 0&&(S&&Hc in S?b=parseFloat(S[Hc]):b=Ww(t[_][0])),v===void 0&&(S&&qc in S?v=parseFloat(S[qc]):v=Zw(t[_][0])),x=255/(v-b),E=-b*x}for(let S=0;S<a[_];++S){const A=t[_][S][g];let P;if(u?P=Ue(x*A+E,0,255):P=A,!h)p[d]=P;else{let R=y.nodata;if(R===void 0){let N;y.bands?N=y.bands[S]-1:N=S,R=l[_][N]}const I=isNaN(R);(!I&&A!==R||I&&!isNaN(A))&&(m=!1,p[d]=P)}d++}if(!m){const S=s+_,A=t[S];A&&!A[0][g]&&(m=!0)}}h&&(m||(p[d]=255),d++)}return p}}du.prototype.getView;class Fe{constructor(e){this.name=e}toString(){return this.name}}Fe.GeoTIFF=new Fe("GeoTIFF");Fe.ImageStatic=new Fe("ImageStatic");Fe.PMTilesRaster=new Fe("PMTilesRaster");Fe.PMTilesVector=new Fe("PMTilesVector");Fe.TileJSON=new Fe("TileJSON");Fe.TileWMS=new Fe("TileWMS");Fe.WMTS=new Fe("WMTS");Fe.XYZ=new Fe("XYZ");function qw(n){const e=n.load||kn,t=n.imageExtent,r=n.crossOrigin??null;return()=>{const i=new Image;return i.crossOrigin=r,e(i,n.url).then(s=>{const o=it(t)/s.width,a=jt(t)/s.height;return{image:s,extent:t,resolution:o!==a?[o,a]:a,pixelRatio:1}})}}class qd extends cn{constructor(e){const t=e.crossOrigin!==void 0?e.crossOrigin:null,r=e.imageLoadFunction!==void 0?e.imageLoadFunction:yl;super({attributions:e.attributions,interpolate:e.interpolate,projection:ue(e.projection)}),this.url_=e.url,this.imageExtent_=e.imageExtent,this.image=null,this.image=new hf(this.imageExtent_,void 0,1,qw({url:e.url,imageExtent:e.imageExtent,crossOrigin:t,load:(i,s)=>(this.image.setImage(i),r(this.image,s),kn(i))})),this.image.addEventListener(ft.CHANGE,this.handleImageChange.bind(this))}getImageExtent(){return this.imageExtent_}getImageInternal(e,t,r,i){return Ln(e,this.image.getExtent())?this.image:null}getUrl(){return this.url_}}function pu(n,e,t,r){const i=document.createElement("script"),s="olc_"+me(e);function o(){delete window[s],i.parentNode.removeChild(i)}i.async=!0,i.src=n+(n.includes("?")?"&":"?")+"callback="+s;const a=setTimeout(function(){o(),t&&t()},1e4);window[s]=function(l){clearTimeout(a),o(),e(l)},document.head.appendChild(i)}class Hw extends Error{constructor(e){const t="Unexpected response status: "+e.status;super(t),this.name="ResponseError",this.response=e}}class Yw extends Error{constructor(e){super("Failed to issue request"),this.name="ClientError",this.client=e}}function Hd(n){return new Promise(function(e,t){function r(o){const a=o.target;if(!a.status||a.status>=200&&a.status<300){let l;try{l=JSON.parse(a.responseText)}catch(u){const h="Error parsing response text as JSON: "+u.message;t(new Error(h));return}e(l);return}t(new Hw(a))}function i(o){t(new Yw(o.target))}const s=new XMLHttpRequest;s.addEventListener("load",r),s.addEventListener("error",i),s.open("GET",n),s.setRequestHeader("Accept","application/json"),s.send()})}function Yd(n,e){return e.includes("://")?e:new URL(e,n).href}class xo extends Er{constructor(e){if(super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:ue("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.tileJSON_=null,this.tileSize_=e.tileSize,e.url)if(e.jsonp)pu(e.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",e.url),t.send()}else if(e.tileJSON)this.handleTileJSONResponse(e.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(r)}else this.handleTileJSONError()}onXHRError_(e){this.handleTileJSONError()}getTileJSON(){return this.tileJSON_}handleTileJSONResponse(e){const t=ue("EPSG:4326"),r=this.getProjection();let i;if(e.bounds!==void 0){const u=ul(t,r);i=Fn(e.bounds,u)}const s=un(r),o=e.minzoom||0,a=e.maxzoom||22,l=kr({extent:s,maxZoom:a,minZoom:o,tileSize:this.tileSize_});if(this.tileGrid=l,this.tileUrlFunction=ff(e.tiles,l),e.attribution&&!this.getAttributions()){const u=i!==void 0?i:s;this.setAttributions(function(h){return Ln(u,h.extent)?[e.attribution]:null})}this.tileJSON_=e,this.setState("ready")}handleTileJSONError(){this.setState("error")}}const Kw="https://stac-extensions.github.io/label/v1.*/schema.json",Kd=new Fr({color:"rgba(0,0,0,0)"});function Jd(n,e,t="rgba(255,255,255,0.4)",r=5){let i=Kd;t&&(i=new Fr({color:t}));const s=new Lr({color:n,width:e});return new er({image:new df({fill:i,stroke:s,radius:r}),fill:i,stroke:s})}const Jw=Jd("#3399CC",3),Yc=Jd("#ff9933",2,null);function Qw(n,e){const t={url:n.getAbsoluteUrl()};let r=n;n.getBands().length===1&&(r=n.getBand(0));const{minimum:i,maximum:s}=r.getMinMaxValues();typeof i=="number"&&(t.min=i),typeof s=="number"&&(t.max=s);const o=r.getNoDataValues();return o.length>0&&(t.nodata=o[0]),e.length>0&&(t.bands=e),t}async function Kc(n,e=void 0){let t=e;if(am()){const r=n.getMetadata("proj:code");if(r)try{if(r.startsWith("EPSG:")){const i=parseInt(r.replace("EPSG:",""),10);t=await lm(i)}}catch{}}return t}function Jc(n,e){const t=n.clone();return e.hasOnlyBounds()||t.setFill(Kd),t}function ev(n){let e=n.href;if(e.includes("{s}"))if(Array.isArray(n["href:servers"])&&n["href:servers"].length>0){const t=Math.random()*n["href:servers"].length|0;e=e.replace("{s}",n["href:servers"][t])}else return null;return e}var Qd=Object.defineProperty,Qc=Object.getOwnPropertySymbols,tv=Object.prototype.hasOwnProperty,rv=Object.prototype.propertyIsEnumerable,eh=(n,e,t)=>e in n?Qd(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Gs=(n,e)=>{for(var t in e||(e={}))tv.call(e,t)&&eh(n,t,e[t]);if(Qc)for(var t of Qc(e))rv.call(e,t)&&eh(n,t,e[t]);return n},Eo=(n,e)=>Qd(n,"name",{value:e,configurable:!0}),nv=(n,e,t)=>new Promise((r,i)=>{var s=l=>{try{a(t.next(l))}catch(u){i(u)}},o=l=>{try{a(t.throw(l))}catch(u){i(u)}},a=l=>l.done?r(l.value):Promise.resolve(l.value).then(s,o);a((t=t.apply(n,e)).next())}),ep=class extends Zi{constructor(e){super(Gs(Gs({},e),{state:"loading"})),this.loadImage=Eo(r=>new Promise((i,s)=>{const o=new Image;o.addEventListener("load",()=>i(o)),o.addEventListener("error",()=>s(new Error("load failed"))),o.src=r}),"loadImage");const t=new vi(e.url);t.getHeader().then(r=>{const i=e.projection===void 0?"EPSG:3857":e.projection;this.tileGrid=e.tileGrid||kr({extent:un(i),maxResolution:e.maxResolution,minZoom:r.minZoom,maxZoom:r.maxZoom,tileSize:e.tileSize}),this.setLoader((s,o,a)=>nv(this,null,function*(){const l=yield t.getZxy(s,o,a);if(!l)return new Uint8Array;const u=URL.createObjectURL(new Blob([l.data])),h=yield this.loadImage(u);return URL.revokeObjectURL(u),h})),this.setState("ready")})}};Eo(ep,"PMTilesRasterSource");var th=ep,tp=class extends Bi{constructor(e){super(Gs(Gs({},e),{state:"loading",url:"pmtiles://{z}/{x}/{y}",format:e.format||new pf})),this.tileLoadFunction=Eo((t,r)=>{const i=t,s=new RegExp(/pmtiles:\/\/(\d+)\/(\d+)\/(\d+)/),o=r.match(s);if(!(o&&o.length>=4))throw Error("Could not parse tile URL");const a=+o[1],l=+o[2],u=+o[3];i.setLoader((h,c,f)=>{this.pmtiles_.getZxy(a,l,u).then(p=>{if(p){const d=i.getFormat();i.setFeatures(d.readFeatures(p.data,{extent:h,featureProjection:f})),i.setState(Q.LOADED)}else i.setFeatures([]),i.setState(Q.EMPTY)}).catch(p=>{i.setFeatures([]),i.setState(Q.ERROR)})})},"tileLoadFunction"),this.pmtiles_=new vi(e.url),this.pmtiles_.getHeader().then(t=>{const r=e.projection||"EPSG:3857",i=e.extent||un(r);this.tileGrid=e.tileGrid||kr({extent:i,maxResolution:e.maxResolution,maxZoom:e.maxZoom!==void 0?e.maxZoom:t.maxZoom,minZoom:t.minZoom,tileSize:e.tileSize||512}),this.setTileLoadFunction(this.tileLoadFunction),this.setState("ready")})}};Eo(tp,"PMTilesVectorSource");var iv=tp;class gu extends Ef{constructor(e){const t={};if(["opacity","visible","zIndex","minResolution","maxResolution","minZoom","maxZoom","properties"].forEach(r=>t[r]=e[r]),super(t),this.getSourceOptions_=e.getSourceOptions,this.children_=null,this.childrenOptions_=e.childrenOptions||{},this.assets_=null,this.bands_=[],this.crossOrigin_=e.crossOrigin||null,this.displayFootprint_=e.displayFootprint!==!1,this.displayGeoTiffByDefault_=!!e.displayGeoTiffByDefault,this.displayPreview_=!!e.displayPreview,this.displayOverview_=e.displayOverview!==!1,this.displayWebMapLink_=e.displayWebMapLink||!1,this.buildTileUrlTemplate_=e.buildTileUrlTemplate||null,this.useTileLayerAsFallback_=e.useTileLayerAsFallback||!1,this.boundsStyle_=e.boundsStyle||Jw,this.collectionStyle_=e.collectionStyle||Yc,this.boundsLayer_=null,this.disableMigration_=e.disableMigration||!1,this.map_=null,this.eventQueue_=[],e.httpRequestFn&&(this.fetch_=e.httpRequestFn),e.data){try{this.configure_(e.data,e.url,e.children,e.assets,e.bands)}catch(r){this.handleError_(r)}return}if(!e.url)throw new Error("Either url or data must be provided");this.fetch_(e.url).then(r=>this.configure_(r,e.url,e.children,e.assets,e.bands)).catch(r=>this.handleError_(r))}async fetch_(e,t="json"){const r=await fetch(e);if(!r.ok)throw new Error(`Unexpected response from ${e}: ${r.status}`);return t==="json"?await r.json():t==="text"?await r.text():null}getBoundsLayer(){return this.boundsLayer_}isEmpty(){var e;if(this.getLayers().getLength()>1)return!1;const r=(e=this.getData())===null||e===void 0?void 0:e.getBoundingBox();return!r||no(r)?!0:!this.boundsLayer_||!this.displayFootprint_}handleError_(e){this.dispatch_(new Hx(e))}configure_(e,t=null,r=null,i=null,s=[]){let o;e instanceof es||e instanceof ei?o=e:(o=ts(e,!this.disableMigration_),t&&t.includes("://")&&o.setAbsoluteUrl(t)),this.set("stac",o),this.bands_=s,this.boundsLayer_=this.addFootprint_();const a=()=>{this.boundsLayer_&&this.boundsLayer_.setStyle(Jc(this.boundsStyle_,this))};this.getLayers().on("add",a),this.getLayers().on("remove",a);const l=c=>this.handleError_(c),u=this.setChildren(r).catch(l),h=this.setAssets(i).catch(l);Promise.all([u,h]).then(()=>this.dispatch_("layersready")),this.dispatch_("sourceready")}dispatch_(e){this.eventQueue_.push(e),this.flush_()}flush_(){if(this.map_){for(const e of this.eventQueue_)this.dispatchEvent(e);this.eventQueue_=[]}}setMap_(e){this.map_!==e&&(this.map_=e,this.flush_())}async addChildren_(e,t={}){const r=e.map(i=>{const s={data:i,crossOrigin:this.crossOrigin_,boundsStyle:this.collectionStyle_,displayGeoTiffByDefault:this.displayGeoTiffByDefault_,displayOverview:this.displayOverview_,displayPreview:this.displayPreview_,displayFootprint:this.displayFootprint_,useTileLayerAsFallback:this.useTileLayerAsFallback_,buildTileUrlTemplate:this.buildTileUrlTemplate_},o=new gu(Object.assign(s,t));return o.on("sourceready",()=>{o.map_&&this.setMap_(o.map_)}),this.addLayer_(o,null),o});return await Promise.all(r)}async addPreviewImage_(e){const t=await Kc(e,"EPSG:4326"),r=e.getContext().getBoundingBoxes();if(r.length!==1)return;const i=r[0];let s={url:e.getAbsoluteUrl(),projection:t,imageExtent:Ea(i,"EPSG:4326",t),crossOrigin:this.crossOrigin_};this.getSourceOptions_&&(s=await this.getSourceOptions_(Fe.ImageStatic,s,e));const o=new _l({source:new qd(s)});return this.addLayer_(o,e),o}async addLayerForLink(e){const t=ev(e);if(!t)return;const r={attributions:e.getMetadata("attribution")||this.getData().getMetadata("attribution"),crossOrigin:this.crossOrigin_,url:t},i=async(o,a)=>(this.getSourceOptions_&&(a=await this.getSourceOptions_(o,a,e)),a),s=[];switch(e.rel){case"pmtiles":const a=await new vi(r.url).getHeader();let l;switch(a.tileType){case xn.Mvt:l=new iv(await i(Fe.PMTilesVector,r));break;case xn.Avif:case xn.Jpeg:case xn.Png:case xn.Webp:l=new th(await i(Fe.PMTilesRaster,r));break;default:return}s.push(l);break;case"tilejson":s.push(new xo(await i(Fe.TileJSON,r)));break;case"wms":if(!Array.isArray(e["wms:layers"]))break;for(const c in e["wms:layers"]){const f=e["wms:layers"][c]||"";let p="";Array.isArray(e["wms:styles"])&&typeof e["wms:styles"][c]=="string"&&(p=e["wms:styles"][c]);const d=Object.assign({LAYERS:f,STYLES:p},e["wms:dimensions"]);typeof e["wms:transparent"]=="boolean"&&(d.TRANSPARENT=String(e["wms:transparent"])),typeof e.type=="string"&&e.type.startsWith("image/")&&(d.FORMAT=e.type);const g=await i(Fe.TileWMS,Object.assign({},r,{params:d}));s.push(new cm(g))}break;case"wmts":const u=await this.getWmtsCapabilities_(t);if(!u)return;const h=Array.isArray(e["wmts:layer"])?e["wmts:layer"]:[e["wmts:layer"]];for(const c of h){let f=Object.assign({},r,{layer:c});typeof e.type=="string"&&e.type.startsWith("image/")&&(f.format=e.type),f=await i(Fe.WMTS,f),s.push(new um(gf(u,f)))}break;case"xyz":s.push(new As(await i(Fe.XYZ,r)));break;default:return}return s.map(o=>{let a;return o instanceof Bi?a=new Sn({source:o,declutter:!0}):o instanceof th?a=new Bs({source:o}):a=new Is({source:o}),this.addLayer_(a,e),a})}async addGeoTiff_(e){if(this.buildTileUrlTemplate_&&!this.useTileLayerAsFallback_)return await this.addTileLayerForImagery_(e);let r={sources:[Qw(e,this.bands_)],convertToRGB:"auto"};const i=await Kc(e);i&&(r.projection=i),this.getSourceOptions_&&(r=await this.getSourceOptions_(Fe.GeoTIFF,r,e));const s=new du(r),o=new Promise((a,l)=>{s.on("error",l),s.on("change",()=>{s.getState()==="error"?l(s.getError()):a()})});try{await o;const a=new Bs({source:s});return this.addLayer_(a,e),a}catch(a){if(this.useTileLayerAsFallback_)return await this.addTileLayerForImagery_(e);this.handleError_(a)}}async addTileLayerForImagery_(e){let t=this.buildTileUrlTemplate_(e);t instanceof Promise&&(t=await t);let r={crossOrigin:this.crossOrigin_,url:t};this.getSourceOptions_&&(r=await this.getSourceOptions_(Fe.XYZ,r,e));const i=new Is({source:new As(r)});return this.addLayer_(i,e),i}addLayer_(e,t=null,r=0){t&&e.set("stac",t),e.setZIndex(r),this.getLayers().push(e)}addFootprint_(){let e=null;const t=this.getData();if(t.isItemCollection()||t.isCollectionCollection()?e=Lm(t.getBoundingBox()):e=t.toGeoJSON(),e){const r=this.createGeoJsonLayer_(e,Jc(this.boundsStyle_,this),this.displayFootprint_);return r.set("bounds",!0),r.on("change",()=>this.setMap_(r.getMapInternal())),this.addLayer_(r,t,1),r}return null}async addGeoJson_(e){try{const t=await this.fetch_(e.getAbsoluteUrl()),r=this.createGeoJsonLayer_(t);return this.addLayer_(r,e),r}catch(t){this.handleError_(t)}}createGeoJsonLayer_(e,t=null,r=!0){const i=new bs,s=new Dr({format:i,loader:(o,a,l)=>{e=Fm(e);const u=i.readFeatures(e,{featureProjection:l});s.addFeatures(u)}});return t||(t=Yc),new Ni({source:s,style:t,visible:r})}async addLabelExtension_(){const e=this.getData();if(!(e instanceof wl))return;let t=e.getAssetsWithRoles(["labels","labels-vector"],!0),r;t.length>1&&(r=t.find(s=>s.roles.includes("labels-vector"))),r||(r=e.getAsset("vector_labels")),r||(t=e.getAssets().filter(s=>s.type===nc&&!s.roles),t.length===1&&(r=t[0]));const i=e.getLinksWithRels(["source"]);if(r&&i.length>0){const s=i.map(async a=>{try{const l=await this.fetch_(a.getAbsoluteUrl());return ts(l)}catch(l){return this.handleError_(l),null}}),o=(await Promise.all(s)).filter(a=>a instanceof ei);await this.addChildren_(o,{displayFootprint:!1})}try{await this.addGeoJson_(r)}catch(s){this.handleError_(s)}}async updateLayers_(){const e=this.getLayers();for(let i=e.getLength()-1;i>=0;i--){const s=e.item(i);s.get("stac")&&!s.get("bounds")&&e.removeAt(i)}const t=this.getData();if(Array.isArray(this.displayWebMapLink_)){const i=this.getWebMapLinks().map(async s=>await this.addLayerForLink(s));await Promise.all(i)}this.children_&&await this.addChildren_(this.children_,this.childrenOptions_);const r=this.getAssets();if(r){const i=r.map(async s=>{if(s){if(s.type===nc)return await this.addGeoJson_(s);if(s.isGeoTIFF())return await this.addGeoTiff_(s);if(s.canBrowserDisplayImage())return await this.addPreviewImage_(s)}});await Promise.all(i)}if(this.hasOnlyBounds()){if(t instanceof vl)await this.addChildren_(t.getAll(),this.childrenOptions_);else if(t instanceof ei){if(t.isItem()&&t.supportsExtension(Kw)&&t.getMetadata("label:type")==="vector"){await this.addLabelExtension_();return}const i=this.getWebMapLinks();if(i.length>0)await this.addLayerForLink(i[0]);else{const s=t.getDefaultGeoTIFF(!0,!this.displayGeoTiffByDefault_);let o;if(s&&this.displayOverview_&&(o=await this.addGeoTiff_(s)),this.displayPreview_&&(!s||!o)){const a=t.getThumbnails(!0,"overview");a.length>0&&await this.addPreviewImage_(a[0])}}}}}hasOnlyBounds(){const e=this.getBoundsLayer();return typeof this.getLayersArray().find(r=>r!==e)>"u"}getWebMapLinks(){const e=this.getData();if(e instanceof es)return[];let t=["xyz","tilejson","pmtiles","wmts","wms"];typeof this.displayWebMapLink_=="string"&&(t=[this.displayWebMapLink_]);let r=e.getLinksWithRels(t);return Array.isArray(this.displayWebMapLink_)?r=this.displayWebMapLink_.map(i=>{if(typeof i=="string"){const s=r.find(o=>o.id===i);return s||null}return i}).filter(i=>!!i):r.sort((i,s)=>{const o=t.indexOf(i.rel),a=t.indexOf(s.rel);return o-a}),r}async setAssets(e){if(Array.isArray(e)){const t=this.getData();this.assets_=e.map(r=>t instanceof ei&&typeof r=="string"?t.getAsset(r):r instanceof es?r:new es(r))}else this.assets_=null;await this.updateLayers_()}async setChildren(e,t=null){e instanceof Sf?this.children_=e.getAll():ic(e)&&e.type==="FeatureCollection"?this.children_=ts(e,!this.disableMigration_).getAll():Array.isArray(e)?this.children_=e.map(r=>r instanceof ei?r:ts(r,!this.disableMigration_)):this.children_=null,this.children_&&this.children_.length===0&&(this.children_=null),this.children_&&ic(t)&&(this.childrenOptions_=t),await this.updateLayers_()}getData(){return this.get("stac")}getChildren(){return this.children_}getAssets(){return this.assets_}getExtent(){if(!this.map_)return;const e=this.map_.getView();if(!e)return;let t;const r=this.getData();r&&(t=r.getBoundingBox());const i=this.getChildren();if(i){const s=i.map(o=>o.getBoundingBox());t=El(s)}if(t)return Ea(t,"EPSG:4326",e.getProjection())}getLayerState(){const e=super.getLayerState();return e.extent=void 0,e}getAttributions(){const e=[],t=this.getData();if(t){const r=t.getMetadata("attribution");r&&r.push(r)}return e}getSource(){return null}async getWmtsCapabilities_(e){try{const t=new URL(e);t.searchParams.set("service","wmts"),t.searchParams.set("request","GetCapabilities");const r=await this.fetch_(t.toString(),"text");return new Nl().read(r)}catch{return null}}}var sv=8,ov={version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number"},centerAltitude:{type:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},roll:{type:"number",default:0,units:"degrees"},state:{type:"state",default:{}},light:{type:"light"},sky:{type:"sky"},projection:{type:"projection"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"sprite"},glyphs:{type:"string"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},av={"*":{type:"source"}},lv=["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],uv={type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},cv={type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},hv={type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{},custom:{}},default:"mapbox"},redFactor:{type:"number",default:1},blueFactor:{type:"number",default:1},greenFactor:{type:"number",default:1},baseShift:{type:"number",default:0},volatile:{type:"boolean",default:!1},"*":{type:"*"}},fv={type:{required:!0,type:"enum",values:{geojson:{}}},data:{required:!0,type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"*"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},dv={type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},pv={type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},gv={id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},"color-relief":{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},mv=["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_color-relief","layout_background"],yv={visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},_v={"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},bv={"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},xv={visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},Ev={"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},wv={"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-variable-anchor-offset":{type:"variableAnchorOffsetCollection",requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},vv={visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},Tv={visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},Sv={type:"array",value:"*"},Rv={type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{}}},Pv={type:"enum",values:{Point:{},LineString:{},Polygon:{}}},Av={type:"array",minimum:0,maximum:24,value:["number","color"],length:2},Iv={type:"array",value:"*",minimum:1},Cv={anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},Lv={"sky-color":{type:"color","property-type":"data-constant",default:"#88C6FC",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-ground-blend":{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-fog-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"sky-horizon-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"atmosphere-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},Fv={source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1}},Mv={type:{type:"projectionDefinition",default:"mercator","property-type":"data-constant",transition:!1,expression:{interpolated:!0,parameters:["zoom"]}}},Ov=["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_color-relief","paint_background"],Nv={"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},Dv={"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},Uv={"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},Bv={"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},Gv={"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},zv={"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},kv={"hillshade-illumination-direction":{type:"numberArray",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-altitude":{type:"numberArray",default:45,minimum:0,maximum:90,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"colorArray",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"colorArray",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-method":{type:"enum",values:{standard:{},basic:{},combined:{},igor:{},multidirectional:{}},default:"standard",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},$v={"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},jv={duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},Vv={"*":{type:"string"}},Xv={$version:sv,$root:ov,sources:av,source:lv,source_vector:uv,source_raster:cv,source_raster_dem:hv,source_geojson:fv,source_video:dv,source_image:pv,layer:gv,layout:mv,layout_background:yv,layout_fill:_v,layout_circle:bv,layout_heatmap:xv,"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_line:Ev,layout_symbol:wv,layout_raster:vv,layout_hillshade:Tv,"layout_color-relief":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},filter:Sv,filter_operator:Rv,geometry_type:Pv,function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:Av,expression:Iv,light:Cv,sky:Lv,terrain:Fv,projection:Mv,paint:Ov,paint_fill:Nv,"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:Dv,paint_circle:Uv,paint_heatmap:Bv,paint_symbol:Gv,paint_raster:zv,paint_hillshade:kv,"paint_color-relief":{"color-relief-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"color-relief-color":{type:"color",transition:!1,expression:{interpolated:!0,parameters:["elevation"]},"property-type":"color-ramp"}},paint_background:$v,transition:jv,"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:Vv};const Wv=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function Zv(n,e){const t={};for(const r in n)r!=="ref"&&(t[r]=n[r]);return Wv.forEach(r=>{r in e&&(t[r]=e[r])}),t}function rp(n){n=n.slice();const e=Object.create(null);for(let t=0;t<n.length;t++)e[n[t].id]=n[t];for(let t=0;t<n.length;t++)"ref"in n[t]&&(n[t]=Zv(n[t],e[n[t].ref]));return n}class tr extends Error{constructor(e,t){super(t),this.message=t,this.key=e}}class mu{constructor(e,t=[]){this.parent=e,this.bindings={};for(const[r,i]of t)this.bindings[r]=i}concat(e){return new mu(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return this.bindings[e]?!0:this.parent?this.parent.has(e):!1}}const wo={kind:"null"},U={kind:"number"},se={kind:"string"},re={kind:"boolean"},ir={kind:"color"},vo={kind:"projectionDefinition"},Qr={kind:"object"},J={kind:"value"},qv={kind:"error"},To={kind:"collator"},So={kind:"formatted"},Ro={kind:"padding"},Si={kind:"colorArray"},Po={kind:"numberArray"},qi={kind:"resolvedImage"},Ao={kind:"variableAnchorOffsetCollection"};function Et(n,e){return{kind:"array",itemType:n,N:e}}function Be(n){if(n.kind==="array"){const e=Be(n.itemType);return typeof n.N=="number"?`array<${e}, ${n.N}>`:n.itemType.kind==="value"?"array":`array<${e}>`}else return n.kind}const Hv=[wo,U,se,re,ir,vo,So,Qr,Et(J),Ro,Po,Si,qi,Ao];function Ri(n,e){if(e.kind==="error")return null;if(n.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!Ri(n.itemType,e.itemType))&&(typeof n.N!="number"||n.N===e.N))return null}else{if(n.kind===e.kind)return null;if(n.kind==="value"){for(const t of Hv)if(!Ri(t,e))return null}}return`Expected ${Be(n)} but found ${Be(e)} instead.`}function yu(n,e){return e.some(t=>t.kind===n.kind)}function en(n,e){return e.some(t=>t==="null"?n===null:t==="array"?Array.isArray(n):t==="object"?n&&!Array.isArray(n)&&typeof n=="object":t===typeof n)}function Rr(n,e){return n.kind==="array"&&e.kind==="array"?n.itemType.kind===e.itemType.kind&&typeof n.N=="number":n.kind===e.kind}const np=.96422,ip=1,sp=.82521,op=4/29,Pn=6/29,ap=3*Pn*Pn,Yv=Pn*Pn*Pn,Kv=Math.PI/180,Jv=180/Math.PI;function lp(n){return n=n%360,n<0&&(n+=360),n}function up([n,e,t,r]){n=sa(n),e=sa(e),t=sa(t);let i,s;const o=oa((.2225045*n+.7168786*e+.0606169*t)/ip);n===e&&e===t?i=s=o:(i=oa((.4360747*n+.3850649*e+.1430804*t)/np),s=oa((.0139322*n+.0971045*e+.7141733*t)/sp));const a=116*o-16;return[a<0?0:a,500*(i-o),200*(o-s),r]}function sa(n){return n<=.04045?n/12.92:Math.pow((n+.055)/1.055,2.4)}function oa(n){return n>Yv?Math.pow(n,1/3):n/ap+op}function cp([n,e,t,r]){let i=(n+16)/116,s=isNaN(e)?i:i+e/500,o=isNaN(t)?i:i-t/200;return i=ip*la(i),s=np*la(s),o=sp*la(o),[aa(3.1338561*s-1.6168667*i-.4906146*o),aa(-.9787684*s+1.9161415*i+.033454*o),aa(.0719453*s-.2289914*i+1.4052427*o),r]}function aa(n){return n=n<=.00304?12.92*n:1.055*Math.pow(n,1/2.4)-.055,n<0?0:n>1?1:n}function la(n){return n>Pn?n*n*n:ap*(n-op)}function Qv(n){const[e,t,r,i]=up(n),s=Math.sqrt(t*t+r*r);return[Math.round(s*1e4)?lp(Math.atan2(r,t)*Jv):NaN,s,e,i]}function e1([n,e,t,r]){return n=isNaN(n)?0:n*Kv,cp([t,Math.cos(n)*e,Math.sin(n)*e,r])}function t1([n,e,t,r]){n=lp(n),e/=100,t/=100;function i(s){const o=(s+n/30)%12,a=e*Math.min(t,1-t);return t-a*Math.max(-1,Math.min(o-3,9-o,1))}return[i(0),i(8),i(4),r]}const r1=Object.hasOwn||function(e,t){return Object.prototype.hasOwnProperty.call(e,t)};function hp(n,e){return r1(n,e)?n[e]:void 0}function n1(n){if(n=n.toLowerCase().trim(),n==="transparent")return[0,0,0,0];const e=hp(i1,n);if(e){const[i,s,o]=e;return[i/255,s/255,o/255,1]}if(n.startsWith("#")&&/^#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/.test(n)){const s=n.length<6?1:2;let o=1;return[as(n.slice(o,o+=s)),as(n.slice(o,o+=s)),as(n.slice(o,o+=s)),as(n.slice(o,o+s)||"ff")]}if(n.startsWith("rgb")){const i=/^rgba?\(\s*([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/,s=n.match(i);if(s){const[o,a,l,u,h,c,f,p,d,g,m,_]=s,y=[u||" ",f||" ",g].join("");if(y==="  "||y==="  /"||y===",,"||y===",,,"){const b=[l,c,d].join(""),v=b==="%%%"?100:b===""?255:0;if(v){const x=[En(+a/v,0,1),En(+h/v,0,1),En(+p/v,0,1),m?rh(+m,_):1];if(nh(x))return x}}return}}const t=/^hsla?\(\s*([\de.+-]+)(?:deg)?(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/,r=n.match(t);if(r){const[i,s,o,a,l,u,h,c,f]=r,p=[o||" ",l||" ",h].join("");if(p==="  "||p==="  /"||p===",,"||p===",,,"){const d=[+s,En(+a,0,100),En(+u,0,100),c?rh(+c,f):1];if(nh(d))return t1(d)}}}function as(n){return parseInt(n.padEnd(2,n),16)/255}function rh(n,e){return En(e?n/100:n,0,1)}function En(n,e,t){return Math.min(Math.max(e,n),t)}function nh(n){return!n.some(Number.isNaN)}const i1={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};function tn(n,e,t){return n+t*(e-n)}function Pi(n,e,t){return n.map((r,i)=>tn(r,e[i],t))}class Se{constructor(e,t,r,i=1,s=!0){this.r=e,this.g=t,this.b=r,this.a=i,s||(this.r*=i,this.g*=i,this.b*=i,i||this.overwriteGetter("rgb",[e,t,r,i]))}static parse(e){if(e instanceof Se)return e;if(typeof e!="string")return;const t=n1(e);if(t)return new Se(...t,!1)}get rgb(){const{r:e,g:t,b:r,a:i}=this,s=i||1/0;return this.overwriteGetter("rgb",[e/s,t/s,r/s,i])}get hcl(){return this.overwriteGetter("hcl",Qv(this.rgb))}get lab(){return this.overwriteGetter("lab",up(this.rgb))}overwriteGetter(e,t){return Object.defineProperty(this,e,{value:t}),t}toString(){const[e,t,r,i]=this.rgb;return`rgba(${[e,t,r].map(s=>Math.round(s*255)).join(",")},${i})`}static interpolate(e,t,r,i="rgb"){switch(i){case"rgb":{const[s,o,a,l]=Pi(e.rgb,t.rgb,r);return new Se(s,o,a,l,!1)}case"hcl":{const[s,o,a,l]=e.hcl,[u,h,c,f]=t.hcl;let p,d;if(!isNaN(s)&&!isNaN(u)){let b=u-s;u>s&&b>180?b-=360:u<s&&s-u>180&&(b+=360),p=s+r*b}else isNaN(s)?isNaN(u)?p=NaN:(p=u,(a===1||a===0)&&(d=h)):(p=s,(c===1||c===0)&&(d=o));const[g,m,_,y]=e1([p,d??tn(o,h,r),tn(a,c,r),tn(l,f,r)]);return new Se(g,m,_,y,!1)}case"lab":{const[s,o,a,l]=cp(Pi(e.lab,t.lab,r));return new Se(s,o,a,l,!1)}}}}Se.black=new Se(0,0,0,1);Se.white=new Se(1,1,1,1);Se.transparent=new Se(0,0,0,0);Se.red=new Se(1,0,0,1);class _u{constructor(e,t,r){e?this.sensitivity=t?"variant":"case":this.sensitivity=t?"accent":"base",this.locale=r,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,t){return this.collator.compare(e,t)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}const s1=["bottom","center","top"];class ja{constructor(e,t,r,i,s,o){this.text=e,this.image=t,this.scale=r,this.fontStack=i,this.textColor=s,this.verticalAlign=o}}class mr{constructor(e){this.sections=e}static fromString(e){return new mr([new ja(e,null,null,null,null,null)])}isEmpty(){return this.sections.length===0?!0:!this.sections.some(e=>e.text.length!==0||e.image&&e.image.name.length!==0)}static factory(e){return e instanceof mr?e:mr.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}}class kt{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof kt)return e;if(typeof e=="number")return new kt([e,e,e,e]);if(Array.isArray(e)&&!(e.length<1||e.length>4)){for(const t of e)if(typeof t!="number")return;switch(e.length){case 1:e=[e[0],e[0],e[0],e[0]];break;case 2:e=[e[0],e[1],e[0],e[1]];break;case 3:e=[e[0],e[1],e[2],e[1]];break}return new kt(e)}}toString(){return JSON.stringify(this.values)}static interpolate(e,t,r){return new kt(Pi(e.values,t.values,r))}}class $t{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof $t)return e;if(typeof e=="number")return new $t([e]);if(Array.isArray(e)){for(const t of e)if(typeof t!="number")return;return new $t(e)}}toString(){return JSON.stringify(this.values)}static interpolate(e,t,r){return new $t(Pi(e.values,t.values,r))}}class wt{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof wt)return e;if(typeof e=="string"){const r=Se.parse(e);return r?new wt([r]):void 0}if(!Array.isArray(e))return;const t=[];for(const r of e){if(typeof r!="string")return;const i=Se.parse(r);if(!i)return;t.push(i)}return new wt(t)}toString(){return JSON.stringify(this.values)}static interpolate(e,t,r,i="rgb"){const s=[];if(e.values.length!=t.values.length)throw new Error(`colorArray: Arrays have mismatched length (${e.values.length} vs. ${t.values.length}), cannot interpolate.`);for(let o=0;o<e.values.length;o++)s.push(Se.interpolate(e.values[o],t.values[o],r,i));return new wt(s)}}class ze extends Error{constructor(e){super(e),this.name="RuntimeError"}toJSON(){return this.message}}const o1=new Set(["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"]);class sr{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof sr)return e;if(!(!Array.isArray(e)||e.length<1||e.length%2!==0)){for(let t=0;t<e.length;t+=2){const r=e[t],i=e[t+1];if(typeof r!="string"||!o1.has(r)||!Array.isArray(i)||i.length!==2||typeof i[0]!="number"||typeof i[1]!="number")return}return new sr(e)}}toString(){return JSON.stringify(this.values)}static interpolate(e,t,r){const i=e.values,s=t.values;if(i.length!==s.length)throw new ze(`Cannot interpolate values of different length. from: ${e.toString()}, to: ${t.toString()}`);const o=[];for(let a=0;a<i.length;a+=2){if(i[a]!==s[a])throw new ze(`Cannot interpolate values containing mismatched anchors. from[${a}]: ${i[a]}, to[${a}]: ${s[a]}`);o.push(i[a]);const[l,u]=i[a+1],[h,c]=s[a+1];o.push([tn(l,h,r),tn(u,c,r)])}return new sr(o)}}class Vr{constructor(e){this.name=e.name,this.available=e.available}toString(){return this.name}static fromString(e){return e?new Vr({name:e,available:!1}):null}}class Ut{constructor(e,t,r){this.from=e,this.to=t,this.transition=r}static interpolate(e,t,r){return new Ut(e,t,r)}static parse(e){if(e instanceof Ut)return e;if(Array.isArray(e)&&e.length===3&&typeof e[0]=="string"&&typeof e[1]=="string"&&typeof e[2]=="number")return new Ut(e[0],e[1],e[2]);if(typeof e=="object"&&typeof e.from=="string"&&typeof e.to=="string"&&typeof e.transition=="number")return new Ut(e.from,e.to,e.transition);if(typeof e=="string")return new Ut(e,e,1)}}function fp(n,e,t,r){return typeof n=="number"&&n>=0&&n<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof t=="number"&&t>=0&&t<=255?typeof r>"u"||typeof r=="number"&&r>=0&&r<=1?null:`Invalid rgba value [${[n,e,t,r].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof r=="number"?[n,e,t,r]:[n,e,t]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Ai(n){if(n===null||typeof n=="string"||typeof n=="boolean"||typeof n=="number"||n instanceof Ut||n instanceof Se||n instanceof _u||n instanceof mr||n instanceof kt||n instanceof $t||n instanceof wt||n instanceof sr||n instanceof Vr)return!0;if(Array.isArray(n)){for(const e of n)if(!Ai(e))return!1;return!0}else if(typeof n=="object"){for(const e in n)if(!Ai(n[e]))return!1;return!0}else return!1}function Ze(n){if(n===null)return wo;if(typeof n=="string")return se;if(typeof n=="boolean")return re;if(typeof n=="number")return U;if(n instanceof Se)return ir;if(n instanceof Ut)return vo;if(n instanceof _u)return To;if(n instanceof mr)return So;if(n instanceof kt)return Ro;if(n instanceof $t)return Po;if(n instanceof wt)return Si;if(n instanceof sr)return Ao;if(n instanceof Vr)return qi;if(Array.isArray(n)){const e=n.length;let t;for(const r of n){const i=Ze(r);if(!t)t=i;else{if(t===i)continue;t=J;break}}return Et(t||J,e)}else return Qr}function di(n){const e=typeof n;return n===null?"":e==="string"||e==="number"||e==="boolean"?String(n):n instanceof Se||n instanceof Ut||n instanceof mr||n instanceof kt||n instanceof $t||n instanceof wt||n instanceof sr||n instanceof Vr?n.toString():JSON.stringify(n)}class Un{constructor(e,t){this.type=e,this.value=t}static parse(e,t){if(e.length!==2)return t.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!Ai(e[1]))return t.error("invalid value");const r=e[1];let i=Ze(r);const s=t.expectedType;return i.kind==="array"&&i.N===0&&s&&s.kind==="array"&&(typeof s.N!="number"||s.N===0)&&(i=s),new Un(i,r)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}const ls={string:se,number:U,boolean:re,object:Qr};class Bt{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");let r=1,i;const s=e[0];if(s==="array"){let a;if(e.length>2){const u=e[1];if(typeof u!="string"||!(u in ls)||u==="object")return t.error('The item type argument of "array" must be one of string, number, boolean',1);a=ls[u],r++}else a=J;let l;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return t.error('The length argument to "array" must be a positive integer literal',2);l=e[2],r++}i=Et(a,l)}else{if(!ls[s])throw new Error(`Types doesn't contain name = ${s}`);i=ls[s]}const o=[];for(;r<e.length;r++){const a=t.parse(e[r],r,J);if(!a)return null;o.push(a)}return new Bt(i,o)}evaluate(e){for(let t=0;t<this.args.length;t++){const r=this.args[t].evaluate(e);if(Ri(this.type,Ze(r))){if(t===this.args.length-1)throw new ze(`Expected value to be of type ${Be(this.type)}, but found ${Be(Ze(r))} instead.`)}else return r}throw new Error}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}}const ih={"to-boolean":re,"to-color":ir,"to-number":U,"to-string":se};class Or{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");const r=e[0];if(!ih[r])throw new Error(`Can't parse ${r} as it is not part of the known types`);if((r==="to-boolean"||r==="to-string")&&e.length!==2)return t.error("Expected one argument.");const i=ih[r],s=[];for(let o=1;o<e.length;o++){const a=t.parse(e[o],o,J);if(!a)return null;s.push(a)}return new Or(i,s)}evaluate(e){switch(this.type.kind){case"boolean":return!!this.args[0].evaluate(e);case"color":{let t,r;for(const i of this.args){if(t=i.evaluate(e),r=null,t instanceof Se)return t;if(typeof t=="string"){const s=e.parseColor(t);if(s)return s}else if(Array.isArray(t)&&(t.length<3||t.length>4?r=`Invalid rgba value ${JSON.stringify(t)}: expected an array containing either three or four numeric values.`:r=fp(t[0],t[1],t[2],t[3]),!r))return new Se(t[0]/255,t[1]/255,t[2]/255,t[3])}throw new ze(r||`Could not parse color from value '${typeof t=="string"?t:JSON.stringify(t)}'`)}case"padding":{let t;for(const r of this.args){t=r.evaluate(e);const i=kt.parse(t);if(i)return i}throw new ze(`Could not parse padding from value '${typeof t=="string"?t:JSON.stringify(t)}'`)}case"numberArray":{let t;for(const r of this.args){t=r.evaluate(e);const i=$t.parse(t);if(i)return i}throw new ze(`Could not parse numberArray from value '${typeof t=="string"?t:JSON.stringify(t)}'`)}case"colorArray":{let t;for(const r of this.args){t=r.evaluate(e);const i=wt.parse(t);if(i)return i}throw new ze(`Could not parse colorArray from value '${typeof t=="string"?t:JSON.stringify(t)}'`)}case"variableAnchorOffsetCollection":{let t;for(const r of this.args){t=r.evaluate(e);const i=sr.parse(t);if(i)return i}throw new ze(`Could not parse variableAnchorOffsetCollection from value '${typeof t=="string"?t:JSON.stringify(t)}'`)}case"number":{let t=null;for(const r of this.args){if(t=r.evaluate(e),t===null)return 0;const i=Number(t);if(!isNaN(i))return i}throw new ze(`Could not convert ${JSON.stringify(t)} to number.`)}case"formatted":return mr.fromString(di(this.args[0].evaluate(e)));case"resolvedImage":return Vr.fromString(di(this.args[0].evaluate(e)));case"projectionDefinition":return this.args[0].evaluate(e);default:return di(this.args[0].evaluate(e))}}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}}const a1=["Unknown","Point","LineString","Polygon"];class dp{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache=new Map,this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?a1[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(e){let t=this._parseColorCache.get(e);return t||(t=Se.parse(e),this._parseColorCache.set(e,t)),t}}class Io{constructor(e,t,r=[],i,s=new mu,o=[]){this.registry=e,this.path=r,this.key=r.map(a=>`[${a}]`).join(""),this.scope=s,this.errors=o,this.expectedType=i,this._isConstant=t}parse(e,t,r,i,s={}){return t?this.concat(t,r,i)._parse(e,s):this._parse(e,s)}_parse(e,t){(e===null||typeof e=="string"||typeof e=="boolean"||typeof e=="number")&&(e=["literal",e]);function r(i,s,o){return o==="assert"?new Bt(s,[i]):o==="coerce"?new Or(s,[i]):i}if(Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const i=e[0];if(typeof i!="string")return this.error(`Expression name must be a string, but found ${typeof i} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const s=this.registry[i];if(s){let o=s.parse(e,this);if(!o)return null;if(this.expectedType){const a=this.expectedType,l=o.type;if((a.kind==="string"||a.kind==="number"||a.kind==="boolean"||a.kind==="object"||a.kind==="array")&&l.kind==="value")o=r(o,a,t.typeAnnotation||"assert");else if(a.kind==="projectionDefinition"&&["string","array"].includes(l.kind)||["color","formatted","resolvedImage"].includes(a.kind)&&["value","string"].includes(l.kind)||["padding","numberArray"].includes(a.kind)&&["value","number","array"].includes(l.kind)||a.kind==="colorArray"&&["value","string","array"].includes(l.kind)||a.kind==="variableAnchorOffsetCollection"&&["value","array"].includes(l.kind))o=r(o,a,t.typeAnnotation||"coerce");else if(this.checkSubtype(a,l))return null}if(!(o instanceof Un)&&o.type.kind!=="resolvedImage"&&this._isConstant(o)){const a=new dp;try{o=new Un(o.type,o.evaluate(a))}catch(l){return this.error(l.message),null}}return o}return this.error(`Unknown expression "${i}". If you wanted a literal array, use ["literal", [...]].`,0)}else return typeof e>"u"?this.error("'undefined' value invalid. Use null instead."):typeof e=="object"?this.error('Bare objects invalid. Use ["literal", {...}] instead.'):this.error(`Expected an array, but found ${typeof e} instead.`)}concat(e,t,r){const i=typeof e=="number"?this.path.concat(e):this.path,s=r?this.scope.concat(r):this.scope;return new Io(this.registry,this._isConstant,i,t||null,s,this.errors)}error(e,...t){const r=`${this.key}${t.map(i=>`[${i}]`).join("")}`;this.errors.push(new tr(r,e))}checkSubtype(e,t){const r=Ri(e,t);return r&&this.error(r),r}}class Co{constructor(e,t){this.type=t.type,this.bindings=[].concat(e),this.result=t}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const t of this.bindings)e(t[1]);e(this.result)}static parse(e,t){if(e.length<4)return t.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const r=[];for(let s=1;s<e.length-1;s+=2){const o=e[s];if(typeof o!="string")return t.error(`Expected string, but found ${typeof o} instead.`,s);if(/[^a-zA-Z0-9_]/.test(o))return t.error("Variable names must contain only alphanumeric characters or '_'.",s);const a=t.parse(e[s+1],s+1);if(!a)return null;r.push([o,a])}const i=t.parse(e[e.length-1],e.length-1,t.expectedType,r);return i?new Co(r,i):null}outputDefined(){return this.result.outputDefined()}}class Lo{constructor(e,t){this.type=t.type,this.name=e,this.boundExpression=t}static parse(e,t){if(e.length!==2||typeof e[1]!="string")return t.error("'var' expression requires exactly one string literal argument.");const r=e[1];return t.scope.has(r)?new Lo(r,t.scope.get(r)):t.error(`Unknown variable "${r}". Make sure "${r}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}}class bu{constructor(e,t,r){this.type=e,this.index=t,this.input=r}static parse(e,t){if(e.length!==3)return t.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const r=t.parse(e[1],1,U),i=t.parse(e[2],2,Et(t.expectedType||J));if(!r||!i)return null;const s=i.type;return new bu(s.itemType,r,i)}evaluate(e){const t=this.index.evaluate(e),r=this.input.evaluate(e);if(t<0)throw new ze(`Array index out of bounds: ${t} < 0.`);if(t>=r.length)throw new ze(`Array index out of bounds: ${t} > ${r.length-1}.`);if(t!==Math.floor(t))throw new ze(`Array index must be an integer, but found ${t} instead.`);return r[t]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}}class xu{constructor(e,t){this.type=re,this.needle=e,this.haystack=t}static parse(e,t){if(e.length!==3)return t.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const r=t.parse(e[1],1,J),i=t.parse(e[2],2,J);return!r||!i?null:yu(r.type,[re,se,U,wo,J])?new xu(r,i):t.error(`Expected first argument to be of type boolean, string, number or null, but found ${Be(r.type)} instead`)}evaluate(e){const t=this.needle.evaluate(e),r=this.haystack.evaluate(e);if(!r)return!1;if(!en(t,["boolean","string","number","null"]))throw new ze(`Expected first argument to be of type boolean, string, number or null, but found ${Be(Ze(t))} instead.`);if(!en(r,["string","array"]))throw new ze(`Expected second argument to be of type array or string, but found ${Be(Ze(r))} instead.`);return r.indexOf(t)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}}class zs{constructor(e,t,r){this.type=U,this.needle=e,this.haystack=t,this.fromIndex=r}static parse(e,t){if(e.length<=2||e.length>=5)return t.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const r=t.parse(e[1],1,J),i=t.parse(e[2],2,J);if(!r||!i)return null;if(!yu(r.type,[re,se,U,wo,J]))return t.error(`Expected first argument to be of type boolean, string, number or null, but found ${Be(r.type)} instead`);if(e.length===4){const s=t.parse(e[3],3,U);return s?new zs(r,i,s):null}else return new zs(r,i)}evaluate(e){const t=this.needle.evaluate(e),r=this.haystack.evaluate(e);if(!en(t,["boolean","string","number","null"]))throw new ze(`Expected first argument to be of type boolean, string, number or null, but found ${Be(Ze(t))} instead.`);let i;if(this.fromIndex&&(i=this.fromIndex.evaluate(e)),en(r,["string"])){const s=r.indexOf(t,i);return s===-1?-1:[...r.slice(0,s)].length}else{if(en(r,["array"]))return r.indexOf(t,i);throw new ze(`Expected second argument to be of type array or string, but found ${Be(Ze(r))} instead.`)}}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}}class Eu{constructor(e,t,r,i,s,o){this.inputType=e,this.type=t,this.input=r,this.cases=i,this.outputs=s,this.otherwise=o}static parse(e,t){if(e.length<5)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!==1)return t.error("Expected an even number of arguments.");let r,i;t.expectedType&&t.expectedType.kind!=="value"&&(i=t.expectedType);const s={},o=[];for(let u=2;u<e.length-1;u+=2){let h=e[u];const c=e[u+1];Array.isArray(h)||(h=[h]);const f=t.concat(u);if(h.length===0)return f.error("Expected at least one branch label.");for(const d of h){if(typeof d!="number"&&typeof d!="string")return f.error("Branch labels must be numbers or strings.");if(typeof d=="number"&&Math.abs(d)>Number.MAX_SAFE_INTEGER)return f.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof d=="number"&&Math.floor(d)!==d)return f.error("Numeric branch labels must be integer values.");if(!r)r=Ze(d);else if(f.checkSubtype(r,Ze(d)))return null;if(typeof s[String(d)]<"u")return f.error("Branch labels must be unique.");s[String(d)]=o.length}const p=t.parse(c,u,i);if(!p)return null;i=i||p.type,o.push(p)}const a=t.parse(e[1],1,J);if(!a)return null;const l=t.parse(e[e.length-1],e.length-1,i);return!l||a.type.kind!=="value"&&t.concat(1).checkSubtype(r,a.type)?null:new Eu(r,i,a,s,o,l)}evaluate(e){const t=this.input.evaluate(e);return(Ze(t)===this.inputType&&this.outputs[this.cases[t]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}}class wu{constructor(e,t,r){this.type=e,this.branches=t,this.otherwise=r}static parse(e,t){if(e.length<4)return t.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!==0)return t.error("Expected an odd number of arguments.");let r;t.expectedType&&t.expectedType.kind!=="value"&&(r=t.expectedType);const i=[];for(let o=1;o<e.length-1;o+=2){const a=t.parse(e[o],o,re);if(!a)return null;const l=t.parse(e[o+1],o+1,r);if(!l)return null;i.push([a,l]),r=r||l.type}const s=t.parse(e[e.length-1],e.length-1,r);if(!s)return null;if(!r)throw new Error("Can't infer output type");return new wu(r,i,s)}evaluate(e){for(const[t,r]of this.branches)if(t.evaluate(e))return r.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[t,r]of this.branches)e(t),e(r);e(this.otherwise)}outputDefined(){return this.branches.every(([e,t])=>t.outputDefined())&&this.otherwise.outputDefined()}}class ks{constructor(e,t,r,i){this.type=e,this.input=t,this.beginIndex=r,this.endIndex=i}static parse(e,t){if(e.length<=2||e.length>=5)return t.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const r=t.parse(e[1],1,J),i=t.parse(e[2],2,U);if(!r||!i)return null;if(!yu(r.type,[Et(J),se,J]))return t.error(`Expected first argument to be of type array or string, but found ${Be(r.type)} instead`);if(e.length===4){const s=t.parse(e[3],3,U);return s?new ks(r.type,r,i,s):null}else return new ks(r.type,r,i)}evaluate(e){const t=this.input.evaluate(e),r=this.beginIndex.evaluate(e);let i;if(this.endIndex&&(i=this.endIndex.evaluate(e)),en(t,["string"]))return[...t].slice(r,i).join("");if(en(t,["array"]))return t.slice(r,i);throw new ze(`Expected first argument to be of type array or string, but found ${Be(Ze(t))} instead.`)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}}function pp(n,e){const t=n.length-1;let r=0,i=t,s=0,o,a;for(;r<=i;)if(s=Math.floor((r+i)/2),o=n[s],a=n[s+1],o<=e){if(s===t||e<a)return s;r=s+1}else if(o>e)i=s-1;else throw new ze("Input is not a number.");return 0}class Fo{constructor(e,t,r){this.type=e,this.input=t,this.labels=[],this.outputs=[];for(const[i,s]of r)this.labels.push(i),this.outputs.push(s)}static parse(e,t){if(e.length-1<4)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!==0)return t.error("Expected an even number of arguments.");const r=t.parse(e[1],1,U);if(!r)return null;const i=[];let s=null;t.expectedType&&t.expectedType.kind!=="value"&&(s=t.expectedType);for(let o=1;o<e.length;o+=2){const a=o===1?-1/0:e[o],l=e[o+1],u=o,h=o+1;if(typeof a!="number")return t.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',u);if(i.length&&i[i.length-1][0]>=a)return t.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',u);const c=t.parse(l,h,s);if(!c)return null;s=s||c.type,i.push([a,c])}return new Fo(s,r,i)}evaluate(e){const t=this.labels,r=this.outputs;if(t.length===1)return r[0].evaluate(e);const i=this.input.evaluate(e);if(i<=t[0])return r[0].evaluate(e);const s=t.length;if(i>=t[s-1])return r[s-1].evaluate(e);const o=pp(t,i);return r[o].evaluate(e)}eachChild(e){e(this.input);for(const t of this.outputs)e(t)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}}function l1(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var ua,sh;function u1(){if(sh)return ua;sh=1,ua=n;function n(e,t,r,i){this.cx=3*e,this.bx=3*(r-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*t,this.by=3*(i-t)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=t,this.p2x=r,this.p2y=i}return n.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,t){if(t===void 0&&(t=1e-6),e<0)return 0;if(e>1)return 1;for(var r=e,i=0;i<8;i++){var s=this.sampleCurveX(r)-e;if(Math.abs(s)<t)return r;var o=this.sampleCurveDerivativeX(r);if(Math.abs(o)<1e-6)break;r=r-s/o}var a=0,l=1;for(r=e,i=0;i<20&&(s=this.sampleCurveX(r),!(Math.abs(s-e)<t));i++)e>s?a=r:l=r,r=(l-a)*.5+a;return r},solve:function(e,t){return this.sampleCurveY(this.solveCurveX(e,t))}},ua}var c1=u1(),h1=l1(c1);class or{constructor(e,t,r,i,s){this.type=e,this.operator=t,this.interpolation=r,this.input=i,this.labels=[],this.outputs=[];for(const[o,a]of s)this.labels.push(o),this.outputs.push(a)}static interpolationFactor(e,t,r,i){let s=0;if(e.name==="exponential")s=ca(t,e.base,r,i);else if(e.name==="linear")s=ca(t,1,r,i);else if(e.name==="cubic-bezier"){const o=e.controlPoints;s=new h1(o[0],o[1],o[2],o[3]).solve(ca(t,1,r,i))}return s}static parse(e,t){let[r,i,s,...o]=e;if(!Array.isArray(i)||i.length===0)return t.error("Expected an interpolation type expression.",1);if(i[0]==="linear")i={name:"linear"};else if(i[0]==="exponential"){const u=i[1];if(typeof u!="number")return t.error("Exponential interpolation requires a numeric base.",1,1);i={name:"exponential",base:u}}else if(i[0]==="cubic-bezier"){const u=i.slice(1);if(u.length!==4||u.some(h=>typeof h!="number"||h<0||h>1))return t.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);i={name:"cubic-bezier",controlPoints:u}}else return t.error(`Unknown interpolation type ${String(i[0])}`,1,0);if(e.length-1<4)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!==0)return t.error("Expected an even number of arguments.");if(s=t.parse(s,2,U),!s)return null;const a=[];let l=null;(r==="interpolate-hcl"||r==="interpolate-lab")&&t.expectedType!=Si?l=ir:t.expectedType&&t.expectedType.kind!=="value"&&(l=t.expectedType);for(let u=0;u<o.length;u+=2){const h=o[u],c=o[u+1],f=u+3,p=u+4;if(typeof h!="number")return t.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',f);if(a.length&&a[a.length-1][0]>=h)return t.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',f);const d=t.parse(c,p,l);if(!d)return null;l=l||d.type,a.push([h,d])}return!Rr(l,U)&&!Rr(l,vo)&&!Rr(l,ir)&&!Rr(l,Ro)&&!Rr(l,Po)&&!Rr(l,Si)&&!Rr(l,Ao)&&!Rr(l,Et(U))?t.error(`Type ${Be(l)} is not interpolatable.`):new or(l,r,i,s,a)}evaluate(e){const t=this.labels,r=this.outputs;if(t.length===1)return r[0].evaluate(e);const i=this.input.evaluate(e);if(i<=t[0])return r[0].evaluate(e);const s=t.length;if(i>=t[s-1])return r[s-1].evaluate(e);const o=pp(t,i),a=t[o],l=t[o+1],u=or.interpolationFactor(this.interpolation,i,a,l),h=r[o].evaluate(e),c=r[o+1].evaluate(e);switch(this.operator){case"interpolate":switch(this.type.kind){case"number":return tn(h,c,u);case"color":return Se.interpolate(h,c,u);case"padding":return kt.interpolate(h,c,u);case"colorArray":return wt.interpolate(h,c,u);case"numberArray":return $t.interpolate(h,c,u);case"variableAnchorOffsetCollection":return sr.interpolate(h,c,u);case"array":return Pi(h,c,u);case"projectionDefinition":return Ut.interpolate(h,c,u)}case"interpolate-hcl":switch(this.type.kind){case"color":return Se.interpolate(h,c,u,"hcl");case"colorArray":return wt.interpolate(h,c,u,"hcl")}case"interpolate-lab":switch(this.type.kind){case"color":return Se.interpolate(h,c,u,"lab");case"colorArray":return wt.interpolate(h,c,u,"lab")}}}eachChild(e){e(this.input);for(const t of this.outputs)e(t)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}}function ca(n,e,t,r){const i=r-t,s=n-t;return i===0?0:e===1?s/i:(Math.pow(e,s)-1)/(Math.pow(e,i)-1)}class Ii{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");let r=null;const i=t.expectedType;i&&i.kind!=="value"&&(r=i);const s=[];for(const a of e.slice(1)){const l=t.parse(a,1+s.length,r,void 0,{typeAnnotation:"omit"});if(!l)return null;r=r||l.type,s.push(l)}if(!r)throw new Error("No output type");return i&&s.some(a=>Ri(i,a.type))?new Ii(J,s):new Ii(r,s)}evaluate(e){let t=null,r=0,i;for(const s of this.args)if(r++,t=s.evaluate(e),t&&t instanceof Vr&&!t.available&&(i||(i=t.name),t=null,r===this.args.length&&(t=i)),t!==null)break;return t}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}}function oh(n,e){return n==="=="||n==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function f1(n,e,t){return e===t}function d1(n,e,t){return e!==t}function p1(n,e,t){return e<t}function g1(n,e,t){return e>t}function m1(n,e,t){return e<=t}function y1(n,e,t){return e>=t}function gp(n,e,t,r){return r.compare(e,t)===0}function _1(n,e,t,r){return!gp(n,e,t,r)}function b1(n,e,t,r){return r.compare(e,t)<0}function x1(n,e,t,r){return r.compare(e,t)>0}function E1(n,e,t,r){return r.compare(e,t)<=0}function w1(n,e,t,r){return r.compare(e,t)>=0}function qn(n,e,t){const r=n!=="=="&&n!=="!=";return class mp{constructor(s,o,a){this.type=re,this.lhs=s,this.rhs=o,this.collator=a,this.hasUntypedArgument=s.type.kind==="value"||o.type.kind==="value"}static parse(s,o){if(s.length!==3&&s.length!==4)return o.error("Expected two or three arguments.");const a=s[0];let l=o.parse(s[1],1,J);if(!l)return null;if(!oh(a,l.type))return o.concat(1).error(`"${a}" comparisons are not supported for type '${Be(l.type)}'.`);let u=o.parse(s[2],2,J);if(!u)return null;if(!oh(a,u.type))return o.concat(2).error(`"${a}" comparisons are not supported for type '${Be(u.type)}'.`);if(l.type.kind!==u.type.kind&&l.type.kind!=="value"&&u.type.kind!=="value")return o.error(`Cannot compare types '${Be(l.type)}' and '${Be(u.type)}'.`);r&&(l.type.kind==="value"&&u.type.kind!=="value"?l=new Bt(u.type,[l]):l.type.kind!=="value"&&u.type.kind==="value"&&(u=new Bt(l.type,[u])));let h=null;if(s.length===4){if(l.type.kind!=="string"&&u.type.kind!=="string"&&l.type.kind!=="value"&&u.type.kind!=="value")return o.error("Cannot use collator to compare non-string types.");if(h=o.parse(s[3],3,To),!h)return null}return new mp(l,u,h)}evaluate(s){const o=this.lhs.evaluate(s),a=this.rhs.evaluate(s);if(r&&this.hasUntypedArgument){const l=Ze(o),u=Ze(a);if(l.kind!==u.kind||!(l.kind==="string"||l.kind==="number"))throw new ze(`Expected arguments for "${n}" to be (string, string) or (number, number), but found (${l.kind}, ${u.kind}) instead.`)}if(this.collator&&!r&&this.hasUntypedArgument){const l=Ze(o),u=Ze(a);if(l.kind!=="string"||u.kind!=="string")return e(s,o,a)}return this.collator?t(s,o,a,this.collator.evaluate(s)):e(s,o,a)}eachChild(s){s(this.lhs),s(this.rhs),this.collator&&s(this.collator)}outputDefined(){return!0}}}const v1=qn("==",f1,gp),T1=qn("!=",d1,_1),S1=qn("<",p1,b1),R1=qn(">",g1,x1),P1=qn("<=",m1,E1),A1=qn(">=",y1,w1);class Mo{constructor(e,t,r){this.type=To,this.locale=r,this.caseSensitive=e,this.diacriticSensitive=t}static parse(e,t){if(e.length!==2)return t.error("Expected one argument.");const r=e[1];if(typeof r!="object"||Array.isArray(r))return t.error("Collator options argument must be an object.");const i=t.parse(r["case-sensitive"]===void 0?!1:r["case-sensitive"],1,re);if(!i)return null;const s=t.parse(r["diacritic-sensitive"]===void 0?!1:r["diacritic-sensitive"],1,re);if(!s)return null;let o=null;return r.locale&&(o=t.parse(r.locale,1,se),!o)?null:new Mo(i,s,o)}evaluate(e){return new _u(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}}class vu{constructor(e,t,r,i,s){this.type=se,this.number=e,this.locale=t,this.currency=r,this.minFractionDigits=i,this.maxFractionDigits=s}static parse(e,t){if(e.length!==3)return t.error("Expected two arguments.");const r=t.parse(e[1],1,U);if(!r)return null;const i=e[2];if(typeof i!="object"||Array.isArray(i))return t.error("NumberFormat options argument must be an object.");let s=null;if(i.locale&&(s=t.parse(i.locale,1,se),!s))return null;let o=null;if(i.currency&&(o=t.parse(i.currency,1,se),!o))return null;let a=null;if(i["min-fraction-digits"]&&(a=t.parse(i["min-fraction-digits"],1,U),!a))return null;let l=null;return i["max-fraction-digits"]&&(l=t.parse(i["max-fraction-digits"],1,U),!l)?null:new vu(r,s,o,a,l)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}}class Tu{constructor(e){this.type=So,this.sections=e}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");const r=e[1];if(!Array.isArray(r)&&typeof r=="object")return t.error("First argument must be an image or text section.");const i=[];let s=!1;for(let o=1;o<=e.length-1;++o){const a=e[o];if(s&&typeof a=="object"&&!Array.isArray(a)){s=!1;let l=null;if(a["font-scale"]&&(l=t.parse(a["font-scale"],1,U),!l))return null;let u=null;if(a["text-font"]&&(u=t.parse(a["text-font"],1,Et(se)),!u))return null;let h=null;if(a["text-color"]&&(h=t.parse(a["text-color"],1,ir),!h))return null;let c=null;if(a["vertical-align"]){if(typeof a["vertical-align"]=="string"&&!s1.includes(a["vertical-align"]))return t.error(`'vertical-align' must be one of: 'bottom', 'center', 'top' but found '${a["vertical-align"]}' instead.`);if(c=t.parse(a["vertical-align"],1,se),!c)return null}const f=i[i.length-1];f.scale=l,f.font=u,f.textColor=h,f.verticalAlign=c}else{const l=t.parse(e[o],1,J);if(!l)return null;const u=l.type.kind;if(u!=="string"&&u!=="value"&&u!=="null"&&u!=="resolvedImage")return t.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");s=!0,i.push({content:l,scale:null,font:null,textColor:null,verticalAlign:null})}}return new Tu(i)}evaluate(e){const t=r=>{const i=r.content.evaluate(e);return Ze(i)===qi?new ja("",i,null,null,null,r.verticalAlign?r.verticalAlign.evaluate(e):null):new ja(di(i),null,r.scale?r.scale.evaluate(e):null,r.font?r.font.evaluate(e).join(","):null,r.textColor?r.textColor.evaluate(e):null,r.verticalAlign?r.verticalAlign.evaluate(e):null)};return new mr(this.sections.map(t))}eachChild(e){for(const t of this.sections)e(t.content),t.scale&&e(t.scale),t.font&&e(t.font),t.textColor&&e(t.textColor),t.verticalAlign&&e(t.verticalAlign)}outputDefined(){return!1}}class Su{constructor(e){this.type=qi,this.input=e}static parse(e,t){if(e.length!==2)return t.error("Expected two arguments.");const r=t.parse(e[1],1,se);return r?new Su(r):t.error("No image name provided.")}evaluate(e){const t=this.input.evaluate(e),r=Vr.fromString(t);return r&&e.availableImages&&(r.available=e.availableImages.indexOf(t)>-1),r}eachChild(e){e(this.input)}outputDefined(){return!1}}class Ru{constructor(e){this.type=U,this.input=e}static parse(e,t){if(e.length!==2)return t.error(`Expected 1 argument, but found ${e.length-1} instead.`);const r=t.parse(e[1],1);return r?r.type.kind!=="array"&&r.type.kind!=="string"&&r.type.kind!=="value"?t.error(`Expected argument of type string or array, but found ${Be(r.type)} instead.`):new Ru(r):null}evaluate(e){const t=this.input.evaluate(e);if(typeof t=="string")return[...t].length;if(Array.isArray(t))return t.length;throw new ze(`Expected value to be of type string or array, but found ${Be(Ze(t))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}}const ar=8192;function I1(n,e){const t=C1(n[0]),r=F1(n[1]),i=Math.pow(2,e.z);return[Math.round(t*i*ar),Math.round(r*i*ar)]}function Pu(n,e){const t=Math.pow(2,e.z),r=(n[0]/ar+e.x)/t,i=(n[1]/ar+e.y)/t;return[L1(r),M1(i)]}function C1(n){return(180+n)/360}function L1(n){return n*360-180}function F1(n){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+n*Math.PI/360)))/360}function M1(n){return 360/Math.PI*Math.atan(Math.exp((180-n*360)*Math.PI/180))-90}function Hi(n,e){n[0]=Math.min(n[0],e[0]),n[1]=Math.min(n[1],e[1]),n[2]=Math.max(n[2],e[0]),n[3]=Math.max(n[3],e[1])}function Ci(n,e){return!(n[0]<=e[0]||n[2]>=e[2]||n[1]<=e[1]||n[3]>=e[3])}function O1(n,e,t){return e[1]>n[1]!=t[1]>n[1]&&n[0]<(t[0]-e[0])*(n[1]-e[1])/(t[1]-e[1])+e[0]}function N1(n,e,t){const r=n[0]-e[0],i=n[1]-e[1],s=n[0]-t[0],o=n[1]-t[1];return r*o-s*i===0&&r*s<=0&&i*o<=0}function Oo(n,e,t,r){const i=[e[0]-n[0],e[1]-n[1]],s=[r[0]-t[0],r[1]-t[1]];return G1(s,i)===0?!1:!!(ah(n,e,t,r)&&ah(t,r,n,e))}function D1(n,e,t){for(const r of t)for(let i=0;i<r.length-1;++i)if(Oo(n,e,r[i],r[i+1]))return!0;return!1}function Hn(n,e,t=!1){let r=!1;for(const i of e)for(let s=0;s<i.length-1;s++){if(N1(n,i[s],i[s+1]))return t;O1(n,i[s],i[s+1])&&(r=!r)}return r}function U1(n,e){for(const t of e)if(Hn(n,t))return!0;return!1}function yp(n,e){for(const t of n)if(!Hn(t,e))return!1;for(let t=0;t<n.length-1;++t)if(D1(n[t],n[t+1],e))return!1;return!0}function B1(n,e){for(const t of e)if(yp(n,t))return!0;return!1}function G1(n,e){return n[0]*e[1]-n[1]*e[0]}function ah(n,e,t,r){const i=n[0]-t[0],s=n[1]-t[1],o=e[0]-t[0],a=e[1]-t[1],l=r[0]-t[0],u=r[1]-t[1],h=i*u-l*s,c=o*u-l*a;return h>0&&c<0||h<0&&c>0}function Au(n,e,t){const r=[];for(let i=0;i<n.length;i++){const s=[];for(let o=0;o<n[i].length;o++){const a=I1(n[i][o],t);Hi(e,a),s.push(a)}r.push(s)}return r}function _p(n,e,t){const r=[];for(let i=0;i<n.length;i++){const s=Au(n[i],e,t);r.push(s)}return r}function bp(n,e,t,r){if(n[0]<t[0]||n[0]>t[2]){const i=r*.5;let s=n[0]-t[0]>i?-r:t[0]-n[0]>i?r:0;s===0&&(s=n[0]-t[2]>i?-r:t[2]-n[0]>i?r:0),n[0]+=s}Hi(e,n)}function z1(n){n[0]=n[1]=1/0,n[2]=n[3]=-1/0}function lh(n,e,t,r){const i=Math.pow(2,r.z)*ar,s=[r.x*ar,r.y*ar],o=[];for(const a of n)for(const l of a){const u=[l.x+s[0],l.y+s[1]];bp(u,e,t,i),o.push(u)}return o}function uh(n,e,t,r){const i=Math.pow(2,r.z)*ar,s=[r.x*ar,r.y*ar],o=[];for(const a of n){const l=[];for(const u of a){const h=[u.x+s[0],u.y+s[1]];Hi(e,h),l.push(h)}o.push(l)}if(e[2]-e[0]<=i/2){z1(e);for(const a of o)for(const l of a)bp(l,e,t,i)}return o}function k1(n,e){const t=[1/0,1/0,-1/0,-1/0],r=[1/0,1/0,-1/0,-1/0],i=n.canonicalID();if(e.type==="Polygon"){const s=Au(e.coordinates,r,i),o=lh(n.geometry(),t,r,i);if(!Ci(t,r))return!1;for(const a of o)if(!Hn(a,s))return!1}if(e.type==="MultiPolygon"){const s=_p(e.coordinates,r,i),o=lh(n.geometry(),t,r,i);if(!Ci(t,r))return!1;for(const a of o)if(!U1(a,s))return!1}return!0}function $1(n,e){const t=[1/0,1/0,-1/0,-1/0],r=[1/0,1/0,-1/0,-1/0],i=n.canonicalID();if(e.type==="Polygon"){const s=Au(e.coordinates,r,i),o=uh(n.geometry(),t,r,i);if(!Ci(t,r))return!1;for(const a of o)if(!yp(a,s))return!1}if(e.type==="MultiPolygon"){const s=_p(e.coordinates,r,i),o=uh(n.geometry(),t,r,i);if(!Ci(t,r))return!1;for(const a of o)if(!B1(a,s))return!1}return!0}class rn{constructor(e,t){this.type=re,this.geojson=e,this.geometries=t}static parse(e,t){if(e.length!==2)return t.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(Ai(e[1])){const r=e[1];if(r.type==="FeatureCollection"){const i=[];for(const s of r.features){const{type:o,coordinates:a}=s.geometry;o==="Polygon"&&i.push(a),o==="MultiPolygon"&&i.push(...a)}if(i.length){const s={type:"MultiPolygon",coordinates:i};return new rn(r,s)}}else if(r.type==="Feature"){const i=r.geometry.type;if(i==="Polygon"||i==="MultiPolygon")return new rn(r,r.geometry)}else if(r.type==="Polygon"||r.type==="MultiPolygon")return new rn(r,r)}return t.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return k1(e,this.geometries);if(e.geometryType()==="LineString")return $1(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}class xp{constructor(e=[],t=(r,i)=>r<i?-1:r>i?1:0){if(this.data=e,this.length=this.data.length,this.compare=t,this.length>0)for(let r=(this.length>>1)-1;r>=0;r--)this._down(r)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(this.length===0)return;const e=this.data[0],t=this.data.pop();return--this.length>0&&(this.data[0]=t,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:t,compare:r}=this,i=t[e];for(;e>0;){const s=e-1>>1,o=t[s];if(r(i,o)>=0)break;t[e]=o,e=s}t[e]=i}_down(e){const{data:t,compare:r}=this,i=this.length>>1,s=t[e];for(;e<i;){let o=(e<<1)+1;const a=o+1;if(a<this.length&&r(t[a],t[o])<0&&(o=a),r(t[o],s)>=0)break;t[e]=t[o],e=o}t[e]=s}}function j1(n,e){if(n.length<=1)return[n];const r=[];let i,s;for(const o of n){const a=V1(o);a!==0&&(o.area=Math.abs(a),s===void 0&&(s=a<0),s===a<0?(i&&r.push(i),i=[o]):i.push(o))}return i&&r.push(i),r}function V1(n){let e=0;for(let t=0,r=n.length,i=r-1,s,o;t<r;i=t++)s=n[t],o=n[i],e+=(o.x-s.x)*(s.y+o.y);return e}const X1=6378.137,ch=1/298.257223563,hh=ch*(2-ch),fh=Math.PI/180;class Iu{constructor(e){const t=fh*X1*1e3,r=Math.cos(e*fh),i=1/(1-hh*(1-r*r)),s=Math.sqrt(i);this.kx=t*s*r,this.ky=t*s*i*(1-hh)}distance(e,t){const r=this.wrap(e[0]-t[0])*this.kx,i=(e[1]-t[1])*this.ky;return Math.sqrt(r*r+i*i)}pointOnLine(e,t){let r=1/0,i,s,o,a;for(let l=0;l<e.length-1;l++){let u=e[l][0],h=e[l][1],c=this.wrap(e[l+1][0]-u)*this.kx,f=(e[l+1][1]-h)*this.ky,p=0;(c!==0||f!==0)&&(p=(this.wrap(t[0]-u)*this.kx*c+(t[1]-h)*this.ky*f)/(c*c+f*f),p>1?(u=e[l+1][0],h=e[l+1][1]):p>0&&(u+=c/this.kx*p,h+=f/this.ky*p)),c=this.wrap(t[0]-u)*this.kx,f=(t[1]-h)*this.ky;const d=c*c+f*f;d<r&&(r=d,i=u,s=h,o=l,a=p)}return{point:[i,s],index:o,t:Math.max(0,Math.min(1,a))}}wrap(e){for(;e<-180;)e+=360;for(;e>180;)e-=360;return e}}const Va=100,Xa=50;function Ep(n,e){return e[0]-n[0]}function $s(n){return n[1]-n[0]+1}function xr(n,e){return n[1]>=n[0]&&n[1]<e}function Wa(n,e){if(n[0]>n[1])return[null,null];const t=$s(n);if(e){if(t===2)return[n,null];const i=Math.floor(t/2);return[[n[0],n[0]+i],[n[0]+i,n[1]]]}if(t===1)return[n,null];const r=Math.floor(t/2)-1;return[[n[0],n[0]+r],[n[0]+r+1,n[1]]]}function Za(n,e){if(!xr(e,n.length))return[1/0,1/0,-1/0,-1/0];const t=[1/0,1/0,-1/0,-1/0];for(let r=e[0];r<=e[1];++r)Hi(t,n[r]);return t}function qa(n){const e=[1/0,1/0,-1/0,-1/0];for(const t of n)for(const r of t)Hi(e,r);return e}function dh(n){return n[0]!==-1/0&&n[1]!==-1/0&&n[2]!==1/0&&n[3]!==1/0}function Cu(n,e,t){if(!dh(n)||!dh(e))return NaN;let r=0,i=0;return n[2]<e[0]&&(r=e[0]-n[2]),n[0]>e[2]&&(r=n[0]-e[2]),n[1]>e[3]&&(i=n[1]-e[3]),n[3]<e[1]&&(i=e[1]-n[3]),t.distance([0,0],[r,i])}function Jr(n,e,t){const r=t.pointOnLine(e,n);return t.distance(n,r.point)}function Lu(n,e,t,r,i){const s=Math.min(Jr(n,[t,r],i),Jr(e,[t,r],i)),o=Math.min(Jr(t,[n,e],i),Jr(r,[n,e],i));return Math.min(s,o)}function W1(n,e,t,r,i){if(!(xr(e,n.length)&&xr(r,t.length)))return 1/0;let o=1/0;for(let a=e[0];a<e[1];++a){const l=n[a],u=n[a+1];for(let h=r[0];h<r[1];++h){const c=t[h],f=t[h+1];if(Oo(l,u,c,f))return 0;o=Math.min(o,Lu(l,u,c,f,i))}}return o}function Z1(n,e,t,r,i){if(!(xr(e,n.length)&&xr(r,t.length)))return NaN;let o=1/0;for(let a=e[0];a<=e[1];++a)for(let l=r[0];l<=r[1];++l)if(o=Math.min(o,i.distance(n[a],t[l])),o===0)return o;return o}function q1(n,e,t){if(Hn(n,e,!0))return 0;let r=1/0;for(const i of e){const s=i[0],o=i[i.length-1];if(s!==o&&(r=Math.min(r,Jr(n,[o,s],t)),r===0))return r;const a=t.pointOnLine(i,n);if(r=Math.min(r,t.distance(n,a.point)),r===0)return r}return r}function H1(n,e,t,r){if(!xr(e,n.length))return NaN;for(let s=e[0];s<=e[1];++s)if(Hn(n[s],t,!0))return 0;let i=1/0;for(let s=e[0];s<e[1];++s){const o=n[s],a=n[s+1];for(const l of t)for(let u=0,h=l.length,c=h-1;u<h;c=u++){const f=l[c],p=l[u];if(Oo(o,a,f,p))return 0;i=Math.min(i,Lu(o,a,f,p,r))}}return i}function ph(n,e){for(const t of n)for(const r of t)if(Hn(r,e,!0))return!0;return!1}function Y1(n,e,t,r=1/0){const i=qa(n),s=qa(e);if(r!==1/0&&Cu(i,s,t)>=r)return r;if(Ci(i,s)){if(ph(n,e))return 0}else if(ph(e,n))return 0;let o=1/0;for(const a of n)for(let l=0,u=a.length,h=u-1;l<u;h=l++){const c=a[h],f=a[l];for(const p of e)for(let d=0,g=p.length,m=g-1;d<g;m=d++){const _=p[m],y=p[d];if(Oo(c,f,_,y))return 0;o=Math.min(o,Lu(c,f,_,y,t))}}return o}function gh(n,e,t,r,i,s){if(!s)return;const o=Cu(Za(r,s),i,t);o<e&&n.push([o,s,[0,0]])}function us(n,e,t,r,i,s,o){if(!s||!o)return;const a=Cu(Za(r,s),Za(i,o),t);a<e&&n.push([a,s,o])}function js(n,e,t,r,i=1/0){let s=Math.min(r.distance(n[0],t[0][0]),i);if(s===0)return s;const o=new xp([[0,[0,n.length-1],[0,0]]],Ep),a=qa(t);for(;o.length>0;){const l=o.pop();if(l[0]>=s)continue;const u=l[1],h=e?Xa:Va;if($s(u)<=h){if(!xr(u,n.length))return NaN;if(e){const c=H1(n,u,t,r);if(isNaN(c)||c===0)return c;s=Math.min(s,c)}else for(let c=u[0];c<=u[1];++c){const f=q1(n[c],t,r);if(s=Math.min(s,f),s===0)return 0}}else{const c=Wa(u,e);gh(o,s,r,n,a,c[0]),gh(o,s,r,n,a,c[1])}}return s}function Vs(n,e,t,r,i,s=1/0){let o=Math.min(s,i.distance(n[0],t[0]));if(o===0)return o;const a=new xp([[0,[0,n.length-1],[0,t.length-1]]],Ep);for(;a.length>0;){const l=a.pop();if(l[0]>=o)continue;const u=l[1],h=l[2],c=e?Xa:Va,f=r?Xa:Va;if($s(u)<=c&&$s(h)<=f){if(!xr(u,n.length)&&xr(h,t.length))return NaN;let p;if(e&&r)p=W1(n,u,t,h,i),o=Math.min(o,p);else if(e&&!r){const d=n.slice(u[0],u[1]+1);for(let g=h[0];g<=h[1];++g)if(p=Jr(t[g],d,i),o=Math.min(o,p),o===0)return o}else if(!e&&r){const d=t.slice(h[0],h[1]+1);for(let g=u[0];g<=u[1];++g)if(p=Jr(n[g],d,i),o=Math.min(o,p),o===0)return o}else p=Z1(n,u,t,h,i),o=Math.min(o,p)}else{const p=Wa(u,e),d=Wa(h,r);us(a,o,i,n,t,p[0],d[0]),us(a,o,i,n,t,p[0],d[1]),us(a,o,i,n,t,p[1],d[0]),us(a,o,i,n,t,p[1],d[1])}}return o}function K1(n,e){const t=n.geometry(),r=t.flat().map(o=>Pu([o.x,o.y],n.canonical));if(t.length===0)return NaN;const i=new Iu(r[0][1]);let s=1/0;for(const o of e){switch(o.type){case"Point":s=Math.min(s,Vs(r,!1,[o.coordinates],!1,i,s));break;case"LineString":s=Math.min(s,Vs(r,!1,o.coordinates,!0,i,s));break;case"Polygon":s=Math.min(s,js(r,!1,o.coordinates,i,s));break}if(s===0)return s}return s}function J1(n,e){const t=n.geometry(),r=t.flat().map(o=>Pu([o.x,o.y],n.canonical));if(t.length===0)return NaN;const i=new Iu(r[0][1]);let s=1/0;for(const o of e){switch(o.type){case"Point":s=Math.min(s,Vs(r,!0,[o.coordinates],!1,i,s));break;case"LineString":s=Math.min(s,Vs(r,!0,o.coordinates,!0,i,s));break;case"Polygon":s=Math.min(s,js(r,!0,o.coordinates,i,s));break}if(s===0)return s}return s}function Q1(n,e){const t=n.geometry();if(t.length===0||t[0].length===0)return NaN;const r=j1(t).map(o=>o.map(a=>a.map(l=>Pu([l.x,l.y],n.canonical)))),i=new Iu(r[0][0][0][1]);let s=1/0;for(const o of e)for(const a of r){switch(o.type){case"Point":s=Math.min(s,js([o.coordinates],!1,a,i,s));break;case"LineString":s=Math.min(s,js(o.coordinates,!0,a,i,s));break;case"Polygon":s=Math.min(s,Y1(a,o.coordinates,i,s));break}if(s===0)return s}return s}function ha(n){return n.type==="MultiPolygon"?n.coordinates.map(e=>({type:"Polygon",coordinates:e})):n.type==="MultiLineString"?n.coordinates.map(e=>({type:"LineString",coordinates:e})):n.type==="MultiPoint"?n.coordinates.map(e=>({type:"Point",coordinates:e})):[n]}class nn{constructor(e,t){this.type=U,this.geojson=e,this.geometries=t}static parse(e,t){if(e.length!==2)return t.error(`'distance' expression requires exactly one argument, but found ${e.length-1} instead.`);if(Ai(e[1])){const r=e[1];if(r.type==="FeatureCollection")return new nn(r,r.features.map(i=>ha(i.geometry)).flat());if(r.type==="Feature")return new nn(r,ha(r.geometry));if("type"in r&&"coordinates"in r)return new nn(r,ha(r))}return t.error("'distance' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return K1(e,this.geometries);if(e.geometryType()==="LineString")return J1(e,this.geometries);if(e.geometryType()==="Polygon")return Q1(e,this.geometries)}return NaN}eachChild(){}outputDefined(){return!0}}class Yi{constructor(e){this.type=J,this.key=e}static parse(e,t){if(e.length!==2)return t.error(`Expected 1 argument, but found ${e.length-1} instead.`);const r=e[1];return r==null?t.error("Global state property must be defined."):typeof r!="string"?t.error(`Global state property must be string, but found ${typeof e[1]} instead.`):new Yi(r)}evaluate(e){var t;const r=(t=e.globals)===null||t===void 0?void 0:t.globalState;return!r||Object.keys(r).length===0?null:hp(r,this.key)}eachChild(){}outputDefined(){return!1}}const No={"==":v1,"!=":T1,">":R1,"<":S1,">=":A1,"<=":P1,array:Bt,at:bu,boolean:Bt,case:wu,coalesce:Ii,collator:Mo,format:Tu,image:Su,in:xu,"index-of":zs,interpolate:or,"interpolate-hcl":or,"interpolate-lab":or,length:Ru,let:Co,literal:Un,match:Eu,number:Bt,"number-format":vu,object:Bt,slice:ks,step:Fo,string:Bt,"to-boolean":Or,"to-color":Or,"to-number":Or,"to-string":Or,var:Lo,within:rn,distance:nn,"global-state":Yi};class vt{constructor(e,t,r,i){this.name=e,this.type=t,this._evaluate=r,this.args=i}evaluate(e){return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}static parse(e,t){const r=e[0],i=vt.definitions[r];if(!i)return t.error(`Unknown expression "${r}". If you wanted a literal array, use ["literal", [...]].`,0);const s=Array.isArray(i)?i[0]:i.type,o=Array.isArray(i)?[[i[1],i[2]]]:i.overloads,a=o.filter(([u])=>!Array.isArray(u)||u.length===e.length-1);let l=null;for(const[u,h]of a){l=new Io(t.registry,Xs,t.path,null,t.scope);const c=[];let f=!1;for(let p=1;p<e.length;p++){const d=e[p],g=Array.isArray(u)?u[p-1]:u.type,m=l.parse(d,1+c.length,g);if(!m){f=!0;break}c.push(m)}if(!f){if(Array.isArray(u)&&u.length!==c.length){l.error(`Expected ${u.length} arguments, but found ${c.length} instead.`);continue}for(let p=0;p<c.length;p++){const d=Array.isArray(u)?u[p]:u.type,g=c[p];l.concat(p+1).checkSubtype(d,g.type)}if(l.errors.length===0)return new vt(r,s,h,c)}}if(a.length===1)t.errors.push(...l.errors);else{const h=(a.length?a:o).map(([f])=>tT(f)).join(" | "),c=[];for(let f=1;f<e.length;f++){const p=t.parse(e[f],1+c.length);if(!p)return null;c.push(Be(p.type))}t.error(`Expected arguments of type ${h}, but found (${c.join(", ")}) instead.`)}return null}static register(e,t){vt.definitions=t;for(const r in t)e[r]=vt}}function mh(n,[e,t,r,i]){e=e.evaluate(n),t=t.evaluate(n),r=r.evaluate(n);const s=i?i.evaluate(n):1,o=fp(e,t,r,s);if(o)throw new ze(o);return new Se(e/255,t/255,r/255,s,!1)}function yh(n,e){return n in e}function fa(n,e){const t=e[n];return typeof t>"u"?null:t}function eT(n,e,t,r){for(;t<=r;){const i=t+r>>1;if(e[i]===n)return!0;e[i]>n?r=i-1:t=i+1}return!1}function Wr(n){return{type:n}}vt.register(No,{error:[qv,[se],(n,[e])=>{throw new ze(e.evaluate(n))}],typeof:[se,[J],(n,[e])=>Be(Ze(e.evaluate(n)))],"to-rgba":[Et(U,4),[ir],(n,[e])=>{const[t,r,i,s]=e.evaluate(n).rgb;return[t*255,r*255,i*255,s]}],rgb:[ir,[U,U,U],mh],rgba:[ir,[U,U,U,U],mh],has:{type:re,overloads:[[[se],(n,[e])=>yh(e.evaluate(n),n.properties())],[[se,Qr],(n,[e,t])=>yh(e.evaluate(n),t.evaluate(n))]]},get:{type:J,overloads:[[[se],(n,[e])=>fa(e.evaluate(n),n.properties())],[[se,Qr],(n,[e,t])=>fa(e.evaluate(n),t.evaluate(n))]]},"feature-state":[J,[se],(n,[e])=>fa(e.evaluate(n),n.featureState||{})],properties:[Qr,[],n=>n.properties()],"geometry-type":[se,[],n=>n.geometryType()],id:[J,[],n=>n.id()],zoom:[U,[],n=>n.globals.zoom],"heatmap-density":[U,[],n=>n.globals.heatmapDensity||0],elevation:[U,[],n=>n.globals.elevation||0],"line-progress":[U,[],n=>n.globals.lineProgress||0],accumulated:[J,[],n=>n.globals.accumulated===void 0?null:n.globals.accumulated],"+":[U,Wr(U),(n,e)=>{let t=0;for(const r of e)t+=r.evaluate(n);return t}],"*":[U,Wr(U),(n,e)=>{let t=1;for(const r of e)t*=r.evaluate(n);return t}],"-":{type:U,overloads:[[[U,U],(n,[e,t])=>e.evaluate(n)-t.evaluate(n)],[[U],(n,[e])=>-e.evaluate(n)]]},"/":[U,[U,U],(n,[e,t])=>e.evaluate(n)/t.evaluate(n)],"%":[U,[U,U],(n,[e,t])=>e.evaluate(n)%t.evaluate(n)],ln2:[U,[],()=>Math.LN2],pi:[U,[],()=>Math.PI],e:[U,[],()=>Math.E],"^":[U,[U,U],(n,[e,t])=>Math.pow(e.evaluate(n),t.evaluate(n))],sqrt:[U,[U],(n,[e])=>Math.sqrt(e.evaluate(n))],log10:[U,[U],(n,[e])=>Math.log(e.evaluate(n))/Math.LN10],ln:[U,[U],(n,[e])=>Math.log(e.evaluate(n))],log2:[U,[U],(n,[e])=>Math.log(e.evaluate(n))/Math.LN2],sin:[U,[U],(n,[e])=>Math.sin(e.evaluate(n))],cos:[U,[U],(n,[e])=>Math.cos(e.evaluate(n))],tan:[U,[U],(n,[e])=>Math.tan(e.evaluate(n))],asin:[U,[U],(n,[e])=>Math.asin(e.evaluate(n))],acos:[U,[U],(n,[e])=>Math.acos(e.evaluate(n))],atan:[U,[U],(n,[e])=>Math.atan(e.evaluate(n))],min:[U,Wr(U),(n,e)=>Math.min(...e.map(t=>t.evaluate(n)))],max:[U,Wr(U),(n,e)=>Math.max(...e.map(t=>t.evaluate(n)))],abs:[U,[U],(n,[e])=>Math.abs(e.evaluate(n))],round:[U,[U],(n,[e])=>{const t=e.evaluate(n);return t<0?-Math.round(-t):Math.round(t)}],floor:[U,[U],(n,[e])=>Math.floor(e.evaluate(n))],ceil:[U,[U],(n,[e])=>Math.ceil(e.evaluate(n))],"filter-==":[re,[se,J],(n,[e,t])=>n.properties()[e.value]===t.value],"filter-id-==":[re,[J],(n,[e])=>n.id()===e.value],"filter-type-==":[re,[se],(n,[e])=>n.geometryType()===e.value],"filter-<":[re,[se,J],(n,[e,t])=>{const r=n.properties()[e.value],i=t.value;return typeof r==typeof i&&r<i}],"filter-id-<":[re,[J],(n,[e])=>{const t=n.id(),r=e.value;return typeof t==typeof r&&t<r}],"filter->":[re,[se,J],(n,[e,t])=>{const r=n.properties()[e.value],i=t.value;return typeof r==typeof i&&r>i}],"filter-id->":[re,[J],(n,[e])=>{const t=n.id(),r=e.value;return typeof t==typeof r&&t>r}],"filter-<=":[re,[se,J],(n,[e,t])=>{const r=n.properties()[e.value],i=t.value;return typeof r==typeof i&&r<=i}],"filter-id-<=":[re,[J],(n,[e])=>{const t=n.id(),r=e.value;return typeof t==typeof r&&t<=r}],"filter->=":[re,[se,J],(n,[e,t])=>{const r=n.properties()[e.value],i=t.value;return typeof r==typeof i&&r>=i}],"filter-id->=":[re,[J],(n,[e])=>{const t=n.id(),r=e.value;return typeof t==typeof r&&t>=r}],"filter-has":[re,[J],(n,[e])=>e.value in n.properties()],"filter-has-id":[re,[],n=>n.id()!==null&&n.id()!==void 0],"filter-type-in":[re,[Et(se)],(n,[e])=>e.value.indexOf(n.geometryType())>=0],"filter-id-in":[re,[Et(J)],(n,[e])=>e.value.indexOf(n.id())>=0],"filter-in-small":[re,[se,Et(J)],(n,[e,t])=>t.value.indexOf(n.properties()[e.value])>=0],"filter-in-large":[re,[se,Et(J)],(n,[e,t])=>eT(n.properties()[e.value],t.value,0,t.value.length-1)],all:{type:re,overloads:[[[re,re],(n,[e,t])=>e.evaluate(n)&&t.evaluate(n)],[Wr(re),(n,e)=>{for(const t of e)if(!t.evaluate(n))return!1;return!0}]]},any:{type:re,overloads:[[[re,re],(n,[e,t])=>e.evaluate(n)||t.evaluate(n)],[Wr(re),(n,e)=>{for(const t of e)if(t.evaluate(n))return!0;return!1}]]},"!":[re,[re],(n,[e])=>!e.evaluate(n)],"is-supported-script":[re,[se],(n,[e])=>{const t=n.globals&&n.globals.isSupportedScript;return t?t(e.evaluate(n)):!0}],upcase:[se,[se],(n,[e])=>e.evaluate(n).toUpperCase()],downcase:[se,[se],(n,[e])=>e.evaluate(n).toLowerCase()],concat:[se,Wr(J),(n,e)=>e.map(t=>di(t.evaluate(n))).join("")],"resolved-locale":[se,[To],(n,[e])=>e.evaluate(n).resolvedLocale()]});function tT(n){return Array.isArray(n)?`(${n.map(Be).join(", ")})`:`(${Be(n.type)}...)`}function Xs(n){if(n instanceof Lo)return Xs(n.boundExpression);if(n instanceof vt&&n.name==="error")return!1;if(n instanceof Mo)return!1;if(n instanceof rn)return!1;if(n instanceof nn)return!1;if(n instanceof Yi)return!1;const e=n instanceof Or||n instanceof Bt;let t=!0;return n.eachChild(r=>{e?t=t&&Xs(r):t=t&&r instanceof Un}),t?Fu(n)&&Ou(n,["zoom","heatmap-density","elevation","line-progress","accumulated","is-supported-script"]):!1}function Fu(n){if(n instanceof vt){if(n.name==="get"&&n.args.length===1)return!1;if(n.name==="feature-state")return!1;if(n.name==="has"&&n.args.length===1)return!1;if(n.name==="properties"||n.name==="geometry-type"||n.name==="id")return!1;if(/^filter-/.test(n.name))return!1}if(n instanceof rn||n instanceof nn)return!1;let e=!0;return n.eachChild(t=>{e&&!Fu(t)&&(e=!1)}),e}function Mu(n){if(n instanceof vt&&n.name==="feature-state")return!1;let e=!0;return n.eachChild(t=>{e&&!Mu(t)&&(e=!1)}),e}function Ou(n,e){if(n instanceof vt&&e.indexOf(n.name)>=0)return!1;let t=!0;return n.eachChild(r=>{t&&!Ou(r,e)&&(t=!1)}),t}function Ha(n){return{result:"success",value:n}}function wn(n){return{result:"error",value:n}}function rT(n){return n["property-type"]==="data-driven"||n["property-type"]==="cross-faded-data-driven"}function nT(n){return!!n.expression&&n.expression.parameters.indexOf("zoom")>-1}function iT(n){return!!n.expression&&n.expression.interpolated}function wp(n){return typeof n=="object"&&n!==null&&!Array.isArray(n)&&Ze(n)===Qr}class sT{constructor(e,t){this.expression=e,this._warningHistory={},this._evaluator=new dp,this._defaultValue=t?uT(t):null,this._enumValues=t&&t.type==="enum"?t.values:null}evaluateWithoutErrorHandling(e,t,r,i,s,o){return this._evaluator.globals=e,this._evaluator.feature=t,this._evaluator.featureState=r,this._evaluator.canonical=i,this._evaluator.availableImages=s||null,this._evaluator.formattedSection=o,this.expression.evaluate(this._evaluator)}evaluate(e,t,r,i,s,o){this._evaluator.globals=e,this._evaluator.feature=t||null,this._evaluator.featureState=r||null,this._evaluator.canonical=i,this._evaluator.availableImages=s||null,this._evaluator.formattedSection=o||null;try{const a=this.expression.evaluate(this._evaluator);if(a==null||typeof a=="number"&&a!==a)return this._defaultValue;if(this._enumValues&&!(a in this._enumValues))throw new ze(`Expected value to be one of ${Object.keys(this._enumValues).map(l=>JSON.stringify(l)).join(", ")}, but found ${JSON.stringify(a)} instead.`);return a}catch(a){return this._warningHistory[a.message]||(this._warningHistory[a.message]=!0,typeof console<"u"&&console.warn(a.message)),this._defaultValue}}}function oT(n){return Array.isArray(n)&&n.length>0&&typeof n[0]=="string"&&n[0]in No}function vp(n,e){const t=new Io(No,Xs,[],e?lT(e):void 0),r=t.parse(n,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return r?Ha(new sT(r,e)):wn(t.errors)}class _h{constructor(e,t){this.kind=e,this._styleExpression=t,this.isStateDependent=e!=="constant"&&!Mu(t.expression),this.globalStateRefs=Do(t.expression)}evaluateWithoutErrorHandling(e,t,r,i,s,o){return this._styleExpression.evaluateWithoutErrorHandling(e,t,r,i,s,o)}evaluate(e,t,r,i,s,o){return this._styleExpression.evaluate(e,t,r,i,s,o)}}class bh{constructor(e,t,r,i){this.kind=e,this.zoomStops=r,this._styleExpression=t,this.isStateDependent=e!=="camera"&&!Mu(t.expression),this.globalStateRefs=Do(t.expression),this.interpolationType=i}evaluateWithoutErrorHandling(e,t,r,i,s,o){return this._styleExpression.evaluateWithoutErrorHandling(e,t,r,i,s,o)}evaluate(e,t,r,i,s,o){return this._styleExpression.evaluate(e,t,r,i,s,o)}interpolationFactor(e,t,r){return this.interpolationType?or.interpolationFactor(this.interpolationType,e,t,r):0}}function aT(n,e){const t=vp(n,e);if(t.result==="error")return t;const r=t.value.expression,i=Fu(r);if(!i&&!rT(e))return wn([new tr("","data expressions not supported")]);const s=Ou(r,["zoom"]);if(!s&&!nT(e))return wn([new tr("","zoom expressions not supported")]);const o=ms(r);if(!o&&!s)return wn([new tr("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')]);if(o instanceof tr)return wn([o]);if(o instanceof or&&!iT(e))return wn([new tr("",'"interpolate" expressions cannot be used with this property')]);if(!o)return Ha(i?new _h("constant",t.value):new _h("source",t.value));const a=o instanceof or?o.interpolation:void 0;return Ha(i?new bh("camera",t.value,o.labels,a):new bh("composite",t.value,o.labels,a))}function ms(n){let e=null;if(n instanceof Co)e=ms(n.result);else if(n instanceof Ii){for(const t of n.args)if(e=ms(t),e)break}else(n instanceof Fo||n instanceof or)&&n.input instanceof vt&&n.input.name==="zoom"&&(e=n);return e instanceof tr||n.eachChild(t=>{const r=ms(t);r instanceof tr?e=r:!e&&r?e=new tr("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):e&&r&&e!==r&&(e=new tr("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}function Do(n,e=new Set){return n instanceof Yi&&e.add(n.key),n.eachChild(t=>{Do(t,e)}),e}function lT(n){const e={color:ir,string:se,number:U,enum:se,boolean:re,formatted:So,padding:Ro,numberArray:Po,colorArray:Si,projectionDefinition:vo,resolvedImage:qi,variableAnchorOffsetCollection:Ao};return n.type==="array"?Et(e[n.value]||J,n.length):e[n.type]}function uT(n){if(n.type==="color"&&wp(n.default))return new Se(0,0,0,0);switch(n.type){case"color":return Se.parse(n.default)||null;case"padding":return kt.parse(n.default)||null;case"numberArray":return $t.parse(n.default)||null;case"colorArray":return wt.parse(n.default)||null;case"variableAnchorOffsetCollection":return sr.parse(n.default)||null;case"projectionDefinition":return Ut.parse(n.default)||null;default:return n.default===void 0?null:n.default}}function Tp(n){if(n===!0||n===!1)return!0;if(!Array.isArray(n)||n.length===0)return!1;switch(n[0]){case"has":return n.length>=2&&n[1]!=="$id"&&n[1]!=="$type";case"in":return n.length>=3&&(typeof n[1]!="string"||Array.isArray(n[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return n.length!==3||Array.isArray(n[1])||Array.isArray(n[2]);case"any":case"all":for(const e of n.slice(1))if(!Tp(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}const cT={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function hT(n){if(n==null)return{filter:()=>!0,needGeometry:!1,getGlobalStateRefs:()=>new Set};Tp(n)||(n=Ws(n));const e=vp(n,cT);if(e.result==="error")throw new Error(e.value.map(t=>`${t.key}: ${t.message}`).join(", "));{const t=Sp(n);return{filter:(r,i,s)=>e.value.evaluate(r,i,{},s),needGeometry:t,getGlobalStateRefs:()=>Do(e.value.expression)}}}function fT(n,e){return n<e?-1:n>e?1:0}function Sp(n){if(!Array.isArray(n))return!1;if(n[0]==="within"||n[0]==="distance")return!0;for(let e=1;e<n.length;e++)if(Sp(n[e]))return!0;return!1}function Ws(n){if(!n)return!0;const e=n[0];return n.length<=1?e!=="any":e==="=="?da(n[1],n[2],"=="):e==="!="?cs(da(n[1],n[2],"==")):e==="<"||e===">"||e==="<="||e===">="?da(n[1],n[2],e):e==="any"?dT(n.slice(1)):e==="all"?["all"].concat(n.slice(1).map(Ws)):e==="none"?["all"].concat(n.slice(1).map(Ws).map(cs)):e==="in"?xh(n[1],n.slice(2)):e==="!in"?cs(xh(n[1],n.slice(2))):e==="has"?Eh(n[1]):e==="!has"?cs(Eh(n[1])):!0}function da(n,e,t){switch(n){case"$type":return[`filter-type-${t}`,e];case"$id":return[`filter-id-${t}`,e];default:return[`filter-${t}`,n,e]}}function dT(n){return["any"].concat(n.map(Ws))}function xh(n,e){if(e.length===0)return!1;switch(n){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(t=>typeof t!=typeof e[0])?["filter-in-large",n,["literal",e.sort(fT)]]:["filter-in-small",n,["literal",e]]}}function Eh(n){switch(n){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",n]}}function cs(n){return["!",n]}function Li(n){return typeof n=="object"?["literal",n]:n}function pT(n,e){let t=n.stops;if(!t)return gT(n,e);const r=t&&typeof t[0][0]=="object",i=r||n.property!==void 0,s=r||!i;return t=t.map(o=>!i&&e.tokens&&typeof o[1]=="string"?[o[0],bT(o[1])]:[o[0],Li(o[1])]),r?mT(n,e,t):s?_T(n,e,t):Ya(n,e,t)}function gT(n,e){const t=["get",n.property];if(n.default===void 0)return e.type==="string"?["string",t]:t;if(e.type==="enum")return["match",t,Object.keys(e.values),t,n.default];{const r=[e.type==="color"?"to-color":e.type,t,Li(n.default)];return e.type==="array"&&r.splice(1,0,e.value,e.length||null),r}}function Nu(n){switch(n.colorSpace){case"hcl":return"interpolate-hcl";case"lab":return"interpolate-lab";default:return"interpolate"}}function mT(n,e,t){const r={},i={},s=[];for(let a=0;a<t.length;a++){const l=t[a],u=l[0].zoom;r[u]===void 0&&(r[u]={zoom:u,type:n.type,property:n.property,default:n.default},i[u]=[],s.push(u)),i[u].push([l[0].value,l[1]])}if(Uu({},e)==="exponential"){const a=[Nu(n),["linear"],["zoom"]];for(const l of s){const u=Ya(r[l],e,i[l]);An(a,l,u,!1)}return a}else{const a=["step",["zoom"]];for(const l of s){const u=Ya(r[l],e,i[l]);An(a,l,u,!0)}return Du(a),a}}function yT(n,e){if(n!==void 0)return n;if(e!==void 0)return e}function wh(n,e){const t=Li(yT(n.default,e.default));return t===void 0&&e.type==="resolvedImage"?"":t}function Ya(n,e,t){const r=Uu(n,e),i=["get",n.property];if(r==="categorical"&&typeof t[0][0]=="boolean"){const s=["case"];for(const o of t)s.push(["==",i,o[0]],o[1]);return s.push(wh(n,e)),s}else if(r==="categorical"){const s=["match",i];for(const o of t)An(s,o[0],o[1],!1);return s.push(wh(n,e)),s}else if(r==="interval"){const s=["step",["number",i]];for(const o of t)An(s,o[0],o[1],!0);return Du(s),n.default===void 0?s:["case",["==",["typeof",i],"number"],s,Li(n.default)]}else if(r==="exponential"){const s=n.base!==void 0?n.base:1,o=[Nu(n),s===1?["linear"]:["exponential",s],["number",i]];for(const a of t)An(o,a[0],a[1],!1);return n.default===void 0?o:["case",["==",["typeof",i],"number"],o,Li(n.default)]}else throw new Error(`Unknown property function type ${r}`)}function _T(n,e,t,r=["zoom"]){const i=Uu(n,e);let s,o=!1;if(i==="interval")s=["step",r],o=!0;else if(i==="exponential"){const a=n.base!==void 0?n.base:1;s=[Nu(n),a===1?["linear"]:["exponential",a],r]}else throw new Error(`Unknown zoom function type "${i}"`);for(const a of t)An(s,a[0],a[1],o);return Du(s),s}function Du(n){n[0]==="step"&&n.length===3&&(n.push(0),n.push(n[3]))}function An(n,e,t,r){n.length>3&&e===n[n.length-2]||(r&&n.length===2||n.push(e),n.push(t))}function Uu(n,e){return n.type?n.type:e.expression.interpolated?"exponential":"interval"}function bT(n){const e=["concat"],t=/{([^{}]+)}/g;let r=0;for(let i=t.exec(n);i!==null;i=t.exec(n)){const s=n.slice(r,t.lastIndex-i[0].length);r=t.lastIndex,s.length>0&&e.push(s),e.push(["get",i[1]])}if(e.length===1)return n;if(r<n.length)e.push(n.slice(r));else if(e.length===2)return["to-string",e[1]];return e}const xT=Xv;var vh={thin:100,hairline:100,"ultra-light":200,"extra-light":200,light:300,book:300,regular:400,normal:400,plain:400,roman:400,standard:400,medium:500,"semi-bold":600,"demi-bold":600,bold:700,"extra-bold":800,"ultra-bold":800,heavy:900,black:900,"heavy-black":900,fat:900,poster:900,"ultra-black":950,"extra-black":950},ri=" ",Th=/(italic|oblique)$/i,Sh={};function Ka(n,e,t){var r=Sh[n];if(!r){Array.isArray(n)||(n=[n]);for(var i=400,s="normal",o=[],a,l,u=0,h=n.length;u<h;++u){var c=n[u],f=c.split(" "),p=f[f.length-1].toLowerCase();p=="normal"||p=="italic"||p=="oblique"?(s=l?s:p,l=!0,f.pop(),p=f[f.length-1].toLowerCase()):Th.test(p)&&(p=p.replace(Th,""),s=l?s:f[f.length-1].replace(p,""),l=!0);for(var d in vh){var g=f.length>1?f[f.length-2].toLowerCase():"";if(p==d||p==d.replace("-","")||g+"-"+p==d){i=a?i:vh[d],f.pop(),g&&d.startsWith(g)&&f.pop();break}}!a&&typeof p=="number"&&(i=p,a=!0);var m=f.join(ri).replace("Klokantech Noto Sans","Noto Sans").replace("DIN Pro","Barlow").replace("Arial Unicode MS","Arial");m.indexOf(ri)!==-1&&(m='"'+m+'"'),o.push(m)}r=Sh[n]=[s,i,o]}return r[0]+ri+r[1]+ri+e+"px"+(t?"/"+t:"")+ri+r[2]}const Rp="https://api.mapbox.com";function Bu(n){const e="mapbox://";return n.indexOf(e)!==0?"":n.slice(e.length)}function ET(n,e,t){if(typeof n=="string")return[{id:"default",url:Rh(n,e,t)}];for(const r of n)r.url=Rh(r.url,e,t);return n}function Rh(n,e,t){const r=Bu(n);if(!r)return decodeURI(new URL(n,t).href);const i="sprites/";if(r.indexOf(i)!==0)throw new Error(`unexpected sprites url: ${n}`);const s=r.slice(i.length);return`${Rp}/styles/v1/${s}/sprite?access_token=${e}`}function Zs(n,e){const t=Bu(n);if(!t)return decodeURI(new URL(n,location.href).href);const r="styles/";if(t.indexOf(r)!==0)throw new Error(`unexpected style url: ${n}`);const i=t.slice(r.length);return`${Rp}/styles/v1/${i}?&access_token=${e}`}const wT=["a","b","c","d"];function ys(n,e,t,r){const i=new URL(n,r||location.href),s=Bu(n);if(!s)return e?(i.searchParams.has(t)||i.searchParams.set(t,e),[decodeURI(i.href)]):[decodeURI(i.href)];if(s==="mapbox.satellite"){const o=window.devicePixelRatio>=1.5?"@2x":"";return[`https://api.mapbox.com/v4/${s}/{z}/{x}/{y}${o}.webp?access_token=${e}`]}return wT.map(o=>`https://${o}.tiles.mapbox.com/v4/${s}/{z}/{x}/{y}.vector.pbf?access_token=${e}`)}const Gt=Object.freeze({}),Ph={},Ah={};let vT=0;function Gu(n){return n.id||(n.id=vT++),n.id}function TT(n,e){return Gu(n)+"."+me(e)}function Pp(n){let e=Ph[n.id];return e||(e={},Ph[Gu(n)]=e),e}function ST(n){let e=Ah[n.id];return e||(e={},Ah[Gu(n)]=e),e}function pa(n){return n*Math.PI/180}const lr=function(){const n=[];for(let e=78271.51696402048;n.length<=24;e/=2)n.push(e);return n}();function Uo(n,e){if(typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof OffscreenCanvas<"u")return new OffscreenCanvas(n,e);const t=document.createElement("canvas");return t.width=n,t.height=e,t}function zu(n,e){let t=0;const r=e.length;for(;t<r;++t)if(e[t]<n&&t+1<r){const s=e[t]/e[t+1];return t+Math.log(e[t]/n)/Math.log(s)}return r-1}function ai(n,e){const t=Math.floor(n),r=Math.pow(2,n-t);return e[t]/r}const mn={};function Bn(n,e,t={},r){if(e in mn)return r&&(r.url=mn[e][0].url),mn[e][1];const i=t.transformRequest&&t.transformRequest(e,n)||e,s=function(l){return delete mn[e],Promise.reject(new Error("Error fetching source "+e))},o=function(l){return delete mn[e],l.ok?l.json():Promise.reject(new Error("Error fetching source "+e))},a=xi(()=>i).then(l=>l instanceof Response?(r&&(r.url=l.url),o(l)):(l instanceof Request||(l=new Request(l)),l.headers.get("Accept")||l.headers.set("Accept","application/json"),r&&(r.url=l.url),fetch(l).then(o).catch(s))).catch(s);return mn[e]=[i,a],a}function Ap(n,e){if(typeof n=="string")if(n.trim().startsWith("{"))try{const t=JSON.parse(n);return Promise.resolve(t)}catch(t){return Promise.reject(t)}else return n=Zs(n,e.accessToken),Bn("Style",n,e);else return Promise.resolve(n)}const Ih={};function Ip(n,e,t={}){const r=[e,JSON.stringify(n)].toString();let i=Ih[r];if(!i||t.transformRequest){let s;t.transformRequest&&(s=(a,l)=>{const u=t.transformRequest&&t.transformRequest(l,"Tiles")||l;if(a instanceof hm)a.setLoader((h,c,f)=>{const p=function(d){d.arrayBuffer().then(g=>{const _=a.getFormat().readFeatures(g,{extent:h,featureProjection:f});a.setFeatures(_)})};xi(()=>u).then(d=>{if(d instanceof Response)return p(d);fetch(d).then(p).catch(g=>a.setState(Q.ERROR))}).catch(d=>a.setState(Q.ERROR))});else{const h=a.getImage();xi(()=>u).then(c=>{if(typeof c=="string"){h.src=c;return}const f=p=>p.blob().then(d=>{const g=URL.createObjectURL(d);h.addEventListener("load",()=>URL.revokeObjectURL(g)),h.addEventListener("error",()=>URL.revokeObjectURL(g)),h.src=g});if(c instanceof Response)return f(c);fetch(c).then(f).catch(p=>a.setState(Q.ERROR))}).catch(c=>a.setState(Q.ERROR))}});const o=n.url;if(o&&!n.tiles){const a=ys(o,t.accessToken,t.accessTokenParam||"access_token",e||location.href);if(o.startsWith("mapbox://"))i=Promise.resolve({tileJson:Object.assign({},n,{url:void 0,tiles:a}),tileLoadFunction:s});else{const l={};i=Bn("Source",a[0],t,l).then(function(u){return u.tiles=u.tiles.map(function(h){return u.scheme==="tms"&&(h=h.replace("{y}","{-y}")),ys(h,t.accessToken,t.accessTokenParam||"access_token",l.url)[0]}),Promise.resolve({tileJson:u,tileLoadFunction:s})})}}else n.tiles?(n=Object.assign({},n,{tiles:n.tiles.map(function(a){return n.scheme==="tms"&&(a=a.replace("{y}","{-y}")),ys(a,t.accessToken,t.accessTokenParam||"access_token",e||location.href)[0]})}),i=Promise.resolve({tileJson:Object.assign({},n),tileLoadFunction:s})):i=Promise.reject(new Error("source has no `tiles` nor `url`"));Ih[r]=i}return i}function Ch(n,e,t,r){const i=[2*t*e.pixelRatio+e.width,2*t*e.pixelRatio+e.height],s=Uo(i[0],i[1]),o=s.getContext("2d");o.drawImage(n,e.x,e.y,e.width,e.height,t*e.pixelRatio,t*e.pixelRatio,e.width,e.height);const a=o.getImageData(0,0,i[0],i[1]);o.globalCompositeOperation="destination-over",o.fillStyle=`rgba(${r.r*255},${r.g*255},${r.b*255},${r.a})`;const l=a.data;for(let u=0,h=a.width;u<h;++u)for(let c=0,f=a.height;c<f;++c){const p=(c*h+u)*4;l[p+3]>0&&o.arc(u,c,t*e.pixelRatio,0,2*Math.PI)}return o.fill(),s}function RT(n,e,t){const r=Math.max(0,Math.min(1,(t-n)/(e-n)));return r*r*(3-2*r)}function Lh(n,e,t){const r=Uo(e.width,e.height),i=r.getContext("2d");i.drawImage(n,e.x,e.y,e.width,e.height,0,0,e.width,e.height);const s=i.getImageData(0,0,e.width,e.height),o=s.data;for(let a=0,l=s.width;a<l;++a)for(let u=0,h=s.height;u<h;++u){const c=(u*l+a)*4,f=o[c+3]/255,p=.75,d=.1,g=RT(p-d,p+d,f);g>0?(o[c+0]=Math.round(255*t.r*g),o[c+1]=Math.round(255*t.g*g),o[c+2]=Math.round(255*t.b*g),o[c+3]=Math.round(255*g)):o[c+3]=0}return i.putImageData(s,0,0),r}const PT=Array(256).join(" ");function Ja(n,e){if(e>=.05){let t="";const r=n.split(`
`),i=PT.slice(0,Math.round(e/.1));for(let s=0,o=r.length;s<o;++s)s>0&&(t+=`
`),t+=r[s].split("").join(i);return t}return n}let ga;function Cp(){return ga||(ga=Uo(1,1).getContext("2d")),ga}function Zr(n,e){return Cp().measureText(n).width+(n.length-1)*e}const qs={};fm.on("propertychange",()=>{for(const n in qs)delete qs[n]});function Qa(n,e,t,r){if(n.indexOf(`
`)!==-1){const o=n.split(`
`),a=[];for(let l=0,u=o.length;l<u;++l)a.push(Qa(o[l],e,t,r));return a.join(`
`)}const i=t+","+e+","+n+","+r;let s=qs[i];if(!s){const o=n.split(" ");if(o.length>1){const a=Cp();a.font=e;const u=a.measureText("M").width*t;let h="";const c=[];for(let f=0,p=o.length;f<p;++f){const d=o[f],g=h+(h?" ":"")+d;Zr(g,r)<=u?h=g:(h&&c.push(h),h=d)}h&&c.push(h);for(let f=0,p=c.length;f<p&&p>1;++f){const d=c[f];if(Zr(d,r)<u*.35){const g=f>0?Zr(c[f-1],r):1/0,m=f<p-1?Zr(c[f+1],r):1/0;c.splice(f,1),p-=1,g<m?(c[f-1]+=" "+d,f-=1):c[f]=d+" "+c[f]}}for(let f=0,p=c.length-1;f<p;++f){const d=c[f],g=c[f+1];if(Zr(d,r)>u*.7&&Zr(g,r)<u*.6){const m=d.split(" "),_=m.pop();Zr(_,r)<u*.2&&(c[f]=m.join(" "),c[f+1]=_+" "+g),p-=1}}s=c.join(`
`)}else s=n;s=Ja(s,r),qs[i]=s}return s}const AT=["Arial","Courier New","Times New Roman","Verdana","sans-serif","serif","monospace","cursive","fantasy"],Fh={};function IT(n,e="https://cdn.jsdelivr.net/npm/@fontsource/{font-family}/{fontweight}{-fontstyle}.css"){let t;for(let r=0,i=n.length;r<i;++r){const s=n[r];if(s in Fh)continue;Fh[s]=!0;const a=Ka(s,16).split(" ");t||(t=[]),t.push([a.slice(3).join(" ").replace(/"/g,""),a[1],a[0]])}return t&&(async()=>{await document.fonts.ready;for(let r=0,i=t.length;r<i;++r){const s=t[r],o=s[0];if(AT.includes(o))continue;const a=s[1],l=s[2];if(!(await document.fonts.load(`${l} ${a} 16px "${o}"`)).some(h=>h.family.replace(/^['"]|['"]$/g,"").toLowerCase()===o.toLowerCase()&&h.weight==a&&h.style===l)){const h=e.replace("{font-family}",o.replace(/ /g,"-").toLowerCase()).replace("{Font+Family}",o.replace(/ /g,"+")).replace("{fontweight}",a).replace("{-fontstyle}",l.replace("normal","").replace(/(.+)/,"-$1")).replace("{fontstyle}",l);if(!document.querySelector('link[href="'+h+'"]')){const c=document.createElement("link");c.href=h,c.rel="stylesheet",document.head.appendChild(c)}}}})(),n}const CT={Point:1,MultiPoint:1,LineString:2,MultiLineString:2,Polygon:3,MultiPolygon:3},LT={center:[.5,.5],left:[0,.5],right:[1,.5],top:[.5,0],bottom:[.5,1],"top-left":[0,0],"top-right":[1,0],"bottom-left":[0,1],"bottom-right":[1,1]},FT=function(n,e){const t=aT(n,e);if(t.result==="error")throw new Error(t.value.map(r=>`${r.key}: ${r.message}`).join(", "));return t.value},Rt={zoom:0,distanceFromCenter:0};vt.register(No,{...vt.definitions,pitch:[{kind:"number"},[],n=>Rt.pitch||90],"distance-from-center":[{kind:"number"},[],n=>Rt.distanceFromCenter||0]});let hs,ma;function V(n,e,t,r,i,s){const o=n.id;i||(i={},console.warn("No functionCache provided to getValue()")),i[o]||(i[o]={});const a=i[o];if(!a[t]){let l=(n[e]||Gt)[t];const u=xT[`${e}_${n.type}`][t];l===void 0&&(l=u.default);let h=oT(l);if(!h&&wp(l)&&(l=pT(l,u),h=!0),h){const c=FT(l,u);a[t]=c.evaluate.bind(c)}else u.type=="color"&&(l=Se.parse(l)),a[t]=function(){return l}}return a[t](Rt,r,s)}function Mh(n,e,t,r){return V(n,"layout",`${t}-allow-overlap`,e,r)?V(n,"layout",`${t}-ignore-placement`,e,r)?"none":"obstacle":"declutter"}function MT(n,e,t,r){if(r||console.warn("No filterCache provided to evaluateFilter()"),!(n in r))try{r[n]=hT(e).filter}catch(i){console.warn("Filter will evaluate to false: "+i.message),r[n]=function(){return!1}}return r[n](Rt,t)}function Ar(n,e){if(n){if(n.a===0||e===0)return;const t=n.a;return e=e===void 0?1:e,t===0?"transparent":"rgba("+Math.round(n.r*255/t)+","+Math.round(n.g*255/t)+","+Math.round(n.b*255/t)+","+t*e+")"}return n}const OT=/\{[^{}}]*\}/g;function ya(n,e){return n.replace(OT,function(t){return e[t.slice(1,-1)]||""})}function Oh(n,e){let t=n.split(":")[0];return t===n&&(t="default"),e[t]}const NT={};function DT(n,e,t,r=lr,i=void 0,s=void 0,o=void 0,a=void 0){if(typeof e=="string"&&(e=JSON.parse(e)),e.version!=8)throw new Error("glStyle version 8 required.");NT[TT(e,n)]=Array.from(arguments);const l={};(typeof s=="string"||s instanceof Request||s instanceof Response||s instanceof Promise)&&(s={default:s});for(const x in s){const E=s[x];xi(()=>E).then(async S=>{let A;if(typeof Image<"u"){const P=new Image;if(typeof S=="string")P.crossOrigin="anonymous",P.src=S;else{let R;S instanceof Request?R=await fetch(S):S instanceof Response&&(R=S);const I=await R.blob();A=URL.createObjectURL(I),P.src=A}P.addEventListener("load",function R(){P.removeEventListener("load",R),l[x]={image:P,size:[P.width,P.height]},n.changed(),A&&URL.revokeObjectURL(A)}),P.addEventListener("error",function R(){URL.revokeObjectURL(A),P.removeEventListener("error",R)})}else if(typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope){const P=self;P.postMessage({action:"loadImage",src:S}),P.addEventListener("message",function(I){I.data.action==="imageLoaded"&&I.data.src===S&&(l[x]={image:I.data.image,size:[I.data.image.width,I.data.image.height]})})}})}const u=rp(e.layers),h={},c=[],f={},p={},d=Pp(e),g=ST(e);let m;for(let x=0,E=u.length;x<E;++x){const S=u[x],A=S.id;if(typeof t=="string"&&S.source==t||Array.isArray(t)&&t.indexOf(A)!==-1){const P=S["source-layer"];if(m){if(S.source!==m)throw new Error(`Layer "${A}" does not use source "${m}`)}else{m=S.source;const I=e.sources[m];if(!I)throw new Error(`Source "${m}" is not defined`);const N=I.type;if(N!=="vector"&&N!=="geojson")throw new Error(`Source "${m}" is not of type "vector" or "geojson", but "${N}"`)}let R=h[P];R||(R=[],h[P]=R),R.push({layer:S,index:x}),c.push(A)}}const _=new Lr,y=new Fr,b=[],v=function(x,E,S){const A=x.getProperties(),P=h[A["mvt:layer"]];if(!P)return;let R=r.indexOf(E);R==-1&&(R=zu(E,r)),Rt.zoom=R,Rt.distanceFromCenter=0;const I=x.getGeometry(),N=CT[I.getType()],X=n.get("map");if(X&&X instanceof bl&&N===1){const z=X.getSize();if(z){const ne=X.getView().getCenter(),Z=nr(I.getExtent());Rt.distanceFromCenter=pg(ne,Z)/E/z[1]}}const M={id:x.getId(),properties:A,type:N},F=n.get("mapbox-featurestate")[x.getId()];let $=-1;for(let z=0,ne=P.length;z<ne;++z){const Z=P[z],C=Z.layer,he=C.id;if(S!==void 0&&S!==he)continue;const ve=C.layout||Gt,Y=C.paint||Gt;if(ve.visibility==="none"||"minzoom"in C&&R<C.minzoom||"maxzoom"in C&&R>=C.maxzoom)continue;const Le=C.filter;if(!Le||MT(he,Le,M,g)){let fe,_e,Ie,Ne,Xe,G;const Ot=Z.index;if(N==3&&(C.type=="fill"||C.type=="fill-extrusion"))if(_e=V(C,"paint",C.type+"-opacity",M,d,F),C.type+"-pattern"in Y){const Ge=V(C,"paint",C.type+"-pattern",M,d,F);if(Ge){const De=typeof Ge=="string"?ya(Ge,A):Ge.toString(),Ce=Oh(De,l);if(i&&i[De]&&Ce){++$,G=b[$],(!G||!G.getFill()||G.getStroke()||G.getText())&&(G=new er({fill:new Fr}),b[$]=G),Ie=G.getFill(),G.setZIndex(Ot);const Re=De+"."+_e;let qe=p[Re];if(!qe){const de=i[De],xe=Uo(de.width,de.height),Ye=xe.getContext("2d");Ye.globalAlpha=_e,Ye.drawImage(Ce.image,de.x,de.y,de.width,de.height,0,0,de.width,de.height),qe=Ye.createPattern(xe,"repeat"),p[Re]=qe}Ie.setColor(qe)}}}else fe=Ar(V(C,"paint",C.type+"-color",M,d,F),_e),C.type+"-outline-color"in Y&&(Xe=Ar(V(C,"paint",C.type+"-outline-color",M,d,F),_e)),Xe||(Xe=fe),(fe||Xe)&&(++$,G=b[$],(!G||fe&&!G.getFill()||!fe&&G.getFill()||Xe&&!G.getStroke()||!Xe&&G.getStroke()||G.getText())&&(G=new er({fill:fe?new Fr:void 0,stroke:Xe?new Lr:void 0}),b[$]=G),fe&&(Ie=G.getFill(),Ie.setColor(fe)),Xe&&(Ne=G.getStroke(),Ne.setColor(Xe),Ne.setWidth(.5)),G.setZIndex(Ot));if(N!=1&&C.type=="line"){"line-pattern"in Y?fe=void 0:fe=Ar(V(C,"paint","line-color",M,d,F),V(C,"paint","line-opacity",M,d,F));const Ge=V(C,"paint","line-width",M,d,F);fe&&Ge>0&&(++$,G=b[$],(!G||!G.getStroke()||G.getFill()||G.getText())&&(G=new er({stroke:new Lr}),b[$]=G),Ne=G.getStroke(),Ne.setLineCap(V(C,"layout","line-cap",M,d,F)),Ne.setLineJoin(V(C,"layout","line-join",M,d,F)),Ne.setMiterLimit(V(C,"layout","line-miter-limit",M,d,F)),Ne.setColor(fe),Ne.setWidth(Ge),Ne.setLineDash(Y["line-dasharray"]?V(C,"paint","line-dasharray",M,d,F).map(function(De){return De*Ge}):null),G.setZIndex(Ot))}let cr=!1,ce=null,Qi=0,wr,Qe,$o;if((N==1||N==2)&&"icon-image"in ve){const Ge=V(C,"layout","icon-image",M,d,F);if(Ge){wr=typeof Ge=="string"?ya(Ge,A):Ge.toString();let De;const Ce=a?a(n,wr):void 0,Re=Oh(wr,l);if(i&&i[wr]&&Re||Ce){const qe=V(C,"layout","icon-rotation-alignment",M,d,F);if(N==2){const de=x.getGeometry();if(de.getFlatMidpoint||de.getFlatMidpoints){const xe=de.getExtent();if(Math.sqrt(Math.max(Math.pow((xe[2]-xe[0])/E,2),Math.pow((xe[3]-xe[1])/E,2)))>150){const tt=de.getType()==="MultiLineString"?de.getFlatMidpoints():de.getFlatMidpoint();if(ma||(hs=[NaN,NaN],ma=new Qh("Point",hs,[],2,{},void 0)),De=ma,hs[0]=tt[0],hs[1]=tt[1],V(C,"layout","symbol-placement",M,d,F)==="line"&&qe==="map"){const Nt=de.getStride(),ct=de.getFlatCoordinates();for(let yt=0,ke=ct.length-Nt;yt<ke;yt+=Nt){const ot=ct[yt],Pt=ct[yt+1],$e=ct[yt+Nt],Tr=ct[yt+Nt+1],Zp=Math.min(ot,$e),qp=Math.max(ot,$e),Vo=tt[0],Hp=tt[1],Yp=(Tr-Pt)*(Vo-ot)-($e-ot)*(Hp-Pt);if(Math.abs(Yp)<.001&&Vo<=qp&&Vo>=Zp){Qi=Math.atan2(Pt-Tr,$e-ot);break}}}}}}if(N!==2||De){const de=V(C,"layout","icon-size",M,d,F),xe=Y["icon-color"]!==void 0?V(C,"paint","icon-color",M,d,F):null;if(!xe||xe.a!==0){const Ye=V(C,"paint","icon-halo-color",M,d,F),tt=V(C,"paint","icon-halo-width",M,d,F);let Wt=`${wr}.${de}.${tt}.${Ye}`;if(xe!==null&&(Wt+=`.${xe}`),Qe=f[Wt],!Qe){const Nt=Mh(C,M,"icon",d);let ct;"icon-offset"in ve&&(ct=V(C,"layout","icon-offset",M,d,F).slice(0),ct[0]*=de,ct[1]*=-de);let yt=xe?[xe.r*255,xe.g*255,xe.b*255,xe.a]:void 0;if(Ce){const ke={color:yt,rotateWithView:qe==="map",displacement:ct,declutterMode:Nt,scale:de};typeof Ce=="string"?ke.src=Ce:(ke.img=Ce,ke.imgSize=[Ce.width,Ce.height]),Qe=new tc(ke)}else{const ke=i[wr];let ot,Pt,$e;if(tt)ke.sdf?(ot=Ch(Lh(Re.image,ke,xe||[0,0,0,1]),{x:0,y:0,width:ke.width,height:ke.height,pixelRatio:ke.pixelRatio},tt,Ye),yt=void 0):ot=Ch(Re.image,ke,tt,Ye);else{if(ke.sdf&&!Re.unSDFed){const Tr=Lh(Re.image,{x:0,y:0,width:Re.size[0],height:Re.size[1]},{r:1,g:1,b:1});Re.image=Tr,Re.unSDFed=!0}ot=Re.image,Pt=[ke.width,ke.height],$e=[ke.x,ke.y]}Qe=new tc({color:yt,img:ot,imgSize:Re.size,size:Pt,offset:$e,rotateWithView:qe==="map",scale:de/ke.pixelRatio,displacement:ct,declutterMode:Nt})}f[Wt]=Qe}}Qe&&(++$,G=b[$],(!G||!G.getImage()||G.getFill()||G.getStroke())&&(G=new er,b[$]=G),G.setGeometry(De),Qe.setRotation(Qi+pa(V(C,"layout","icon-rotate",M,d,F))),Qe.setOpacity(V(C,"paint","icon-opacity",M,d,F)),Qe.setAnchor(LT[V(C,"layout","icon-anchor",M,d,F)]),G.setImage(Qe),ce=G.getText(),G.setText(void 0),G.setZIndex(Ot),cr=!0,$o=!1)}else $o=!0}}}if(N==1&&C.type==="circle"){++$,G=b[$],(!G||!G.getImage()||G.getFill()||G.getStroke())&&(G=new er,b[$]=G);const Ge="circle-radius"in Y?V(C,"paint","circle-radius",M,d,F):5,De=Ar(V(C,"paint","circle-stroke-color",M,d,F),V(C,"paint","circle-stroke-opacity",M,d,F)),Ce=V(C,"paint","circle-translate",M,d,F),Re=Ar(V(C,"paint","circle-color",M,d,F),V(C,"paint","circle-opacity",M,d,F)),qe=V(C,"paint","circle-stroke-width",M,d,F),de=Ge+"."+De+"."+Re+"."+qe+"."+Ce[0]+"."+Ce[1];Qe=f[de],Qe||(Qe=new df({radius:Ge,displacement:[Ce[0],-Ce[1]],stroke:De&&qe>0?new Lr({width:qe,color:De}):void 0,fill:Re?new Fr({color:Re}):void 0,declutterMode:"none"}),f[de]=Qe),G.setImage(Qe),ce=G.getText(),G.setText(void 0),G.setGeometry(void 0),G.setZIndex(Ot),cr=!0}let et,Kn,Jn,vr,Qn,jo;if("text-field"in ve){vr=Math.round(V(C,"layout","text-size",M,d,F));const Ge=V(C,"layout","text-font",M,d,F);Jn=V(C,"layout","text-line-height",M,d,F),Kn=Ka(o?o(Ge,e.metadata?e.metadata["ol:webfonts"]:void 0):Ge,vr,Jn),Kn.includes("sans-serif")||(Kn+=",sans-serif"),Qn=V(C,"layout","text-letter-spacing",M,d,F),jo=V(C,"layout","text-max-width",M,d,F);const De=V(C,"layout","text-field",M,d,F);typeof De=="object"&&De.sections?De.sections.length===1?et=De.toString():et=De.sections.reduce((Ce,Re,qe)=>{const de=Re.fontStack?Re.fontStack.split(","):Ge,xe=Ka(o?o(de):de,vr*(Re.scale||1),Jn);let Ye=Re.text;if(Ye===`
`)return Ce.push(`
`,""),Ce;if(N==2)return Ce.push(Ja(Ye,Qn),xe),Ce;Ye=Qa(Ye,xe,jo,Qn).split(`
`);for(let tt=0,Wt=Ye.length;tt<Wt;++tt)tt>0&&Ce.push(`
`,""),Ce.push(Ye[tt],xe);return Ce},[]):et=ya(De,A).trim(),_e=V(C,"paint","text-opacity",M,d,F)}if(et&&_e&&!$o){cr||(++$,G=b[$],(!G||!G.getText()||G.getFill()||G.getStroke())&&(G=new er,b[$]=G),G.setImage(void 0),G.setGeometry(void 0));const Ge=Mh(C,M,"text",d);G.getText()||G.setText(ce),ce=G.getText(),(!ce||"getDeclutterMode"in ce&&ce.getDeclutterMode()!==Ge)&&(ce=new Ta({padding:[2,2,2,2],declutterMode:Ge}),G.setText(ce));const De=V(C,"layout","text-transform",M,d,F);De=="uppercase"?et=Array.isArray(et)?et.map(($e,Tr)=>Tr%2?$e:$e.toUpperCase()):et.toUpperCase():De=="lowercase"&&(et=Array.isArray(et)?et.map(($e,Tr)=>Tr%2?$e:$e.toLowerCase()):et.toLowerCase());const Ce=Array.isArray(et)?et:N==2?Ja(et,Qn):Qa(et,Kn,jo,Qn);if(ce.setText(Ce),ce.setFont(Kn),ce.setRotation(pa(V(C,"layout","text-rotate",M,d,F))),typeof ce.setKeepUpright=="function"){const $e=V(C,"layout","text-keep-upright",M,d,F);ce.setKeepUpright($e)}const Re=V(C,"layout","text-anchor",M,d,F),qe=cr||N==1?"point":V(C,"layout","symbol-placement",M,d,F);let de;if(qe==="line-center"?(ce.setPlacement("line"),de="center"):ce.setPlacement(qe),qe==="line"&&typeof ce.setRepeat=="function"){const $e=V(C,"layout","symbol-spacing",M,d,F);ce.setRepeat($e*2)}ce.setOverflow(qe==="point");let xe=V(C,"paint","text-halo-width",M,d,F);const Ye=V(C,"layout","text-offset",M,d,F),tt=V(C,"paint","text-translate",M,d,F);let Wt=0,Nt=0;if(qe=="point"){de="center",Re.indexOf("left")!==-1?(de="left",Nt=xe):Re.indexOf("right")!==-1&&(de="right",Nt=-xe);const $e=V(C,"layout","text-rotation-alignment",M,d,F);ce.setRotateWithView($e=="map")}else ce.setMaxAngle(pa(V(C,"layout","text-max-angle",M,d,F))*et.length/Ce.length),ce.setRotateWithView(!1);ce.setTextAlign(de);let ct="middle";Re.indexOf("bottom")==0?(ct="bottom",Wt=-xe-.5*(Jn-1)*vr):Re.indexOf("top")==0&&(ct="top",Wt=xe+.5*(Jn-1)*vr),ce.setTextBaseline(ct);const yt=V(C,"layout","text-justify",M,d,F);ce.setJustify(yt==="auto"?void 0:yt),ce.setOffsetX(Ye[0]*vr+Nt+tt[0]),ce.setOffsetY(Ye[1]*vr+Wt+tt[1]),y.setColor(Ar(V(C,"paint","text-color",M,d,F),_e)),ce.setFill(y);const ke=Ar(V(C,"paint","text-halo-color",M,d,F),_e);if(ke&&xe>0){_.setColor(ke),xe*=2;const $e=.5*vr;_.setWidth(xe<=$e?xe:$e),ce.setStroke(_)}else ce.setStroke(void 0);const ot=V(C,"layout","text-padding",M,d,F),Pt=ce.getPadding();ot!==Pt[0]&&(Pt[0]=ot,Pt[1]=ot,Pt[2]=ot,Pt[3]=ot),G.setZIndex(Ot)}}}if($>-1)return b.length=$+1,b};return n.setStyle(v),n.set("mapbox-layers",c),n.set("mapbox-source",m),n.set("mapbox-featurestate",n.get("mapbox-featurestate")||{}),v}function Lp(n){return function(e){const t=e.buffers,r=e.meta,i=e.imageOps,s=e.width,o=e.height,a=t.length,l=t[0].byteLength;if(i){const f=new Array(a);for(let d=0;d<a;++d)f[d]=new ImageData(new Uint8ClampedArray(t[d]),s,o);return n(f,r).data.buffer}const u=new Uint8ClampedArray(l),h=new Array(a),c=new Array(a);for(let f=0;f<a;++f)h[f]=new Uint8ClampedArray(t[f]),c[f]=[0,0,0,0];for(let f=0;f<l;f+=4){for(let d=0;d<a;++d){const g=h[d];c[d][0]=g[f],c[d][1]=g[f+1],c[d][2]=g[f+2],c[d][3]=g[f+3]}const p=n(c,r);u[f]=p[0],u[f+1]=p[1],u[f+2]=p[2],u[f+3]=p[3]}return u.buffer}}function UT(n,e){const r=Object.keys(n.lib||{}).map(function(s){return"const "+s+" = "+n.lib[s].toString()+";"}).concat(["const __minion__ = ("+Lp.toString()+")(",n.operation.toString(),");",'self.addEventListener("message", function(event) {',"  const buffer = __minion__(event.data);","  self.postMessage({buffer: buffer, meta: event.data.meta}, [buffer]);","});"]),i=new Worker(typeof Blob>"u"?"data:text/javascript;base64,"+Buffer.from(r.join(`
`),"binary").toString("base64"):URL.createObjectURL(new Blob(r,{type:"text/javascript"})));return i.addEventListener("message",e),i}function BT(n,e){const t=Lp(n.operation);let r=!1;return{postMessage:function(i){setTimeout(function(){r||e({data:{buffer:t(i),meta:i.meta}})},0)},terminate:function(){r=!0}}}class GT extends rf{constructor(e){super(),this.imageOps_=!!e.imageOps;let t;e.threads===0?t=0:this.imageOps_?t=1:t=e.threads||1;const r=new Array(t);if(t)for(let i=0;i<t;++i)r[i]=UT(e,this.onWorkerMessage_.bind(this,i));else r[0]=BT(e,this.onWorkerMessage_.bind(this,0));this.workers_=r,this.queue_=[],this.maxQueueLength_=e.queue||1/0,this.running_=0,this.dataLookup_={},this.job_=null}process(e,t,r){this.enqueue_({inputs:e,meta:t,callback:r}),this.dispatch_()}enqueue_(e){for(this.queue_.push(e);this.queue_.length>this.maxQueueLength_;)this.queue_.shift().callback(null,null)}dispatch_(){if(this.running_||this.queue_.length===0)return;const e=this.queue_.shift();this.job_=e;const t=e.inputs[0].width,r=e.inputs[0].height,i=e.inputs.map(function(l){return l.data.buffer}),s=this.workers_.length;if(this.running_=s,s===1){this.workers_[0].postMessage({buffers:i,meta:e.meta,imageOps:this.imageOps_,width:t,height:r},i);return}const o=e.inputs[0].data.length,a=4*Math.ceil(o/4/s);for(let l=0;l<s;++l){const u=l*a,h=[];for(let c=0,f=i.length;c<f;++c)h.push(i[c].slice(u,u+a));this.workers_[l].postMessage({buffers:h,meta:e.meta,imageOps:this.imageOps_,width:t,height:r},h)}}onWorkerMessage_(e,t){this.disposed||(this.dataLookup_[e]=t.data,--this.running_,this.running_===0&&this.resolveJob_())}resolveJob_(){const e=this.job_,t=this.workers_.length;let r,i;if(t===1)r=new Uint8ClampedArray(this.dataLookup_[0].buffer),i=this.dataLookup_[0].meta;else{const s=e.inputs[0].data.length;r=new Uint8ClampedArray(s),i=new Array(t);const o=4*Math.ceil(s/4/t);for(let a=0;a<t;++a){const l=this.dataLookup_[a].buffer,u=a*o;r.set(new Uint8ClampedArray(l),u),i[a]=this.dataLookup_[a].meta}}this.job_=null,this.dataLookup_={},e.callback(null,new ImageData(r,e.inputs[0].width,e.inputs[0].height),i),this.dispatch_()}disposeInternal(){for(let e=0;e<this.workers_.length;++e)this.workers_[e].terminate();this.workers_.length=0}}const Nh={BEFOREOPERATIONS:"beforeoperations",AFTEROPERATIONS:"afteroperations"};class Dh extends sf{constructor(e,t,r){super(e),this.extent=t.extent,this.resolution=t.viewState.resolution/t.pixelRatio,this.data=r}}class ku extends cn{constructor(e){super({projection:null}),this.on,this.once,this.un,this.processor_=null,this.operationType_=e.operationType!==void 0?e.operationType:"pixel",this.threads_=e.threads!==void 0?e.threads:1,this.layers_=$T(e.sources);const t=this.changed.bind(this);for(let r=0,i=this.layers_.length;r<i;++r)this.layers_[r].addEventListener(ft.CHANGE,t);this.useResolutions_=e.resolutions!==null,this.tileQueue_=new dm(function(){return 1},this.processSources_.bind(this)),this.requestedFrameState_,this.renderedImageCanvas_=null,this.renderedRevision_,this.frameState_={animate:!1,coordinateToPixelTransform:nt(),declutter:null,extent:null,index:0,layerIndex:0,layerStatesArray:kT(this.layers_),pixelRatio:1,pixelToCoordinateTransform:nt(),postRenderFunctions:[],size:[0,0],tileQueue:this.tileQueue_,time:Date.now(),usedTiles:{},viewState:{rotation:0},viewHints:[],wantedTiles:{},mapId:me(this),renderTargets:{}},this.setAttributions(function(r){var s;const i=[];for(let o=0,a=e.sources.length;o<a;++o){const l=e.sources[o],u=l instanceof uo?l:l.getSource();if(!u)continue;const h=(s=u.getAttributions())==null?void 0:s(r);typeof h=="string"?i.push(h):h!==void 0&&i.push(...h)}return i}),e.operation!==void 0&&this.setOperation(e.operation,e.lib)}setOperation(e,t){this.processor_&&this.processor_.dispose(),this.processor_=new GT({operation:e,imageOps:this.operationType_==="image",queue:1,lib:t,threads:this.threads_}),this.changed()}updateFrameState_(e,t,r){const i=Object.assign({},this.frameState_);i.viewState=Object.assign({},i.viewState);const s=nr(e);i.size[0]=Math.ceil(it(e)/t),i.size[1]=Math.ceil(jt(e)/t),i.extent=[s[0]-i.size[0]*t/2,s[1]-i.size[1]*t/2,s[0]+i.size[0]*t/2,s[1]+i.size[1]*t/2],i.time=Date.now();const o=i.viewState;return o.center=s,o.projection=r,o.resolution=t,i}allSourcesReady_(){let e=!0,t;for(let r=0,i=this.layers_.length;r<i;++r)if(t=this.layers_[r].getSource(),!t||t.getState()!=="ready"){e=!1;break}return e}getImage(e,t,r,i){if(!this.allSourcesReady_())return null;this.tileQueue_.loadMoreTiles(16,16),t=this.findNearestResolution(t);const s=this.updateFrameState_(e,t,i);if(this.requestedFrameState_=s,this.renderedImageCanvas_){const o=this.renderedImageCanvas_.getResolution(),a=this.renderedImageCanvas_.getExtent();(t!==o||!bi(s.extent,a))&&(this.renderedImageCanvas_=null)}return(!this.renderedImageCanvas_||this.getRevision()!==this.renderedRevision_)&&this.processSources_(),s.animate&&requestAnimationFrame(this.changed.bind(this)),this.renderedImageCanvas_}processSources_(){const e=this.requestedFrameState_,t=this.layers_.length,r=new Array(t);for(let s=0;s<t;++s){e.layerIndex=s,e.renderTargets={};const o=zT(this.layers_[s],e);if(o)r[s]=o;else return}const i={};this.dispatchEvent(new Dh(Nh.BEFOREOPERATIONS,e,i)),this.processor_.process(r,i,this.onWorkerComplete_.bind(this,e))}onWorkerComplete_(e,t,r,i){if(t||!r)return;const s=e.extent,o=e.viewState.resolution;if(o!==this.requestedFrameState_.viewState.resolution||!bi(s,this.requestedFrameState_.extent))return;let a;if(this.renderedImageCanvas_)a=this.renderedImageCanvas_.getImage().getContext("2d");else{const l=Math.round(it(s)/o),u=Math.round(jt(s)/o);a=Br(l,u),this.renderedImageCanvas_=new Xl(s,o,1,a.canvas)}a.putImageData(r,0,0),e.animate?requestAnimationFrame(this.changed.bind(this)):this.changed(),this.renderedRevision_=this.getRevision(),this.dispatchEvent(new Dh(Nh.AFTEROPERATIONS,e,i))}getResolutions(e){if(!this.useResolutions_)return null;let t=super.getResolutions();if(!t)for(let r=0,i=this.layers_.length;r<i&&(t=this.layers_[r].getSource().getResolutions(e),!t);++r);return t}disposeInternal(){this.processor_&&this.processor_.dispose(),super.disposeInternal()}}ku.prototype.dispose;let qr=null;function zT(n,e){const t=n.getRenderer();if(!t)throw new Error("Unsupported layer type: "+n);if(!t.prepareFrame(e))return null;const r=e.size[0],i=e.size[1];if(r===0||i===0)return null;const s=t.renderFrame(e,null);let o;if(s instanceof HTMLCanvasElement)o=s;else{if(s&&(o=s.firstElementChild),!(o instanceof HTMLCanvasElement))throw new Error("Unsupported rendered element: "+o);if(o.width===r&&o.height===i)return o.getContext("2d").getImageData(0,0,r,i)}if(!qr)qr=Br(r,i,void 0,{willReadFrequently:!0});else{const a=qr.canvas;a.width!==r||a.height!==i?qr=Br(r,i,void 0,{willReadFrequently:!0}):qr.clearRect(0,0,r,i)}return qr.drawImage(o,0,0,r,i),qr.getImageData(0,0,r,i)}function kT(n){return n.map(function(e){return e.getLayerState()})}function $T(n){const e=n.length,t=new Array(e);for(let r=0;r<e;++r)t[r]=jT(n[r]);return t}function jT(n){let e;return n instanceof uo?n instanceof ml?e=new Is({source:n}):n instanceof cn&&(e=new _l({source:n})):e=n,e}function VT(n,e){const t=n[0],r=t.width,i=t.height,s=t.data,o=new Uint8ClampedArray(s.length),a=e.resolution*2,l=r-1,u=i-1,h=[0,0,0,0],c=2*Math.PI,f=Math.PI/2,p=Math.PI*e.sunEl/180,d=Math.PI*e.sunAz/180,g=Math.cos(p),m=Math.sin(p),_=e.highlightColor,y=e.shadowColor,b=e.accentColor,v=e.encoding;let x,E,S,A,P,R,I,N,X,M,F,$,z,ne,Z,C,he,ve,Y,Le,fe,_e;function Ie(Ne,Xe="mapbox"){if(Xe==="mapbox")return(Ne[0]*256*256+Ne[1]*256+Ne[2])*.1-1e4;if(Xe==="terrarium")return Ne[0]*256+Ne[1]+Ne[2]/256-32768}for(E=0;E<=u;++E)for(P=E===0?0:E-1,R=E===u?u:E+1,x=0;x<=l;++x)S=x===0?0:x-1,A=x===l?l:x+1,I=(E*r+S)*4,h[0]=s[I],h[1]=s[I+1],h[2]=s[I+2],h[3]=s[I+3],N=e.vert*Ie(h,v),I=(E*r+A)*4,h[0]=s[I],h[1]=s[I+1],h[2]=s[I+2],h[3]=s[I+3],X=e.vert*Ie(h,v),M=(X-N)/a,I=(P*r+x)*4,h[0]=s[I],h[1]=s[I+1],h[2]=s[I+2],h[3]=s[I+3],N=e.vert*Ie(h,v),I=(R*r+x)*4,h[0]=s[I],h[1]=s[I+1],h[2]=s[I+2],h[3]=s[I+3],X=e.vert*Ie(h,v),F=(X-N)/a,z=Math.atan2(F,-M),z<0?z=f-z:z>f?z=c-z+f:z=f-z,$=Math.atan(Math.sqrt(M*M+F*F)),_e=m*Math.cos($)+g*Math.sin($)*Math.cos(d-z),ne=Math.cos($),Z=255*_e,Y=Math.min(Math.max(2*e.sunEl,0),1),Le=1.875-e.opacity*1.75,fe=e.opacity!==.5?f*((Math.pow(Le,$)-1)/(Math.pow(Le,f)-1)):$,he={r:(1-ne)*b.r*Y*255,g:(1-ne)*b.g*Y*255,b:(1-ne)*b.b*Y*255,a:(1-ne)*b.a*Y*255},C=Math.abs(((z+d)/Math.PI+.5)%2-1),ve={r:(_.r*(1-C)+y.r*C)*Z,g:(_.g*(1-C)+y.g*C)*Z,b:(_.b*(1-C)+y.b*C)*Z,a:(_.a*(1-C)+y.a*C)*Z},I=(E*r+x)*4,o[I]=he.r*(1-C)+ve.r,o[I+1]=he.g*(1-C)+ve.g,o[I+2]=he.b*(1-C)+ve.b,o[I+3]=s[I+3]*e.opacity*Y*Math.sin(fe);return new ImageData(o,r,i)}function XT(n,e=512){return n.getExtent()?kr({extent:n.getExtent(),tileSize:e,maxZoom:22}).getResolutions():lr}function Fp(n,e){return e.accessToken||(e=Object.assign({},e),new URL(n).searchParams.forEach((r,i)=>{e.accessToken=r,e.accessTokenParam=i})),e}function WT(n,e,t="",r={},i=void 0){let s,o,a,l,u=!0;return typeof t!="string"&&!Array.isArray(t)?(a=t,l=a.source||a.layers,r=a):l=t,typeof r=="string"?(s=r,a={}):(s=r.styleUrl,a=r),a.updateSource===!1&&(u=!1),i||(i=a.resolutions),!s&&typeof e=="string"&&!e.trim().startsWith("{")&&(s=e),s&&(s=s.startsWith("data:")?location.href:Zs(s,a.accessToken),a=Fp(s,a)),new Promise(function(h,c){Ap(e,a).then(function(f){if(f.version!=8)return c(new Error("glStyle version 8 required."));if(!(n instanceof Ni||n instanceof Sn))return c(new Error("Can only apply to VectorLayer or VectorTileLayer"));const p=n instanceof Sn?"vector":"geojson";if(l?Array.isArray(l)?o=f.layers.find(function(v){return v.id===l[0]}).source:o=l:(o=f.layers.find(function(v){return v.source&&f.sources[v.source].type===p}).source,l=o),!o)return c(new Error(`No ${p} source found in the glStyle.`));function d(){if(!u)return Promise.resolve();if(n instanceof Sn)return Np(f.sources[o],s,a).then(function(S){const A=n.getSource();A?S!==A&&(A.setTileUrlFunction(S.getTileUrlFunction()),typeof A.setUrls=="function"&&typeof S.getUrls=="function"&&A.setUrls(S.getUrls()),A.format_||(A.format_=S.format_),A.getAttributions()||A.setAttributions(S.getAttributions()),A.getTileLoadFunction()===gm&&A.setTileLoadFunction(S.getTileLoadFunction()),li(A.getProjection(),S.getProjection())&&(A.tileGrid=S.getTileGrid())):n.setSource(S);const P=n.getSource().getTileGrid();!isFinite(n.getMaxResolution())&&!isFinite(n.getMinZoom())&&P.getMinZoom()>0&&n.setMaxResolution(ai(Math.max(0,P.getMinZoom()-1e-12),P.getResolutions()))});const v=f.sources[o];let x=n.getSource();(!x||x.get("mapbox-source")!==v)&&(x=Bp(v,s,a));const E=n.getSource();return E?x!==E&&(E.getAttributions()||E.setAttributions(x.getAttributions()),E.format_||(E.format_=x.getFormat()),E.url_=x.getUrl()):n.setSource(x),Promise.resolve()}let g,m;const _={},y={};function b(){if(!m&&(!f.sprite||_)){if(a.projection&&!i){const x=ue(a.projection).getUnits();x!=="m"&&(i=lr.map(E=>E/wa[x]))}m=DT(n,f,l,i,_,y,(v,x=a.webfonts)=>IT(v,x),a.getImage),n.getStyle()?d().then(h).catch(c):c(new Error(`Nothing to show for source [${o}]`))}else m?(n.setStyle(m),d().then(h).catch(c)):c(new Error("Something went wrong trying to apply style."))}if(f.sprite){const v=ET(f.sprite,a.accessToken,s||location.href);g=window.devicePixelRatio>=1.5?.5:1;const x=g==.5?"@2x":"";Promise.all(v.map(function(E){const S=new URL(E.url);let A=S.origin+S.pathname+x+".json"+S.search;return new Promise(function(P,R){Bn("Sprite",A,a).then(P).catch(function(I){A=S.origin+S.pathname+".json"+S.search,Bn("Sprite",A,a).then(P).catch(R)})}).then(function(P){P===void 0&&c(new Error("No sprites found."));let R;if(R=S.origin+S.pathname+x+".png"+S.search,a.transformRequest){const I=a.transformRequest(R,"SpriteImage")||R;(I instanceof Request||I instanceof Promise)&&(R=I)}y[E.id]=R;for(const I in P){const N=E.id=="default"?I:`${E.id}:${I}`;_[N]=P[I]}}).catch(function(P){c(new Error(`Sprites cannot be loaded: ${A}: ${P.message}`))})})).then(b).catch(c)}else b()}).catch(c)})}function Mp(n,e){let t;return n.some(function(r){if(r.id==e)return t=r.source,!0}),t}function ZT(n,e){const t=n.bounds;if(t){const r=va([t[0],t[1]],e),i=va([t[2],t[3]],e);return[r[0],r[1],i[0],i[1]]}return ue(e).getExtent()}function Op(n,e,t){const r=new xo({tileJSON:e,tileSize:n.tileSize||e.tileSize||512}),i=r.getTileJSON(),s=r.getTileGrid(),o=ue(t.projection||"EPSG:3857"),a=ZT(i,o),l=o.getExtent(),u=i.minzoom||0,h=i.maxzoom||22,c={attributions:r.getAttributions(),projection:o,tileGrid:new Ui({origin:l?vs(l):s.getOrigin(0),extent:a||s.getExtent(),minZoom:u,resolutions:XT(o,e.tileSize).slice(0,h+1),tileSize:s.getTileSize(0)})};return Array.isArray(i.tiles)?c.urls=i.tiles:c.url=i.tiles,c}function qT(n,e,t,r){const i={id:n.id,type:n.type},s=n.layout||{},o=n.paint||{};i.paint=o,Rt.zoom=zu(e,t.resolutions||lr),Rt.distanceFromCenter=0;let a;const l=V(i,"paint","background-color",Gt,r);return o["background-opacity"]!==void 0&&(a=V(i,"paint","background-opacity",Gt,r)),s.visibility=="none"?void 0:Ar(l,a)}function HT(n,e,t){const r=document.createElement("div");return r.className="ol-mapbox-style-background",r.style.position="absolute",r.style.width="100%",r.style.height="100%",new lo({source:new uo({}),render(i){const s=qT(n,i.viewState.resolution,e,t);return r.style.backgroundColor=s,r}})}function Np(n,e,t){return new Promise(function(r,i){Ip(n,e,t).then(function({tileJson:s,tileLoadFunction:o}){const a=Op(n,s,t);a.tileLoadFunction=o,a.format=new pf({layerName:"mvt:layer"});const l=new Bi(a);l.set("mapbox-source",n),r(l)}).catch(i)})}function YT(n,e,t){const r=new Sn({declutter:!0,visible:!1});return Np(n,e,t).then(function(i){r.setSource(i)}).catch(function(i){r.setSource(void 0)}),r}function Dp(n){return`{bbox-${(n?n.getCode():"EPSG:3857").toLowerCase().replace(/[^a-z0-9]/g,"-")}}`}function KT(n,e,t){return new Promise(function(r,i){Ip(n,e,t).then(function({tileJson:s,tileLoadFunction:o}){const a=new xo({interpolate:t.interpolate===void 0?!0:t.interpolate,transition:0,crossOrigin:"anonymous",tileJSON:s});a.tileGrid=Op(n,s,t).tileGrid,t.projection&&(a.projection=ue(t.projection));const l=a.getTileUrlFunction();o&&a.setTileLoadFunction(o),a.setTileUrlFunction(function(u,h,c){const f=Dp(c);let p=l(u,h,c);if(p.indexOf(f)!=-1){const d=a.getTileGrid().getTileCoordExtent(u);p=p.replace(f,d.toString())}return p}),a.set("mapbox-source",n),r(a)}).catch(function(s){i(s)})})}function Up(n,e,t){const r=new Is;return KT(n,e,t).then(function(i){r.setSource(i)}).catch(function(){r.setSource(void 0)}),r}function JT(n,e,t){const r=Up(n,e,t);return new _l({source:new ku({operationType:"image",operation:VT,sources:[r]})})}function Bp(n,e,t){const r=t.projection?new bs({dataProjection:t.projection}):new bs,i=n.data,s={};if(typeof i=="string"){const[a]=ys(i,t.accessToken,t.accessTokenParam||"access_token",e||location.href);if(/\{bbox-[0-9a-z-]+\}/.test(a)){const u=(c,f,p)=>{const d=Dp(p);return a.replace(d,`${c.join(",")}`)},h=new Dr({attributions:n.attribution,format:r,loader:(c,f,p,d,g)=>{const m=typeof u=="function"?u(c,f,p):u;Bn("GeoJSON",m,t).then(_=>{const y=h.getFormat().readFeatures(_,{featureProjection:p});h.addFeatures(y),d(y)}).catch(_=>{h.removeLoadedExtent(c),g()})},strategy:mf});return h.set("mapbox-source",n),h}const l=new Dr({attributions:n.attribution,format:r,url:a,loader:(u,h,c,f,p)=>{Bn("GeoJSON",a,t).then(d=>{const g=l.getFormat().readFeatures(d,{featureProjection:c});l.addFeatures(g),f(g)}).catch(d=>{l.removeLoadedExtent(u),p()})}});return l}s.features=r.readFeatures(i,{featureProjection:"EPSG:3857"});const o=new Dr(Object.assign({attributions:n.attribution,format:r},s));return o.set("mapbox-source",n),o}function QT(n,e,t){return new Ni({declutter:!0,source:Bp(n,e,t),visible:!1})}function eS(n,e,t){let r=null;return function(i){n.paint&&"raster-opacity"in n.paint&&i.frameState.viewState.zoom!==r&&(r=i.frameState.viewState.zoom,delete t[n.id],tS(n,e,r,t))}}function tS(n,e,t,r){Rt.zoom=t,Rt.distanceFromCenter=0;const i=V(n,"paint","raster-opacity",Gt,r);e.setOpacity(i)}function rS(n,e){function t(){const r=e.get("mapbox-style");if(!r)return;const i=rp(r.layers),s=n.get("mapbox-layers"),o=i.filter(function(a){return s.includes(a.id)}).some(function(a){return!a.layout||!a.layout.visibility||a.layout.visibility==="visible"});n.get("visible")!==o&&n.setVisible(o)}n.on("change",t),t()}function nS(n,e,t,r){const i=Pp(n),s=n.layers,o=t.type,a=t.source||Mp(s,t.ref),l=n.sources[a];let u;if(o=="background")u=HT(t,r,i);else if(l.type=="vector")u=YT(l,e,r);else if(l.type=="raster")u=Up(l,e,r),u.setVisible(t.layout?t.layout.visibility!=="none":!0),u.on("prerender",eS(t,u,i));else if(l.type=="geojson")u=QT(l,e,r);else if(l.type=="raster-dem"&&t.type=="hillshade"){const c=JT(l,e,r);u=c,c.getSource().on("beforeoperations",function(f){const p=f.data;p.resolution=gg(r.projection||"EPSG:3857",f.resolution,nr(f.extent),"m"),Rt.zoom=zu(f.resolution,r.resolutions||lr),Rt.distanceFromCenter=0,p.encoding=l.encoding,p.vert=5*V(t,"paint","hillshade-exaggeration",Gt,i),p.sunAz=V(t,"paint","hillshade-illumination-direction",Gt,i),p.sunEl=35,p.opacity=.3,p.highlightColor=V(t,"paint","hillshade-highlight-color",Gt,i),p.shadowColor=V(t,"paint","hillshade-shadow-color",Gt,i),p.accentColor=V(t,"paint","hillshade-accent-color",Gt,i)}),u.setVisible(t.layout?t.layout.visibility!=="none":!0)}const h=a;return u&&u.set("mapbox-source",h),u}function Uh(n,e,t,r){const i=[];let s=null;if(e instanceof bl){if(s=e.getView(),!s.isDef()&&!s.getRotation()&&!s.getResolutions()){const c=r.projection?ue(r.projection):s.getProjection();s=new pm(Object.assign(s.getProperties(),{maxResolution:lr[0]/wa[c.getUnits()],projection:r.projection||s.getProjection()})),e.setView(s)}"center"in n&&!s.getCenter()&&s.setCenter(va(n.center,s.getProjection())),"zoom"in n&&s.getZoom()===void 0&&s.setResolution(lr[0]/wa[s.getProjection().getUnits()]/Math.pow(2,n.zoom)),(!s.getCenter()||s.getZoom()===void 0)&&s.fit(s.getProjection().getExtent(),{nearest:!0,size:e.getSize()})}e.set("mapbox-style",n),e.set("mapbox-metadata",{styleUrl:t,options:r});const o=n.layers;let a=[],l,u,h;for(let c=0,f=o.length;c<f;++c){const p=o[c],d=p.type;if(d=="heatmap"){console.debug(`layers[${c}].type "${d}" not supported`);continue}else h=p.source||Mp(o,p.ref),(!h||h!=u)&&(a.length&&(i.push(Bh(l,a,n,t,e,r)),a=[]),l=nS(n,t,p,r),l instanceof Ni||l instanceof Sn||(a=[]),u=l.get("mapbox-source")),a.push(p.id)}return i.push(Bh(l,a,n,t,e,r)),Promise.all(i)}function iS(n,e,t={}){let r,i;if(typeof n=="string"||n instanceof HTMLElement?i=new bl({target:n}):i=n,typeof e=="string"){const s=e.startsWith("data:")?location.href:Zs(e,t.accessToken);t=Fp(s,t),r=new Promise(function(o,a){Ap(e,t).then(function(l){Uh(l,i,s,t).then(function(){o(i)}).catch(a)}).catch(function(l){a(new Error(`Could not load ${e}: ${l.message}`))})})}else r=new Promise(function(s,o){Uh(e,i,!t.styleUrl||t.styleUrl.startsWith("data:")?location.href:Zs(t.styleUrl,t.accessToken),t).then(function(){s(i)}).catch(o)});return r}function Bh(n,e,t,r,i,s={}){let o=24,a=0;const l=t.layers;for(let u=0,h=l.length;u<h;++u){const c=l[u];e.indexOf(c.id)!==-1&&(o=Math.min("minzoom"in c?c.minzoom:0,o),a=Math.max("maxzoom"in c?c.maxzoom:24,a))}return new Promise(function(u,h){const c=function(){const p=n.getSource();if(!p||p.getState()==="error"){h(new Error("Error accessing data for source "+n.get("mapbox-source")));return}if("getTileGrid"in p){const d=p.getTileGrid();if(d){const g=d.getMinZoom();(o>0||g>0)&&n.setMaxResolution(Math.min(ai(Math.max(0,o-1e-12),lr),ai(Math.max(0,g-1e-12),d.getResolutions()))),a<24&&n.setMinResolution(ai(a,lr))}}else o>0&&n.setMaxResolution(ai(Math.max(0,o-1e-12),lr));p instanceof Dr||p instanceof Bi?WT(n,t,e,Object.assign({styleUrl:r},s)).then(function(){rS(n,i),u()}).catch(h):u()};n.set("mapbox-layers",e);const f=i.getLayers();f.getArray().indexOf(n)===-1&&f.push(n),n.getSource()?c():n.once("change:source",c)})}class sS extends Ef{constructor(e={}){const{mapboxStyle:t,applyOptions:r,...i}=e;super(i),t&&this.applyMapboxStyle(t,r)}applyMapboxStyle(e,t){return iS(this,e,t)}}mm(ym);window.eoxMapAdvancedOlLayers={Graticule:mb,Heatmap:hx,Layer:lo,VectorImage:px,WebGLPoints:mx,WebGLTile:Bs,WebGLVector:yx,STAC:gu,MapboxStyle:sS};function oS(n){const e=n[0],t=new Array(e);let r=1<<e-1,i,s;for(i=0;i<e;++i)s=48,n[1]&r&&(s+=1),n[2]&r&&(s+=2),t[i]=String.fromCharCode(s),r>>=1;return t.join("")}const aS='<a class="ol-attribution-bing-tos" href="https://www.microsoft.com/maps/product/terms.html" target="_blank">Terms of Use</a>';class lS extends Er{constructor(e){const t=e.hidpi!==void 0?e.hidpi:!1;super({cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,projection:ue("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.hidpi_=t,this.culture_=e.culture!==void 0?e.culture:"en-us",this.maxZoom_=e.maxZoom!==void 0?e.maxZoom:-1,this.apiKey_=e.key,this.imagerySet_=e.imagerySet,this.placeholderTiles_=e.placeholderTiles;const r="https://dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.imagerySet_+"?uriScheme=https&include=ImageryProviders&key="+this.apiKey_+"&c="+this.culture_;fetch(r).then(i=>i.json()).then(i=>this.handleImageryMetadataResponse(i))}getApiKey(){return this.apiKey_}getImagerySet(){return this.imagerySet_}handleImageryMetadataResponse(e){if(e.statusCode!=200||e.statusDescription!="OK"||e.authenticationResultCode!="ValidCredentials"||e.resourceSets.length!=1||e.resourceSets[0].resources.length!=1){this.setState("error");return}const t=e.resourceSets[0].resources[0],r=this.maxZoom_==-1?t.zoomMax:this.maxZoom_,i=this.getProjection(),s=un(i),o=this.hidpi_?2:1,a=t.imageWidth==t.imageHeight?t.imageWidth/o:[t.imageWidth/o,t.imageHeight/o],l=kr({extent:s,minZoom:t.zoomMin,maxZoom:r,tileSize:a});this.tileGrid=l;const u=this.culture_,h=this.hidpi_,c=this.placeholderTiles_;if(this.tileUrlFunction=xl(t.imageUrlSubdomains.map(function(f){const p=[0,0,0],d=t.imageUrl.replace("{subdomain}",f).replace("{culture}",u);return function(g,m,_){if(!g)return;Pa(g[0],g[1],g[2],p);const y=new URL(d.replace("{quadkey}",oS(p))),b=y.searchParams;return h&&(b.set("dpi","d1"),b.set("device","mobile")),c===!0?b.delete("n"):c===!1&&b.set("n","z"),y.toString()}})),t.imageryProviders){const f=ul(ue("EPSG:4326"),this.getProjection());this.setAttributions(p=>{const d=[],g=p.viewState,m=this.getTileGrid(),_=m.getZForResolution(g.resolution,this.zDirection),b=m.getTileCoordForCoordAndZ(g.center,_)[0];return t.imageryProviders.map(function(v){let x=!1;const E=v.coverageAreas;for(let S=0,A=E.length;S<A;++S){const P=E[S];if(b>=P.zoomMin&&b<=P.zoomMax){const R=P.bbox,I=[R[1],R[0],R[3],R[2]],N=Fn(I,f);if(Ln(N,p.extent)){x=!0;break}}}x&&d.push(v.attribution)}),d.push(aS),d})}this.setState("ready")}}class uS extends As{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,maxZoom:e.maxZoom!==void 0?e.maxZoom:18,minZoom:e.minZoom,projection:e.projection,transition:e.transition,wrapX:e.wrapX,zDirection:e.zDirection}),this.account_=e.account,this.mapId_=e.map||"",this.config_=e.config||{},this.templateCache_={},this.initializeMap_()}getConfig(){return this.config_}updateConfig(e){Object.assign(this.config_,e),this.initializeMap_()}setConfig(e){this.config_=e||{},this.initializeMap_()}initializeMap_(){const e=JSON.stringify(this.config_);if(this.templateCache_[e]){this.applyTemplate_(this.templateCache_[e]);return}let t="https://"+this.account_+".carto.com/api/v1/map";this.mapId_&&(t+="/named/"+this.mapId_);const r=new XMLHttpRequest;r.addEventListener("load",this.handleInitResponse_.bind(this,e)),r.addEventListener("error",this.handleInitError_.bind(this)),r.open("POST",t),r.setRequestHeader("Content-type","application/json"),r.send(JSON.stringify(this.config_))}handleInitResponse_(e,t){const r=t.target;if(!r.status||r.status>=200&&r.status<300){let i;try{i=JSON.parse(r.responseText)}catch{this.setState("error");return}this.applyTemplate_(i),this.templateCache_[e]=i,this.setState("ready")}else this.setState("error")}handleInitError_(e){this.setState("error")}applyTemplate_(e){const t="https://"+e.cdn_url.https+"/"+this.account_+"/api/v1/map/"+e.layergroupid+"/{z}/{x}/{y}.png";this.setUrl(t)}}const cS="https://tile.googleapis.com/v1/createSession",hS="https://tile.googleapis.com/v1/2dtiles",fS="https://tile.googleapis.com/tile/v1/viewport",dS=22;class pS extends Er{constructor(e){const t=!!e.highDpi;super({attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,projection:"EPSG:3857",reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.apiKey_=e.key,this.error_=null;const r={mapType:e.mapType||"roadmap",language:e.language||"en-US",region:e.region||"US"};e.imageFormat&&(r.imageFormat=e.imageFormat),e.scale&&(r.scale=e.scale),t&&(r.highDpi=!0),e.layerTypes&&(r.layerTypes=e.layerTypes),e.styles&&(r.styles=e.styles),e.overlay===!0&&(r.overlay=!0),e.apiOptions&&(r.apiOptions=e.apiOptions),this.sessionTokenRequest_=r,this.sessionTokenValue_,this.sessionRefreshId_,this.previousViewportAttribution_,this.previousViewportExtent_,this.createSession_()}getError(){return this.error_}fetchSessionToken(e,t){return fetch(e,t)}async createSession_(){const e=cS+"?key="+this.apiKey_,t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.sessionTokenRequest_)},r=await this.fetchSessionToken(e,t);if(!r.ok){try{const c=await r.json();this.error_=new Error(c.error.message)}catch{this.error_=new Error("Error fetching session token")}this.setState("error");return}const i=await r.json(),s=this.getTilePixelRatio(1),o=[i.tileWidth/s,i.tileHeight/s];this.tileGrid=kr({extent:un(this.getProjection()),maxZoom:dS,tileSize:o});const a=i.session;this.sessionTokenValue_=a;const l=this.apiKey_;this.tileUrlFunction=function(c,f,p){const d=c[0],g=c[1],m=c[2];return`${hS}/${d}/${g}/${m}?session=${a}&key=${l}`};const u=parseInt(i.expiry,10)*1e3,h=Math.max(u-Date.now()-60*1e3,1);this.sessionRefreshId_=setTimeout(()=>this.createSession_(),h),this.setAttributions(this.fetchAttributions_.bind(this)),this.setState("ready")}async fetchAttributions_(e){if(e.viewHints[Gr.ANIMATING]||e.viewHints[Gr.INTERACTING]||e.animate)return this.previousViewportAttribution_;const[t,r]=Ju(Ig(e.extent),e.viewState.projection),[i,s]=Ju(Cg(e.extent),e.viewState.projection),l=`zoom=${this.getTileGrid().getZForResolution(e.viewState.resolution,this.zDirection)}&north=${s}&south=${r}&east=${i}&west=${t}`;if(this.previousViewportExtent_==l)return this.previousViewportAttribution_;this.previousViewportExtent_=l;const u=this.sessionTokenValue_,h=this.apiKey_,c=`${fS}?session=${u}&key=${h}&${l}`;return this.previousViewportAttribution_=await fetch(c).then(f=>f.json()).then(f=>f.copyright),this.previousViewportAttribution_}disposeInternal(){clearTimeout(this.sessionRefreshId_),super.disposeInternal()}}let Gp=class extends pl{constructor(e,t,r,i,s,o,a){super(t,r,i,s,o,a),this.zoomifyImage_=null,this.tileSize_=e}getImage(){if(this.zoomifyImage_)return this.zoomifyImage_;const e=super.getImage();if(this.state==Q.LOADED){const t=this.tileSize_;if(e.width==t[0]&&e.height==t[1])return this.zoomifyImage_=e,e;const r=Br(t[0],t[1]);return r.drawImage(e,0,0),this.zoomifyImage_=r.canvas,r.canvas}return e}};class gS extends Er{constructor(e){const t=e.size,r=e.tierSizeCalculation!==void 0?e.tierSizeCalculation:"default",i=e.tilePixelRatio||1,s=t[0],o=t[1],a=[],l=e.tileSize||Aa;let u=l*i;switch(r){case"default":for(;s>u||o>u;)a.push([Math.ceil(s/u),Math.ceil(o/u)]),u+=u;break;case"truncated":let E=s,S=o;for(;E>u||S>u;)a.push([Math.ceil(E/u),Math.ceil(S/u)]),E>>=1,S>>=1;break;default:throw new Error("Unknown `tierSizeCalculation` configured")}a.push([1,1]),a.reverse();const h=[i],c=[0];for(let E=1,S=a.length;E<S;E++)h.push(i<<E),c.push(a[E-1][0]*a[E-1][1]+c[E-1]);h.reverse();const f=new Ui({tileSize:l,extent:e.extent||[0,-o,s,0],resolutions:h});let p=e.url;p&&!p.includes("{TileGroup}")&&!p.includes("{tileIndex}")&&(p+="{TileGroup}/{z}-{x}-{y}.jpg");const d=yf(p);let g=l*i;function m(E){return function(S,A,P){if(!S)return;const R=S[0],I=S[1],N=S[2],X=I+N*a[R][0],M=(X+c[R])/g|0,F={z:R,x:I,y:N,tileIndex:X,TileGroup:"TileGroup"+M};return E.replace(/\{(\w+?)\}/g,function($,z){return F[z]})}}const _=xl(d.map(m)),y=Gp.bind(null,Vt(l*i));super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,tilePixelRatio:i,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileClass:y,tileGrid:f,tileUrlFunction:_,transition:e.transition}),this.zDirection=e.zDirection;const b=f.getTileCoordForCoordAndResolution(nr(f.getExtent()),h[h.length-1]),v=_(b,1,null),x=new Image;x.addEventListener("error",()=>{g=l,this.changed()}),x.src=v}}function ni(n){return n.toLocaleString("en",{maximumFractionDigits:10})}class mS extends Er{constructor(e){const t=e||{};let r=t.url||"";r=r+(r.lastIndexOf("/")===r.length-1||r===""?"":"/");const i=t.version||We.VERSION2,s=t.sizes||[],o=t.size;Mt(o!=null&&Array.isArray(o)&&o.length==2&&!isNaN(o[0])&&o[0]>0&&!isNaN(o[1])&&o[1]>0,"Missing or invalid `size`");const a=o[0],l=o[1],u=t.tileSize,h=t.tilePixelRatio||1,c=t.format||"jpg",f=t.quality||(t.version==We.VERSION1?"native":"default");let p=t.resolutions||[];const d=t.supports||[],g=t.extent||[0,-l,a,0],m=s!=null&&Array.isArray(s)&&s.length>0,_=u!==void 0&&(typeof u=="number"&&Number.isInteger(u)&&u>0||Array.isArray(u)&&u.length>0),y=d!=null&&Array.isArray(d)&&(d.includes("regionByPx")||d.includes("regionByPct"))&&(d.includes("sizeByWh")||d.includes("sizeByH")||d.includes("sizeByW")||d.includes("sizeByPct"));let b,v,x;if(p.sort(function(P,R){return R-P}),_||y)if(u!=null&&(typeof u=="number"&&Number.isInteger(u)&&u>0?(b=u,v=u):Array.isArray(u)&&u.length>0&&((u.length==1||u[1]==null&&Number.isInteger(u[0]))&&(b=u[0],v=u[0]),u.length==2&&(Number.isInteger(u[0])&&Number.isInteger(u[1])?(b=u[0],v=u[1]):u[0]==null&&Number.isInteger(u[1])&&(b=u[1],v=u[1])))),(b===void 0||v===void 0)&&(b=Aa,v=Aa),p.length==0){x=Math.max(Math.ceil(Math.log(a/b)/Math.LN2),Math.ceil(Math.log(l/v)/Math.LN2));for(let P=x;P>=0;P--)p.push(Math.pow(2,P))}else{const P=Math.max(...p);x=Math.round(Math.log(P)/Math.LN2)}else if(b=a,v=l,p=[],m){s.sort(function(R,I){return R[0]-I[0]}),x=-1;const P=[];for(let R=0;R<s.length;R++){const I=a/s[R][0];if(p.length>0&&p[p.length-1]==I){P.push(R);continue}p.push(I),x++}if(P.length>0)for(let R=0;R<P.length;R++)s.splice(P[R]-R,1)}else p.push(1),s.push([a,l]),x=0;const E=new Ui({tileSize:[b,v],extent:g,origin:vs(g),resolutions:p}),S=function(P,R,I){let N,X;const M=P[0];if(M>x)return;const F=P[1],$=P[2],z=p[M];if(!(F===void 0||$===void 0||z===void 0||F<0||Math.ceil(a/z/b)<=F||$<0||Math.ceil(l/z/v)<=$)){if(y||_){const ne=F*b*z,Z=$*v*z;let C=b*z,he=v*z,ve=b,Y=v;if(ne+C>a&&(C=a-ne),Z+he>l&&(he=l-Z),ne+b*z>a&&(ve=Math.floor((a-ne+z-1)/z)),Z+v*z>l&&(Y=Math.floor((l-Z+z-1)/z)),ne==0&&C==a&&Z==0&&he==l)N="full";else if(!y||d.includes("regionByPx"))N=ne+","+Z+","+C+","+he;else if(d.includes("regionByPct")){const Le=ni(ne/a*100),fe=ni(Z/l*100),_e=ni(C/a*100),Ie=ni(he/l*100);N="pct:"+Le+","+fe+","+_e+","+Ie}i==We.VERSION3&&(!y||d.includes("sizeByWh"))?X=ve+","+Y:!y||d.includes("sizeByW")?X=ve+",":d.includes("sizeByH")?X=","+Y:d.includes("sizeByWh")?X=ve+","+Y:d.includes("sizeByPct")&&(X="pct:"+ni(100/z))}else if(N="full",m){const ne=s[M][0],Z=s[M][1];i==We.VERSION3?ne==a&&Z==l?X="max":X=ne+","+Z:ne==a?X="full":X=ne+","}else X=i==We.VERSION3?"max":"full";return r+N+"/"+X+"/0/"+f+"."+c}},A=Gp.bind(null,Vt(u||256).map(function(P){return P*h}));super({attributions:t.attributions,attributionsCollapsible:t.attributionsCollapsible,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,interpolate:t.interpolate,projection:t.projection,reprojectionErrorThreshold:t.reprojectionErrorThreshold,state:t.state,tileClass:A,tileGrid:E,tilePixelRatio:t.tilePixelRatio,tileUrlFunction:S,transition:t.transition}),this.zDirection=t.zDirection}}function zp(n,e,t,r,i,s){const o=i.getCode().split(/:(?=\d+$)/).pop(),a=t/r,l=[ec(it(e)/a,rc),ec(jt(e)/a,rc)];s.SIZE=l[0]+","+l[1],s.BBOX=e.join(","),s.BBOXSR=o,s.IMAGESR=o,s.DPI=Math.round(s.DPI?s.DPI*r:90*r);const u=n.replace(/MapServer\/?$/,"MapServer/export").replace(/ImageServer\/?$/,"ImageServer/exportImage");return Cs(u,s)}function yS(n){const e=n.load?n.load:kn,t=ue(n.projection||"EPSG:3857"),r=n.ratio??1.5,i=n.crossOrigin??null;return function(s,o,a){a=n.hidpi?a:1;const l={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};Object.assign(l,n.params),s=_f(s,o,a,r);const u=zp(n.url,s,o,a,t,l),h=new Image;return h.crossOrigin=i,e(h,u).then(c=>{const f=it(s)/c.width*a;return{image:c,extent:s,resolution:f,pixelRatio:a}})}}class _S extends cn{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:yl,this.params_=Object.assign({},e.params),this.imageSize_=[0,0],this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(e,t,r,i){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==i)&&(this.loaderProjection_=i,this.loader=yS({crossOrigin:this.crossOrigin_,params:this.params_,projection:i,hidpi:this.hidpi_,url:this.url_,ratio:this.ratio_,load:(s,o)=>(this.image.setImage(s),this.imageLoadFunction_(this.image,o),kn(s))})),super.getImageInternal(e,t,r,i))}getImageLoadFunction(){return this.imageLoadFunction_}getUrl(){return this.url_}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}setUrl(e){e!=this.url_&&(this.url_=e,this.loader=null,this.changed())}setParams(e){this.params_=Object.assign({},e),this.changed()}updateParams(e){Object.assign(this.params_,e),this.changed()}changed(){this.image=null,super.changed()}}class bS extends cn{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions,state:e.state}),this.canvasFunction_=e.canvasFunction,this.canvas_=null,this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5}getImageInternal(e,t,r,i){t=this.findNearestResolution(t);let s=this.canvas_;if(s&&this.renderedRevision_==this.getRevision()&&s.getResolution()==t&&s.getPixelRatio()==r&&xs(s.getExtent(),e))return s;e=e.slice(),nf(e,this.ratio_);const o=it(e)/t,a=jt(e)/t,l=[o*r,a*r],u=this.canvasFunction_.call(this,e,t,r,l,i);return u&&(s=new Xl(e,t,r,u)),this.canvas_=s,this.renderedRevision_=this.getRevision(),s}}function xS(n,e,t,r){const i=it(n),s=jt(n),o=e[0],a=e[1],l=.0254/r;return a*i>o*s?i*t/(o*l):s*t/(a*l)}function ES(n,e,t,r,i,s,o){const a=xS(t,r,s,o),l=nr(t),u={OPERATION:i?"GETDYNAMICMAPOVERLAYIMAGE":"GETMAPIMAGE",VERSION:"2.0.0",LOCALE:"en",CLIENTAGENT:"ol/source/ImageMapGuide source",CLIP:"1",SETDISPLAYDPI:o,SETDISPLAYWIDTH:Math.round(r[0]),SETDISPLAYHEIGHT:Math.round(r[1]),SETVIEWSCALE:a,SETVIEWCENTERX:l[0],SETVIEWCENTERY:l[1]};return Object.assign(u,e),Cs(n,u)}function wS(n){const e=n.load||kn,t=n.useOverlay??!1,r=n.metersPerUnit||1,i=n.displayDpi||96,s=n.ratio??1,o=n.crossOrigin??null;return function(a,l,u){const h=new Image;h.crossOrigin=o,a=_f(a,l,u,s);const c=it(a)/l,f=jt(a)/l,p=[c*u,f*u],d=ES(n.url,n.params,a,p,t,r,i);return e(h,d).then(g=>({image:g,extent:a,pixelRatio:u}))}}class vS extends cn{constructor(e){super({interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.displayDpi_=e.displayDpi!==void 0?e.displayDpi:96,this.params_=Object.assign({},e.params),this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:yl,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.metersPerUnit_=e.metersPerUnit!==void 0?e.metersPerUnit:1,this.ratio_=e.ratio!==void 0?e.ratio:1,this.useOverlay_=e.useOverlay!==void 0?e.useOverlay:!1,this.renderedRevision_=0,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(e,t,r,i){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==i)&&(this.loaderProjection_=i,this.loader=wS({crossOrigin:this.crossOrigin_,params:this.params_,hidpi:this.hidpi_,metersPerUnit:this.metersPerUnit_,url:this.url_,useOverlay:this.useOverlay_,ratio:this.ratio_,load:(s,o)=>(this.image.setImage(s),this.imageLoadFunction_(this.image,o),kn(s))})),super.getImageInternal(e,t,r,i))}getImageLoadFunction(){return this.imageLoadFunction_}setParams(e){this.params_=Object.assign({},e),this.changed()}updateParams(e){Object.assign(this.params_,e),this.changed()}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}changed(){this.image=null,super.changed()}}const TS=new Error("Image failed to load");function kp(n,e,t,r,i){return new Promise((s,o)=>{const a=new Image;a.crossOrigin=i.crossOrigin??null,a.addEventListener("load",()=>s(a)),a.addEventListener("error",()=>o(TS)),a.src=bf(n,e,t,r,i.maxY)})}function Gh(n){return function(e,t,r,i){const s=_m(n,e,t,r);return kp(s,e,t,r,i)}}function SS(n){return function(e,t,r,i){const s=n(e,t,r,i);return kp(s,e,t,r,i)}}function zh(n){let e;if(Array.isArray(n))e=Gh(n);else if(typeof n=="string"){const t=yf(n);e=Gh(t)}else if(typeof n=="function")e=SS(n);else throw new Error("The url option must be a single template, an array of templates, or a function for getting a URL");return e}let kh=0;function $h(n){return Array.isArray(n)?n.join(`
`):typeof n=="string"?n:(++kh,"url-function-key-"+kh)}class $p extends Zi{constructor(e){e=e||{};let t=e.loader,r;e.url&&(t=zh(e.url),r=$h(e.url));const i=t?e.state:"loading",s=e.wrapX===void 0?!0:e.wrapX;super({loader:t,key:r,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize,gutter:e.gutter,maxResolution:e.maxResolution,projection:e.projection,tileGrid:e.tileGrid,state:i,wrapX:s,transition:e.transition,interpolate:e.interpolate!==!1,crossOrigin:e.crossOrigin,zDirection:e.zDirection})}setUrl(e){const t=zh(e);this.setLoader(t),this.setKey($h(e)),this.getState()!=="ready"&&this.setState("ready")}}const RS={"image/png":!0,"image/jpeg":!0,"image/gif":!0,"image/webp":!0},PS={"application/vnd.mapbox-vector-tile":!0,"application/geo+json":!0};function jp(n,e){if(!e.length)return n;const t=new URL(n,"file:/");if(t.pathname.split("/").includes("collections"))return _i('The "collections" query parameter cannot be added to collection endpoints'),n;const r=e.map(o=>encodeURIComponent(o)).join(",");t.searchParams.append("collections",r);const i=n.split("?")[0],s=decodeURIComponent(t.searchParams.toString());return`${i}?${s}`}function AS(n,e,t){let r,i;for(let s=0;s<n.length;++s){const o=n[s];if(o.rel==="item"){if(o.type===e){r=o.href;break}(RS[o.type]||!i&&o.type.startsWith("image/"))&&(i=o.href)}}if(!r)if(i)r=i;else throw new Error('Could not find "item" link');return t&&(r=jp(r,t)),r}function IS(n,e,t,r){let i,s;const o={};for(let a=0;a<n.length;++a){const l=n[a];if(o[l.type]=l.href,l.rel==="item"){if(l.type===e){i=l.href;break}PS[l.type]&&(s=l.href)}}if(!i&&t)for(let a=0;a<t.length;++a){const l=t[a];if(o[l]){i=o[l];break}}if(!i)if(s)i=s;else throw new Error('Could not find "item" link');return r&&(i=jp(i,r)),i}function jh(n,e,t,r){let i=n.projection;if(!i&&(typeof e.crs=="string"?i=ue(e.crs):"uri"in e.crs&&(i=ue(e.crs.uri)),!i))throw new Error(`Unsupported CRS: ${JSON.stringify(e.crs)}`);const s=e.orderedAxes,a=!(s?s.slice(0,2).map(E=>E.replace(/E|X|Lon/i,"e").replace(/N|Y|Lat/i,"n")).join(""):i.getAxisOrientation()).startsWith("en"),l=e.tileMatrices,u={};for(let E=0;E<l.length;++E){const S=l[E];u[S.id]=S}const h={},c=[];if(r)for(let E=0;E<r.length;++E){const S=r[E],A=S.tileMatrix;c.push(A),h[A]=S}else for(let E=0;E<l.length;++E){const S=l[E].id;c.push(S)}const f=c.length,p=new Array(f),d=new Array(f),g=new Array(f),m=new Array(f),_=[-1/0,-1/0,1/0,1/0];for(let E=0;E<f;++E){const S=c[E],A=u[S],P=A.pointOfOrigin;a?p[E]=[P[1],P[0]]:p[E]=P,d[E]=A.cellSize,g[E]=[A.matrixWidth,A.matrixHeight],m[E]=[A.tileWidth,A.tileHeight];const R=h[S];if(R){const I=A.cellSize*A.tileWidth,N=p[E][0]+R.minTileCol*I,X=p[E][0]+(R.maxTileCol+1)*I,M=A.cellSize*A.tileHeight,F=A.cornerOfOrigin==="bottomLeft";let $,z;F?($=p[E][1]+R.minTileRow*M,z=p[E][1]+(R.maxTileRow+1)*M):($=p[E][1]-(R.maxTileRow+1)*M,z=p[E][1]-R.minTileRow*M),rr(_,[N,$,X,z],_)}}const y=new Ui({origins:p,resolutions:d,sizes:g,tileSizes:m,extent:r?_:void 0}),b=n.context,v=n.url;function x(E,S,A){if(!E)return;const P=c[E[0]],R=u[P],I=R.cornerOfOrigin==="bottomLeft",N={tileMatrix:P,tileCol:E[1],tileRow:I?-E[2]-1:E[2]};if(r){const M=h[R.id];if(N.tileCol<M.minTileCol||N.tileCol>M.maxTileCol||N.tileRow<M.minTileRow||N.tileRow>M.maxTileRow)return}Object.assign(N,b);const X=t.replace(/\{(\w+?)\}/g,function(M,F){return N[F]});return Yd(v,X)}return{grid:y,projection:i,urlTemplate:t,urlFunction:x}}function CS(n,e){const t=e.tileMatrixSetLimits;let r;if(e.dataType==="map")r=AS(e.links,n.mediaType,n.collections);else if(e.dataType==="vector")r=IS(e.links,n.mediaType,n.supportedMediaTypes,n.collections);else throw new Error('Expected tileset data type to be "map" or "vector"');if(e.tileMatrixSet)return jh(n,e.tileMatrixSet,r,t);const i=e.links.find(a=>a.rel==="http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme");if(!i)throw new Error("Expected http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme link or tileMatrixSet");const s=i.href,o=Yd(n.url,s);return Hd(o).then(function(a){return jh(n,a,r,t)})}function Vp(n){return Hd(n.url).then(function(e){return CS(n,e)})}class LS extends Er{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition});const t={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,context:e.context||null,collections:e.collections};Vp(t).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.projection=e.projection,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){_i(e),this.setState("error")}}class FS extends Bi{constructor(e){super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,format:e.format,overlaps:e.overlaps,projection:e.projection,tileClass:e.tileClass,transition:e.transition,wrapX:e.wrapX,zDirection:e.zDirection,state:"loading"});const t={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,supportedMediaTypes:e.format.supportedMediaTypes,context:e.context||null,collections:e.collections};Vp(t).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.projection=e.projection,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){_i(e),this.setState("error")}}const MS='&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a>',OS='&copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a>',NS='&copy; <a href="https://stamen.com/" target="_blank">Stamen Design</a>',DS={stamen_terrain:{extension:"png"},stamen_terrain_background:{extension:"png"},stamen_terrain_labels:{extension:"png"},stamen_terrain_lines:{extension:"png"},stamen_toner_background:{extension:"png"},stamen_toner:{extension:"png"},stamen_toner_labels:{extension:"png"},stamen_toner_lines:{extension:"png"},stamen_toner_lite:{extension:"png"},stamen_watercolor:{extension:"jpg"},alidade_smooth:{extension:"png"},alidade_smooth_dark:{extension:"png"},alidade_satellite:{extension:"png"},outdoors:{extension:"png"},osm_bright:{extension:"png"}},US={stamen_terrain:{minZoom:0,maxZoom:18,retina:!0},stamen_toner:{minZoom:0,maxZoom:20,retina:!0},stamen_watercolor:{minZoom:1,maxZoom:18,retina:!1}};class BS extends As{constructor(e){const t=e.layer.indexOf("-"),r=t==-1?e.layer:e.layer.slice(0,t),i=US[r]||{minZoom:0,maxZoom:20,retina:!0},s=DS[e.layer],o=e.apiKey?"?api_key="+e.apiKey:"",a=i.retina&&e.retina?"@2x":"",l=e.url!==void 0?e.url:"https://tiles.stadiamaps.com/tiles/"+e.layer+"/{z}/{x}/{y}"+a+"."+s.extension+o,u=[MS,OS,bm];e.layer.startsWith("stamen_")&&u.splice(1,0,NS),super({attributions:u,cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,maxZoom:e.maxZoom!==void 0?e.maxZoom:i.maxZoom,minZoom:e.minZoom!==void 0?e.minZoom:i.minZoom,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileLoadFunction:e.tileLoadFunction,transition:e.transition,url:l,tilePixelRatio:a?2:1,wrapX:e.wrapX,zDirection:e.zDirection})}}class GS extends Er{constructor(e){e=e||{},super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileGrid:e.tileGrid,tileLoadFunction:e.tileLoadFunction,url:e.url,urls:e.urls,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.params_=Object.assign({},e.params),this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.tmpExtent_=Oi(),this.setKey(this.getKeyForParams_())}getKeyForParams_(){let e=0;const t=[];for(const r in this.params_)t[e++]=r+"-"+this.params_[r];return t.join("/")}getParams(){return this.params_}getRequestUrl_(e,t,r,i,s,o){const a=this.urls;if(!a)return;let l;if(a.length==1)l=a[0];else{const u=Lg(xm(e),a.length);l=a[u]}return zp(l,r,(this.tileGrid||this.getTileGridForProjection(s)).getResolution(e[0]),i,s,o)}getTilePixelRatio(e){return this.hidpi_?e:1}setParams(e){this.params_=Object.assign({},e),this.setKey(this.getKeyForParams_())}updateParams(e){Object.assign(this.params_,e),this.setKey(this.getKeyForParams_())}tileUrlFunction(e,t,r){let i=this.getTileGrid();if(i||(i=this.getTileGridForProjection(r)),i.getResolutions().length<=e[0])return;t!=1&&!this.hidpi_&&(t=1);const s=i.getTileCoordExtent(e,this.tmpExtent_);let o=Vt(i.getTileSize(e[0]),this.tmpSize);t!=1&&(o=Em(o,t,this.tmpSize));const a={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};return Object.assign(a,this.params_),this.getRequestUrl_(e,o,s,t,r,a)}}class zS extends $p{constructor(e){e=e||{};const t=e.template||"z:{z} x:{x} y:{y}",r=e.source,i=e.color||"grey";super({transition:0,wrapX:e.wrapX!==void 0?e.wrapX:r!==void 0?r.getWrapX():void 0});const s=()=>{var a;this.projection=e.projection!==void 0?ue(e.projection):r!==void 0?r.getProjection():this.projection,this.tileGrid=e.tileGrid!==void 0?e.tileGrid:r!==void 0?r.getTileGrid():this.tileGrid,this.zDirection=e.zDirection!==void 0?e.zDirection:r!==void 0?r.zDirection:this.zDirection,r instanceof Zi&&(this.transformMatrix=((a=r.transformMatrix)==null?void 0:a.slice())||null);const o=this.tileGrid;o&&this.setTileSizes(o.getResolutions().map((l,u)=>Vt(o.getTileSize(u)).map(h=>Math.max(Math.floor(h),1)))),this.setLoader((l,u,h,c)=>{const f=bf(t,l,u,h,c.maxY),[p,d]=this.getTileSize(l),g=Br(p,d);return g.strokeStyle=i,g.strokeRect(.5,.5,p+.5,d+.5),g.fillStyle=i,g.strokeStyle="white",g.textAlign="center",g.textBaseline="middle",g.font="24px sans-serif",g.lineWidth=4,g.strokeText(f,p/2,d/2,p),g.fillText(f,p/2,d/2,p),Promise.resolve(g.canvas)}),this.setState("ready")};if(r===void 0||r.getState()==="ready")s();else{const o=()=>{r.getState()==="ready"&&(r.removeEventListener(ft.CHANGE,o),s())};r.addEventListener(ft.CHANGE,o)}}}class kS extends Tm{constructor(e,t,r,i,s,o){super(e,t),this.src_=r,this.extent_=i,this.preemptive_=s,this.grid_=null,this.keys_=null,this.data_=null,this.jsonp_=o}getImage(){return null}getData(e){if(!this.grid_||!this.keys_)return null;const t=(e[0]-this.extent_[0])/(this.extent_[2]-this.extent_[0]),r=(e[1]-this.extent_[1])/(this.extent_[3]-this.extent_[1]),i=this.grid_[Math.floor((1-r)*this.grid_.length)];if(typeof i!="string")return null;let s=i.charCodeAt(Math.floor(t*i.length));s>=93&&s--,s>=35&&s--,s-=32;let o=null;if(s in this.keys_){const a=this.keys_[s];this.data_&&a in this.data_?o=this.data_[a]:o=a}return o}forDataAtCoordinate(e,t,r){this.state==Q.EMPTY&&r===!0?(this.state=Q.IDLE,Fg(this,ft.CHANGE,i=>{t(this.getData(e))}),this.loadInternal_()):r===!0?setTimeout(()=>{t(this.getData(e))},0):t(this.getData(e))}getKey(){return this.src_}handleError_(){this.state=Q.ERROR,this.changed()}handleLoad_(e){this.grid_=e.grid,this.keys_=e.keys,this.data_=e.data,this.state=Q.LOADED,this.changed()}loadInternal_(){if(this.state==Q.IDLE)if(this.state=Q.LOADING,this.jsonp_)pu(this.src_,this.handleLoad_.bind(this),this.handleError_.bind(this));else{const e=new XMLHttpRequest;e.addEventListener("load",this.onXHRLoad_.bind(this)),e.addEventListener("error",this.onXHRError_.bind(this)),e.open("GET",this.src_),e.send()}}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleError_();return}this.handleLoad_(r)}else this.handleError_()}onXHRError_(e){this.handleError_()}load(){this.preemptive_?this.loadInternal_():this.setState(Q.EMPTY)}}class $S extends ml{constructor(e){if(super({projection:ue("EPSG:3857"),state:"loading",wrapX:e.wrapX!==void 0?e.wrapX:!0,zDirection:e.zDirection}),this.preemptive_=e.preemptive!==void 0?e.preemptive:!0,this.tileUrlFunction_=wm,this.template_=void 0,this.jsonp_=e.jsonp||!1,this.tileCache_=new lf(512),e.url)if(this.jsonp_)pu(e.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",e.url),t.send()}else if(e.tileJSON)this.handleTileJSONResponse(e.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(r)}else this.handleTileJSONError()}onXHRError_(e){this.handleTileJSONError()}getTemplate(){return this.template_}forDataAtCoordinateAndResolution(e,t,r,i){if(this.tileGrid){const s=this.tileGrid.getZForResolution(t,this.zDirection),o=this.tileGrid.getTileCoordForCoordAndZ(e,s),a=this.getTile(o[0],o[1],o[2],1,this.getProjection());a.getState()==Q.IDLE&&a.load(),a.forDataAtCoordinate(e,r,i)}else i===!0?setTimeout(function(){r(null)},0):r(null)}handleTileJSONError(){this.setState("error")}handleTileJSONResponse(e){const t=ue("EPSG:4326"),r=this.getProjection();let i;if(e.bounds!==void 0){const h=ul(t,r);i=Fn(e.bounds,h)}const s=un(r),o=e.minzoom||0,a=e.maxzoom||22,l=kr({extent:s,maxZoom:a,minZoom:o});this.tileGrid=l,this.template_=e.template;const u=e.grids;if(!u){this.setState("error");return}if(this.tileUrlFunction_=ff(u,l),e.attribution){const h=i!==void 0?i:s;this.setAttributions(function(c){return Ln(h,c.extent)?[e.attribution]:null})}this.setState("ready")}getTile(e,t,r,i,s){const o=[e,t,r],a=this.getTileCoordForTileUrlFunction(o,s),l=this.tileUrlFunction_(a,i,s),u=`${this.getKey()},${vm(e,t,r)}`;if(this.tileCache_.containsKey(u))return this.tileCache_.get(u);this.tileCache_.expireCache();const h=new kS(o,l!==void 0?Q.IDLE:Q.EMPTY,l!==void 0?l:"",this.tileGrid.getTileCoordExtent(o),this.preemptive_,this.jsonp_);return this.tileCache_.set(u,h),h}}class jS extends Dr{constructor(e){e=e||{},super({attributions:e.attributions,wrapX:e.wrapX}),this.resolution=void 0,this.distance=e.distance!==void 0?e.distance:20,this.minDistance=e.minDistance||0,this.interpolationRatio=0,this.features=[],this.geometryFunction=e.geometryFunction||function(t){const r=t.getGeometry();return Mt(!r||r.getType()==="Point","The default `geometryFunction` can only handle `Point` or null geometries"),r},this.createCustomCluster_=e.createCluster,this.source=null,this.boundRefresh_=this.refresh.bind(this),this.updateDistance(this.distance,this.minDistance),this.setSource(e.source||null)}clear(e){this.features.length=0,super.clear(e)}getDistance(){return this.distance}getSource(){return this.source}loadFeatures(e,t,r){var i;(i=this.source)==null||i.loadFeatures(e,t,r),t!==this.resolution&&(this.resolution=t,this.refresh())}setDistance(e){this.updateDistance(e,this.minDistance)}setMinDistance(e){this.updateDistance(this.distance,e)}getMinDistance(){return this.minDistance}setSource(e){this.source&&this.source.removeEventListener(ft.CHANGE,this.boundRefresh_),this.source=e,e&&e.addEventListener(ft.CHANGE,this.boundRefresh_),this.refresh()}refresh(){this.clear(),this.cluster(),this.addFeatures(this.features)}updateDistance(e,t){const r=e===0?0:Math.min(t,e)/e,i=e!==this.distance||this.interpolationRatio!==r;this.distance=e,this.minDistance=t,this.interpolationRatio=r,i&&this.refresh()}cluster(){if(this.resolution===void 0||!this.source)return;const e=Oi(),t=this.distance*this.resolution,r=this.source.getFeatures(),i={};for(let s=0,o=r.length;s<o;s++){const a=r[s];if(!(me(a)in i)){const l=this.geometryFunction(a);if(l){const u=l.getCoordinates();Mg(u,e),fl(e,t,e);const h=this.source.getFeaturesInExtent(e).filter(function(c){const f=me(c);return f in i?!1:(i[f]=!0,!0)});this.features.push(this.createCluster(h,e))}}}}createCluster(e,t){const r=[0,0];for(let a=e.length-1;a>=0;--a){const l=this.geometryFunction(e[a]);l?mg(r,l.getCoordinates()):e.splice(a,1)}yg(r,1/e.length);const i=nr(t),s=this.interpolationRatio,o=new zt([r[0]*(1-s)+i[0]*s,r[1]*(1-s)+i[1]*s]);return this.createCustomCluster_?this.createCustomCluster_(o,e):new Ft({geometry:o,features:e})}}class Hs extends jS{constructor(e={}){super({...e,createCluster:Hs.defaultCreateCluster,geometryFunction:Hs.defaultGeometryFunction})}static defaultCreateCluster(e,t){const r=t.length===1&&t[0].getGeometry()instanceof Cn?t[0].getGeometry():e,i=new Ft({geometry:r,features:t});if(t.length===1){const s=t[0];for(const o in s.getProperties())o!=="geometry"&&i.set(o,s.get(o))}return i}static defaultGeometryFunction(e){const t=e&&e.getGeometry();return t instanceof zt?t:t instanceof Cn?t.getInteriorPoint():null}}class VS extends Er{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,tilePixelRatio:e.tilePixelRatio,transition:e.transition,interpolate:e.interpolate!==void 0?e.interpolate:!0,key:e.key,attributionsCollapsible:e.attributionsCollapsible,zDirection:e.zDirection,wrapX:e.wrapX}),this.version_=e.version!==void 0?e.version:"1.0.0",this.dimensions_=e.dimensions!==void 0?e.dimensions:{},this.layer_=e.layer,fetch(e.url).then(t=>t.text()).then(t=>new window.DOMParser().parseFromString(t,"application/xml")).then(t=>{this.handleCapabilitiesResponse(t,e)})}handleCapabilitiesResponse(e,t){const i=new Nl().read(e),s=gf(i,t);this.crossOrigin=s.crossOrigin,this.projection=s.projection,this.tileGrid=s.tileGrid,this.requestEncoding_=s.requestEncoding,this.matrixSet_=s.matrixSet,this.style_=s.style,this.format_=s.format,this.dimensions_=s.dimensions,this.setUrls(s.urls),this.urls&&this.urls.length>0&&(this.tileUrlFunction=xl(this.urls.map(this.createFromWMTSTemplate.bind(this)))),this.setState("ready")}createFromWMTSTemplate(e){const t=this.requestEncoding_,r={layer:this.layer_,style:this.style_,tilematrixset:this.matrixSet_};t==="KVP"&&Object.assign(r,{Service:"WMTS",Request:"GetTile",Version:this.version_,Format:this.format_}),e=t==="KVP"?Cs(e,r):e.replace(/\{(\w+?)\}/g,(o,a)=>a.toLowerCase()in r?r[a.toLowerCase()]:o);const i=this.tileGrid,s=this.dimensions_;return function(o){if(!o)return;const a={TileMatrix:i.getMatrixId(o[0]),TileCol:o[1],TileRow:o[2]};Object.assign(a,s);let l=e;return t==="KVP"?l=Cs(l,a):l=l.replace(/\{(\w+?)\}/g,(u,h)=>a[h]),l}}}const pr=new Uint8Array([102,103,98,3,102,103,98,0]),Tt=4,ii=4,si=4,Ki=4,Ir=new Int32Array(2),Vh=new Float32Array(Ir.buffer),Xh=new Float64Array(Ir.buffer),fs=new Uint16Array(new Uint8Array([1,0]).buffer)[0]===1;var el;(function(n){n[n.UTF8_BYTES=1]="UTF8_BYTES",n[n.UTF16_STRING=2]="UTF16_STRING"})(el||(el={}));class Xt{constructor(e){this.bytes_=e,this.position_=0,this.text_decoder_=new TextDecoder}static allocate(e){return new Xt(new Uint8Array(e))}clear(){this.position_=0}bytes(){return this.bytes_}position(){return this.position_}setPosition(e){this.position_=e}capacity(){return this.bytes_.length}readInt8(e){return this.readUint8(e)<<24>>24}readUint8(e){return this.bytes_[e]}readInt16(e){return this.readUint16(e)<<16>>16}readUint16(e){return this.bytes_[e]|this.bytes_[e+1]<<8}readInt32(e){return this.bytes_[e]|this.bytes_[e+1]<<8|this.bytes_[e+2]<<16|this.bytes_[e+3]<<24}readUint32(e){return this.readInt32(e)>>>0}readInt64(e){return BigInt.asIntN(64,BigInt(this.readUint32(e))+(BigInt(this.readUint32(e+4))<<BigInt(32)))}readUint64(e){return BigInt.asUintN(64,BigInt(this.readUint32(e))+(BigInt(this.readUint32(e+4))<<BigInt(32)))}readFloat32(e){return Ir[0]=this.readInt32(e),Vh[0]}readFloat64(e){return Ir[fs?0:1]=this.readInt32(e),Ir[fs?1:0]=this.readInt32(e+4),Xh[0]}writeInt8(e,t){this.bytes_[e]=t}writeUint8(e,t){this.bytes_[e]=t}writeInt16(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8}writeUint16(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8}writeInt32(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8,this.bytes_[e+2]=t>>16,this.bytes_[e+3]=t>>24}writeUint32(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8,this.bytes_[e+2]=t>>16,this.bytes_[e+3]=t>>24}writeInt64(e,t){this.writeInt32(e,Number(BigInt.asIntN(32,t))),this.writeInt32(e+4,Number(BigInt.asIntN(32,t>>BigInt(32))))}writeUint64(e,t){this.writeUint32(e,Number(BigInt.asUintN(32,t))),this.writeUint32(e+4,Number(BigInt.asUintN(32,t>>BigInt(32))))}writeFloat32(e,t){Vh[0]=t,this.writeInt32(e,Ir[0])}writeFloat64(e,t){Xh[0]=t,this.writeInt32(e,Ir[fs?0:1]),this.writeInt32(e+4,Ir[fs?1:0])}getBufferIdentifier(){if(this.bytes_.length<this.position_+ii+si)throw new Error("FlatBuffers: ByteBuffer is too short to contain an identifier.");let e="";for(let t=0;t<si;t++)e+=String.fromCharCode(this.readInt8(this.position_+ii+t));return e}__offset(e,t){const r=e-this.readInt32(e);return t<this.readInt16(r)?this.readInt16(r+t):0}__union(e,t){return e.bb_pos=t+this.readInt32(t),e.bb=this,e}__string(e,t){e+=this.readInt32(e);const r=this.readInt32(e);e+=ii;const i=this.bytes_.subarray(e,e+r);return t===el.UTF8_BYTES?i:this.text_decoder_.decode(i)}__union_with_string(e,t){return typeof e=="string"?this.__string(t):this.__union(e,t)}__indirect(e){return e+this.readInt32(e)}__vector(e){return e+this.readInt32(e)+ii}__vector_len(e){return this.readInt32(e+this.readInt32(e))}__has_identifier(e){if(e.length!=si)throw new Error("FlatBuffers: file identifier must be length "+si);for(let t=0;t<si;t++)if(e.charCodeAt(t)!=this.readInt8(this.position()+ii+t))return!1;return!0}createScalarList(e,t){const r=[];for(let i=0;i<t;++i){const s=e(i);s!==null&&r.push(s)}return r}createObjList(e,t){const r=[];for(let i=0;i<t;++i){const s=e(i);s!==null&&r.push(s.unpack())}return r}}var Ee,rt=((Ee={})[Ee.Byte=0]="Byte",Ee[Ee.UByte=1]="UByte",Ee[Ee.Bool=2]="Bool",Ee[Ee.Short=3]="Short",Ee[Ee.UShort=4]="UShort",Ee[Ee.Int=5]="Int",Ee[Ee.UInt=6]="UInt",Ee[Ee.Long=7]="Long",Ee[Ee.ULong=8]="ULong",Ee[Ee.Float=9]="Float",Ee[Ee.Double=10]="Double",Ee[Ee.String=11]="String",Ee[Ee.Json=12]="Json",Ee[Ee.DateTime=13]="DateTime",Ee[Ee.Binary=14]="Binary",Ee);class Ke{constructor(){pe(this,"bb",null);pe(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsColumn(e,t){return(t||new Ke).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsColumn(e,t){return e.setPosition(e.position()+Ki),(t||new Ke).__init(e.readInt32(e.position())+e.position(),e)}name(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}type(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readUint8(this.bb_pos+e):rt.Byte}title(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.__string(this.bb_pos+t,e):null}width(){let e=this.bb.__offset(this.bb_pos,12);return e?this.bb.readInt32(this.bb_pos+e):-1}precision(){let e=this.bb.__offset(this.bb_pos,14);return e?this.bb.readInt32(this.bb_pos+e):-1}scale(){let e=this.bb.__offset(this.bb_pos,16);return e?this.bb.readInt32(this.bb_pos+e):-1}nullable(){let e=this.bb.__offset(this.bb_pos,18);return!e||!!this.bb.readInt8(this.bb_pos+e)}unique(){let e=this.bb.__offset(this.bb_pos,20);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}primaryKey(){let e=this.bb.__offset(this.bb_pos,22);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}metadata(e){let t=this.bb.__offset(this.bb_pos,24);return t?this.bb.__string(this.bb_pos+t,e):null}static startColumn(e){e.startObject(11)}static addName(e,t){e.addFieldOffset(0,t,0)}static addType(e,t){e.addFieldInt8(1,t,rt.Byte)}static addTitle(e,t){e.addFieldOffset(2,t,0)}static addDescription(e,t){e.addFieldOffset(3,t,0)}static addWidth(e,t){e.addFieldInt32(4,t,-1)}static addPrecision(e,t){e.addFieldInt32(5,t,-1)}static addScale(e,t){e.addFieldInt32(6,t,-1)}static addNullable(e,t){e.addFieldInt8(7,+t,1)}static addUnique(e,t){e.addFieldInt8(8,+t,0)}static addPrimaryKey(e,t){e.addFieldInt8(9,+t,0)}static addMetadata(e,t){e.addFieldOffset(10,t,0)}static endColumn(e){let t=e.endObject();return e.requiredField(t,4),t}static createColumn(e,t,r,i,s,o,a,l,u,h,c,f){return Ke.startColumn(e),Ke.addName(e,t),Ke.addType(e,r),Ke.addTitle(e,i),Ke.addDescription(e,s),Ke.addWidth(e,o),Ke.addPrecision(e,a),Ke.addScale(e,l),Ke.addNullable(e,u),Ke.addUnique(e,h),Ke.addPrimaryKey(e,c),Ke.addMetadata(e,f),Ke.endColumn(e)}}var le,at=((le={})[le.Unknown=0]="Unknown",le[le.Point=1]="Point",le[le.LineString=2]="LineString",le[le.Polygon=3]="Polygon",le[le.MultiPoint=4]="MultiPoint",le[le.MultiLineString=5]="MultiLineString",le[le.MultiPolygon=6]="MultiPolygon",le[le.GeometryCollection=7]="GeometryCollection",le[le.CircularString=8]="CircularString",le[le.CompoundCurve=9]="CompoundCurve",le[le.CurvePolygon=10]="CurvePolygon",le[le.MultiCurve=11]="MultiCurve",le[le.MultiSurface=12]="MultiSurface",le[le.Curve=13]="Curve",le[le.Surface=14]="Surface",le[le.PolyhedralSurface=15]="PolyhedralSurface",le[le.TIN=16]="TIN",le[le.Triangle=17]="Triangle",le);class ht{constructor(){pe(this,"bb",null);pe(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsGeometry(e,t){return(t||new ht).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsGeometry(e,t){return e.setPosition(e.position()+Ki),(t||new ht).__init(e.readInt32(e.position())+e.position(),e)}ends(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.readUint32(this.bb.__vector(this.bb_pos+t)+4*e):0}endsLength(){let e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__vector_len(this.bb_pos+e):0}endsArray(){let e=this.bb.__offset(this.bb_pos,4);return e?new Uint32Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}xy(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}xyLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}xyArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}z(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}zLength(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.__vector_len(this.bb_pos+e):0}zArray(){let e=this.bb.__offset(this.bb_pos,8);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}m(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}mLength(){let e=this.bb.__offset(this.bb_pos,10);return e?this.bb.__vector_len(this.bb_pos+e):0}mArray(){let e=this.bb.__offset(this.bb_pos,10);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}t(e){let t=this.bb.__offset(this.bb_pos,12);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}tLength(){let e=this.bb.__offset(this.bb_pos,12);return e?this.bb.__vector_len(this.bb_pos+e):0}tArray(){let e=this.bb.__offset(this.bb_pos,12);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}tm(e){let t=this.bb.__offset(this.bb_pos,14);return t?this.bb.readUint64(this.bb.__vector(this.bb_pos+t)+8*e):BigInt(0)}tmLength(){let e=this.bb.__offset(this.bb_pos,14);return e?this.bb.__vector_len(this.bb_pos+e):0}type(){let e=this.bb.__offset(this.bb_pos,16);return e?this.bb.readUint8(this.bb_pos+e):at.Unknown}parts(e,t){let r=this.bb.__offset(this.bb_pos,18);return r?(t||new ht).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+r)+4*e),this.bb):null}partsLength(){let e=this.bb.__offset(this.bb_pos,18);return e?this.bb.__vector_len(this.bb_pos+e):0}static startGeometry(e){e.startObject(8)}static addEnds(e,t){e.addFieldOffset(0,t,0)}static createEndsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addInt32(t[r]);return e.endVector()}static startEndsVector(e,t){e.startVector(4,t,4)}static addXy(e,t){e.addFieldOffset(1,t,0)}static createXyVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startXyVector(e,t){e.startVector(8,t,8)}static addZ(e,t){e.addFieldOffset(2,t,0)}static createZVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startZVector(e,t){e.startVector(8,t,8)}static addM(e,t){e.addFieldOffset(3,t,0)}static createMVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startMVector(e,t){e.startVector(8,t,8)}static addT(e,t){e.addFieldOffset(4,t,0)}static createTVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startTVector(e,t){e.startVector(8,t,8)}static addTm(e,t){e.addFieldOffset(5,t,0)}static createTmVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addInt64(t[r]);return e.endVector()}static startTmVector(e,t){e.startVector(8,t,8)}static addType(e,t){e.addFieldInt8(6,t,at.Unknown)}static addParts(e,t){e.addFieldOffset(7,t,0)}static createPartsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addOffset(t[r]);return e.endVector()}static startPartsVector(e,t){e.startVector(4,t,4)}static endGeometry(e){return e.endObject()}static createGeometry(e,t,r,i,s,o,a,l,u){return ht.startGeometry(e),ht.addEnds(e,t),ht.addXy(e,r),ht.addZ(e,i),ht.addM(e,s),ht.addT(e,o),ht.addTm(e,a),ht.addType(e,l),ht.addParts(e,u),ht.endGeometry(e)}}class Lt{constructor(){pe(this,"bb",null);pe(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsFeature(e,t){return(t||new Lt).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsFeature(e,t){return e.setPosition(e.position()+Ki),(t||new Lt).__init(e.readInt32(e.position())+e.position(),e)}geometry(e){let t=this.bb.__offset(this.bb_pos,4);return t?(e||new ht).__init(this.bb.__indirect(this.bb_pos+t),this.bb):null}properties(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readUint8(this.bb.__vector(this.bb_pos+t)+e):0}propertiesLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}propertiesArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Uint8Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}columns(e,t){let r=this.bb.__offset(this.bb_pos,8);return r?(t||new Ke).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+r)+4*e),this.bb):null}columnsLength(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.__vector_len(this.bb_pos+e):0}static startFeature(e){e.startObject(3)}static addGeometry(e,t){e.addFieldOffset(0,t,0)}static addProperties(e,t){e.addFieldOffset(1,t,0)}static createPropertiesVector(e,t){e.startVector(1,t.length,1);for(let r=t.length-1;r>=0;r--)e.addInt8(t[r]);return e.endVector()}static startPropertiesVector(e,t){e.startVector(1,t,1)}static addColumns(e,t){e.addFieldOffset(2,t,0)}static createColumnsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addOffset(t[r]);return e.endVector()}static startColumnsVector(e,t){e.startVector(4,t,4)}static endFeature(e){return e.endObject()}static finishFeatureBuffer(e,t){e.finish(t)}static finishSizePrefixedFeatureBuffer(e,t){e.finish(t,void 0,!0)}static createFeature(e,t,r,i){return Lt.startFeature(e),Lt.addGeometry(e,t),Lt.addProperties(e,r),Lt.addColumns(e,i),Lt.endFeature(e)}}function _a(n,e){let t=[];for(let r=0;r<n.length;r+=2){let i=[n[r],n[r+1]];e&&i.push(e[r>>1]),t.push(i)}return t}new TextEncoder;let Wh=new TextDecoder;function XS(n,e){let t={};if(!e||e.length===0)return t;let r=n.propertiesArray();if(!r)return t;let i=new DataView(r.buffer,r.byteOffset),s=n.propertiesLength(),o=0;for(;o<s;){let a=i.getUint16(o,!0);o+=2;let l=e[a],u=l.name;switch(l.type){case rt.Bool:t[u]=!!i.getUint8(o),o+=1;break;case rt.Byte:t[u]=i.getInt8(o),o+=1;break;case rt.UByte:t[u]=i.getUint8(o),o+=1;break;case rt.Short:t[u]=i.getInt16(o,!0),o+=2;break;case rt.UShort:t[u]=i.getUint16(o,!0),o+=2;break;case rt.Int:t[u]=i.getInt32(o,!0),o+=4;break;case rt.UInt:t[u]=i.getUint32(o,!0),o+=4;break;case rt.Long:t[u]=Number(i.getBigInt64(o,!0)),o+=8;break;case rt.ULong:t[u]=Number(i.getBigUint64(o,!0)),o+=8;break;case rt.Float:t[u]=i.getFloat32(o,!0),o+=4;break;case rt.Double:t[u]=i.getFloat64(o,!0),o+=8;break;case rt.DateTime:case rt.String:{let h=i.getUint32(o,!0);o+=4,t[u]=Wh.decode(r.subarray(o,o+h)),o+=h;break}case rt.Json:{let h=i.getUint32(o,!0);o+=4;let c=Wh.decode(r.subarray(o,o+h));t[u]=JSON.parse(c),o+=h;break}case rt.Binary:{let h=i.getUint32(o,!0);o+=4,t[u]=r.subarray(o,o+h),o+=h;break}default:throw Error(`Unknown type ${l.type}`)}}return t}const $u=new Uint8Array(0);function WS(){return this._source.cancel()}function ZS(n,e){if(!n.length)return e;if(!e.length)return n;var t=new Uint8Array(n.length+e.length);return t.set(n),t.set(e,n.length),t}function qS(){var n=this,e=n._array.subarray(n._index);return n._source.read().then(function(t){return n._array=$u,n._index=0,t.done?e.length>0?{done:!1,value:e}:{done:!0,value:void 0}:{done:!1,value:ZS(e,t.value)}})}function HS(n){if((n|=0)<0)throw new Error("invalid length");var e=this,t=this._array.length-this._index;if(this._index+n<=this._array.length)return Promise.resolve(this._array.subarray(this._index,this._index+=n));var r=new Uint8Array(n);return r.set(this._array.subarray(this._index)),function i(){return e._source.read().then(function(s){return s.done?(e._array=$u,e._index=0,t>0?r.subarray(0,t):null):t+s.value.length>=n?(e._array=s.value,e._index=n-t,r.set(s.value.subarray(0,n-t),t),r):(r.set(s.value,t),t+=s.value.length,i())})}()}function YS(n){return typeof n.slice=="function"?n:new Bo(typeof n.read=="function"?n:n.getReader())}function Bo(n){this._source=n,this._array=$u,this._index=0}Bo.prototype.read=qS;Bo.prototype.slice=HS;Bo.prototype.cancel=WS;class Ct{constructor(){pe(this,"bb",null);pe(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsCrs(e,t){return(t||new Ct).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsCrs(e,t){return e.setPosition(e.position()+Ki),(t||new Ct).__init(e.readInt32(e.position())+e.position(),e)}org(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}code(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readInt32(this.bb_pos+e):0}name(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.__string(this.bb_pos+t,e):null}wkt(e){let t=this.bb.__offset(this.bb_pos,12);return t?this.bb.__string(this.bb_pos+t,e):null}codeString(e){let t=this.bb.__offset(this.bb_pos,14);return t?this.bb.__string(this.bb_pos+t,e):null}static startCrs(e){e.startObject(6)}static addOrg(e,t){e.addFieldOffset(0,t,0)}static addCode(e,t){e.addFieldInt32(1,t,0)}static addName(e,t){e.addFieldOffset(2,t,0)}static addDescription(e,t){e.addFieldOffset(3,t,0)}static addWkt(e,t){e.addFieldOffset(4,t,0)}static addCodeString(e,t){e.addFieldOffset(5,t,0)}static endCrs(e){return e.endObject()}static createCrs(e,t,r,i,s,o,a){return Ct.startCrs(e),Ct.addOrg(e,t),Ct.addCode(e,r),Ct.addName(e,i),Ct.addDescription(e,s),Ct.addWkt(e,o),Ct.addCodeString(e,a),Ct.endCrs(e)}}class Ys{constructor(){pe(this,"bb",null);pe(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsHeader(e,t){return(t||new Ys).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsHeader(e,t){return e.setPosition(e.position()+Ki),(t||new Ys).__init(e.readInt32(e.position())+e.position(),e)}name(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}envelope(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}envelopeLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}envelopeArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}geometryType(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.readUint8(this.bb_pos+e):at.Unknown}hasZ(){let e=this.bb.__offset(this.bb_pos,10);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasM(){let e=this.bb.__offset(this.bb_pos,12);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasT(){let e=this.bb.__offset(this.bb_pos,14);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasTm(){let e=this.bb.__offset(this.bb_pos,16);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}columns(e,t){let r=this.bb.__offset(this.bb_pos,18);return r?(t||new Ke).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+r)+4*e),this.bb):null}columnsLength(){let e=this.bb.__offset(this.bb_pos,18);return e?this.bb.__vector_len(this.bb_pos+e):0}featuresCount(){let e=this.bb.__offset(this.bb_pos,20);return e?this.bb.readUint64(this.bb_pos+e):BigInt("0")}indexNodeSize(){let e=this.bb.__offset(this.bb_pos,22);return e?this.bb.readUint16(this.bb_pos+e):16}crs(e){let t=this.bb.__offset(this.bb_pos,24);return t?(e||new Ct).__init(this.bb.__indirect(this.bb_pos+t),this.bb):null}title(e){let t=this.bb.__offset(this.bb_pos,26);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,28);return t?this.bb.__string(this.bb_pos+t,e):null}metadata(e){let t=this.bb.__offset(this.bb_pos,30);return t?this.bb.__string(this.bb_pos+t,e):null}static startHeader(e){e.startObject(14)}static addName(e,t){e.addFieldOffset(0,t,0)}static addEnvelope(e,t){e.addFieldOffset(1,t,0)}static createEnvelopeVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startEnvelopeVector(e,t){e.startVector(8,t,8)}static addGeometryType(e,t){e.addFieldInt8(2,t,at.Unknown)}static addHasZ(e,t){e.addFieldInt8(3,+t,0)}static addHasM(e,t){e.addFieldInt8(4,+t,0)}static addHasT(e,t){e.addFieldInt8(5,+t,0)}static addHasTm(e,t){e.addFieldInt8(6,+t,0)}static addColumns(e,t){e.addFieldOffset(7,t,0)}static createColumnsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addOffset(t[r]);return e.endVector()}static startColumnsVector(e,t){e.startVector(4,t,4)}static addFeaturesCount(e,t){e.addFieldInt64(8,t,BigInt("0"))}static addIndexNodeSize(e,t){e.addFieldInt16(9,t,16)}static addCrs(e,t){e.addFieldOffset(10,t,0)}static addTitle(e,t){e.addFieldOffset(11,t,0)}static addDescription(e,t){e.addFieldOffset(12,t,0)}static addMetadata(e,t){e.addFieldOffset(13,t,0)}static endHeader(e){return e.endObject()}static finishHeaderBuffer(e,t){e.finish(t)}static finishSizePrefixedHeaderBuffer(e,t){e.finish(t,void 0,!0)}}function Go(n){let e=Ys.getRootAsHeader(n),t=e.featuresCount(),r=e.indexNodeSize(),i=[];for(let a=0;a<e.columnsLength();a++){let l=e.columns(a);if(!l)throw Error("Column unexpectedly missing");if(!l.name())throw Error("Column name unexpectedly missing");i.push({name:l.name(),type:l.type(),title:l.title(),description:l.description(),width:l.width(),precision:l.precision(),scale:l.scale(),nullable:l.nullable(),unique:l.unique(),primary_key:l.primaryKey()})}let s=e.crs(),o=s?{org:s.org(),code:s.code(),name:s.name(),description:s.description(),wkt:s.wkt(),code_string:s.codeString()}:null;return{geometryType:e.geometryType(),columns:i,envelope:null,featuresCount:Number(t),indexNodeSize:r,crs:o,title:e.title(),description:e.description(),metadata:e.metadata()}}const to=class to{constructor(){pe(this,"_extraRequestThreshold",262144)}extraRequestThreshold(){return this._extraRequestThreshold}setExtraRequestThreshold(e){if(e<0)throw Error("extraRequestThreshold cannot be negative");this._extraRequestThreshold=e}};pe(to,"global",new to);let Ks=to;const KS=40,JS=16;function zo(n,e){e=Math.min(Math.max(+e,2),65535);let t=n,r=t;do r+=t=Math.ceil(t/e);while(t!==1);return 40*r}function QS(n,e){if(e<2)throw Error("Node size must be at least 2");if(n===0)throw Error("Number of items must be greater than 0");let t=n,r=t,i=[t];do r+=t=Math.ceil(t/e),i.push(t);while(t!==1);let s=[];for(let a of(t=r,i))s.push(t-a),t-=a;let o=[];for(let a=0;a<i.length;a++)o.push([s[a],s[a]+i[a]]);return o}async function*Xp(n,e,t,r){class i{constructor(p,d){pe(this,"_level");pe(this,"nodes");this._level=d,this.nodes=p}level(){return this._level}startNodeIdx(){return this.nodes[0]}endNodeIdx(){return this.nodes[1]}extendEndNodeIdx(p){this.nodes[1]=p}toString(){return`[NodeRange level: ${this._level}, nodes: ${this.nodes[0]}-${this.nodes[1]}]`}}let{minX:s,minY:o,maxX:a,maxY:l}=t,u=QS(n,e),h=u[0][0],c=[new i([0,1],u.length-1)];for(;c.length!==0;){let f=c.shift(),p=f.startNodeIdx(),d=p>=h,g=(()=>{let[,y]=u[f.level()],b=Math.min(f.endNodeIdx()+e,y);return d&&b<y?b+1:b})(),m=g-p,_=new DataView(await r(40*p,40*m));for(let y=p;y<g;y++){let b=y-p,v=40*b;if(a<_.getFloat64(v+0,!0)||l<_.getFloat64(v+8,!0)||s>_.getFloat64(v+16,!0)||o>_.getFloat64(v+24,!0))continue;let x=_.getBigUint64(v+32,!0);if(d){let P=(()=>{if(y<n-1){let I=(b+1)*40;return _.getBigUint64(I+32,!0)-x}return null})(),R=y-h;yield[Number(x),R,Number(P)];continue}let E=Ks.global.extraRequestThreshold()/40,S=c[c.length-1];if(S!==void 0&&S.level()===f.level()-1&&x<S.endNodeIdx()+E){S.extendEndNodeIdx(Number(x));continue}let A=(()=>{let P=f.level()-1;return new i([Number(x),Number(x)+1],P)})();S!==void 0&&(S.level(),A.level()),c.push(A)}}}class ju{constructor(e,t,r,i){pe(this,"bytes");pe(this,"header");pe(this,"headerLength");pe(this,"indexLength");this.bytes=e,this.header=t,this.headerLength=r,this.indexLength=i}static open(e){if(!e.subarray(0,3).every((o,a)=>pr[a]===o))throw Error("Not a FlatGeobuf file");let t=new DataView(e.buffer).getUint32(8,!0);if(t>10485760||t<8)throw Error("Invalid header size");let r=e.subarray(12,12+t),i=Go(new Xt(r)),s=zo(i.featuresCount,i.indexNodeSize);return new ju(e,i,t,s)}async*selectBbox(e){let t=this.lengthBeforeTree(),r=async(i,s)=>{let o=t+i;return this.bytes.slice(o,o+s).buffer};for await(let i of Xp(this.header.featuresCount,this.header.indexNodeSize,e,r)){let[s,o]=i,a=this.readFeature(s);yield{id:o,feature:a}}}lengthBeforeTree(){return pr.length+Tt+this.headerLength}lengthBeforeFeatures(){return this.lengthBeforeTree()+this.indexLength}readFeature(e){let t=e+this.lengthBeforeFeatures(),r=new DataView(this.bytes.buffer).getUint32(t,!0),i=this.bytes.subarray(t+4,t+4+r),s=new Uint8Array(r+Tt);s.set(i,Tt);let o=new Xt(s);return o.setPosition(Tt),Lt.getRootAsFeature(o)}}/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var tl=function(n,e){return tl=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var i in r)r.hasOwnProperty(i)&&(t[i]=r[i])},tl(n,e)};function eR(n,e){tl(n,e);function t(){this.constructor=n}n.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function Gn(n,e,t,r){function i(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function a(h){try{u(r.next(h))}catch(c){o(c)}}function l(h){try{u(r.throw(h))}catch(c){o(c)}}function u(h){h.done?s(h.value):i(h.value).then(a,l)}u((r=r.apply(n,[])).next())})}function zr(n,e){var t={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},r,i,s,o;return o={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function a(u){return function(h){return l([u,h])}}function l(u){if(r)throw new TypeError("Generator is already executing.");for(;t;)try{if(r=1,i&&(s=u[0]&2?i.return:u[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,u[1])).done)return s;switch(i=0,s&&(u=[u[0]&2,s.value]),u[0]){case 0:case 1:s=u;break;case 4:return t.label++,{value:u[1],done:!1};case 5:t.label++,i=u[1],u=[0];continue;case 7:u=t.ops.pop(),t.trys.pop();continue;default:if(s=t.trys,!(s=s.length>0&&s[s.length-1])&&(u[0]===6||u[0]===2)){t=0;continue}if(u[0]===3&&(!s||u[1]>s[0]&&u[1]<s[3])){t.label=u[1];break}if(u[0]===6&&t.label<s[1]){t.label=s[1],s=u;break}if(s&&t.label<s[2]){t.label=s[2],t.ops.push(u);break}s[2]&&t.ops.pop(),t.trys.pop();continue}u=e.call(n,t)}catch(h){u=[6,h],i=0}finally{r=s=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}}function Yn(n){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&n[e],r=0;if(t)return t.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&r>=n.length&&(n=void 0),{value:n&&n[r++],done:!n}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function Fi(n){return this instanceof Fi?(this.v=n,this):new Fi(n)}function tR(n,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=t.apply(n,e||[]),i,s=[];return i={},o("next"),o("throw"),o("return"),i[Symbol.asyncIterator]=function(){return this},i;function o(f){r[f]&&(i[f]=function(p){return new Promise(function(d,g){s.push([f,p,d,g])>1||a(f,p)})})}function a(f,p){try{l(r[f](p))}catch(d){c(s[0][3],d)}}function l(f){f.value instanceof Fi?Promise.resolve(f.value.v).then(u,h):c(s[0][2],f)}function u(f){a("next",f)}function h(f){a("throw",f)}function c(f,p){f(p),s.shift(),s.length&&a(s[0][0],s[0][1])}}var Wp=function(n){eR(e,n);function e(t){var r=n.call(this,t)||this;return Object.defineProperty(r,"name",{value:"RepeaterOverflowError",enumerable:!1}),typeof Object.setPrototypeOf=="function"?Object.setPrototypeOf(r,r.constructor.prototype):r.__proto__=r.constructor.prototype,typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(r,r.constructor),r}return e}(Error);(function(){function n(e){if(e<0)throw new RangeError("Capacity may not be less than 0");this._c=e,this._q=[]}return Object.defineProperty(n.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"full",{get:function(){return this._q.length>=this._c},enumerable:!1,configurable:!0}),n.prototype.add=function(e){if(this.full)throw new Error("Buffer full");this._q.push(e)},n.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},n})();(function(){function n(e){if(e<1)throw new RangeError("Capacity may not be less than 1");this._c=e,this._q=[]}return Object.defineProperty(n.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"full",{get:function(){return!1},enumerable:!1,configurable:!0}),n.prototype.add=function(e){for(;this._q.length>=this._c;)this._q.shift();this._q.push(e)},n.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},n})();(function(){function n(e){if(e<1)throw new RangeError("Capacity may not be less than 1");this._c=e,this._q=[]}return Object.defineProperty(n.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"full",{get:function(){return!1},enumerable:!1,configurable:!0}),n.prototype.add=function(e){this._q.length<this._c&&this._q.push(e)},n.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},n})();function rl(n){n!=null&&typeof n.then=="function"&&n.then(eo,eo)}var ba=0,Zh=1,an=2,Js=3,nl=4,Qs=1024,eo=function(){};function In(n){var e=n.err,t=Promise.resolve(n.execution).then(function(r){if(e!=null)throw e;return r});return n.err=void 0,n.execution=t.then(function(){},function(){}),n.pending===void 0?t:n.pending.then(function(){return t})}function Kr(n,e){var t=n.state>=Js;return Promise.resolve(e).then(function(r){return!t&&n.state>=nl?In(n).then(function(i){return{value:i,done:!0}}):{value:r,done:t}})}function Vu(n,e){var t,r;if(!(n.state>=an))if(n.state=an,n.onnext(),n.onstop(),n.err==null&&(n.err=e),n.pushes.length===0&&(typeof n.buffer>"u"||n.buffer.empty))pi(n);else try{for(var i=Yn(n.pushes),s=i.next();!s.done;s=i.next()){var o=s.value;o.resolve()}}catch(a){t={error:a}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(t)throw t.error}}}function pi(n){var e,t;if(!(n.state>=Js)){n.state<an&&Vu(n),n.state=Js,n.buffer=void 0;try{for(var r=Yn(n.nexts),i=r.next();!i.done;i=r.next()){var s=i.value,o=n.pending===void 0?In(n):n.pending.then(function(){return In(n)});s.resolve(Kr(n,o))}}catch(a){e={error:a}}finally{try{i&&!i.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}n.pushes=[],n.nexts=[]}}function qh(n){n.state>=nl||(n.state<Js&&pi(n),n.state=nl)}function rR(n,e){if(rl(e),n.pushes.length>=Qs)throw new Wp("No more than "+Qs+" pending calls to push are allowed on a single repeater.");if(n.state>=an)return Promise.resolve(void 0);var t=n.pending===void 0?Promise.resolve(e):n.pending.then(function(){return e});t=t.catch(function(l){n.state<an&&(n.err=l),qh(n)});var r;if(n.nexts.length){var i=n.nexts.shift();i.resolve(Kr(n,t)),n.nexts.length?r=Promise.resolve(n.nexts[0].value):typeof n.buffer<"u"&&!n.buffer.full?r=Promise.resolve(void 0):r=new Promise(function(l){return n.onnext=l})}else typeof n.buffer<"u"&&!n.buffer.full?(n.buffer.add(t),r=Promise.resolve(void 0)):r=new Promise(function(l){return n.pushes.push({resolve:l,value:t})});var s=!0,o={},a=r.catch(function(l){if(s)throw l});return o.then=function(l,u){return s=!1,Promise.prototype.then.call(r,l,u)},o.catch=function(l){return s=!1,Promise.prototype.catch.call(r,l)},o.finally=r.finally.bind(r),n.pending=t.then(function(){return a}).catch(function(l){n.err=l,qh(n)}),o}function nR(n){var e=Vu.bind(null,n),t=new Promise(function(r){return n.onstop=r});return e.then=t.then.bind(t),e.catch=t.catch.bind(t),e.finally=t.finally.bind(t),e}function iR(n){if(!(n.state>=Zh)){n.state=Zh;var e=rR.bind(null,n),t=nR(n);n.execution=new Promise(function(r){return r(n.executor(e,t))}),n.execution.catch(function(){return Vu(n)})}}var ds=new WeakMap,Ji=function(){function n(e,t){ds.set(this,{executor:e,buffer:t,err:void 0,state:ba,pushes:[],nexts:[],pending:void 0,execution:void 0,onnext:eo,onstop:eo})}return n.prototype.next=function(e){rl(e);var t=ds.get(this);if(t===void 0)throw new Error("WeakMap error");if(t.nexts.length>=Qs)throw new Wp("No more than "+Qs+" pending calls to next are allowed on a single repeater.");if(t.state<=ba&&iR(t),t.onnext(e),typeof t.buffer<"u"&&!t.buffer.empty){var r=Kr(t,t.buffer.remove());if(t.pushes.length){var i=t.pushes.shift();t.buffer.add(i.value),t.onnext=i.resolve}return r}else if(t.pushes.length){var s=t.pushes.shift();return t.onnext=s.resolve,Kr(t,s.value)}else if(t.state>=an)return pi(t),Kr(t,In(t));return new Promise(function(o){return t.nexts.push({resolve:o,value:e})})},n.prototype.return=function(e){rl(e);var t=ds.get(this);if(t===void 0)throw new Error("WeakMap error");return pi(t),t.execution=Promise.resolve(t.execution).then(function(){return e}),Kr(t,In(t))},n.prototype.throw=function(e){var t=ds.get(this);if(t===void 0)throw new Error("WeakMap error");return t.state<=ba||t.state>=an||typeof t.buffer<"u"&&!t.buffer.empty?(pi(t),t.err==null&&(t.err=e),Kr(t,In(t))):this.next(Promise.reject(e))},n.prototype[Symbol.asyncIterator]=function(){return this},n.race=sR,n.merge=oR,n.zip=aR,n.latest=lR,n}();function ko(n,e){var t,r,i=[],s=function(u){u!=null&&typeof u[Symbol.asyncIterator]=="function"?i.push(u[Symbol.asyncIterator]()):u!=null&&typeof u[Symbol.iterator]=="function"?i.push(u[Symbol.iterator]()):i.push(function(){return tR(this,arguments,function(){return zr(this,function(f){switch(f.label){case 0:return e.yieldValues?[4,Fi(u)]:[3,3];case 1:return[4,f.sent()];case 2:f.sent(),f.label=3;case 3:return e.returnValues?[4,Fi(u)]:[3,5];case 4:return[2,f.sent()];case 5:return[2]}})})}())};try{for(var o=Yn(n),a=o.next();!a.done;a=o.next()){var l=a.value;s(l)}}catch(u){t={error:u}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}return i}function sR(n){var e=this,t=ko(n,{returnValues:!0});return new Ji(function(r,i){return Gn(e,void 0,void 0,function(){var s,o,a,l,u,h;return zr(this,function(c){switch(c.label){case 0:if(!t.length)return i(),[2];o=!1,i.then(function(){s(),o=!0}),c.label=1;case 1:c.trys.push([1,,5,7]),l=void 0,u=0,h=function(){var f,p,d,g,m,_;return zr(this,function(y){switch(y.label){case 0:f=u;try{for(p=(m=void 0,Yn(t)),d=p.next();!d.done;d=p.next())g=d.value,Promise.resolve(g.next()).then(function(b){b.done?(i(),a===void 0&&(a=b)):u===f&&(u++,s(b))},function(b){return i(b)})}catch(b){m={error:b}}finally{try{d&&!d.done&&(_=p.return)&&_.call(p)}finally{if(m)throw m.error}}return[4,new Promise(function(b){return s=b})];case 1:return l=y.sent(),l===void 0?[3,3]:[4,r(l.value)];case 2:y.sent(),y.label=3;case 3:return[2]}})},c.label=2;case 2:return o?[3,4]:[5,h()];case 3:return c.sent(),[3,2];case 4:return[2,a&&a.value];case 5:return i(),[4,Promise.race(t.map(function(f){return f.return&&f.return()}))];case 6:return c.sent(),[7];case 7:return[2]}})})})}function oR(n){var e=this,t=ko(n,{yieldValues:!0});return new Ji(function(r,i){return Gn(e,void 0,void 0,function(){var s,o,a,l=this;return zr(this,function(u){switch(u.label){case 0:if(!t.length)return i(),[2];s=[],o=!1,i.then(function(){var h,c;o=!0;try{for(var f=Yn(s),p=f.next();!p.done;p=f.next()){var d=p.value;d()}}catch(g){h={error:g}}finally{try{p&&!p.done&&(c=f.return)&&c.call(f)}finally{if(h)throw h.error}}}),u.label=1;case 1:return u.trys.push([1,,3,4]),[4,Promise.all(t.map(function(h,c){return Gn(l,void 0,void 0,function(){var f,p;return zr(this,function(d){switch(d.label){case 0:d.trys.push([0,,6,9]),d.label=1;case 1:return o?[3,5]:(Promise.resolve(h.next()).then(function(g){return s[c](g)},function(g){return i(g)}),[4,new Promise(function(g){s[c]=g})]);case 2:return f=d.sent(),f===void 0?[3,4]:f.done?(a=f,[2]):[4,r(f.value)];case 3:d.sent(),d.label=4;case 4:return[3,1];case 5:return[3,9];case 6:return p=h.return,p?[4,h.return()]:[3,8];case 7:p=d.sent(),d.label=8;case 8:return[7];case 9:return[2]}})})}))];case 2:return u.sent(),[2,a&&a.value];case 3:return i(),[7];case 4:return[2]}})})})}function aR(n){var e=this,t=ko(n,{returnValues:!0});return new Ji(function(r,i){return Gn(e,void 0,void 0,function(){var s,o,a,l;return zr(this,function(u){switch(u.label){case 0:if(!t.length)return i(),[2,[]];o=!1,i.then(function(){s(),o=!0}),u.label=1;case 1:u.trys.push([1,,6,8]),u.label=2;case 2:return o?[3,5]:(Promise.all(t.map(function(h){return h.next()})).then(function(h){return s(h)},function(h){return i(h)}),[4,new Promise(function(h){return s=h})]);case 3:return a=u.sent(),a===void 0?[2]:(l=a.map(function(h){return h.value}),a.some(function(h){return h.done})?[2,l]:[4,r(l)]);case 4:return u.sent(),[3,2];case 5:return[3,8];case 6:return i(),[4,Promise.all(t.map(function(h){return h.return&&h.return()}))];case 7:return u.sent(),[7];case 8:return[2]}})})})}function lR(n){var e=this,t=ko(n,{yieldValues:!0,returnValues:!0});return new Ji(function(r,i){return Gn(e,void 0,void 0,function(){var s,o,a,l,u,h=this;return zr(this,function(c){switch(c.label){case 0:if(!t.length)return i(),[2,[]];o=[],a=!1,i.then(function(){var f,p;s();try{for(var d=Yn(o),g=d.next();!g.done;g=d.next()){var m=g.value;m()}}catch(_){f={error:_}}finally{try{g&&!g.done&&(p=d.return)&&p.call(d)}finally{if(f)throw f.error}}a=!0}),c.label=1;case 1:return c.trys.push([1,,5,7]),Promise.all(t.map(function(f){return f.next()})).then(function(f){return s(f)},function(f){return i(f)}),[4,new Promise(function(f){return s=f})];case 2:return l=c.sent(),l===void 0?[2]:(u=l.map(function(f){return f.value}),l.every(function(f){return f.done})?[2,u]:[4,r(u.slice())]);case 3:return c.sent(),[4,Promise.all(t.map(function(f,p){return Gn(h,void 0,void 0,function(){var d;return zr(this,function(g){switch(g.label){case 0:if(l[p].done)return[2,l[p].value];g.label=1;case 1:return a?[3,4]:(Promise.resolve(f.next()).then(function(m){return o[p](m)},function(m){return i(m)}),[4,new Promise(function(m){return o[p]=m})]);case 2:return d=g.sent(),d===void 0?[2,l[p].value]:d.done?[2,d.value]:(u[p]=d.value,[4,r(u.slice())]);case 3:return g.sent(),[3,1];case 4:return[2]}})})}))];case 4:return[2,c.sent()];case 5:return i(),[4,Promise.all(t.map(function(f){return f.return&&f.return()}))];case 6:return c.sent(),[7];case 7:return[2]}})})})}class Xu{constructor(e,t,r,i,s,o={}){pe(this,"headerClient");pe(this,"header");pe(this,"headerLength");pe(this,"indexLength");pe(this,"nocache");pe(this,"headers");this.headerClient=e,this.header=t,this.headerLength=r,this.indexLength=i,this.nocache=s,this.headers=o}static async open(e,t,r={}){let i,s=new Hh(e,t,r),o=2024+(()=>{let h,c=0;for(h=0;h<3;h++)c+=JS**h*KS;return c})();if(!new Uint8Array(await s.getRange(0,8,o,"header")).subarray(0,3).every((h,c)=>pr[c]===h))throw Error("Not a FlatGeobuf file");if((i=new DataView(await s.getRange(8,4,o,"header")).getUint32(0,!0))>10485760||i<8)throw Error("Invalid header size");let a=await s.getRange(12,i,o,"header"),l=Go(new Xt(new Uint8Array(a)));if(l.indexNodeSize===0)throw Error("No index found, cannot read features filtered by bbox");let u=zo(l.featuresCount,l.indexNodeSize);return new Xu(s,l,i,u,t,r)}async*selectBbox(e){let t=this.lengthBeforeTree(),r=this.headerClient,i=async(l,u)=>r.getRange(t+l,u,0,"index"),s=[],o=[];for await(let l of Xp(this.header.featuresCount,this.header.indexNodeSize,e,i)){let[u,h]=l,[,,c]=l;if(c||(c=4),o.length===0){o.push([u,c,h]);continue}let f=o[o.length-1];u-(f[0]+f[1])>Ks.global.extraRequestThreshold()&&(s.push(o),o=[]),o.push([u,c,h])}this.headerClient.logUsage("header+index"),o.length>0&&s.push(o);let a=s.flatMap(l=>this.readFeatureBatch(l,this.nocache));yield*Ji.merge(a)}lengthBeforeTree(){return pr.length+Tt+this.headerLength}lengthBeforeFeatures(){return this.lengthBeforeTree()+this.indexLength}buildFeatureClient(e){return new Hh(this.headerClient.httpClient,e,this.headers)}async*readFeatureBatch(e,t){let[r]=e[0],[i,s]=e[e.length-1],o=this.buildFeatureClient(t),a=i+s-r;for(let[l,,u]of e){let h=await this.readFeature(o,l,a);yield{id:u,feature:h},a=0}o.logUsage("feature")}async readFeature(e,t,r){let i,s=t+this.lengthBeforeFeatures();i=new DataView(await e.getRange(s,4,r,"feature length")).getUint32(0,!0);let o=new Uint8Array(await e.getRange(s+4,i,r,"feature data")),a=new Uint8Array(i+Tt);a.set(o,Tt);let l=new Xt(a);return l.setPosition(Tt),Lt.getRootAsFeature(l)}}class Hh{constructor(e,t,r={}){pe(this,"httpClient");pe(this,"bytesEverUsed",0);pe(this,"bytesEverFetched",0);pe(this,"buffer",new ArrayBuffer(0));pe(this,"head",0);if(typeof e=="string")this.httpClient=new Yh(e,t,r);else if(e instanceof Yh)this.httpClient=e;else throw Error("Unknown source")}async getRange(e,t,r,i){this.bytesEverUsed+=t;let s=e-this.head,o=s+t;if(s>=0&&o<=this.buffer.byteLength)return this.buffer.slice(s,o);let a=Math.max(t,r);return this.bytesEverFetched+=a,this.buffer=await this.httpClient.getRange(e,a,i),this.head=e,this.buffer.slice(0,t)}logUsage(e){e.split(" ")[0],(100*this.bytesEverUsed/this.bytesEverFetched).toFixed(2)}}class Yh{constructor(e,t,r={}){pe(this,"url");pe(this,"nocache");pe(this,"headers");pe(this,"requestsEverMade",0);pe(this,"bytesEverRequested",0);this.url=e,this.nocache=t,this.headers=r}async getRange(e,t,r){this.requestsEverMade+=1,this.bytesEverRequested+=t;let i=`bytes=${e}-${e+t-1}`,s=new Headers(this.headers);return s.set("Range",i),this.nocache&&s.set("Cache-Control","no-cache, no-store"),await(await fetch(this.url,{headers:s})).arrayBuffer()}}async function*uR(n,e,t,r){if(!n.subarray(0,3).every((c,f)=>pr[f]===c))throw Error("Not a FlatGeobuf file");if(t){let c=ju.open(n);for await(let f of c.selectBbox(t))yield e(f.id,f.feature,c.header);return}let i=new Xt(n),s=i.readUint32(pr.length);i.setPosition(pr.length+Tt);let o=Go(i),a=pr.length+Tt+s,{indexNodeSize:l,featuresCount:u}=o;l>0&&(a+=zo(u,l));let h=0;for(;a<i.capacity();){let c=i.readUint32(a);i.setPosition(a+Tt);let f=Lt.getRootAsFeature(i);yield e(h++,f,o),a+=Tt+c}}async function*cR(n,e,t){let r,i=YS(n),s=async p=>await i.slice(p),o=new Uint8Array(await s(8));if(!o.subarray(0,3).every((p,d)=>pr[d]===p))throw Error("Not a FlatGeobuf file");o=new Uint8Array(await s(4));let a=new Xt(o),l=a.readUint32(0);o=new Uint8Array(await s(l));let u=Go(a=new Xt(o)),{indexNodeSize:h,featuresCount:c}=u;if(h>0){let p=zo(c,h);await s(p)}let f=0;for(;r=await fR(s,u,e,f++);)yield r}async function*hR(n,e,t,r,i=!1,s={}){let o=await Xu.open(n,i,s);for await(let a of o.selectBbox(e))yield t(a.id,a.feature,o.header)}async function fR(n,e,t,r){let i=new Uint8Array(await n(4,"feature length"));if(i.byteLength===0)return;let s=new Xt(i),o=s.readUint32(0);i=new Uint8Array(await n(o,"feature data"));let a=new Uint8Array(o+4);return a.set(i,4),(s=new Xt(a)).setPosition(Tt),t(r,Lt.getRootAsFeature(s),e)}function il(n,e){let t=e;if(t===at.Unknown&&(t=n.type()),t===at.GeometryCollection){let i=[];for(let s=0;s<n.partsLength();s++){let o=n.parts(s),a=o.type();i.push(il(o,a))}return{type:at[t],geometries:i}}if(t===at.MultiPolygon){let i=[];for(let s=0;s<n.partsLength();s++)i.push(il(n.parts(s),at.Polygon));return{type:at[t],coordinates:i.map(s=>s.coordinates)}}let r=function(i,s){let o=i.xyArray(),a=i.zArray();switch(s){case at.Point:{let l=Array.from(o);return a&&l.push(a[0]),l}case at.MultiPoint:case at.LineString:return _a(o,a);case at.MultiLineString:case at.Polygon:return function(l,u,h){let c;if(!h||h.length===0)return[_a(l,u)];let f=0,p=Array.from(h).map(d=>l.slice(f,f=d<<1));return u&&(f=0,c=Array.from(h).map(d=>u.slice(f,f=d))),p.map((d,g)=>_a(d,c?c[g]:void 0))}(o,a,i.endsArray())}}(n,t);return{type:at[t],coordinates:r}}function Wu(n,e,t){let r=t.columns;return{type:"Feature",id:n,geometry:il(e.geometry(),t.geometryType),properties:XS(e,r)}}async function*dR(n,e,t){yield*uR(n,Wu,e)}function pR(n,e){return cR(n,Wu)}function gR(n,e,t,r=!1,i={}){return hR(n,e,Wu,t,r,i)}function mR(n,e,t,r=!1,i={}){return n instanceof Uint8Array?dR(n,e):n instanceof ReadableStream?pR(n):gR(n,e,t,r,i)}const Kh=new bs({featureProjection:"EPSG:3857"});class yR extends Dr{constructor(e){super({url:e.url,attributions:e.attributions,wrapX:e.wrapX,format:Kh,strategy:mf}),this.ressourceURL=e.url,super.setLoader(this.loader)}fgbBoundingBox(e,t){const r=Ea(e,t.getCode(),"EPSG:4326");return{minX:r[0],minY:r[1],maxX:r[2],maxY:r[3]}}async loader(e,t,r,i,s){const o=this.fgbBoundingBox(e,r);try{if(o.minX!==-1/0){const a=[],l=mR(this.ressourceURL,o);for await(const u of l){const h=Kh.readFeature(u);a.push(h)}super.clear(),super.addFeatures(a),i(a)}}catch{s()}}}window.eoxMapAdvancedOlSources={BingMaps:lS,CartoDB:uS,Cluster:Hs,DataTile:Zi,GeoTIFF:du,Google:pS,IIIF:mS,Image:cn,ImageArcGISRest:_S,ImageCanvas:bS,ImageMapGuide:vS,ImageStatic:qd,ImageTile:$p,OGCMapTile:LS,OGCVectorTile:FS,Raster:ku,Source:uo,StadiaMaps:BS,TileArcGISRest:GS,TileDebug:zS,TileImage:Er,TileJSON:xo,UrlTile:Sm,UTFGrid:$S,Zoomify:gS,WMTSCapabilities:VS,FlatGeoBuf:yR};const zR=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));export{NR as L,DR as a,zR as i};
