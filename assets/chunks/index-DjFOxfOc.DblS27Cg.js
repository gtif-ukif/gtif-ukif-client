import"./main.CWAxQwH5.js";import"./index.DqDmNI4B.js";import{q as b,s as G,a as I,k as se,j as ie,d as U,h as V,l as N,r as ae,t as le,o as ne,n as ue,i as ce,v as pe,w as D,x as q,E as H}from"./eo-dash.ChwlPagu.js";import{p as L,ao as R,h as A,v as $,c as ye,o as ve,j as z,N as Z,k as W,x as E,q as fe}from"./framework.DGPOY9aA.js";import"./lit-element.C0HUAAc_.js";import"./WMTS.D-lC2MIp.js";import"./Group.DfJ6KxFj.js";import"./extent.CajDHjk1.js";import"./GeoJSON.Br7Jz3X5.js";import"./getElement.CdRlZPdn.js";import"./addCommonStyleSheet.B9YrlOoW.js";import"./WKT.CRW3-4HE.js";import"./commonjsHelpers.BosuxZz1.js";import"./item.koN_VtZd.js";const K=async(e,i,n)=>{N.debug("Creating layers config",e,i,n);const r=[],s={type:"Group",properties:{id:"AnalysisGroup",title:"Data Layers",layerControlExpand:!0},layers:[]};for(const a of i){let y;n?y=await a.createLayersJson(new Date(n)):y=await a.createLayersJson(),y.forEach(l=>{l.properties.layerControlExpand=!0,l.properties.layerControlToolsExpand=!0}),s.layers.push(...y)}r.push(s);const u=await H.getIndicatorLayers(e),d=H.getObservationPointsLayer(i);d&&s.layers.unshift(d);const c={type:"Group",properties:{id:"BaseLayersGroup",title:"Base Layers"},layers:[]},t=u.filter(a=>a.properties.group==="baselayer");if(t.length){let a=0,y=0;for(let l=0;l<t.length;l++){const f=t[l];"visible"in f.properties||(f.properties.visible=!1),f.properties.visible&&(a++,y=l)}a===0&&(t[0].properties.visible=!0),a>0&&t.forEach((l,f)=>{f!==y?l.properties.visible=!1:l.properties.visible=!0}),c.layers.push(...t),c.layers.forEach(l=>{l.properties.layerControlExclusive=!0})}else c.layers.push({type:"Tile",properties:{id:"osm",title:"Background",layerControlExclusive:!0},source:{type:"OSM"}});c.layers.length&&r.push(c);const g={type:"Group",properties:{id:"OverlayGroup",title:"Overlay Layers"},layers:[]},p=u.filter(a=>a.properties.group==="overlay");return p.length&&(g.layers.push(...p),r.unshift(g)),r};let J=null;const de=(e,i)=>{const n=r=>{var c;const s=r.map,u=(c=e.value)==null?void 0:c.lonLatCenter,d=s==null?void 0:s.getView().getZoom();u&&!Number.isNaN(u[0])&&!Number.isNaN(u[1])&&!Number.isNaN(d)&&(i.value=[u[0],u[1],d])};$(()=>{var r,s;(s=(r=e.value)==null?void 0:r.map)==null||s.on("moveend",n)}),E(()=>{var r,s;(s=(r=e.value)==null?void 0:r.map)==null||s.un("moveend",n)})},Q=(e,i,n,r,s,u,d)=>{N.debug("InitMap",e.value,i.value,n.values,r.value);const c=fe([i,r],async([t,g],[p,a])=>{var y,l,f,M,O,_,h,x,P,v,m,C,k,j,F,S;if(t){N.debug("Selected Indicator watch triggered",t,g),((y=e==null?void 0:e.value)==null?void 0:y.id)==="main"&&J!==null&&((l=e==null?void 0:e.value)==null||l.map.setView(J),J=null);let w=[];const ee=(t==null?void 0:t.id)===(p==null?void 0:p.id)&&g!==a,{selectedCompareStac:oe}=G(I());if(((f=e==null?void 0:e.value)==null?void 0:f.id)==="main"?await pe(t):oe.value!==null&&(J=((M=e==null?void 0:e.value)==null?void 0:M.map.getView())??null,e.value.sync=u.value),ee){w=await K(t,n,g),N.debug("Assigned layers after changing time only",JSON.parse(JSON.stringify(w))),s.value=w,D(((O=e.value)==null?void 0:O.id)==="compare"?"compareTime:updated":"time:updated",e.value,w);return}w=await K(t,n,r.value);let T=null;const B=(h=(_=t==null?void 0:t.extent)==null?void 0:_.temporal)==null?void 0:h.interval;if(B&&B.length>0&&B[0].length>1&&(T=new Date(B[0][1]),N.debug("Indicator load: found stac extent, setting time to latest value",T)),T!==null&&T.toISOString()!==r.value&&!q.value&&(r.value=T.toISOString()),d&&((x=e==null?void 0:e.value)==null?void 0:x.id)==="main"&&(P=t.extent)!=null&&P.spatial.bbox&&!(q.value&&((v=b.value)!=null&&v[0])&&((m=b.value)!=null&&m[1]))){const o=(C=t.extent)==null?void 0:C.spatial.bbox[0],re=[(o==null?void 0:o[0])>-180?o==null?void 0:o[0]:-180,(o==null?void 0:o[1])>-90?o==null?void 0:o[1]:-90,(o==null?void 0:o[2])<180?o==null?void 0:o[2]:180,(o==null?void 0:o[3])<90?o==null?void 0:o[3]:90],te=(F=e.value)==null?void 0:F.transformExtent(re,"EPSG:4326",(j=(k=e.value)==null?void 0:k.map)==null?void 0:j.getView().getProjection());e.value.zoomExtent=te}N.debug("Assigned layers",JSON.parse(JSON.stringify(w))),s.value=w,await D(((S=e.value)==null?void 0:S.id)==="compare"?"compareLayers:updated":"layers:updated",e.value,s.value)}},{immediate:!0});E(()=>{c()})},X=(e,i)=>{ae(async(n,r)=>{if(n.includes("compare"))return;const s=[];for(const u of e)s.push(...await u.getToolTipProperties());i.value=s,N.debug("Updated tooltip properties",i.value)})};function ge(e){return 3*e*e-2*e*e*e}const he=[".enabled"],xe=[".center",".zoom",".layers"],Ce=[".propertyTransform"],we=[".layers"],be=[".propertyTransform"];var Y;const Ge={__name:"index",props:{enableCompare:{type:Boolean,default:!1},center:{type:Array,default:()=>{var e,i;return[((e=b.value)==null?void 0:e[0])??15,((i=b.value)==null?void 0:i[1])??48]}},zoom:{type:Number,default:((Y=b.value)==null?void 0:Y[2])??4},zoomToExtent:{type:Boolean,default:!0}},setup(e){var _;const i=e,n=L([]),r=L([]),s={Attribution:{collapsible:!0}},u=R(i.center),d=R(((_=b.value)==null?void 0:_[2])??i.zoom),c=L([{type:"Tile",source:{type:"OSM"},properties:{id:"osm",title:"Background"}}]),t=L([{type:"Tile",source:{type:"OSM"},properties:{id:"osm",title:"Background"}}]),g={duration:1200,easing:ge},p=L(null),a=L(null),{selectedCompareStac:y}=G(I()),l=A(()=>i.enableCompare&&y.value?"":"first");de(p,b),$(()=>{const{selectedCompareStac:h,selectedStac:x}=G(I());se.value=p.value,i.enableCompare&&(ie.value=a.value),i.enableCompare&&(Q(a,h,ce,U,t,p,!1),X(V,r)),Q(p,x,V,U,c,a,i.zoomToExtent)}),X(V,n);const f=A(()=>({visibility:n.value.length?"visible":"hidden"})),M=A(()=>({visibility:r.value.length?"visible":"hidden"})),O=h=>{const x=h==="main"?n:r,P=h=="main"?ne:ue;return v=>{const m=JSON.parse(le.render(JSON.stringify(x.value),{...P.value??{}})),C=m==null?void 0:m.find(k=>k.id===v.key);if(C)return typeof v.value=="object"&&(v.value=JSON.stringify(v.value)),isNaN(Number(v.value))||(v.value=Number(v.value).toFixed(4).toString()),{key:C.title||C.id,value:v.value+" "+(C.appendix||"")}}};return(h,x)=>(ve(),ye("eox-map-compare",{class:"fill-height fill-width overflow-none",".enabled":l.value},[z("eox-map",{class:"fill-height fill-width overflow-none",slot:"first",ref_key:"eoxMap",ref:p,id:"main",".animationOptions":g,".center":W(u),".zoom":W(d),".layers":c.value,".controls":s},[z("eox-map-tooltip",{style:Z(f.value),".propertyTransform":O("main")},null,44,Ce)],40,xe),z("eox-map",{class:"fill-height fill-width overflow-none",id:"compare",slot:"second",ref_key:"compareMap",ref:a,".layers":t.value},[z("eox-map-tooltip",{style:Z(M.value),".propertyTransform":O("compare")},null,44,be)],40,we)],40,he))}};export{Ge as default};
