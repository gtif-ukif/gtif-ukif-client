import{a9 as d,l as D,S as h,aa as O,ab as P,ac as T,ad as R,w as v,R as g,K as J,L as k}from"./eo-dash.ChwlPagu.js";import{i as L}from"./utils.DZj92Qv1.js";function F(e){return Object.keys((e==null?void 0:e.properties)??{}).find(s=>(e==null?void 0:e.properties[s].format)==="bounding-box")}function N(e){return Object.keys((e==null?void 0:e.properties)??{}).filter(s=>(e==null?void 0:e.properties[s].type)==="geojson")}function M(e,s){const t=N(s);for(const o of t)e[o]&&(L(s==null?void 0:s.properties[o])?e[o]=e[o].features.map(r=>JSON.stringify(r.geometry)):e[o]=JSON.stringify(e[o].geometry))}async function K(e,s,t,o,r){let a=null;"eox:flatstyle"in(e??{})&&(a=await g.get(e["eox:flatstyle"]).then(n=>n.data));let l,i;if(a){const n=h(s??"",a);l=n.layerConfig,i=n.style}t=t.sort();const c=t.length>0?{type:"WebGLTile",source:{type:"GeoTIFF",normalize:!i,sources:t.map(n=>({url:n}))},properties:{id:e.id+"_process"+r,title:"Results "+s,...l&&{layerConfig:l},layerControlToolsExpand:!0},...i&&{style:i}}:void 0;return o&&c&&(c.source.projection=o),c}const U=(e,s)=>{if(!s)return;let t=s;if(typeof s=="object"){s=JSON.stringify(s);const r=new Blob([s],{type:"text"});t=URL.createObjectURL(r)}const o=document.createElement("a");confirm(`Would you like to download ${e}?`)&&(o.href=t,o.download=e,o.click()),URL.revokeObjectURL(t),o.remove()};function B(e,s,t){let o="",r="";[o,r]=s??["",""];const[a,l]=e??["",""];try{if(o&&r?(o=new Date(o),r=new Date(r)):(o=new Date(a),r=new Date(l)),(o<new Date(a)||o>new Date(l))&&(console.warn("[eodash] warn: start date is outside of the collection temporal extent and will be clamped",`
provided start date:${o.toISOString()}`,`
collection start date:${a}`),o=new Date(a)),(r>new Date(l)||r<new Date(a))&&(console.warn("[eodash] warn: end date is outside of the collection temporal extent and will be clamped",`
provided end date:${r.toISOString()}`,`
collection end date:${l}`),r=new Date(l)),o>r)return console.error("[eodash] Error: start date is greater than end date",o,r),[]}catch(f){return console.error("[eodash] Invalid date:",f.message),[]}const i=o.toISOString(),c=r.toISOString();if(!i||!c)return[];const n=[];let u=new Date(c);const p=new Date(i),y=24*60*60*1e3,x=t==="daily"?y:t==="weekly"?y*7:t==="monthly"?y*30:t==="yearly"?y*365:y;for(;u>=p&&n.length<31;)n.push(new Date(u)),u.setTime(u.getTime()-x);const w=[];for(let f=0;f<n.length-1;f++)w.push([n[f].toISOString(),n[f+1].toISOString()]);return w}function W(e,s,t){if(!e)return[[],[]];const o=[],r=[];for(const a of e){const l=a.rel===s,i=t?a.type===t:!0;l&&i&&(a.endpoint?r.push(a):o.push(a))}return[o,r]}async function $(e,s,t,o=""){var l;const r=[],a=await m(s);for(const i of e){const c=_(i,a);let n,u;if(c){const p=h((t==null?void 0:t.id)??"",c);u=p.layerConfig,n=p.style}switch(i.type){case"image/tiff":{r.push({type:"WebGLTile",properties:{id:s.id+"_process"+i.id+o,title:"Results "+((t==null?void 0:t.id)??"")+" "+(i.id??""),layerControlToolsExpand:!0,...u&&{layerConfig:u}},source:{type:"GeoTIFF",normalize:!n,sources:i.urls.map(p=>({url:p})),...((l=t["eodash:mapProjection"])==null?void 0:l.name)&&{projection:t["eodash:mapProjection"].name}},...n&&{style:n}});break}case"application/geo+json":{const p=await O(i.urls);r.push({type:"Vector",source:{type:"Vector",format:"GeoJSON",...p&&{url:p}},properties:{id:s.id+"_process_"+i.id+o,title:"Results "+((t==null?void 0:t.id)??"")+" "+(i.id??""),...u&&{layerConfig:{...u,style:n}}},...!(n!=null&&n.variables)&&{style:n},interactions:[]});break}default:console.warn(`[eodash] Unsupported result type "${i.type}" for ${i.id} layer creation.`);break}}return r}async function m(e){let s=null;return e["eox:flatstyle"]&&(typeof e["eox:flatstyle"]=="string"?s=await g.get(e["eox:flatstyle"]).then(t=>t.data):Array.isArray(e["eox:flatstyle"])&&e["eox:flatstyle"].length?(s={multipleStyles:!0},await Promise.all(e["eox:flatstyle"].map(async t=>{s[t.id]=await g.get(t.url).then(o=>o.data)}))):(s={multipleStyles:!0},await Promise.all(Object.keys(e["eox:flatstyle"]??{}).map(t=>{s[t]=g.get(e["eox:flatstyle"][t]).then(o=>o.data)})))),s}function _(e,s){if(!s)return;if(!("multipleStyles"in s))return s;const t=e.id;if(!(!t||!(t in s)))return s[t]}function C(e){if(!e)return[];if("urls"in e&&Array.isArray(e.urls))return[{id:"",urls:e.urls,type:"image/tiff"}];const s=[];for(const t in e)t!=="id"&&s.push({id:t,urls:e[t].urls,type:e[t].mimetype});return s}const G=(e,s)=>{var a;if(!s.length||!e)return;const o=[...(e.id==="compare"?P:T)()];let r=o.find(l=>{var i;return(i=l.properties)==null?void 0:i.id.includes("AnalysisGroup")});if(r){for(const l of s)r.layers.find(c=>{var n,u;return((n=c.properties)==null?void 0:n.id)===((u=l.properties)==null?void 0:u.id)})?r.layers=R(r.layers,((a=l.properties)==null?void 0:a.id)??"",[l]):r.layers.unshift(l);if(e){const l=[...o],i=e.id==="compare"?"compareProcess:updated":"process:updated";v(i,e,l),e.layers=l}}};function z(e){if(!e)return e;const s=JSON.stringify(e).replaceAll("eox-map#main","eox-map#compare");return JSON.parse(s)}async function q({jobs:e,processUrl:s,isPolling:t,pollInterval:o=1e4,maxRetries:r=560,enableCompare:a=!1}){let l=0;for(t.value=!0,setTimeout(()=>{b(e,a?J.value:k.value)},500);l<r&&t.value;){try{const i=new Date().getTime(),n=(await d.get(`${s}?t=${i}`)).data;if(n.status==="successful"){console.log("Process completed successfully. Fetching result item...");const u=n.links[1].href;if(!u)throw new Error("Result links not found in the process report.");const p=await d.get(u);return console.log("Result file fetched successfully:",p.data),p.data}if(n.status==="failed")throw t.value=!1,new Error("Process failed.",n);console.log(`Status: ${n.status}. Retrying in ${o/1e3} seconds...`)}catch(i){i instanceof Error?console.error("Error while polling process status:",i.message):console.error("Unknown error occurred:",i)}await new Promise(i=>setTimeout(i,o)),l++}if(!t.value)return console.warn("Polling was stopped before the process was completed."),JSON.parse("{}");throw new Error("Max retries reached. Process did not complete successfully.")}async function b(e,s){const t=JSON.parse(localStorage.getItem(s)||"[]"),o=await Promise.all(t.map(r=>d.get(r,{params:{t:Date.now()}}).then(a=>a.data)));o.sort((r,a)=>new Date(a.job_start_datetime).getTime()-new Date(r.job_start_datetime).getTime()),e.value=o}const H=async(e,s,t)=>{const r=JSON.parse(localStorage.getItem(t)||"[]").filter(a=>!a.includes(s.jobID));localStorage.setItem(t,JSON.stringify(r)),await b(e,t)},Q=async(e,s)=>{const t=[],o=e.links.find(r=>r.rel.includes("results")&&r.type=="application/json");o&&(await d.get(o.href).then(r=>r.data).then(r=>{t.push(...r.urls)}),t.forEach(r=>{if(!r)return;let a="";typeof r=="string"?(a=r.includes("/")?r.split("/").pop()??"":r,a=a.includes("?")?a.split("?")[0]:a):a=(s==null?void 0:s.id)+"_process_results.json",U(a,r)}))},X=async(e,s,t)=>{const o=await d.get(e.links[1].href).then(r=>r.data);await A({selectedStac:s,results:o,jobId:e.jobID,mapElement:t})};async function A({selectedStac:e,results:s,jobId:t,mapElement:o}){const r=e==null?void 0:e.links.find(i=>i.rel==="service"&&i.endpoint=="eoxhub_workspaces");if(!r)return;const a=C(s),l=await $(a,r,e,t);D.debug("rendered layers after loading previous process:",l),G(o,l)}export{z as a,G as b,K as c,U as d,M as e,C as f,F as g,$ as h,B as i,Q as j,H as k,X as l,q as p,W as s,b as u};
