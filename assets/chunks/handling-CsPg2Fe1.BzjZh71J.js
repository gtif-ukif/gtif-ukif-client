import{d as Q,k,a as N,M as D,N as G,z as S,A as K,q as v,l as q,B as w,E as J,O as W,P as H,Q as F,R as $,S as V,T as X,U as Y}from"./eo-dash.UF-_AMWh.js";import{a as Z,g as I,e as j,b as ee,s as A,c as te,p as re,f as ae,u as _,h as ne,i as oe}from"./async-Y3lqquUe.Do1fzdBE.js";import{t as T}from"./item.Bx-rtsOD.js";async function se({links:e,jsonformValue:r,specUrl:s,customEndpointsHandler:t,jsonformSchema:a,selectedStac:o,isPolling:u,jobs:d,enableCompare:c=!1}){if(!s||!e)return[null,null];const l=await v.get(s).then(h=>h.data),n={},[f,i]=A(e,"service",void 0),p=t&&r&&await t({jsonformSchema:a,jsonformValue:r,links:i,selectedStac:o,isPolling:u,jobs:d,enableCompare:c});if(p&&p.length)return l.data.values=p,[l,n];const g=f.filter(h=>h.rel==="service");try{e:for(const h of g??[])switch(h.type){case void 0:continue;case"application/json":await ie(l,{url:h.href,jsonformValue:r,link:h,flatstyleUrl:h["eox:flatstyle"],jsonformSchema:a});break e;case"text/csv":await ce(l,{url:h.href,jsonformValue:r,flatstyleUrl:h["eox:flatstyle"]});break e}}catch(h){console.error("[eodash] Error while injecting Vega data",h)}return[l,n]}async function ie(e,{url:r,jsonformValue:s,link:t,flatstyleUrl:a,jsonformSchema:o}){var u;if(e.data){if(t.method=="GET"){const d=(u=o==null?void 0:o.options)==null?void 0:u.multiQuery,c=Object.keys(s??{}).filter(n=>Array.isArray(d)?d.includes(n):d===n);if(c.length>0&&s){const n=[];for(const f of c)if(Array.isArray(s[f]))for(const i of s[f]){const p=await C(r,{...s,[f]:i},a);n.push(await v.get(p).then(g=>g.data))}else{const i=await C(r,s,a);n.push(await v.get(i).then(p=>p.data))}return e.data.values=n.flat(),e}const l=await C(r,s,a);e.data.values=await v.get(l).then(n=>n.data)}else if(t.method=="POST"){if(!t.body)return console.error("[eodash] Inline data POST request requires a body template"),e;const d=await v.get(t.body,{responseType:"text"}).then(l=>l.data),c=JSON.parse(w.render(d,{...s??{}}));e.data.values=await v.post(r,c).then(l=>l.data)}return e}}async function ce(e,{url:r,jsonformValue:s,flatstyleUrl:t}){if(!e.data)return;const a=await C(r,s,t);return e.data.url=a,e}async function C(e,r,s){let t={};return s&&(t=await v.get(s).then(a=>a.data)),w.render(e,{...r??{},...t})}async function le({links:e,jsonformValue:r,layerId:s,projection:t}){if(!e)return;const[a]=A(e,"service","image/tiff");if(!a.length)return;let o=[],u="";for(const c of a??[])o.push(w.render(c.href,{...r??{}}));return await Promise.all(a.map(c=>te(c,s,o,t,u))).then(c=>c.filter(l=>!!l))}function ue(e,r,s){if(!e)return;const t=e.filter(o=>o.rel==="service"&&o.type==="image/png"),a=[];for(const o of t)a.push({type:"Image",properties:{id:o.id+"_process",title:"Results "+o.id},source:{type:"ImageStatic",imageExtent:s,url:w.render(o.href,{...r??{}})}});return a}async function de(e,r,s){if(!e)return;const t=[],a=e.filter(u=>u.rel==="service"&&u.type==="application/geo+json");if(!a.length)return t;let o=null;for(const u of a){"eox:flatstyle"in(u??{})&&(o=await v.get(u["eox:flatstyle"]).then(n=>n.data));let d,c;if(o){const n=W(s??"",o);d=n.layerConfig,c=n.style}const l={type:"Vector",source:{type:"Vector",url:w.render(u.href,{...r??{}}),format:"GeoJSON"},properties:{id:u.id+"_process",title:"Results "+s,...d&&{...d}},...c&&{style:c}};t.push(l)}return t}async function fe({links:e,jsonformValue:r,layerId:s,projection:t,origBbox:a,isPolling:o,selectedStac:u,jsonformSchema:d,jobs:c,customLayersHandler:l,enableCompare:n=!1}){if(!e)return[];const f=[],[i,p]=A(e,"service",void 0);if(l&&r&&u&&d&&p.length>0){const m=await l({jsonformValue:r,links:p,selectedStac:u,isPolling:o,jsonformSchema:d,jobs:c,enableCompare:n});m.length&&f.push(...m)}const g=await de(i,r,s),h=ue(i,r,a),x=await le({links:i,jsonformValue:r,layerId:s,projection:t});return f.push(...g??[],...h??[],...x??[]),f}async function pe(e,r,s=!1){const t=e.find(d=>d.rel==="service"&&d.type=="application/json; profile=collection"&&d.endpoint==="STAC");if(!t)return;let a=w.render(t.href,{...r??{}});J.value&&(J.value=!1);const o=N();await(s?o.loadSelectedCompareSTAC:o.loadSelectedSTAC)(a,!0)}async function he({links:e,jsonformValue:r,isPolling:s,selectedStac:t,jobs:a,enableCompare:o=!1}){if(!s)return;const u=e.filter(c=>c.rel==="service"&&c.endpoint==="eoxhub_workspaces"),d=[];for(const c of u){const l=await v.get(c.body,{responseType:"text"}).then(i=>i.data),n=JSON.parse(w.render(l,{...r??{}})),f=o?S:k;try{const i=await v.post(c.href,n,{headers:{"Content-Type":"application/json"}}),p=JSON.parse(localStorage.getItem(f.value)||"[]");p.push(i.headers.location),localStorage.setItem(f.value,JSON.stringify(p));const g=await re({jobs:a,processUrl:i.headers.location,isPolling:s,enableCompare:o}).then(h=>ae(h)).catch(h=>(h instanceof Error?console.error("Polling failed:",h.message):console.error("Unknown error occurred during polling:",h),[]));await _(a,f.value),d.push(...await ne(g,c,t))}catch(i){await _(a,f.value),i instanceof Error?console.error("Error sending POST request:",i.message):console.error("Unknown error occurred:",i)}}return d}const ge=ve([he]);function ve(e){return async r=>await Promise.all(e.map(s=>s(r))).then(s=>{const t=[];for(const a of s)t.push(...(a==null?void 0:a.filter(ye))??[]);return t})}function ye(e){return!!e&&!!e.type&&(!!e.source||!!e.layers)}async function we({links:e,jsonformValue:r,jsonformSchema:s,selectedStac:t,enableCompare:a=!1}){const o=e.find(i=>i.rel==="service"&&i.endpoint==="sentinelhub");if(!o)return;const u=await Pe(t,a?H.value:F.value);if(!u){console.error("[eodash] evalscript link for sentinel hub not found in indicator",u);return}if(!o)return;const d=o.href,c=I(s),l=r[c],n=await be();if(!n){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const f=oe(t.extent.temporal.interval[0],[r.start_date,r.end_date],r.distribution);return await Promise.all(f.map(([i,p])=>me({url:d,bearer:n,bbox:l,from:p,to:i,exampleLink:u}).catch(g=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",g)))).then(i=>i.flat().map(p=>p.outputs.data))}async function be(e,r){{console.error("[eodash] Error (sentinelhub): client id or secret not found");return}}async function me({url:e,bearer:r,bbox:s,from:t,to:a,timeout:o=2e4,exampleLink:u}){if(!u){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!s){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!t||!a||new Date(t)>new Date(a)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",t,a);return}const d=await v.get(u.href,{responseType:"text"}).then(n=>n.data);if(!d||d.error){console.error("[eodash] Error (sentinelhub): evalscript not found",d);return}const c={input:{bounds:{bbox:s},data:[{dataFilter:{},type:u.dataId}]},aggregation:{evalscript:d,timeRange:{from:t,to:a},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},l={headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:o};return await v.post(e,c,l).then(n=>{const f=n.data.data;return f.forEach(i=>{i.outputs.data.date=t}),f}).catch(n=>{var f,i;if(((f=n.response)==null?void 0:f.status)===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",(i=n.response)==null?void 0:i.data),[]})}async function Pe(e,r){const s=e.links.find(t=>t.rel==="example"&&t.title==="evalscript");if(s)return s;for(const t of $(e,r)){const a=v.get(t).then(o=>o.data.links.find(u=>u.rel==="example"&&u.title==="evalscript"));if(a)return a}}async function xe({links:e,jsonformSchema:r,jsonformValue:s,selectedStac:t,enableCompare:a=!1}){const o=e.find(n=>n.rel==="service"&&(n.endpoint==="veda"||n.endpoint==="veda_stac"));if(!o)return;const u=o==null?void 0:o.href,d=I(r),c=JSON.parse(s[d]),l=await ke(t,a?H.value:F.value,o);return await Promise.all(l.map(({endpoint:n,datetime:f})=>{const i=new URL(u),p=o.endpoint==="veda_stac"?"ids":"url";return i.searchParams.set(p,n),v.post(i.toString(),{type:"Feature",properties:{},geometry:c}).then(g=>{const h=g.data.properties.statistics;return h.date=f,h}).catch(g=>console.error("[eodash] Error while fetching data from veda endpoint:",g))}))}async function ke(e,r,s){const t=e.links.filter(l=>l.rel=="child"),a=[];t.length?a.push(...await Promise.all(t.map(l=>v.get(T(l.href,r)).then(n=>n.data).then(async n=>{const f=Object.values(n.assets??{}).find(i=>{var p;return i.type==="application/vnd.apache.parquet"&&((p=i.roles)==null?void 0:p.includes("collection-mirror"))});if(f){const i=T(f.href,T(l.href,r));await V(i).then(p=>{n.links.push(...X(p))})}return n})))):a.push(e);const o=[];for(const l of a){const n=Y(l.links),f=l.links.filter(i=>i.rel=="item");o.push(...f.map(i=>({endpoint:s.endpoint==="veda_stac"?i.id:i.cog_href,datetime:i[n]})))}o.sort((l,n)=>new Date(l.datetime).getTime()-new Date(n.datetime).getTime());const u=50;if(o.length<=u)return o;const d=o.length,c=[];for(let l=0;l<u;l++){const n=Math.floor(l*(d-1)/(u-1));c.push(o[n])}return c}const Ce=Le([we,xe]);function Le(e){return async r=>{for(const s of e){const t=await s(r);if(q.debug("Custom endpoint data:",t,"for callback:",s.name,"inputs:",r),!(!t||!t.length||t.some(o=>!o)))return t}return null}}async function Oe({selectedStac:e,jsonformEl:r,jsonformSchema:s,chartSpec:t,isProcessed:a,processResults:o,loading:u,isPolling:d,enableCompare:c}){var f,i;const l=c?!!G.value:!!K.value;let n=null;if((f=e.value)!=null&&f["eodash:jsonform"]&&(n=await v.get(e.value["eodash:jsonform"]).then(p=>p.data)),!n&&l){s.value=null;return}Te({loading:u,isProcessed:a,chartSpec:t,jsonformSchema:s,isPolling:d,processResults:o}),await((i=r.value)==null?void 0:i.editor.destroy()),n&&(c&&(n=Z(n)),s.value=n)}async function Ee({loading:e,selectedStac:r,jsonformEl:s,jsonformSchema:t,chartSpec:a,chartData:o,isPolling:u,processResults:d,mapElement:c,jobs:l}){var n,f,i,p,g,h,x,m,O,E,U;if(!(!s.value||!t.value||!r.value)){q.debug("Processing..."),e.value=!0;try{const b=(f=(n=r.value)==null?void 0:n.links)==null?void 0:f.filter(y=>y.rel==="service"),B=I(t.value),P=(i=s.value)==null?void 0:i.value;j(P,t.value);const R=P[B],z=(p=r.value)==null?void 0:p["eodash:vegadefinition"],M=((g=r.value)==null?void 0:g.id)??"";[a.value,o.value]=await se({links:b,jsonformValue:{...P??{}},jsonformSchema:t.value,enableCompare:(c==null?void 0:c.id)==="compare",selectedStac:r.value,specUrl:z,isPolling:u,jobs:l,customEndpointsHandler:Ce}),Object.keys(o.value??{}).length&&d.value.push(o.value),(m=(x=(h=a.value)==null?void 0:h.data)==null?void 0:x.values)!=null&&m.length&&d.value.push((O=a.value)==null?void 0:O.data.values),a.value&&!("background"in a.value)&&(a.value.background="transparent"),await pe(b,P,(c==null?void 0:c.id)==="compare");const L=await fe({isPolling:u,links:b,jsonformValue:{...P??{}},jsonformSchema:t.value,selectedStac:r.value,enableCompare:(c==null?void 0:c.id)==="compare",layerId:M,origBbox:R,jobs:l,customLayersHandler:ge,projection:(E=r.value["eodash:mapProjection"])==null?void 0:E.name});if(L.length)for(const y of L)y.type==="WebGLTile"&&((U=y.source)==null?void 0:U.type)==="GeoTIFF"?d.value.push(...y.source.sources??[]):y.source&&"url"in y.source&&d.value.push(y.source.url);ee(c,L),e.value=!1}catch(b){throw console.error("[eodash] Error while running process:",b),e.value=!1,b}}}function Te({loading:e,isProcessed:r,chartSpec:s,jsonformSchema:t,processResults:a,isPolling:o}){e.value=!1,r.value=!1,o.value=!1,s.value=null,a.value=[],t.value=null}const Ue=e=>{var a,o,u,d,c,l;const r=(a=e.target)==null?void 0:a.spec;if(!r||!((u=(o=e.detail)==null?void 0:o.item)!=null&&u.datum)||!((c=(d=e.detail)==null?void 0:d.item)!=null&&c.datum.datum))return;const s=Object.keys(r.encoding??{}).find(n=>{var f;return((f=r.encoding)==null?void 0:f[n].type)==="temporal"});if(!s)return;const t=(l=r.encoding)==null?void 0:l[s].field;if(t)try{const n=e.detail.item;let f="";n.datum&&n.datum.datum?f=n.datum.datum[t]:f=n.datum[t];const i=new Date(f);Q.value=i.toISOString()}catch(n){console.warn("[eodash] Error while setting datetime from eox-chart:",n)}},De=()=>{var s,t;k.value||(k.value=new URLSearchParams(window.location.search).get("indicator")??"");const e=N(),r=(s=e.stac)==null?void 0:s.find(a=>D(a)===k.value);if(e.loadSelectedSTAC(r==null?void 0:r.href),G.value)if(S.value){const a=(t=e.stac)==null?void 0:t.find(o=>D(o)===S.value);e.loadSelectedCompareSTAC(a==null?void 0:a.href).catch(o=>{console.error("[eodash] Error loading compare STAC:",o)})}else e.resetSelectedCompareSTAC()};export{Ee as h,Oe as i,De as l,Ue as o};
