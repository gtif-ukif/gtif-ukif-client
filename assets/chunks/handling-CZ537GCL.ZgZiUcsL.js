import{d as Q,k as P,a as G,L as U,M as _,y as S,z as K,q as g,l as q,A as w,D as J,N as $,O as H,P as F,Q as W,R as V,S as X,T as Y}from"./eo-dash.Cy6AWBjk.js";import{a as Z,g as I,e as j,b as ee,s as A,c as te,p as re,f as ae,u as N,h as ne,i as oe}from"./async-C1hb39Tc.DI-kM5uJ.js";import{t as T}from"./item.Bx-rtsOD.js";async function se({links:e,jsonformValue:a,specUrl:n,customEndpointsHandler:t,jsonformSchema:r,selectedStac:s,isPolling:f,jobs:d,enableCompare:o=!1}){if(!n||!e)return[null,null];const u=await g.get(n).then(p=>p.data),i={},[c,l]=A(e,"service",void 0),h=t&&a&&await t({jsonformSchema:r,jsonformValue:a,links:l,selectedStac:s,isPolling:f,jobs:d,enableCompare:o});if(h&&h.length)return u.data.values=h,[u,i];const v=c.filter(p=>p.rel==="service");try{e:for(const p of v??[])switch(p.type){case void 0:continue;case"application/json":await ie(u,{url:p.href,jsonformValue:a,link:p,flatstyleUrl:p["eox:flatstyle"],jsonformSchema:r});break e;case"text/csv":await ce(u,{url:p.href,jsonformValue:a,flatstyleUrl:p["eox:flatstyle"]});break e}}catch(p){console.error("[eodash] Error while injecting Vega data",p)}return[u,i]}async function ie(e,{url:a,jsonformValue:n,link:t,flatstyleUrl:r,jsonformSchema:s}){var f;if(e.data){if(t.method=="GET"){const d=(f=s==null?void 0:s.options)==null?void 0:f.multiQuery,o=Object.keys(n??{}).filter(i=>Array.isArray(d)?d.includes(i):d===i);if(o.length>0&&n){const i=[];for(const c of o)if(Array.isArray(n[c]))for(const l of n[c]){const h=await C(a,{...n,[c]:l},r);i.push(await g.get(h).then(v=>v.data))}else{const l=await C(a,n,r);i.push(await g.get(l).then(h=>h.data))}return e.data.values=i.flat(),e}const u=await C(a,n,r);e.data.values=await g.get(u).then(i=>i.data)}else if(t.method=="POST"){if(!t.body)return console.error("[eodash] Inline data POST request requires a body template"),e;const d=await g.get(t.body,{responseType:"text"}).then(u=>u.data),o=JSON.parse(w.render(d,{...n??{}}));e.data.values=await g.post(a,o).then(u=>u.data)}return e}}async function ce(e,{url:a,jsonformValue:n,flatstyleUrl:t}){if(!e.data)return;const r=await C(a,n,t);return e.data.url=r,e}async function C(e,a,n){let t={};return n&&(t=await g.get(n).then(r=>r.data)),w.render(e,{...a??{},...t})}async function le({links:e,jsonformValue:a,layerId:n,projection:t}){if(!e)return;const[r]=A(e,"service","image/tiff");if(!r.length)return;let s=[],f="";for(const o of r??[])s.push(w.render(o.href,{...a??{}}));return await Promise.all(r.map(o=>te(o,n,s,t,f))).then(o=>o.filter(u=>!!u))}function ue(e,a,n){if(!e)return;const t=e.filter(s=>s.rel==="service"&&s.type==="image/png"),r=[];for(const s of t)r.push({type:"Image",properties:{id:s.id+"_process",title:"Results "+s.id},source:{type:"ImageStatic",imageExtent:n,url:w.render(s.href,{...a??{}})}});return r}async function de(e,a,n){if(!e)return;const t=[],r=e.filter(f=>f.rel==="service"&&f.type==="application/geo+json");if(!r.length)return t;let s=null;for(const f of r){"eox:flatstyle"in(f??{})&&(s=await g.get(f["eox:flatstyle"]).then(i=>i.data));let d,o;if(s){const i=$(n??"",s);d=i.layerConfig,o=i.style}const u={type:"Vector",source:{type:"Vector",url:w.render(f.href,{...a??{}}),format:"GeoJSON"},properties:{id:f.id+"_process",title:"Results "+n,...d&&{...d}},...o&&{style:o}};t.push(u)}return t}async function fe({links:e,jsonformValue:a,layerId:n,projection:t,origBbox:r,isPolling:s,selectedStac:f,jsonformSchema:d,jobs:o,customLayersHandler:u,enableCompare:i=!1}){if(!e)return[];const c=[],[l,h]=A(e,"service",void 0);if(u&&a&&f&&d&&h.length>0){const m=await u({jsonformValue:a,links:h,selectedStac:f,isPolling:s,jsonformSchema:d,jobs:o,enableCompare:i});m.length&&c.push(...m)}const v=await de(l,a,n),p=ue(l,a,r),x=await le({links:l,jsonformValue:a,layerId:n,projection:t});return c.push(...v??[],...p??[],...x??[]),c}async function he(e,a,n=!1){const t=e.find(d=>d.rel==="service"&&d.type=="application/json; profile=collection"&&d.endpoint==="STAC");if(!t)return;let r=w.render(t.href,{...a??{}});J.value&&(J.value=!1);const s=G();await(n?s.loadSelectedCompareSTAC:s.loadSelectedSTAC)(r,!0)}async function pe({links:e,jsonformValue:a,isPolling:n,selectedStac:t,jobs:r,enableCompare:s=!1}){if(!n)return;const f=e.filter(o=>o.rel==="service"&&o.endpoint==="eoxhub_workspaces"),d=[];for(const o of f){const u=await g.get(o.body,{responseType:"text"}).then(l=>l.data),i=JSON.parse(w.render(u,{...a??{}})),c=s?S:P;try{const l=await g.post(o.href,i,{headers:{"Content-Type":"application/json"}}),h=JSON.parse(localStorage.getItem(c.value)||"[]");h.push(l.headers.location),localStorage.setItem(c.value,JSON.stringify(h));const v=await re({jobs:r,processUrl:l.headers.location,isPolling:n,enableCompare:s}).then(p=>ae(p)).catch(p=>(p instanceof Error?console.error("Polling failed:",p.message):console.error("Unknown error occurred during polling:",p),[]));await N(r,c.value),d.push(...await ne(v,o,t))}catch(l){await N(r,c.value),l instanceof Error?console.error("Error sending POST request:",l.message):console.error("Unknown error occurred:",l)}}return d}const ge=ve([pe]);function ve(e){return async a=>await Promise.all(e.map(n=>n(a))).then(n=>{const t=[];for(const r of n)t.push(...(r==null?void 0:r.filter(ye))??[]);return t})}function ye(e){return!!e&&!!e.type&&(!!e.source||!!e.layers)}async function we({links:e,jsonformValue:a,jsonformSchema:n,selectedStac:t,enableCompare:r=!1}){const s=e.find(l=>l.rel==="service"&&l.endpoint==="sentinelhub");if(!s)return;const f=await ke(t,r?H.value:F.value);if(!f){console.error("[eodash] evalscript link for sentinel hub not found in indicator",f);return}if(!s)return;const d=s.href,o=I(n),u=a[o],i=await be();if(!i){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const c=oe(t.extent.temporal.interval[0],[a.start_date,a.end_date],a.distribution);return await Promise.all(c.map(([l,h])=>me({url:d,bearer:i,bbox:u,from:h,to:l,exampleLink:f}).catch(v=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",v)))).then(l=>l.flat().map(h=>h.outputs.data))}async function be(e,a){{console.error("[eodash] Error (sentinelhub): client id or secret not found");return}}async function me({url:e,bearer:a,bbox:n,from:t,to:r,timeout:s=2e4,exampleLink:f}){if(!f){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!n){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!t||!r||new Date(t)>new Date(r)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",t,r);return}const d=await g.get(f.href,{responseType:"text"}).then(i=>i.data);if(!d||d.error){console.error("[eodash] Error (sentinelhub): evalscript not found",d);return}const o={input:{bounds:{bbox:n},data:[{dataFilter:{},type:f.dataId}]},aggregation:{evalscript:d,timeRange:{from:t,to:r},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},u={headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:s};return await g.post(e,o,u).then(i=>{const c=i.data.data;return c.forEach(l=>{l.outputs.data.date=t}),c}).catch(i=>{var c,l;if(((c=i.response)==null?void 0:c.status)===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",(l=i.response)==null?void 0:l.data),[]})}async function ke(e,a){const n=e.links.find(t=>t.rel==="example"&&t.title==="evalscript");if(n)return n;for(const t of W(e,a)){const r=g.get(t).then(s=>s.data.links.find(f=>f.rel==="example"&&f.title==="evalscript"));if(r)return r}}async function xe({links:e,jsonformSchema:a,jsonformValue:n,selectedStac:t,enableCompare:r=!1}){const s=e.find(i=>i.rel==="service"&&i.endpoint==="veda");if(!s)return;const f=s==null?void 0:s.href,d=I(a),o=JSON.parse(n[d]),u=await Pe(t,r?H.value:F.value);return await Promise.all(u.map(({endpoint:i,datetime:c})=>g.post(f+`?url=${i}`,{type:"Feature",properties:{},geometry:o}).then(l=>{const h=l.data.properties.statistics;return h.date=c,h}).catch(l=>console.error("[eodash] Error while fetching data from veda endpoint:",l))))}async function Pe(e,a){const n=e.links.filter(o=>o.rel=="child"),t=[];n.length?t.push(...await Promise.all(n.map(o=>g.get(T(o.href,a)).then(u=>u.data).then(async u=>{const i=Object.values(u.assets??{}).find(c=>{var l;return c.type==="application/vnd.apache.parquet"&&((l=c.roles)==null?void 0:l.includes("collection-mirror"))});if(i){const c=T(i.href,T(o.href,a));await V(c).then(l=>{u.links.push(...X(l))})}return u})))):t.push(e);const r=[];for(const o of t){const u=Y(o.links),i=o.links.filter(c=>c.rel=="item");r.push(...i.map(c=>({endpoint:c.cog_href,datetime:c[u]})))}r.sort((o,u)=>new Date(o.datetime).getTime()-new Date(u.datetime).getTime());const s=50;if(r.length<=s)return r;const f=r.length,d=[];for(let o=0;o<s;o++){const u=Math.floor(o*(f-1)/(s-1));d.push(r[u])}return d}const Ce=Le([we,xe]);function Le(e){return async a=>{for(const n of e){const t=await n(a);if(q.debug("Custom endpoint data:",t,"for callback:",n.name,"inputs:",a),!(!t||!t.length||t.some(s=>!s)))return t}return null}}async function Oe({selectedStac:e,jsonformEl:a,jsonformSchema:n,chartSpec:t,isProcessed:r,processResults:s,loading:f,isPolling:d,enableCompare:o}){var c,l;const u=o?!!_.value:!!K.value;let i=null;if((c=e.value)!=null&&c["eodash:jsonform"]&&(i=await g.get(e.value["eodash:jsonform"]).then(h=>h.data)),!i&&u){n.value=null;return}Te({loading:f,isProcessed:r,chartSpec:t,jsonformSchema:n,isPolling:d,processResults:s}),await((l=a.value)==null?void 0:l.editor.destroy()),i&&(o&&(i=Z(i)),n.value=i)}async function Ee({loading:e,selectedStac:a,jsonformEl:n,jsonformSchema:t,chartSpec:r,chartData:s,isPolling:f,processResults:d,mapElement:o,jobs:u}){var i,c,l,h,v,p,x,m,O,E,D;if(!(!n.value||!t.value||!a.value)){q.debug("Processing..."),e.value=!0;try{const b=(c=(i=a.value)==null?void 0:i.links)==null?void 0:c.filter(y=>y.rel==="service"),B=I(t.value),k=(l=n.value)==null?void 0:l.value;j(k,t.value);const R=k[B],z=(h=a.value)==null?void 0:h["eodash:vegadefinition"],M=((v=a.value)==null?void 0:v.id)??"";[r.value,s.value]=await se({links:b,jsonformValue:{...k??{}},jsonformSchema:t.value,enableCompare:(o==null?void 0:o.id)==="compare",selectedStac:a.value,specUrl:z,isPolling:f,jobs:u,customEndpointsHandler:Ce}),Object.keys(s.value??{}).length&&d.value.push(s.value),(m=(x=(p=r.value)==null?void 0:p.data)==null?void 0:x.values)!=null&&m.length&&d.value.push((O=r.value)==null?void 0:O.data.values),r.value&&!("background"in r.value)&&(r.value.background="transparent"),await he(b,k,(o==null?void 0:o.id)==="compare");const L=await fe({isPolling:f,links:b,jsonformValue:{...k??{}},jsonformSchema:t.value,selectedStac:a.value,enableCompare:(o==null?void 0:o.id)==="compare",layerId:M,origBbox:R,jobs:u,customLayersHandler:ge,projection:(E=a.value["eodash:mapProjection"])==null?void 0:E.name});if(L.length)for(const y of L)y.type==="WebGLTile"&&((D=y.source)==null?void 0:D.type)==="GeoTIFF"?d.value.push(...y.source.sources??[]):y.source&&"url"in y.source&&d.value.push(y.source.url);ee(o,L),e.value=!1}catch(b){throw console.error("[eodash] Error while running process:",b),e.value=!1,b}}}function Te({loading:e,isProcessed:a,chartSpec:n,jsonformSchema:t,processResults:r,isPolling:s}){e.value=!1,a.value=!1,s.value=!1,n.value=null,r.value=[],t.value=null}const De=e=>{var r,s,f,d,o,u;const a=(r=e.target)==null?void 0:r.spec;if(!a||!((f=(s=e.detail)==null?void 0:s.item)!=null&&f.datum)||!((o=(d=e.detail)==null?void 0:d.item)!=null&&o.datum.datum))return;const n=Object.keys(a.encoding??{}).find(i=>{var c;return((c=a.encoding)==null?void 0:c[i].type)==="temporal"});if(!n)return;const t=(u=a.encoding)==null?void 0:u[n].field;if(t)try{const i=e.detail.item;let c="";i.datum&&i.datum.datum?c=i.datum.datum[t]:c=i.datum[t];const l=new Date(c);Q.value=l.toISOString()}catch(i){console.warn("[eodash] Error while setting datetime from eox-chart:",i)}},Ue=()=>{var n,t;P.value||(P.value=new URLSearchParams(window.location.search).get("indicator")??"");const e=G(),a=(n=e.stac)==null?void 0:n.find(r=>U(r)===P.value);if(e.loadSelectedSTAC(a==null?void 0:a.href),_.value)if(S.value){const r=(t=e.stac)==null?void 0:t.find(s=>U(s)===S.value);e.loadSelectedCompareSTAC(r==null?void 0:r.href).catch(s=>{console.error("[eodash] Error loading compare STAC:",s)})}else e.resetSelectedCompareSTAC()};export{Ee as h,Oe as i,Ue as l,De as o};
