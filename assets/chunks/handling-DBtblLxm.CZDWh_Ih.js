import{d as Q,k as x,a as N,M as D,N as G,z as I,A as W,q as g,O as K,l as q,B as m,E as J,P as $,Q as H,R as F,S as V,T as X,U as Y,W as Z}from"./eo-dash.BEQ7Ey2_.js";import{a as j,g as ee,b as S,e as te,c as re,s as A,f as ae,p as ne,h as oe,u as _,i as se,j as ie}from"./async-Du7k1bKY.B2ZnbfjL.js";import{t as T}from"./item.Bx-rtsOD.js";async function le({links:e,jsonformValue:t,specUrl:a,customEndpointsHandler:r,jsonformSchema:n,selectedStac:s,isPolling:u,jobs:f,enableCompare:l=!1}){if(!a||!e)return[null,null];const c=await g.get(a).then(h=>h.data),o={},[d,i]=A(e,"service",void 0),p=r&&t&&await r({jsonformSchema:n,jsonformValue:t,links:i,selectedStac:s,isPolling:u,jobs:f,enableCompare:l});if(p&&p.length)return c.data.values=p,[c,o];const y=d.filter(h=>h.rel==="service");try{e:for(const h of y??[])switch(h.type){case void 0:continue;case"application/json":await ce(c,{url:h.href,jsonformValue:t,link:h,flatstyleUrl:h["eox:flatstyle"],jsonformSchema:n});break e;case"text/csv":await ue(c,{url:h.href,jsonformValue:t,flatstyleUrl:h["eox:flatstyle"]});break e}}catch(h){console.error("[eodash] Error while injecting Vega data",h)}return[c,o]}async function ce(e,{url:t,jsonformValue:a,link:r,flatstyleUrl:n,jsonformSchema:s}){var u;if(e.data){if(r.method=="GET"){const f=(u=s==null?void 0:s.options)==null?void 0:u.multiQuery,l=Object.keys(a??{}).filter(o=>Array.isArray(f)?f.includes(o):f===o);if(l.length>0&&a){const o=[];for(const d of l)if(Array.isArray(a[d]))for(const i of a[d]){const p=await C(t,{...a,[d]:i},n);o.push(await g.get(p).then(y=>y.data))}else{const i=await C(t,a,n);o.push(await g.get(i).then(p=>p.data))}return e.data.values=o.flat(),e}const c=await C(t,a,n);e.data.values=await g.get(c).then(o=>o.data)}else if(r.method=="POST"){if(!r.body)return console.error("[eodash] Inline data POST request requires a body template"),e;const f=await g.get(r.body,{responseType:"text"}).then(c=>c.data),l=JSON.parse(m.render(f,{...a??{}}));e.data.values=await g.post(t,l).then(c=>c.data)}return e}}async function ue(e,{url:t,jsonformValue:a,flatstyleUrl:r}){if(!e.data)return;const n=await C(t,a,r);return e.data.url=n,e}async function C(e,t,a){let r={};return a&&(r=await g.get(a).then(n=>n.data)),m.render(e,{...t??{},...r})}async function de({links:e,jsonformValue:t,layerId:a,projection:r}){if(!e)return;const[n]=A(e,"service","image/tiff");if(!n.length)return;let s=[],u="";for(const l of n??[])s.push(m.render(l.href,{...t??{}}));return await Promise.all(n.map(l=>ae(l,a,s,r,u))).then(l=>l.filter(c=>!!c))}function fe(e,t,a){if(!e)return;const r=e.filter(s=>s.rel==="service"&&s.type==="image/png"),n=[];for(const s of r)n.push({type:"Image",properties:{id:s.id+"_process",title:"Results "+s.id},source:{type:"ImageStatic",imageExtent:a,url:m.render(s.href,{...t??{}})}});return n}async function pe(e,t,a){if(!e)return;const r=[],n=e.filter(u=>u.rel==="service"&&u.type==="application/geo+json");if(!n.length)return r;let s=null;for(const u of n){"eox:flatstyle"in(u??{})&&(s=await g.get(u["eox:flatstyle"]).then(o=>o.data));let f,l;if(s){const o=$(a??"",s);f=o.layerConfig,l=o.style}const c={type:"Vector",source:{type:"Vector",url:m.render(u.href,{...t??{}}),format:"GeoJSON"},properties:{id:u.id+"_process",title:"Results "+a,...f&&{...f}},...l&&{style:l}};r.push(c)}return r}async function he({links:e,jsonformValue:t,layerId:a,projection:r,origBbox:n,isPolling:s,selectedStac:u,jsonformSchema:f,jobs:l,customLayersHandler:c,enableCompare:o=!1}){if(!e)return[];const d=[],[i,p]=A(e,"service",void 0);if(c&&t&&u&&f&&p.length>0){const b=await c({jsonformValue:t,links:p,selectedStac:u,isPolling:s,jsonformSchema:f,jobs:l,enableCompare:o});b.length&&d.push(...b)}const y=await pe(i,t,a),h=fe(i,t,n),w=await de({links:i,jsonformValue:t,layerId:a,projection:r});return d.push(...y??[],...h??[],...w??[]),d}async function ye(e,t,a=!1){const r=e.find(f=>f.rel==="service"&&f.type=="application/json; profile=collection"&&f.endpoint==="STAC");if(!r)return;let n=m.render(r.href,{...t??{}});J.value&&(J.value=!1);const s=N();await(a?s.loadSelectedCompareSTAC:s.loadSelectedSTAC)(n,!0)}async function ge({links:e,jsonformValue:t,isPolling:a,selectedStac:r,jobs:n,enableCompare:s=!1}){if(!a)return;const u=e.filter(l=>l.rel==="service"&&l.endpoint==="eoxhub_workspaces"),f=[];for(const l of u){const c=await g.get(l.body,{responseType:"text"}).then(i=>i.data),o=JSON.parse(m.render(c,{...t??{}})),d=s?I:x;try{const i=await g.post(l.href,o,{headers:{"Content-Type":"application/json"}}),p=JSON.parse(localStorage.getItem(d.value)||"[]");p.push(i.headers.location),localStorage.setItem(d.value,JSON.stringify(p));const y=await ne({jobs:n,processUrl:i.headers.location,isPolling:a,enableCompare:s}).then(h=>oe(h)).catch(h=>(h instanceof Error?console.error("Polling failed:",h.message):console.error("Unknown error occurred during polling:",h),[]));await _(n,d.value),f.push(...await se(y,l,r))}catch(i){await _(n,d.value),i instanceof Error?console.error("Error sending POST request:",i.message):console.error("Unknown error occurred:",i)}}return f}const ve=we([ge]);function we(e){return async t=>await Promise.all(e.map(a=>a(t))).then(a=>{const r=[];for(const n of a)r.push(...(n==null?void 0:n.filter(be))??[]);return r})}function be(e){return!!e&&!!e.type&&(!!e.source||!!e.layers)}async function me({links:e,jsonformValue:t,jsonformSchema:a,selectedStac:r,enableCompare:n=!1}){const s=e.find(i=>i.rel==="service"&&i.endpoint==="sentinelhub");if(!s)return;const u=await xe(r,n?H.value:F.value);if(!u){console.error("[eodash] evalscript link for sentinel hub not found in indicator",u);return}if(!s)return;const f=s.href,l=S(a),c=t[l],o=await Pe();if(!o){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const d=ie(r.extent.temporal.interval[0],[t.start_date,t.end_date],t.distribution);return await Promise.all(d.map(([i,p])=>ke({url:f,bearer:o,bbox:c,from:p,to:i,exampleLink:u}).catch(y=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",y)))).then(i=>i.flat().map(p=>p.outputs.data))}async function Pe(e,t){{console.error("[eodash] Error (sentinelhub): client id or secret not found");return}}async function ke({url:e,bearer:t,bbox:a,from:r,to:n,timeout:s=2e4,exampleLink:u}){if(!u){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!a){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!r||!n||new Date(r)>new Date(n)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",r,n);return}const f=await g.get(u.href,{responseType:"text"}).then(o=>o.data);if(!f||f.error){console.error("[eodash] Error (sentinelhub): evalscript not found",f);return}const l={input:{bounds:{bbox:a},data:[{dataFilter:{},type:u.dataId}]},aggregation:{evalscript:f,timeRange:{from:r,to:n},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},c={headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:s};return await g.post(e,l,c).then(o=>{const d=o.data.data;return d.forEach(i=>{i.outputs.data.date=r}),d}).catch(o=>{var d,i;if(((d=o.response)==null?void 0:d.status)===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",(i=o.response)==null?void 0:i.data),[]})}async function xe(e,t){const a=e.links.find(r=>r.rel==="example"&&r.title==="evalscript");if(a)return a;for(const r of V(e,t)){const n=g.get(r).then(s=>s.data.links.find(u=>u.rel==="example"&&u.title==="evalscript"));if(n)return n}}async function Ce({links:e,jsonformSchema:t,jsonformValue:a,selectedStac:r,enableCompare:n=!1}){const s=e.find(o=>o.rel==="service"&&(o.endpoint==="veda"||o.endpoint==="veda_stac"));if(!s)return;const u=s==null?void 0:s.href,f=S(t),l=JSON.parse(a[f]),c=await Le(r,n?H.value:F.value,s);return await Promise.all(c.map(({endpoint:o,datetime:d})=>{const i=new URL(u),p=s.endpoint==="veda_stac"?"ids":"url";return i.searchParams.set(p,o),g.post(i.toString(),{type:"Feature",properties:{},geometry:l}).then(y=>{const h=y.data.properties.statistics;return h.date=d,h}).catch(y=>console.error("[eodash] Error while fetching data from veda endpoint:",y))}))}async function Le(e,t,a){const r=e.links.filter(c=>c.rel=="child"),n=[];r.length?n.push(...await Promise.all(r.map(c=>g.get(T(c.href,t)).then(o=>o.data).then(async o=>{const d=Object.values(o.assets??{}).find(i=>{var p;return i.type==="application/vnd.apache.parquet"&&((p=i.roles)==null?void 0:p.includes("collection-mirror"))});if(d){const i=T(d.href,T(c.href,t));await X(i).then(p=>{o.links.push(...Y(p))})}return o})))):n.push(e);const s=[];for(const c of n){const o=Z(c.links),d=c.links.filter(i=>i.rel=="item");s.push(...d.map(i=>({endpoint:a.endpoint==="veda_stac"?i.id:i.cog_href,datetime:i[o]})))}s.sort((c,o)=>new Date(c.datetime).getTime()-new Date(o.datetime).getTime());const u=50;if(s.length<=u)return s;const f=s.length,l=[];for(let c=0;c<u;c++){const o=Math.floor(c*(f-1)/(u-1));l.push(s[o])}return l}const Te=Ie([me,Ce]);function Ie(e){return async t=>{for(const a of e){const r=await a(t);if(q.debug("Custom endpoint data:",r,"for callback:",a.name,"inputs:",t),!(!r||!r.length||r.some(s=>!s)))return r}return null}}async function De({selectedStac:e,jsonformEl:t,jsonformSchema:a,chartSpec:r,isProcessed:n,processResults:s,loading:u,isPolling:f,enableCompare:l}){var d,i,p,y,h,w;const c=l?!!G.value:!!W.value;let o=null;if((d=e.value)!=null&&d["eodash:jsonform"]&&(o=await g.get(e.value["eodash:jsonform"]).then(b=>b.data)),!o&&c){a.value=null;return}Ae({loading:u,isProcessed:n,chartSpec:r,jsonformSchema:a,isPolling:f,processResults:s}),await((i=t.value)==null?void 0:i.editor.destroy()),o&&((w=(h=(y=(p=o.properties)==null?void 0:p.feature)==null?void 0:y.options)==null?void 0:h.drawtools)!=null&&w.layerId&&await Se({jsonformSchema:a,newLayers:await K()}),l&&(o=j(o)),a.value=o)}async function Se({jsonformSchema:e,newLayers:t}){var n,s,u;const a=e.value;if(!a)return;const r=ee(a);if(r&&t&&((u=(s=(n=a==null?void 0:a.properties[r])==null?void 0:n.options)==null?void 0:s.drawtools)!=null&&u.layerId)){let f=t;t.layers&&Array.isArray(t.layers)&&(f=t.layers);const l=a.properties[r].options.drawtools.layerId.split(";:;")[0];let c=null;const o=d=>{var i,p;if(d){for(const y of d)if(y.layers)o(y);else if((p=(i=y.properties)==null?void 0:i.id)!=null&&p.startsWith(l)){c=y.properties.id;break}}};if(o(f),c)a.properties.feature.options.drawtools.layerId=c,e.value=null,await new Promise(d=>setTimeout(d,0)),e.value=a;else throw new Error(`Could not find matching layer for processing form with id: ${l}`)}}async function Je({loading:e,selectedStac:t,jsonformEl:a,jsonformSchema:r,chartSpec:n,chartData:s,isPolling:u,processResults:f,mapElement:l,jobs:c}){var o,d,i,p,y,h,w,b,O,E,U;if(!(!a.value||!r.value||!t.value)){q.debug("Processing..."),e.value=!0;try{const P=(d=(o=t.value)==null?void 0:o.links)==null?void 0:d.filter(v=>v.rel==="service"),B=S(r.value),k=(i=a.value)==null?void 0:i.value;te(k,r.value);const R=k[B],z=(p=t.value)==null?void 0:p["eodash:vegadefinition"],M=((y=t.value)==null?void 0:y.id)??"";[n.value,s.value]=await le({links:P,jsonformValue:{...k??{}},jsonformSchema:r.value,enableCompare:(l==null?void 0:l.id)==="compare",selectedStac:t.value,specUrl:z,isPolling:u,jobs:c,customEndpointsHandler:Te}),Object.keys(s.value??{}).length&&f.value.push(s.value),(b=(w=(h=n.value)==null?void 0:h.data)==null?void 0:w.values)!=null&&b.length&&f.value.push((O=n.value)==null?void 0:O.data.values),n.value&&!("background"in n.value)&&(n.value.background="transparent"),await ye(P,k,(l==null?void 0:l.id)==="compare");const L=await he({isPolling:u,links:P,jsonformValue:{...k??{}},jsonformSchema:r.value,selectedStac:t.value,enableCompare:(l==null?void 0:l.id)==="compare",layerId:M,origBbox:R,jobs:c,customLayersHandler:ve,projection:(E=t.value["eodash:mapProjection"])==null?void 0:E.name});if(L.length)for(const v of L)v.type==="WebGLTile"&&((U=v.source)==null?void 0:U.type)==="GeoTIFF"?f.value.push(...v.source.sources??[]):v.source&&"url"in v.source&&f.value.push(v.source.url);re(l,L),e.value=!1}catch(P){throw console.error("[eodash] Error while running process:",P),e.value=!1,P}}}function Ae({loading:e,isProcessed:t,chartSpec:a,jsonformSchema:r,processResults:n,isPolling:s}){e.value=!1,t.value=!1,s.value=!1,a.value=null,n.value=[],r.value=null}const _e=e=>{var n,s,u,f,l,c;const t=(n=e.target)==null?void 0:n.spec;if(!t||!((u=(s=e.detail)==null?void 0:s.item)!=null&&u.datum)||!((l=(f=e.detail)==null?void 0:f.item)!=null&&l.datum.datum))return;const a=Object.keys(t.encoding??{}).find(o=>{var d;return((d=t.encoding)==null?void 0:d[o].type)==="temporal"});if(!a)return;const r=(c=t.encoding)==null?void 0:c[a].field;if(r)try{const o=e.detail.item;let d="";o.datum&&o.datum.datum?d=o.datum.datum[r]:d=o.datum[r];const i=new Date(d);Q.value=i.toISOString()}catch(o){console.warn("[eodash] Error while setting datetime from eox-chart:",o)}},Ne=()=>{var a,r;x.value||(x.value=new URLSearchParams(window.location.search).get("indicator")??"");const e=N(),t=(a=e.stac)==null?void 0:a.find(n=>D(n)===x.value);if(e.loadSelectedSTAC(t==null?void 0:t.href),G.value)if(I.value){const n=(r=e.stac)==null?void 0:r.find(s=>D(s)===I.value);e.loadSelectedCompareSTAC(n==null?void 0:n.href).catch(s=>{console.error("[eodash] Error loading compare STAC:",s)})}else e.resetSelectedCompareSTAC()};export{Je as h,De as i,Ne as l,_e as o,Se as u};
