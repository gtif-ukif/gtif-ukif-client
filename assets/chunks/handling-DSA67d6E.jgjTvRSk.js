import{k as x,a as _,T as E,U as N,z as A,d as K,A as Q,q as v,W as X,M as G,N as q,l as F,O as Y,P as Z,C,F as U,X as V,Y as H,Z as B,$ as j,a0 as ee,a1 as te,a2 as ae}from"./eo-dash.DvI3qekh.js";import{a as re,g as ne,b as O,e as oe,c as se,s as D,f as ie,p as ce,h as le,u as J,i as ue,j as de}from"./async-D6Lvv-fT.B73-GQd0.js";import{t as I}from"./item.Bx-rtsOD.js";async function fe({links:e,jsonformValue:t,specUrl:r,customEndpointsHandler:a,jsonformSchema:s,selectedStac:n,isPolling:c,jobs:d,enableCompare:f=!1}){if(!r||!e)return[null,null];const i=await v.get(r).then(h=>h.data),o={},[u,l]=D(e,"service",void 0),p=a&&t&&await a({jsonformSchema:s,jsonformValue:t,links:l,selectedStac:n,isPolling:c,jobs:d,enableCompare:f});if(p&&p.length)return i.data.values=p,[structuredClone(i),structuredClone(o)];const y=u.filter(h=>h.rel==="service"),g=y.filter(h=>h.type==="application/json");if(g.length>=2){for(const h of g??[])switch(h.type){case void 0:continue;case"application/json":o[h.id]=await v.get(C.render(h.href,{...t??{}})).then(b=>b.data),i.data&&(i.data.values={...i.data&&"values"in i.data&&typeof i.data.values=="object"?i.data.values:{},[h.id]:o[h.id]});break}return[i,o]}try{e:for(const h of y??[])switch(h.type){case void 0:continue;case"application/json":await pe(i,{url:h.href,jsonformValue:t,link:h,flatstyleUrl:h["eox:flatstyle"],jsonformSchema:s});break e;case"text/csv":await he(i,{url:h.href,jsonformValue:t,flatstyleUrl:h["eox:flatstyle"]});break e}}catch(h){console.error("[eodash] Error while injecting Vega data",h)}return[structuredClone(i),structuredClone(o)]}async function pe(e,{url:t,jsonformValue:r,link:a,flatstyleUrl:s,jsonformSchema:n}){var c;if(e.data){if(a.method=="GET"){const d=(c=n==null?void 0:n.options)==null?void 0:c.multiQuery,f=Object.keys(r??{}).filter(o=>Array.isArray(d)?d.includes(o):d===o);if(f.length>0&&r){const o=[];for(const u of f)if(Array.isArray(r[u]))for(const l of r[u]){const p=await T(t,{...r,[u]:l},s);o.push(await v.get(p).then(y=>y.data))}else{const l=await T(t,r,s);o.push(await v.get(l).then(p=>p.data))}return e.data.values=o.flat(),e}const i=await T(t,r,s);e.data.values=await v.get(i).then(o=>o.data)}else if(a.method=="POST"){if(!a.body)return console.error("[eodash] Inline data POST request requires a body template"),e;const d=await v.get(a.body,{responseType:"text"}).then(i=>i.data),f=JSON.parse(C.render(d,{...r??{}}));e.data.values=await v.post(t,f).then(i=>i.data)}return e}}async function he(e,{url:t,jsonformValue:r,flatstyleUrl:a}){if(!e.data)return;const s=await T(t,r,a);return e.data.url=s,e}async function T(e,t,r){let a={};return r&&(a=await v.get(r).then(s=>s.data)),C.render(e,{...t??{},...a})}async function ye({links:e,jsonformValue:t,layerId:r,projection:a}){if(!e)return;const[s]=D(e,"service","image/tiff");if(!s.length)return;let n=[],c="";for(const f of s??[])n.push(C.render(f.href,{...t??{}}));return await Promise.all(s.map(f=>ie(f,r,n,a,c))).then(f=>f.filter(i=>!!i))}function ge(e,t,r){if(!e)return;const a=e.filter(n=>n.rel==="service"&&n.type==="image/png"),s=[];for(const n of a)s.push({type:"Image",properties:{id:n.id+"_process",title:"Results "+n.id},source:{type:"ImageStatic",imageExtent:r,url:C.render(n.href,{...t??{}})}});return s}async function ve(e,t,r){if(!e)return;const a=[],s=e.filter(c=>c.rel==="service"&&c.type==="application/geo+json");if(!s.length)return a;let n=null;for(const c of s){"eox:flatstyle"in(c??{})&&(n=await v.get(c["eox:flatstyle"]).then(o=>o.data));let d,f;if(n){const o=V(r??"",n);d=o.layerConfig,f=o.style}const i={type:"Vector",source:{type:"Vector",url:C.render(c.href,{...t??{}}),format:"GeoJSON"},properties:{id:c.id+"_process",title:"Results "+r,...d&&{...d}},...f&&{style:f}};a.push(i)}return a}async function we({links:e,jsonformValue:t,layerId:r,projection:a,origBbox:s,isPolling:n,selectedStac:c,jsonformSchema:d,jobs:f,customLayersHandler:i,enableCompare:o=!1}){if(!e)return[];const u=[],[l,p]=D(e,"service",void 0);if(i&&t&&c&&d&&p.length>0){const k=await i({jsonformValue:t,links:p,selectedStac:c,isPolling:n,jsonformSchema:d,jobs:f,enableCompare:o});k.length&&u.push(...k)}const y=await ve(l,t,r),g=ge(l,t,s),h=await ye({links:l,jsonformValue:t,layerId:r,projection:a});return u.push(...y??[],...g??[],...h??[]),u}async function be(e,t,r=!1){const a=e.find(d=>d.rel==="service"&&d.type=="application/json; profile=collection"&&d.endpoint==="STAC");if(!a)return;let s=C.render(a.href,{...t??{}});U.value&&(U.value=!1);const n=_();await(r?n.loadSelectedCompareSTAC:n.loadSelectedSTAC)(s,!0)}async function me({links:e,jsonformValue:t,isPolling:r,selectedStac:a,jobs:s,enableCompare:n=!1}){if(!r)return;const c=e.filter(f=>f.rel==="service"&&f.endpoint==="eoxhub_workspaces"),d=[];for(const f of c){const i=await v.get(f.body,{responseType:"text"}).then(l=>l.data),o=JSON.parse(C.render(i,{...t??{}})),u=n?A:x;try{const l=await v.post(f.href,o,{headers:{"Content-Type":"application/json"}}),p=JSON.parse(localStorage.getItem(u.value)||"[]");p.push(l.headers.location),localStorage.setItem(u.value,JSON.stringify(p));const y=await ce({jobs:s,processUrl:l.headers.location,isPolling:r,enableCompare:n}).then(g=>le(g)).catch(g=>(g instanceof Error?console.error("Polling failed:",g.message):console.error("Unknown error occurred during polling:",g),[]));await J(s,u.value),d.push(...await ue(y,f,a))}catch(l){await J(s,u.value),l instanceof Error?console.error("Error sending POST request:",l.message):console.error("Unknown error occurred:",l)}}return d}const Ce=ke([me]);function ke(e){return async t=>await Promise.all(e.map(r=>r(t))).then(r=>{const a=[];for(const s of r)a.push(...(s==null?void 0:s.filter(Pe))??[]);return a})}function Pe(e){return!!e&&!!e.type&&(!!e.source||!!e.layers)}async function xe({links:e,jsonformValue:t,jsonformSchema:r,selectedStac:a,enableCompare:s=!1}){const n=e.find(l=>l.rel==="service"&&l.endpoint==="sentinelhub");if(!n)return;const c=await Se(a,s?H.value:B.value);if(!c){console.error("[eodash] evalscript link for sentinel hub not found in indicator",c);return}if(!n)return;const d=n.href,f=O(r),i=t[f],o=await Te();if(!o){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const u=de(a.extent.temporal.interval[0],[t.start_date,t.end_date],t.distribution);return await Promise.all(u.map(([l,p])=>Le({url:d,bearer:o,bbox:i,from:p,to:l,exampleLink:c}).catch(y=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",y)))).then(l=>l.flat().map(p=>p.outputs.data))}async function Te(e,t){{console.error("[eodash] Error (sentinelhub): client id or secret not found");return}}async function Le({url:e,bearer:t,bbox:r,from:a,to:s,timeout:n=2e4,exampleLink:c}){if(!c){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!r){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!a||!s||new Date(a)>new Date(s)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",a,s);return}const d=await v.get(c.href,{responseType:"text"}).then(o=>o.data);if(!d||d.error){console.error("[eodash] Error (sentinelhub): evalscript not found",d);return}const f={input:{bounds:{bbox:r},data:[{dataFilter:{},type:c.dataId}]},aggregation:{evalscript:d,timeRange:{from:a,to:s},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},i={headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:n};return await v.post(e,f,i).then(o=>{const u=o.data.data;return u.forEach(l=>{l.outputs.data.date=a}),u}).catch(o=>{var u,l;if(((u=o.response)==null?void 0:u.status)===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",(l=o.response)==null?void 0:l.data),[]})}async function Se(e,t){const r=e.links.find(a=>a.rel==="example"&&a.title==="evalscript");if(r)return r;for(const a of j(e,t)){const s=v.get(a).then(n=>n.data.links.find(c=>c.rel==="example"&&c.title==="evalscript"));if(s)return s}}async function Ie({links:e,jsonformSchema:t,jsonformValue:r,selectedStac:a,enableCompare:s=!1}){const n=e.find(o=>o.rel==="service"&&(o.endpoint==="veda"||o.endpoint==="veda_stac"));if(!n)return;const c=n==null?void 0:n.href,d=O(t),f=JSON.parse(r[d]),i=await Ae(a,s?H.value:B.value,n);return await Promise.all(i.map(({endpoint:o,datetime:u})=>{const l=new URL(c),p=n.endpoint==="veda_stac"?"ids":"url";return l.searchParams.set(p,o),v.post(l.toString(),{type:"Feature",properties:{},geometry:f}).then(y=>{const g=y.data.properties.statistics;return g.date=u,g}).catch(y=>console.error("[eodash] Error while fetching data from veda endpoint:",y))}))}async function Ae(e,t,r){const a=e.links.filter(i=>i.rel=="child"),s=[];a.length?s.push(...await Promise.all(a.map(i=>v.get(I(i.href,t)).then(o=>o.data).then(async o=>{const u=Object.values(o.assets??{}).find(l=>{var p;return l.type==="application/vnd.apache.parquet"&&((p=l.roles)==null?void 0:p.includes("collection-mirror"))});if(u){const l=I(u.href,I(i.href,t));await ee(l).then(p=>{o.links.push(...te(p))})}return o})))):s.push(e);const n=[];for(const i of s){const o=ae(i.links),u=i.links.filter(l=>l.rel=="item");n.push(...u.map(l=>({endpoint:r.endpoint==="veda_stac"?l.id:l.cog_href,datetime:l[o]})))}n.sort((i,o)=>new Date(i.datetime).getTime()-new Date(o.datetime).getTime());const c=50;if(n.length<=c)return n;const d=n.length,f=[];for(let i=0;i<c;i++){const o=Math.floor(i*(d-1)/(c-1));f.push(n[o])}return f}const Oe=De([xe,Ie]);function De(e){return async t=>{for(const r of e){const a=await r(t);if(F.debug("Custom endpoint data:",a,"for callback:",r.name,"inputs:",t),!(!a||!a.length||a.some(n=>!n)))return a}return null}}async function Ge({selectedStac:e,jsonformEl:t,jsonformSchema:r,isProcessed:a,processResults:s,loading:n,isPolling:c,enableCompare:d}){var o,u,l,p,y,g;const f=d?!!N.value:!!Q.value;let i=null;if((o=e.value)!=null&&o["eodash:jsonform"]&&(i=await v.get(e.value["eodash:jsonform"]).then(h=>h.data)),!i&&f){r.value=null;return}Ue({loading:n,isProcessed:a,jsonformSchema:r,isPolling:c,processResults:s,enableCompare:d}),await((u=t.value)==null?void 0:u.editor.destroy()),i&&((g=(y=(p=(l=i.properties)==null?void 0:l.feature)==null?void 0:p.options)==null?void 0:y.drawtools)!=null&&g.layerId&&await Ee({jsonformSchema:r,newLayers:await X()}),d&&(i=re(i)),r.value=i)}async function Ee({jsonformSchema:e,newLayers:t}){var s,n,c;const r=e.value;if(!r)return;const a=ne(r);if(a&&t&&((c=(n=(s=r==null?void 0:r.properties[a])==null?void 0:s.options)==null?void 0:n.drawtools)!=null&&c.layerId)){let d=t;t.layers&&Array.isArray(t.layers)&&(d=t.layers);const f=r.properties[a].options.drawtools.layerId.split(";:;")[0];let i=null;const o=u=>{var l,p;if(u){for(const y of u)if(y.layers)o(y);else if((p=(l=y.properties)==null?void 0:l.id)!=null&&p.startsWith(f)){i=y.properties.id;break}}};if(o(d),i)r.properties.feature.options.drawtools.layerId=i,e.value=null,await new Promise(u=>setTimeout(u,0)),e.value=r;else throw new Error(`Could not find matching layer for processing form with id: ${f}`)}}async function qe({loading:e,selectedStac:t,jsonformEl:r,jsonformSchema:a,isPolling:s,processResults:n,mapElement:c,jobs:d}){var i,o,u,l,p,y,g,h,k;if(!r.value||!a.value||!t.value)return;const f=(c==null?void 0:c.id)==="compare";F.debug("Processing..."),e.value=!0;try{const b=(o=(i=t.value)==null?void 0:i.links)==null?void 0:o.filter(m=>m.rel==="service"),R=O(a.value),P=(u=r.value)==null?void 0:u.value;oe(P,a.value);const z=P[R],M=(l=t.value)==null?void 0:l["eodash:vegadefinition"],W=((p=t.value)==null?void 0:p.id)??"",$=f?G:q,L=f?Y:Z;let w=null;[w,L.value]=await fe({links:b,jsonformValue:{...P??{}},jsonformSchema:a.value,enableCompare:f,selectedStac:t.value,specUrl:M,isPolling:s,jobs:d,customEndpointsHandler:Oe}),Object.keys(L.value??{}).length&&n.value.push(L.value),(g=(y=w.data)==null?void 0:y.values)!=null&&g.length&&n.value.push(w==null?void 0:w.data.values),w&&!("background"in w)&&(w.background="transparent"),$.value=w,await be(b,P,(c==null?void 0:c.id)==="compare");const S=await we({isPolling:s,links:b,jsonformValue:{...P??{}},jsonformSchema:a.value,selectedStac:t.value,enableCompare:(c==null?void 0:c.id)==="compare",layerId:W,origBbox:z,jobs:d,customLayersHandler:Ce,projection:(h=t.value["eodash:mapProjection"])==null?void 0:h.name});if(S.length)for(const m of S)m.type==="WebGLTile"&&((k=m.source)==null?void 0:k.type)==="GeoTIFF"?n.value.push(...m.source.sources??[]):m.source&&"url"in m.source&&n.value.push(m.source.url);se(c,S),e.value=!1}catch(b){throw console.error("[eodash] Error while running process:",b),e.value=!1,b}}function Ue({loading:e,isProcessed:t,jsonformSchema:r,processResults:a,isPolling:s,enableCompare:n}){e.value=!1,t.value=!1,s.value=!1;const c=n?G:q;c.value=null,a.value=[],r.value=null}const Fe=e=>{var s,n,c,d,f,i;const t=(s=e.target)==null?void 0:s.spec;if(!t||!((c=(n=e.detail)==null?void 0:n.item)!=null&&c.datum)&&!((f=(d=e.detail)==null?void 0:d.item)!=null&&f.datum.datum))return;const r=Object.keys(t.encoding??{}).find(o=>{var u;return((u=t.encoding)==null?void 0:u[o].type)==="temporal"});if(!r)return;const a=(i=t.encoding)==null?void 0:i[r].field;if(a)try{const o=e.detail.item;let u="";o.datum&&o.datum.datum?u=o.datum.datum[a]:u=o.datum[a];const l=new Date(u);K.value=l.toISOString()}catch(o){console.warn("[eodash] Error while setting datetime from eox-chart:",o)}},He=()=>{var r,a;x.value||(x.value=new URLSearchParams(window.location.search).get("indicator")??"");const e=_(),t=(r=e.stac)==null?void 0:r.find(s=>E(s)===x.value);if(e.loadSelectedSTAC(t==null?void 0:t.href),N.value)if(A.value){const s=(a=e.stac)==null?void 0:a.find(n=>E(n)===A.value);e.loadSelectedCompareSTAC(s==null?void 0:s.href).catch(n=>{console.error("[eodash] Error loading compare STAC:",n)})}else e.resetSelectedCompareSTAC()};export{qe as h,Ge as i,He as l,Fe as o,Ee as u};
