import{k as P,a as _,T as E,U as N,z as A,d as $,A as K,q as g,W as Q,M as G,N as q,l as F,O as X,P as Y,C as k,F as U,X as Z,Y as H,Z as B,$ as V,a0 as j,a1 as ee,a2 as te}from"./eo-dash.B7792BtV.js";import{a as re,g as ae,b as O,e as ne,c as oe,s as D,f as se,p as ie,h as ce,u as J,i as le,j as ue}from"./async-DmSHMxv_.BczQCnYR.js";import{t as I}from"./item.Bx-rtsOD.js";async function de({links:t,jsonformValue:e,specUrl:r,customEndpointsHandler:a,jsonformSchema:s,selectedStac:n,isPolling:l,jobs:u,enableCompare:d=!1}){if(!r||!t)return[null,null];const i=await g.get(r).then(h=>h.data),o={},[f,c]=D(t,"service",void 0),p=a&&e&&await a({jsonformSchema:s,jsonformValue:e,links:c,selectedStac:n,isPolling:l,jobs:u,enableCompare:d});if(p&&p.length)return i.data.values=p,[structuredClone(i),structuredClone(o)];const y=f.filter(h=>h.rel==="service"),v=y.filter(h=>h.type==="application/json");if(v.length>=2){for(const h of v??[])switch(h.type){case void 0:continue;case"application/json":o[h.id]=await g.get(k.render(h.href,{...e??{}})).then(T=>T.data),i.data&&(i.data.values={...i.data&&"values"in i.data&&typeof i.data.values=="object"?i.data.values:{},[h.id]:o[h.id]});break}return[i,o]}try{e:for(const h of y??[])switch(h.type){case void 0:continue;case"application/json":await fe(i,{url:h.href,jsonformValue:e,link:h,flatstyleUrl:h["eox:flatstyle"],jsonformSchema:s});break e;case"text/csv":await pe(i,{url:h.href,jsonformValue:e,flatstyleUrl:h["eox:flatstyle"]});break e}}catch(h){console.error("[eodash] Error while injecting Vega data",h)}return[structuredClone(i),structuredClone(o)]}async function fe(t,{url:e,jsonformValue:r,link:a,flatstyleUrl:s,jsonformSchema:n}){var l;if(t.data){if(a.method=="GET"){const u=(l=n==null?void 0:n.options)==null?void 0:l.multiQuery,d=Object.keys(r??{}).filter(o=>Array.isArray(u)?u.includes(o):u===o);if(d.length>0&&r){const o=[];for(const f of d)if(Array.isArray(r[f]))for(const c of r[f]){const p=await x(e,{...r,[f]:c},s);o.push(await g.get(p).then(y=>y.data))}else{const c=await x(e,r,s);o.push(await g.get(c).then(p=>p.data))}return t.data.values=o.flat(),t}const i=await x(e,r,s);t.data.values=await g.get(i).then(o=>o.data)}else if(a.method=="POST"){if(!a.body)return console.error("[eodash] Inline data POST request requires a body template"),t;const u=await g.get(a.body,{responseType:"text"}).then(i=>i.data),d=JSON.parse(k.render(u,{...r??{}}));t.data.values=await g.post(e,d).then(i=>i.data)}return t}}async function pe(t,{url:e,jsonformValue:r,flatstyleUrl:a}){if(!t.data)return;const s=await x(e,r,a);return t.data.url=s,t}async function x(t,e,r){let a={};return r&&(a=await g.get(r).then(s=>s.data)),k.render(t,{...e??{},...a})}async function he({links:t,jsonformValue:e,layerId:r,projection:a}){if(!t)return;const[s]=D(t,"service","image/tiff");if(!s.length)return;let n=[],l="";for(const d of s??[])n.push(k.render(d.href,{...e??{}}));return await Promise.all(s.map(d=>se(d,r,n,a,l))).then(d=>d.filter(i=>!!i))}function ye(t,e,r){if(!t)return;const a=t.filter(n=>n.rel==="service"&&n.type==="image/png"),s=[];for(const n of a)s.push({type:"Image",properties:{id:n.id+"_process",title:"Results "+n.id},source:{type:"ImageStatic",imageExtent:r,url:k.render(n.href,{...e??{}})}});return s}async function ge(t,e,r){if(!t)return;const a=[],s=t.filter(l=>l.rel==="service"&&l.type==="application/geo+json");if(!s.length)return a;let n=null;for(const l of s){"eox:flatstyle"in(l??{})&&(n=await g.get(l["eox:flatstyle"]).then(o=>o.data));let u,d;if(n){const o=Z(r??"",n);u=o.layerConfig,d=o.style}const i={type:"Vector",source:{type:"Vector",url:k.render(l.href,{...e??{}}),format:"GeoJSON"},properties:{id:l.id+"_process",title:"Results "+r,...u&&{...u}},...d&&{style:d}};a.push(i)}return a}async function ve({links:t,jsonformValue:e,layerId:r,projection:a,origBbox:s,isPolling:n,selectedStac:l,jsonformSchema:u,jobs:d,customLayersHandler:i,enableCompare:o=!1}){if(!t)return[];const f=[],[c,p]=D(t,"service",void 0);if(i&&e&&l&&u&&p.length>0){const b=await i({jsonformValue:e,links:p,selectedStac:l,isPolling:n,jsonformSchema:u,jobs:d,enableCompare:o});b.length&&f.push(...b)}const y=await ge(c,e,r),v=ye(c,e,s),h=await he({links:c,jsonformValue:e,layerId:r,projection:a});return f.push(...y??[],...v??[],...h??[]),f}async function we(t,e,r=!1){const a=t.find(u=>u.rel==="service"&&u.type=="application/json; profile=collection"&&u.endpoint==="STAC");if(!a)return;let s=k.render(a.href,{...e??{}});U.value&&(U.value=!1);const n=_();await(r?n.loadSelectedCompareSTAC:n.loadSelectedSTAC)(s,!0)}async function be({links:t,jsonformValue:e,isPolling:r,selectedStac:a,jobs:s,enableCompare:n=!1}){if(!r)return;const l=t.filter(d=>d.rel==="service"&&d.endpoint==="eoxhub_workspaces"),u=[];for(const d of l){const i=await g.get(d.body,{responseType:"text"}).then(c=>c.data),o=JSON.parse(k.render(i,{...e??{}})),f=n?A:P;try{const c=await g.post(d.href,o,{headers:{"Content-Type":"application/json"}}),p=JSON.parse(localStorage.getItem(f.value)||"[]");p.push(c.headers.location),localStorage.setItem(f.value,JSON.stringify(p));const y=await ie({jobs:s,processUrl:c.headers.location,isPolling:r,enableCompare:n}).then(v=>ce(v)).catch(v=>(v instanceof Error?console.error("Polling failed:",v.message):console.error("Unknown error occurred during polling:",v),[]));await J(s,f.value),u.push(...await le(y,d,a))}catch(c){await J(s,f.value),c instanceof Error?console.error("Error sending POST request:",c.message):console.error("Unknown error occurred:",c)}}return u}const me=ke([be]);function ke(t){return async e=>await Promise.all(t.map(r=>r(e))).then(r=>{const a=[];for(const s of r)a.push(...(s==null?void 0:s.filter(Ce))??[]);return a})}function Ce(t){return!!t&&!!t.type&&(!!t.source||!!t.layers)}async function Pe({links:t,jsonformValue:e,jsonformSchema:r,selectedStac:a,enableCompare:s=!1}){const n=t.find(c=>c.rel==="service"&&c.endpoint==="sentinelhub");if(!n)return;const l=await Le(a,s?H.value:B.value);if(!l){console.error("[eodash] evalscript link for sentinel hub not found in indicator",l);return}if(!n)return;const u=n.href,d=O(r),i=e[d],o=await xe();if(!o){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const f=ue(a.extent.temporal.interval[0],[e.start_date,e.end_date],e.distribution);return await Promise.all(f.map(([c,p])=>Te({url:u,bearer:o,bbox:i,from:p,to:c,exampleLink:l}).catch(y=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",y)))).then(c=>c.flat().map(p=>p.outputs.data))}async function xe(t,e){{console.error("[eodash] Error (sentinelhub): client id or secret not found");return}}async function Te({url:t,bearer:e,bbox:r,from:a,to:s,timeout:n=2e4,exampleLink:l}){if(!l){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!r){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!a||!s||new Date(a)>new Date(s)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",a,s);return}const u=await g.get(l.href,{responseType:"text"}).then(o=>o.data);if(!u||u.error){console.error("[eodash] Error (sentinelhub): evalscript not found",u);return}const d={input:{bounds:{bbox:r},data:[{dataFilter:{},type:l.dataId}]},aggregation:{evalscript:u,timeRange:{from:a,to:s},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},i={headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:n};return await g.post(t,d,i).then(o=>{const f=o.data.data;return f.forEach(c=>{c.outputs.data.date=a}),f}).catch(o=>{var f,c;if(((f=o.response)==null?void 0:f.status)===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",(c=o.response)==null?void 0:c.data),[]})}async function Le(t,e){const r=t.links.find(a=>a.rel==="example"&&a.title==="evalscript");if(r)return r;for(const a of V(t,e)){const s=g.get(a).then(n=>n.data.links.find(l=>l.rel==="example"&&l.title==="evalscript"));if(s)return s}}async function Se({links:t,jsonformSchema:e,jsonformValue:r,selectedStac:a,enableCompare:s=!1}){const n=t.find(o=>o.rel==="service"&&(o.endpoint==="veda"||o.endpoint==="veda_stac"));if(!n)return;const l=n==null?void 0:n.href,u=O(e),d=JSON.parse(r[u]),i=await Ie(a,s?H.value:B.value,n);return await Promise.all(i.map(({endpoint:o,datetime:f})=>{const c=new URL(l),p=n.endpoint==="veda_stac"?"ids":"url";return c.searchParams.set(p,o),g.post(c.toString(),{type:"Feature",properties:{},geometry:d}).then(y=>{const v=y.data.properties.statistics;return v.date=f,v}).catch(y=>console.error("[eodash] Error while fetching data from veda endpoint:",y))}))}async function Ie(t,e,r){const a=t.links.filter(i=>i.rel=="child"),s=[];a.length?s.push(...await Promise.all(a.map(i=>g.get(I(i.href,e)).then(o=>o.data).then(async o=>{const f=Object.values(o.assets??{}).find(c=>{var p;return c.type==="application/vnd.apache.parquet"&&((p=c.roles)==null?void 0:p.includes("collection-mirror"))});if(f){const c=I(f.href,I(i.href,e));await j(c).then(p=>{o.links.push(...ee(p))})}return o})))):s.push(t);const n=[];for(const i of s){const o=te(i.links),f=i.links.filter(c=>c.rel=="item");n.push(...f.map(c=>({endpoint:r.endpoint==="veda_stac"?c.id:c.cog_href,datetime:c[o]})))}n.sort((i,o)=>new Date(i.datetime).getTime()-new Date(o.datetime).getTime());const l=50;if(n.length<=l)return n;const u=n.length,d=[];for(let i=0;i<l;i++){const o=Math.floor(i*(u-1)/(l-1));d.push(n[o])}return d}const Ae=Oe([Pe,Se]);function Oe(t){return async e=>{for(const r of t){const a=await r(e);if(F.debug("Custom endpoint data:",a,"for callback:",r.name,"inputs:",e),!(!a||!a.length||a.some(n=>!n)))return a}return null}}async function Ne({selectedStac:t,jsonformEl:e,jsonformSchema:r,isProcessed:a,processResults:s,loading:n,isPolling:l,enableCompare:u}){var o,f;const d=u?!!N.value:!!K.value;let i=null;if((o=t.value)!=null&&o["eodash:jsonform"]&&(i=await g.get(t.value["eodash:jsonform"]).then(c=>c.data)),!i&&d){r.value=null;return}if(Ee({loading:n,isProcessed:a,jsonformSchema:r,isPolling:l,processResults:s,enableCompare:u}),await((f=e.value)==null?void 0:f.editor.destroy()),i){let c=null;c=await De({jsonformSchema:i,newLayers:Q()}),u&&(c=re(c)),r.value=null,await new Promise(p=>setTimeout(p,0)),r.value=c}}async function De({jsonformSchema:t,newLayers:e}){var s,n,l;const r=t;if(!r)return;const a=ae(r);if(a&&e&&((l=(n=(s=r==null?void 0:r.properties[a])==null?void 0:s.options)==null?void 0:n.drawtools)!=null&&l.layerId)){let u=e;e.layers&&Array.isArray(e.layers)&&(u=e.layers);const d=r.properties[a].options.drawtools.layerId.split(";:;")[0];let i=null;const o=f=>{var c,p;if(f){for(const y of f)if(y.type==="Group"&&Array.isArray(y.layers))o(y.layers);else if((p=(c=y.properties)==null?void 0:c.id)!=null&&p.startsWith(d)){i=y.properties.id;break}}};return o(u),i?(r.properties.feature.options.drawtools.layerId=i,r):(console.warn(`Could not find matching layer for processing form with id: ${d}`),null)}return r}async function Ge({loading:t,selectedStac:e,jsonformEl:r,jsonformSchema:a,isPolling:s,processResults:n,mapElement:l,jobs:u}){var i,o,f,c,p,y,v,h;if(!r.value||!a.value||!e.value)return;const d=(l==null?void 0:l.id)==="compare";F.debug("Processing..."),t.value=!0;try{const b=(o=(i=e.value)==null?void 0:i.links)==null?void 0:o.filter(m=>m.rel==="service"),T=O(a.value),C=(f=r.value)==null?void 0:f.value;ne(C,a.value);const R=C[T],z=(c=e.value)==null?void 0:c["eodash:vegadefinition"],M=((p=e.value)==null?void 0:p.id)??"",W=d?G:q,L=d?X:Y;let w=null;[w,L.value]=await de({links:b,jsonformValue:{...C??{}},jsonformSchema:a.value,enableCompare:d,selectedStac:e.value,specUrl:z,isPolling:s,jobs:u,customEndpointsHandler:Ae}),Object.keys(L.value??{}).length&&n.value.push(L.value),Object.keys(((y=w==null?void 0:w.data)==null?void 0:y.values)??{}).length&&n.value.push(w==null?void 0:w.data.values),w&&!("background"in w)&&(w.background="transparent"),W.value=w,await we(b,C,(l==null?void 0:l.id)==="compare");const S=await ve({isPolling:s,links:b,jsonformValue:{...C??{}},jsonformSchema:a.value,selectedStac:e.value,enableCompare:(l==null?void 0:l.id)==="compare",layerId:M,origBbox:R,jobs:u,customLayersHandler:me,projection:(v=e.value["eodash:mapProjection"])==null?void 0:v.name});if(S.length)for(const m of S)m.type==="WebGLTile"&&((h=m.source)==null?void 0:h.type)==="GeoTIFF"?n.value.push(...m.source.sources??[]):m.source&&"url"in m.source&&n.value.push(m.source.url);oe(l,S),t.value=!1}catch(b){throw console.error("[eodash] Error while running process:",b),t.value=!1,b}}function Ee({loading:t,isProcessed:e,jsonformSchema:r,processResults:a,isPolling:s,enableCompare:n}){t.value=!1,e.value=!1,s.value=!1;const l=n?G:q;l.value=null,a.value=[],r.value=null}const qe=t=>{var s,n,l,u,d,i;const e=(s=t.target)==null?void 0:s.spec;if(!e||!((l=(n=t.detail)==null?void 0:n.item)!=null&&l.datum)&&!((d=(u=t.detail)==null?void 0:u.item)!=null&&d.datum.datum))return;const r=Object.keys(e.encoding??{}).find(o=>{var f;return((f=e.encoding)==null?void 0:f[o].type)==="temporal"});if(!r)return;const a=(i=e.encoding)==null?void 0:i[r].field;if(a)try{const o=t.detail.item;let f="";o.datum&&o.datum.datum?f=o.datum.datum[a]:f=o.datum[a];const c=new Date(f);$.value=c.toISOString()}catch(o){console.warn("[eodash] Error while setting datetime from eox-chart:",o)}},Fe=()=>{var r,a;P.value||(P.value=new URLSearchParams(window.location.search).get("indicator")??"");const t=_(),e=(r=t.stac)==null?void 0:r.find(s=>E(s)===P.value);if(t.loadSelectedSTAC(e==null?void 0:e.href),N.value)if(A.value){const s=(a=t.stac)==null?void 0:a.find(n=>E(n)===A.value);t.loadSelectedCompareSTAC(s==null?void 0:s.href).catch(n=>{console.error("[eodash] Error loading compare STAC:",n)})}else t.resetSelectedCompareSTAC()};export{Ge as h,Ne as i,Fe as l,qe as o,De as u};
